<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#faf9f7;--sf:#ffffff;--br:#e8e5e0;
  --tp:#1a1916;--ts:#7a7670;
  --ac:#c8a96e;--as:#f5f0e8;
  --cdbg:#1a1917;--cdtx:#e8e4dc;
  --green:#3d7a52;--blue:#2d5fa0;--red:#8a3a3a;--purple:#6040a0;--orange:#b06020;
  --gs:#eaf3ee;--bs:#e8f0fb;--rs:#faeaea;--ps:#f2edfb;--os:#fdf0e4;
}
body{font-family:-apple-system,sans-serif;background:var(--bg);color:var(--tp);min-height:100vh;max-width:720px;margin:0 auto;padding:0 0 80px;}

/* LIST */
.app-header{padding:52px 24px 14px;border-bottom:1px solid var(--br);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(250,249,247,.93);}
.app-title{font-size:28px;font-weight:700;letter-spacing:-.5px;}
.note-count{font-size:13px;color:var(--ts);margin-top:3px;}
.note-row{padding:16px 24px;border-bottom:1px solid var(--br);display:flex;gap:14px;align-items:flex-start;cursor:pointer;width:100%;background:none;border-left:none;border-right:none;border-top:none;text-align:left;}
.note-row:active{background:var(--as);}
.note-icon{width:40px;height:40px;border-radius:10px;background:var(--as);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;}
.note-preview{flex:1;min-width:0;}
.note-title{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--tp);}
.note-snippet{font-size:13px;color:var(--ts);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.note-date{font-size:12px;color:var(--ts);flex-shrink:0;margin-top:2px;}

/* DETAIL */
.note-detail{display:none;min-height:100vh;}
.note-detail.open{display:block;}
.detail-header{padding:13px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--br);position:sticky;top:0;background:rgba(250,249,247,.96);backdrop-filter:blur(20px);z-index:10;}
.back-btn{color:var(--ac);font-size:17px;font-weight:600;border:none;background:none;padding:6px 4px;min-width:56px;cursor:pointer;}
.detail-title{flex:1;font-size:14px;font-weight:600;text-align:center;}
.gear-btn{font-size:20px;border:none;background:none;padding:6px;min-width:40px;color:var(--ac);cursor:pointer;}

/* SETUP */
.setup-box{margin:12px 20px;padding:14px;background:var(--as);border:1px solid rgba(200,169,110,.3);border-radius:12px;}
.setup-box input{width:100%;padding:9px 11px;border:1px solid var(--br);border-radius:8px;font-size:13px;font-family:monospace;background:#fff;color:var(--tp);outline:none;margin-bottom:7px;-webkit-appearance:none;}
.setup-box button{width:100%;padding:9px;background:var(--tp);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;}
.setup-lbl{font-size:12px;font-weight:600;margin-bottom:5px;}
.setup-desc{font-size:11px;color:var(--ts);margin-bottom:8px;line-height:1.5;}

/* MODE */
.mode-row{display:flex;margin:12px 20px 8px;background:var(--br);border-radius:11px;padding:3px;gap:2px;}
.mode-btn{flex:1;padding:8px 6px;border-radius:8px;border:none;font-size:11.5px;font-weight:700;cursor:pointer;transition:all .18s;background:none;color:var(--ts);}
.mode-btn.on{background:var(--sf);color:var(--tp);box-shadow:0 1px 4px rgba(0,0,0,.12);}

/* VOICE */
.voice-wrap{margin:0 20px 6px;background:var(--sf);border:1px solid var(--br);border-radius:14px;overflow:hidden;}
.voice-top{padding:10px 14px 8px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--br);}
.vlbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);}
.vtimer{font-size:12px;color:var(--ts);font-variant-numeric:tabular-nums;}
.mic-wrap{display:flex;justify-content:center;padding:16px 0 4px;}
.mic-btn{width:68px;height:68px;border-radius:50%;background:var(--as);border:2px solid rgba(200,169,110,.4);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;}
.mic-btn:active{transform:scale(.92);}
.mic-btn.on{background:#fff0f0;border-color:rgba(200,60,60,.5);animation:mPulse 1s ease-in-out infinite;}
@keyframes mPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.waveform{display:none;align-items:flex-end;justify-content:center;gap:3px;height:26px;margin:3px auto 0;width:100px;}
.waveform.on{display:flex;}
.wb{width:4px;border-radius:2px;background:var(--ac);animation:wv .9s infinite ease-in-out;}
.wb:nth-child(1){animation-delay:0s}.wb:nth-child(2){animation-delay:.1s}.wb:nth-child(3){animation-delay:.2s}.wb:nth-child(4){animation-delay:.3s}.wb:nth-child(5){animation-delay:.2s}.wb:nth-child(6){animation-delay:.1s}.wb:nth-child(7){animation-delay:0s}
@keyframes wv{0%,100%{height:4px;opacity:.4}50%{height:22px;opacity:1}}
.vstatus{text-align:center;font-size:12.5px;color:var(--ts);padding:5px 14px 3px;font-style:italic;min-height:24px;}
.vstatus.on{color:#c0392b;font-style:normal;font-weight:500;}
.tbox{margin:7px 14px 11px;padding:10px 12px;background:var(--bg);border:1px solid var(--br);border-radius:9px;font-size:14px;line-height:1.65;color:var(--tp);min-height:48px;outline:none;-webkit-user-select:text;user-select:text;}
.tbox:empty::before{content:attr(data-ph);color:var(--ts);font-style:italic;}
.vactions{display:flex;gap:8px;padding:0 14px 14px;}
.btn-cl{flex:1;padding:10px;border-radius:8px;font-size:13px;font-weight:600;border:1.5px solid var(--br);background:var(--bg);color:var(--ts);cursor:pointer;}
.btn-go{flex:2;padding:10px;border-radius:8px;font-size:13px;font-weight:700;border:none;background:var(--tp);color:#fff;cursor:pointer;}
.btn-go:disabled{opacity:.35;cursor:not-allowed;}

/* CHIPS */
.chips{display:flex;gap:7px;padding:8px 20px 10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.chips::-webkit-scrollbar{display:none;}
.chip{padding:6px 13px;border-radius:20px;font-size:11.5px;font-weight:600;border:1.5px solid var(--br);background:var(--sf);color:var(--ts);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.chip.on{background:var(--tp);color:#fff;border-color:var(--tp);}

/* STREAM */
.sprog{display:none;margin:0 20px 2px;height:2px;background:var(--br);border-radius:2px;overflow:hidden;}
.sprog.on{display:block;}
.sbar{height:100%;background:linear-gradient(90deg,var(--ac),#e8c878);border-radius:2px;width:0%;transition:width .4s ease;}

/* THINKING */
.thinking{display:none;padding:14px 20px;align-items:center;gap:10px;}
.thinking.on{display:flex;}
.dots{display:flex;gap:4px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--ac);animation:pulse 1.2s infinite;}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{transform:scale(1);opacity:.5}40%{transform:scale(1.3);opacity:1}}
.ttext{font-size:12.5px;color:var(--ts);font-style:italic;}

/* RESPONSE */
.rarea{padding:0 20px 40px;display:none;}
.rarea.on{display:block;}

/* PRIMARY TABS */
.ptabs{display:flex;border-bottom:1px solid var(--br);margin:0 -20px;padding:0 10px;overflow-x:auto;margin-top:14px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.ptabs::-webkit-scrollbar{display:none;}
.ptab{padding:9px 11px;font-size:11.5px;font-weight:700;color:var(--ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;}
.ptab.on{color:var(--tp);border-bottom-color:var(--ac);}
.ppanel{display:none;padding-top:14px;}
.ppanel.on{display:block;}

/* SUB-TABS */
.stab-row{display:flex;margin:10px -20px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;background:var(--sf);border-bottom:1px solid var(--br);}
.stab-row::-webkit-scrollbar{display:none;}
.stab{padding:8px 11px;font-size:10.5px;font-weight:700;color:var(--ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:4px;}
.stab.on{color:var(--blue);border-bottom-color:var(--blue);}
.sn{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(--br);color:var(--ts);font-size:9px;font-weight:800;flex-shrink:0;}
.stab.on .sn{background:var(--blue);color:#fff;}
.step-t{font-size:9px;font-weight:400;color:var(--ts);margin-left:2px;}
.spanel{display:none;padding-top:12px;}
.spanel.on{display:block;}

/* CONTENT BLOCKS */
.iblock{border-radius:0 10px 10px 0;padding:13px 15px;font-size:13px;line-height:1.75;margin-bottom:11px;}
.iblock.blue{background:var(--bs);border-left:3px solid var(--blue);}
.iblock.green{background:var(--gs);border-left:3px solid var(--green);}
.iblock.red{background:var(--rs);border-left:3px solid var(--red);}
.iblock.purple{background:var(--ps);border-left:3px solid var(--purple);}
.iblock.orange{background:var(--os);border-left:3px solid var(--orange);}
.blbl{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.iblock.blue .blbl{color:var(--blue);}
.iblock.green .blbl{color:var(--green);}
.iblock.red .blbl{color:var(--red);}
.iblock.purple .blbl{color:var(--purple);}
.iblock.orange .blbl{color:var(--orange);}

.sumbox{background:var(--as);border:1px solid rgba(200,169,110,.3);border-radius:10px;padding:14px;font-size:14px;line-height:1.7;margin-bottom:12px;}
.mrow{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.badge{font-size:10.5px;padding:3px 9px;border-radius:20px;font-weight:600;}
.bb{background:var(--bs);color:var(--blue);border:1px solid rgba(45,95,160,.2);}
.bg{background:var(--gs);color:var(--green);border:1px solid rgba(61,122,82,.2);}
.ba{background:var(--as);color:var(--ac);border:1px solid rgba(200,169,110,.3);}
.bp{background:var(--ps);color:var(--purple);border:1px solid rgba(96,64,160,.2);}
.bo{background:var(--os);color:var(--orange);border:1px solid rgba(176,96,32,.2);}

.sublbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);margin:16px 0 7px;}
.hrow{background:var(--as);border:1px solid rgba(200,169,110,.22);border-radius:8px;padding:9px 13px;margin-bottom:7px;font-size:13px;line-height:1.6;}
.pill-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.pill{font-size:11.5px;padding:3px 11px;border-radius:20px;border:1px solid var(--br);background:var(--sf);color:var(--tp);font-weight:500;}
.divider{height:1px;background:var(--br);margin:14px 0;}

/* CARD */
.card{background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:13px;margin-bottom:9px;}
.card-head{font-size:13px;font-weight:700;margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}
.cnum{width:22px;height:22px;border-radius:50%;background:var(--ac);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.card-body{font-size:12.5px;line-height:1.65;}
.card-body code{font-family:monospace;font-size:11px;background:var(--as);padding:1px 4px;border-radius:3px;}
.card-sub{font-size:11.5px;color:var(--blue);margin-top:5px;font-style:italic;}
.card-warn{font-size:11.5px;color:var(--red);margin-top:5px;}

/* TECH CARD with inline alts */
.tech-card{background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:13px;margin-bottom:10px;}
.tech-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.tech-name{font-size:13.5px;font-weight:700;}
.chosen-tag{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700;background:var(--gs);color:var(--green);}
.tech-role{font-size:12.5px;line-height:1.6;color:var(--tp);margin-bottom:3px;}
.tech-why{font-size:12px;line-height:1.6;color:var(--ts);margin-bottom:8px;border-left:2px solid var(--green);padding-left:8px;}
.alt-lbl{font-size:9.5px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--ts);margin-bottom:5px;}
.alt-row{display:flex;align-items:flex-start;gap:7px;padding:6px 9px;background:var(--bg);border-radius:7px;margin-bottom:4px;border:1px solid var(--br);}
.alt-name{font-size:12px;font-weight:600;flex-shrink:0;min-width:90px;}
.av{font-size:9.5px;padding:2px 7px;border-radius:7px;font-weight:700;flex-shrink:0;white-space:nowrap;}
.av-ok{background:var(--bs);color:var(--blue);}
.av-trade{background:var(--os);color:var(--orange);}
.av-avoid{background:var(--rs);color:var(--red);}
.alt-why{font-size:11.5px;color:var(--ts);line-height:1.5;}

/* DIAGRAM â€” two diagrams stacked, pre-wrap so no horizontal scroll */
.diag-wrap{margin-bottom:14px;}
.diag-label{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);margin-bottom:5px;display:flex;align-items:center;gap:6px;}
.diag-pill{font-size:9px;padding:2px 7px;border-radius:10px;background:var(--bs);color:var(--blue);font-weight:600;}
.diagram{background:var(--cdbg);border-radius:12px;padding:14px 16px;font-family:'SF Mono',monospace;font-size:11.5px;line-height:1.9;color:#c8c4bc;white-space:pre-wrap;word-break:break-word;overflow-x:auto;}
/* colour accents inside diagram */
.diagram .chosen{color:#7ec87e;}
.diagram .alt{color:#e8c878;}

/* CODE â€” pre-wrap no horizontal scroll */
.code-outer{background:var(--cdbg);border-radius:12px;overflow:hidden;margin-bottom:10px;}
.code-hdr{padding:9px 14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.08);}
.code-lang{font-size:10px;color:#8a8580;font-family:monospace;letter-spacing:.05em;}
.copy-btn{font-size:11px;color:var(--ac);background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:4px;font-weight:500;}
.code-body{padding:14px;}
.code-body pre{font-family:'SF Mono',monospace;font-size:12px;line-height:1.7;color:var(--cdtx);white-space:pre-wrap;word-break:break-word;}

/* Q&A */
.qa-item{border:1px solid var(--br);border-radius:10px;overflow:hidden;margin-bottom:9px;}
.qa-q{padding:12px 14px;font-size:13px;font-weight:600;background:var(--sf);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px;}
.chev{color:var(--ts);transition:transform .2s;font-size:13px;flex-shrink:0;}
.chev.open{transform:rotate(90deg);}
.qa-a{display:none;padding:11px 14px;font-size:12.5px;line-height:1.7;background:var(--bg);border-top:1px solid var(--br);}
.qa-a.open{display:block;}

/* SKELETON shimmer */
.skel{background:linear-gradient(90deg,var(--br) 25%,var(--as) 50%,var(--br) 75%);background-size:200% 100%;animation:sk 1.2s infinite;border-radius:5px;height:13px;margin-bottom:7px;}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* SPEAK MODE */
#sovl{display:none;position:fixed;inset:0;background:rgba(12,11,10,.97);z-index:999;flex-direction:column;padding:60px 22px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
#sovl.on{display:flex;}
.sovl-close{position:fixed;top:16px;right:18px;color:var(--ac);font-size:26px;cursor:pointer;background:none;border:none;z-index:1000;padding:8px;}
.sovl-title{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--ac);margin-bottom:18px;}
.sc{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:13px;padding:16px 18px;margin-bottom:13px;}
.sc-lbl{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ac);margin-bottom:8px;}
.sc-txt{font-size:15px;line-height:1.9;color:#ede9e2;}

.spk-btn{width:100%;padding:12px;background:var(--as);border:1.5px solid rgba(200,169,110,.4);border-radius:9px;font-size:13px;font-weight:600;color:var(--tp);cursor:pointer;margin-top:4px;}
.err-box{background:#fff0f0;border:1px solid #ffcccc;border-radius:9px;padding:13px 15px;font-size:13px;color:#c0392b;margin-top:10px;}
.fadein{animation:fadeIn .3s ease forwards;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.toast{position:fixed;bottom:36px;left:50%;transform:translateX(-50%);background:#1a1916;color:#fff;padding:8px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .25s;white-space:nowrap;pointer-events:none;}
</style>
</head>
<body>

<!-- LIST -->
<div id="list">
  <div class="app-header">
    <div class="app-title">Notes</div>
    <div class="note-count">4 notes</div>
  </div>
  <div style="padding:6px 0">
    <button class="note-row" onclick="openTool('coding')">
      <div class="note-icon">â˜•</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ Java</div><div class="note-snippet">Tap to solve a coding problemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="openTool('sd')">
      <div class="note-icon">ğŸ—ï¸</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ System Design</div><div class="note-snippet">Tap to design a systemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“‹</div>
      <div class="note-preview"><div class="note-title">Meeting notes â€“ Product sync</div><div class="note-snippet">Roadmap priorities, Q2 milestones</div></div>
      <div class="note-date">Mon</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“</div>
      <div class="note-preview"><div class="note-title">Grocery list</div><div class="note-snippet">Eggs, bread, olive oil, tomatoesâ€¦</div></div>
      <div class="note-date">Sun</div>
    </button>
  </div>
</div>

<!-- TOOL -->
<div id="tool" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">â€¹ Notes</button>
    <div class="detail-title" id="dtitle">Quick Ref</div>
    <button class="gear-btn" onclick="toggleSetup()">âš™ï¸</button>
  </div>

  <div id="setup" class="setup-box" style="display:none;margin-top:12px">
    <div class="setup-lbl">ğŸ”‘ API Key</div>
    <div class="setup-desc">Stored locally â€” never sent anywhere except Anthropic.</div>
    <input type="password" id="apikey" placeholder="sk-ant-â€¦" autocomplete="off"/>
    <button onclick="saveKey()">Save & Close</button>
  </div>

  <div class="mode-row">
    <button class="mode-btn on" id="mCoding" onclick="setMode('coding')">â˜• Java Coding</button>
    <button class="mode-btn" id="mSD" onclick="setMode('sd')">ğŸ—ï¸ System Design</button>
  </div>

  <div class="voice-wrap">
    <div class="voice-top">
      <span class="vlbl" id="vlbl">ğŸ™ Speak your coding problem</span>
      <span class="vtimer" id="vtimer"></span>
    </div>
    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ™ï¸</button>
    </div>
    <div class="waveform" id="wf">
      <div class="wb" style="height:5px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:25px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:5px"></div>
    </div>
    <div class="vstatus" id="vs">Tap the mic and speak clearly</div>
    <div class="tbox" id="tbox" contenteditable="true" spellcheck="false" data-ph="Tap mic to speakâ€¦"></div>
    <div class="vactions">
      <button class="btn-cl" onclick="clearAll()">Clear</button>
      <button class="btn-go" id="goBtn" onclick="generate()" disabled>Generate âš¡</button>
    </div>
  </div>

  <div class="chips" id="chips">
    <div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
    <div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
    <div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>
  </div>

  <div class="sprog" id="sprog"><div class="sbar" id="sbar"></div></div>
  <div class="thinking" id="thinking"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div class="ttext" id="ttext">Thinkingâ€¦</div></div>
  <div class="rarea" id="rarea"></div>
</div>

<!-- SPEAK MODE -->
<div id="sovl">
  <button class="sovl-close" onclick="closeSM()">âœ•</button>
  <div class="sovl-title">ğŸ“¢ How to Explain This</div>
  <div id="smc"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â• STATE â•â•â• */
const SK='nt_v6';
let mode='coding',depth='interview',last=null;
let rec=null,listening=false,silT=null,timerI=null,elapsed=0,accTxt='';

/* â•â•â• KEY â•â•â• */
const getKey=()=>localStorage.getItem(SK)||'';
function saveKey(){const v=document.getElementById('apikey').value.trim();if(!v){toast('Enter a key');return;}localStorage.setItem(SK,v);document.getElementById('setup').style.display='none';toast('Saved âœ“');}
function toggleSetup(){const s=document.getElementById('setup');const show=s.style.display==='none';s.style.display=show?'block':'none';if(show&&getKey())document.getElementById('apikey').value=getKey();}

/* â•â•â• NAV â•â•â• */
function openTool(m){document.getElementById('list').style.display='none';document.getElementById('tool').classList.add('open');setMode(m);if(!getKey())document.getElementById('setup').style.display='block';}
function goBack(){stopMic(false);document.getElementById('tool').classList.remove('open');document.getElementById('list').style.display='block';clearAll();last=null;}

/* â•â•â• MODE â•â•â• */
function setMode(m){
  mode=m;
  document.getElementById('mCoding').classList.toggle('on',m==='coding');
  document.getElementById('mSD').classList.toggle('on',m==='sd');
  document.getElementById('dtitle').textContent=m==='coding'?'Java Coding':'System Design';
  document.getElementById('vlbl').textContent=m==='coding'?'ğŸ™ Speak your coding problem':'ğŸ™ Describe the system to design';
  document.getElementById('tbox').setAttribute('data-ph',m==='coding'?'Tap mic to speak your problemâ€¦':'e.g. "Design Twitter" or "Design a URL shortener"');
  const ch=document.getElementById('chips');
  if(m==='sd'){ch.innerHTML=`<div class="chip on" data-d="senior" onclick="setDepth(this)">ğŸ¯ Senior/Staff</div><div class="chip" data-d="mid" onclick="setDepth(this)">ğŸ‘¨â€ğŸ’» Mid-level</div><div class="chip" data-d="deep" onclick="setDepth(this)">ğŸ“– Deep Dive</div>`;depth='senior';}
  else{ch.innerHTML=`<div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div><div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div><div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>`;depth='interview';}
  clearAll();
}
function setDepth(el){el.closest('.chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));el.classList.add('on');depth=el.dataset.d;}

/* â•â•â• TOAST / TIMER â•â•â• */
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2400);}
function startTimer(){elapsed=0;clearInterval(timerI);timerI=setInterval(()=>{elapsed++;document.getElementById('vtimer').textContent=pad(Math.floor(elapsed/60))+':'+pad(elapsed%60);},1000);}
function stopTimer(){clearInterval(timerI);document.getElementById('vtimer').textContent='';}
const pad=n=>String(n).padStart(2,'0');

/* â•â•â• MIC â•â•â• */
function toggleMic(){listening?stopMic(true):startMic();}
function startMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('Voice not supported â€” type instead');return;}
  accTxt=document.getElementById('tbox').textContent.trim();
  rec=new SR();rec.continuous=true;rec.interimResults=true;rec.lang='en-US';
  rec.onstart=()=>{listening=true;document.getElementById('micBtn').classList.add('on');document.getElementById('micBtn').textContent='â¹ï¸';document.getElementById('wf').classList.add('on');document.getElementById('vs').textContent='Listeningâ€¦ speak clearly';document.getElementById('vs').classList.add('on');startTimer();};
  rec.onresult=e=>{
    clearTimeout(silT);silT=setTimeout(()=>stopMic(true),2800);
    let fin=accTxt?accTxt+' ':'',int='';
    for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;e.results[i].isFinal?(fin+=t,accTxt=fin.trim()):int=t;}
    document.getElementById('tbox').textContent=(accTxt+(int?' '+int:'')).trim();chkBtn();
  };
  rec.onerror=e=>{if(e.error==='not-allowed')toast('Mic blocked â€” allow in Safari settings');stopMic(false);};
  rec.onend=()=>{if(listening){try{rec.start();}catch(e){stopMic(false);}}};
  try{rec.start();}catch(e){toast('Cannot start mic');}
}
function stopMic(auto){
  const was=listening;listening=false;clearTimeout(silT);stopTimer();
  if(rec){try{rec.stop();}catch(e){}rec=null;}
  document.getElementById('micBtn').classList.remove('on');document.getElementById('micBtn').textContent='ğŸ™ï¸';
  document.getElementById('wf').classList.remove('on');document.getElementById('vs').classList.remove('on');
  const txt=document.getElementById('tbox').textContent.trim();
  if(was&&auto&&txt.length>5){document.getElementById('vs').textContent='Got it â€” generatingâ€¦';setTimeout(generate,500);}
  else{document.getElementById('vs').textContent=txt.length>5?'Ready â€” tap Generate':'Tap the mic and speak clearly';}
}
function chkBtn(){document.getElementById('goBtn').disabled=document.getElementById('tbox').textContent.trim().length<5;}
function clearAll(){accTxt='';document.getElementById('tbox').textContent='';document.getElementById('goBtn').disabled=true;document.getElementById('vs').textContent='Tap the mic and speak clearly';document.getElementById('rarea').innerHTML='';document.getElementById('rarea').classList.remove('on');document.getElementById('thinking').classList.remove('on');document.getElementById('sprog').classList.remove('on');document.getElementById('sbar').style.width='0%';last=null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE â€” STREAMING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generate(){
  const prob=document.getElementById('tbox').textContent.trim();
  if(prob.length<4){toast('Say or type a problem first');return;}
  const key=getKey();if(!key){toggleSetup();toast('Add API key first');return;}
  document.getElementById('goBtn').disabled=true;
  document.getElementById('rarea').innerHTML='';
  document.getElementById('rarea').classList.remove('on');
  document.getElementById('thinking').classList.add('on');
  document.getElementById('ttext').textContent=mode==='coding'?'Solving your problemâ€¦':'Architecting your systemâ€¦';
  document.getElementById('sprog').classList.add('on');
  const bar=document.getElementById('sbar');bar.style.width='5%';
  const sys=mode==='coding'?codingPrompt():sdPrompt();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:mode==='coding'?4500:12000,stream:true,system:sys,messages:[{role:'user',content:prob}]})
    });
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'API error '+res.status);}
    const reader=res.body.getReader(),dec=new TextDecoder();
    let full='',pct=5,dk=new Set(),lineBuf='';
    /* Show skeleton immediately */
    document.getElementById('thinking').classList.remove('on');
    showSkeleton();
    document.getElementById('rarea').classList.add('on');

    while(true){
      const{done,value}=await reader.read();
      /* Flush decoder on final read â€” no stream:true drains internal buffer */
      const chunk=value?dec.decode(value,{stream:true}):(done?dec.decode():'');
      lineBuf+=chunk;
      const lines=lineBuf.split('\n');
      lineBuf=lines.pop()||'';
      for(const ln of lines){
        if(!ln.startsWith('data: '))continue;
        const d=ln.slice(6).trim();
        if(d==='[DONE]')continue;
        try{
          const ev=JSON.parse(d);
          if(ev.type==='content_block_delta'&&ev.delta?.text){
            full+=ev.delta.text;
            pct=Math.min(90,pct+0.15);
            bar.style.width=pct+'%';
            patch(full,dk);
          }
        }catch(e){}
      }
      if(done)break;
    }
    /* Drain any remaining line buffer */
    if(lineBuf.startsWith('data: ')){
      const d=lineBuf.slice(6).trim();
      if(d&&d!=='[DONE]'){try{const ev=JSON.parse(d);if(ev.type==='content_block_delta'&&ev.delta?.text)full+=ev.delta.text;}catch(e){}}
    }

    bar.style.width='100%';
    setTimeout(()=>{document.getElementById('sprog').classList.remove('on');bar.style.width='0%';},500);

    /* Multi-strategy JSON parse */
    let parsed=null;
    const tryP=s=>{try{return JSON.parse(s);}catch(e){return null;}};
    let c=full.trim().replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
    parsed=tryP(c);
    if(!parsed){const fi=c.indexOf('{'),la=c.lastIndexOf('}');if(fi>=0&&la>fi)parsed=tryP(c.slice(fi,la+1));}
    if(!parsed){try{parsed=tryP(c.replace(/,\s*([}\]])/g,'$1'));}catch(e){}}

    if(parsed){
      last={mode,data:parsed};
      mode==='coding'?renderCoding(parsed):renderSD(parsed);
    }else{
      document.getElementById('rarea').innerHTML=
        '<div class="err-box">&#9888; Could not parse response.'+(full.length<50?' Response empty â€” check API key.':' Model returned unexpected format. Tap Generate to retry.')+'<br><br>'+
        '<details><summary style="cursor:pointer;font-weight:600">Show raw response</summary>'+
        '<pre style="white-space:pre-wrap;word-break:break-word;font-size:10px;margin-top:6px;max-height:180px;overflow-y:auto">'+
        full.slice(0,800).replace(/&/g,'&amp;').replace(/</g,'&lt;')+
        '</pre></details></div>';
    }
  }catch(err){
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('rarea').innerHTML='<div class="err-box">âš ï¸ '+err.message+'</div>';
    document.getElementById('rarea').classList.add('on');
    document.getElementById('sprog').classList.remove('on');
  }finally{
    document.getElementById('goBtn').disabled=false;
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('vs').textContent='Tap mic to record again';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAM PATCH â€” renders content progressively as tokens arrive.
   Uses TWO extraction strategies:
   A) strComplete â€” only fires when JSON string is fully closed (safe for short fields)
   B) strPartial  â€” fires as soon as MIN_CHARS arrived (for long fields like thought_process)
   Priority: problem_statement (partial, ~40 chars) â†’ FR items â†’ NFR items â†’ thought_process
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function patch(txt,dk){
  /* A: fully-closed string â€” safe value */
  const strComplete=key=>{
    const m=txt.match(new RegExp('"'+key+'"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*?)"\\s*[,}\\n]','s'));
    return m?unescape(m[1]):null;
  };
  /* B: partial string â€” grab whatever has arrived so far (no closing quote required) */
  const strPartial=(key,minLen=40)=>{
    const m=txt.match(new RegExp('"'+key+'"\\s*:\\s*"((?:[^"\\\\]|\\\\.){'+minLen+',})','s'));
    return m?unescape(m[1]):null;
  };
  const unescape=s=>s.replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\\\/g,'\\');

  /* Write to a named slot, removing skeleton shimmer lines */
  const slot=(id,html)=>{
    const el=document.getElementById(id);
    if(!el||el.dataset.filled)return;
    el.dataset.filled='1';
    el.innerHTML=html;
    el.classList.add('fadein');
  };

  if(mode==='coding'){
    ['thought_process','analogy','summary','complexity'].forEach(k=>{
      if(!dk.has(k)){
        const v=strComplete(k)||strPartial(k,30);
        if(v&&v.length>15){dk.add(k);slot('sk_'+k,v.replace(/\n/g,'<br>'));}
      }
    });
    return;
  }

  /* â”€â”€ SD mode â”€â”€ */

  /* PRIORITY 1: problem_statement â€” partial, fires as soon as ~50 chars arrive (~1s) */
  if(!dk.has('ps')){
    const v=strComplete('problem_statement')||strPartial('problem_statement',50);
    if(v&&v.length>15){dk.add('ps');slot('sk_ps',v);}
  }

  /* PRIORITY 2: functional requirements â€” parse objects as each closes */
  if(!dk.has('fr')){
    const m=txt.match(/"functional"\s*:\s*\[([\s\S]*?)(?:\]|(?="non_functional"))/);
    if(m&&m[1]){
      const reqs=[];let rx2=/"req"\s*:\s*"([^"\\\\]+)"/g,hit;
      while((hit=rx2.exec(m[1]))!==null)reqs.push(hit[1]);
      if(reqs.length>=1){
        dk.add('fr');
        /* Don't lock â€” keep updating until NFR starts */
        const el=document.getElementById('sk_fr');
        if(el){el.innerHTML=reqs.map(r=>'<div class="hrow fadein">ğŸ”µ '+r+'</div>').join('');el.classList.add('fadein');}
      }
    }
  }

  /* PRIORITY 3: NFRs â€” same rolling parse */
  if(!dk.has('nfr')){
    const m=txt.match(/"non_functional"\s*:\s*\[([\s\S]*?)(?:\]|(?="out_of_scope"))/);
    if(m&&m[1]){
      const items=[];let pos=0;
      while(true){
        const s=m[1].indexOf('"req"',pos);if(s<0)break;
        const rM=m[1].slice(s).match(/"req"\s*:\s*"([^"\\\\]+)"/);
        const vM=m[1].slice(s).match(/"value"\s*:\s*"([^"\\\\]+)"/);
        if(rM)items.push({r:rM[1],v:vM?vM[1]:''});
        pos=s+5;
      }
      if(items.length>=1){
        dk.add('nfr');
        const el=document.getElementById('sk_nfr');
        if(el){el.innerHTML=items.map(i=>'<div class="hrow fadein">â— <strong>'+i.r+'</strong>'+(i.v?' <span class="badge ba">'+i.v+'</span>':'')+'</div>').join('');el.classList.add('fadein');}
      }
    }
  }

  /* PRIORITY 4: capacity numbers â€” parse as soon as write_qps appears */
  if(!dk.has('cap')){
    const wq=strComplete('write_qps'), rq=strComplete('read_qps'), st=strComplete('storage_per_year');
    const assM=txt.match(/"assumptions"\s*:\s*\[([\s\S]*?)(?:\])/);
    const assumptions=[];
    if(assM){let rx3=/"([^"]+)"/g,h2;while((h2=rx3.exec(assM[1]))!==null)assumptions.push(h2[1]);}
    if(wq&&rq){
      dk.add('cap');
      const el=document.getElementById('sk_cap');
      if(el){
        el.innerHTML=
          (assumptions.length?assumptions.map(a=>'<div style="font-size:11.5px;color:var(--ts);margin-bottom:3px">â€¢ '+a+'</div>').join(''):'') +
          '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">'+
          '<div style="flex:1;min-width:110px;background:var(--os);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">âœï¸ Write QPS</div><div style="font-size:12px;font-weight:700">'+wq+'</div></div>'+
          '<div style="flex:1;min-width:110px;background:var(--bs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ“– Read QPS</div><div style="font-size:12px;font-weight:700">'+rq+'</div></div>'+
          (st?'<div style="flex:1;min-width:110px;background:var(--gs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ’¾ Storage/yr</div><div style="font-size:12px;font-weight:700">'+st+'</div></div>':'')+
          '</div>';
        el.classList.add('fadein');
      }
    }
  }

  /* PRIORITY 5: thought_process â€” partial after 80 chars (~5-6s) */
  if(!dk.has('tp')){
    const v=strComplete('thought_process')||strPartial('thought_process',80);
    if(v&&v.length>40){dk.add('tp');slot('sk_tp',v.replace(/\n/g,'<br>'));}
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETON â€” shown instantly before any stream arrives
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSkeleton(){
  const a=document.getElementById('rarea');
  if(mode==='coding'){
    a.innerHTML=`<div style="padding-top:12px">
      <div class="iblock blue"><div class="blbl">ğŸ§  Approach</div><div id="sk_thought_process"><div class="skel" style="width:100%"></div><div class="skel" style="width:84%"></div><div class="skel" style="width:66%"></div></div></div>
      <div class="iblock green"><div class="blbl">ğŸ’¡ Analogy</div><div id="sk_analogy"><div class="skel" style="width:100%"></div><div class="skel" style="width:72%"></div></div></div>
      <div class="sumbox" id="sk_summary"><div class="skel" style="width:100%"></div><div class="skel" style="width:55%"></div></div>
      <div id="sk_complexity" style="font-size:12.5px;color:var(--ts);padding:2px 0 10px"><div class="skel" style="width:76%"></div><div class="skel" style="width:52%"></div></div>
      <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:6px 0">â³ Code & walkthrough loadingâ€¦</div></div>`;
  } else {
    a.innerHTML=`<div style="padding-top:12px">
      <!-- Problem statement arrives FIRST ~1-2s -->
      <div class="sumbox" id="sk_ps" style="min-height:52px"><div class="skel" style="width:100%"></div><div class="skel" style="width:68%"></div></div>

      <!-- FRs stream in ~2-3s -->
      <div class="sublbl">ğŸ”µ Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
      <div id="sk_fr"><div class="skel" style="width:90%"></div><div class="skel" style="width:76%"></div><div class="skel" style="width:83%"></div></div>

      <!-- NFRs stream in ~3-4s -->
      <div class="sublbl">â— Non-Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
      <div id="sk_nfr"><div class="skel" style="width:86%"></div><div class="skel" style="width:72%"></div><div class="skel" style="width:79%"></div></div>

      <!-- Capacity numbers stream in ~4-5s -->
      <div class="sublbl">ğŸ“Š Scale Assumptions & QPS</div>
      <div id="sk_cap" style="background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:11px 13px;margin-bottom:10px">
        <div class="skel" style="width:80%;margin-bottom:6px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
        </div>
      </div>

      <!-- Interview framing ~5-6s -->
      <div class="sublbl">ğŸ§  Interview Framing</div>
      <div class="iblock blue" id="sk_tp"><div class="skel" style="width:100%"></div><div class="skel" style="width:88%"></div><div class="skel" style="width:70%"></div><div class="skel" style="width:80%"></div></div>

      <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:10px 0">â³ Diagrams, components & deep dives loadingâ€¦</div></div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function codingPrompt(){
  const ctx={interview:'Crisp, confident. Anticipate follow-ups.',explain:'Conversational, real-world trade-offs.',beginner:'Simple language, vivid analogies.'}[depth];
  return `Elite Java coding coach. Context: ${ctx}
Return ONLY valid JSON starting with { :
{"summary":"confident one-liner","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences WHY","pattern":"algorithm pattern","approach":"core technique","thought_process":"4-5 sentences first-person: aha moment, why naive fails, why this clicks","analogy":"vivid 2-3 sentence real-world analogy","code":"complete clean well-commented Java â€” use meaningful variable names","steps":[{"title":"title","what":"1-2 sentences","how":"mechanics with backtick \`varName\`","why":"reasoning"}],"tricky_parts":[{"issue":"gotcha","explanation":"why tricky, exactly how handled"}],"followup_qa":[{"question":"realistic question","answer":"confident 3-4 sentence answer"}],"alternatives":[{"name":"approach","complexity":"T/S","when_to_use":"when to prefer","verdict":"better|tradeoff|worse"}]}
5-6 steps, 3 tricky_parts, 5 followup_qa, 3 alternatives.`;
}

function sdPrompt(){
  const lvl={
    senior:'Senior/Staff Engineer level â€” deep trade-offs, real numbers, justify EVERY decision.',
    mid:'Mid-level â€” clear architecture with solid reasoning on key trade-offs.',
    deep:'Thorough walkthrough â€” explain every component as if teaching a principal engineer.'
  }[depth]||'Senior/Staff Engineer level.';

  return `You are a principal engineer who has conducted 200+ FAANG system design interviews. You follow Evan King's Hello Interview framework EXACTLY. Your answers are the benchmark candidates are measured against.

LEVEL: ${lvl}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EVAN KING'S HELLO INTERVIEW FRAMEWORK â€” STRICT ORDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Step 1: Requirements (FRs + NFRs + capacity)
Step 2: Core Entities â€” nouns ONLY, no fields yet
Step 3: API Design â€” REST endpoints + real-time protocol
Step 4: High-Level Design â€” draw boxes and arrows, schema emerges HERE as you trace each request
Step 5: Deep Dives â€” harden specific NFRs

IMPORTANT on Entities vs Schema:
- Step 2 entities = NOUNS ONLY. "User, Tweet, Follow, Timeline". NO fields. Fields belong in HLD.
- Schema lives in step5_high_level_design, NOT in step2. You introduce fields only when you trace the write path through each service to the DB.
- This separation is deliberate â€” Evan King explicitly teaches it. Candidates who dump fields in step 2 waste time and lose signal on prioritization.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DIAGRAM RULES â€” CRITICAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Produce TWO diagrams. Diagram 2 MUST visibly EVOLVE from Diagram 1 â€” same core boxes, with new layers added on top.

DIAGRAM 1 â€” Baseline (satisfies core FRs only, simple monolith path):
Use this style. Every box must be drawn with â”Œâ”€â”â””â”€â”˜â”‚ box-drawing chars. Arrows must be â†“ or â†’ never plain dashes.

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Client  (Web / Mobile)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Load Balancer (Nginx)     â”‚  â€” horizontal scale, health checks
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  API Server                â”‚  â€” stateless, JWT auth
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ (write)   â†“ (read)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Primary DB  (PostgreSQL)                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DIAGRAM 2 â€” Production (evolves diagram 1, every NEW component labelled with WHY it was added):
- Keep the SAME core boxes from Diagram 1
- Add new layers above/below with a comment showing what NFR it satisfies
- Every component that has alternatives: show on same line in [brackets]
- Mark new additions with â˜… prefix so evolution is clear

Example evolution annotation style:
  â˜… CDN [CloudFront|Akamai|Fastly]   â† satisfies: p99 latency < 100ms for global users
  â˜… Kafka [RabbitMQ|SQS]             â† satisfies: async fan-out, decouples write latency
  â˜… Redis Cache [Memcached]          â† satisfies: read QPS 100k/s without DB overload

BOTH diagrams must be 100% accurate for the specific system â€” do NOT use Twitter/feed as a template for a URL shortener.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUALITY BAR â€” what separates Staff from Mid answers
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Never say "use a database". Say "PostgreSQL with a composite index on (user_id, created_at DESC) because our read pattern is always per-user ordered by time"
- Never say "add a cache". Say "Redis with write-through strategy, TTL 5 min, ~95% hit rate at 100K read QPS eliminates the need for read replicas in early stages"
- Never say "use a queue". Say "Kafka with 3 partitions keyed by user_id â€” gives us ordered fan-out per user and consumer group replay if the notification service crashes"
- Capacity numbers must drive decisions: "at 10K write QPS a single Postgres instance hits ~8K TPS limit â€” this is why we add read replicas"
- Always state the bottleneck and how you resolved it

Return ONLY valid JSON, starting with {, no markdown fences, no preamble:
{
  "problem_statement": "2-3 sentences: exactly what we are building, the core scale challenge, and the dominant technical constraint (read-heavy? write-heavy? consistency? latency?)",

  "thought_process": "5-6 sentences, first-person Staff engineer thinking out loud: 1) what makes this uniquely hard 2) the core trade-off (e.g. consistency vs availability) 3) read/write ratio and how it drives architecture 4) the one insight most candidates miss 5) your high-level approach",

  "clarifying_questions": [
    "DAU / MAU â€” sets scale tier (10M vs 500M changes every decision)",
    "one question scoping a key feature boundary",
    "one question surfacing the dominant trade-off (e.g. is eventual consistency acceptable?)"
  ],

  "step1_requirements": {
    "functional": [
      {"req": "Users should be able to [verb] [noun]", "priority": "core", "technical_implication": "specific architectural consequence â€” e.g. fan-out on write required, or requires low-latency read path"}
    ],
    "non_functional": [
      {"req": "System must achieve [measurable quality]", "value": "concrete number e.g. p99 write latency < 500ms", "tradeoff": "what we sacrifice â€” e.g. strong consistency traded for availability"},
      {"req": "System must handle [scale]", "value": "e.g. 100K read QPS at peak", "tradeoff": "cost of caching layer"},
      {"req": "System must be [reliability]", "value": "99.99% availability (< 52 min downtime/year)", "tradeoff": "complexity of multi-region failover"},
      {"req": "Data must be [durability]", "value": "no data loss on single node failure", "tradeoff": "replication overhead"}
    ],
    "out_of_scope": ["specific excluded feature â€” e.g. analytics/reporting dashboard", "another exclusion"],
    "capacity": {
      "assumptions": ["e.g. 100M DAU", "e.g. avg 2 writes/user/day", "e.g. avg 20 reads/user/day", "e.g. avg object size 1KB"],
      "write_qps": "~2,300/s (100M Ã— 2 / 86,400) â€” show the actual calc",
      "read_qps": "~23,000/s (100M Ã— 20 / 86,400) â€” 10:1 read/write ratio",
      "storage_per_year": "~72 TB/year (2,300 writes/s Ã— 1KB Ã— 31.5M seconds)",
      "design_impact": "Read/write ratio of 10:1 â†’ add read replicas and Redis cache. Storage of 72TB/yr â†’ consider object store for large blobs."
    }
  },

  "step2_core_entities": [
    {
      "name": "EntityName",
      "description": "what this noun represents â€” one sentence on its domain role",
      "note": "the non-obvious modeling insight â€” e.g. why this is a separate entity vs embedded, or why it is denormalized"
    }
  ],

  "step3_api_design": {
    "protocol_choice": "REST â€” default. One sentence why REST over gRPC/GraphQL for this specific system.",
    "realtime_protocol": {
      "needed": true,
      "chosen": "SSE | WebSocket | Long Polling | None",
      "reason": "specific reason matched to this system â€” e.g. SSE because updates are serverâ†’client only (notifications/feed), auto-reconnects, simpler than WS when client never sends",
      "where_in_arch": "exactly where it plugs in â€” e.g. Client keeps open SSE connection to Notification Service through API Gateway; fan-out worker pushes events to Redis Pub/Sub â†’ Notification Service â†’ client",
      "alternatives": [
        {"name": "WebSocket", "verdict": "tradeoff", "reason": "better for bi-directional (chat, collaborative editing); overhead not justified when client only receives"},
        {"name": "Long Polling", "verdict": "avoid", "reason": "reconnects every 30s, 100K concurrent users = 3.3K reconnects/sec hammering API Gateway â€” wasteful vs persistent SSE"},
        {"name": "Polling", "verdict": "avoid", "reason": "fixed interval polling at 100K users even at 30s interval = 3.3K req/s wasted on empty responses"}
      ]
    },
    "endpoints": [
      {
        "method": "POST|GET|PUT|DELETE",
        "path": "/v1/resource",
        "auth": "JWT Bearer â€” user_id derived from token, NEVER from request body",
        "request": "{ field: type, field2: type }",
        "response": "{ id: uuid, ...relevant fields, created_at: ISO8601 }",
        "note": "Rate limit: X req/min. Key design note â€” e.g. idempotency key required to prevent double-submit"
      }
    ]
  },

  "step4_data_flow": {
    "needed": true,
    "reason": "one sentence why the flow matters â€” e.g. fan-out complexity, async processing pipeline",
    "steps": [
      "1. Client â†’ POST /v1/[resource] with JWT Bearer token",
      "2. API Gateway validates JWT, applies rate limit (token bucket), routes to Write Service",
      "3. Write Service validates payload, writes to Primary DB (synchronous, durability guarantee)",
      "4. Write Service publishes event to Kafka topic (async, fire-and-forget after DB ack)",
      "5. Fan-out Worker consumes event, updates derived caches / search index / notification queue",
      "6. Read path: Client GET â†’ API GW â†’ Read Service â†’ Redis cache (hit ~95%) â†’ on miss: Read Replica â†’ cache back-fill"
    ]
  },

  "step5_high_level_design": {
    "diagram_simple": "Draw Diagram 1 here â€” baseline satisfying core FRs only. Use â”Œâ”€â”â””â”€â”˜â”‚â†“â†’ box-drawing. Show: Client â†’ Load Balancer â†’ API Server â†’ Primary DB. Label EVERY arrow with what flows (e.g. HTTP/REST, SQL query). Keep it to 6-8 boxes maximum. Make it specific to this system, not generic.",
    "diagram_simple_commentary": [
      {"component": "name of first key box", "say": "word-for-word what to say while drawing this â€” explain its role and why it's here"},
      {"component": "name of second key box", "say": "word-for-word what to say â€” include the specific trade-off this component introduces"},
      {"component": "Primary DB", "say": "word-for-word â€” name the specific DB, why it was chosen, and what the bottleneck will be at scale"}
    ],
    "diagram_scaled": "Draw Diagram 2 here â€” EVOLUTION of Diagram 1. Keep the same core boxes. Add new components with â˜… prefix and a comment showing which NFR each satisfies. Show write path (left side) and read path (right side) diverging from API Gateway. Use â”Œâ”€â”â””â”€â”˜â”‚â†“â†’ box-drawing. Label EVERY arrow. Show [Alt1|Alt2] on every component that has alternatives.",
    "diagram_scaled_commentary": [
      {"component": "â˜… first new component added", "say": "explain WHY this was added â€” connect it to the specific NFR it satisfies and the bottleneck it solves"},
      {"component": "â˜… second new component", "say": "explain the trade-off â€” what complexity it adds and why it's worth it at this scale"},
      {"component": "â˜… third new component", "say": "explain how it connects to the component before it in the flow"}
    ],
    "schema": [
      {
        "table": "TableName",
        "storage": "PostgreSQL | DynamoDB | Cassandra | Redis | S3",
        "why": "specific reason â€” e.g. relational model needed for foreign key constraints on user/tweet / wide-column for time-series append-only / key-value for O(1) session lookup",
        "key_fields": "id UUID PK, user_id UUID FK NOT NULL, content VARCHAR(280), status ENUM('active','deleted') DEFAULT 'active', created_at TIMESTAMPTZ DEFAULT NOW()",
        "key_indexes": "INDEX (user_id, created_at DESC) â€” feeds query pattern: SELECT ... WHERE user_id = ? ORDER BY created_at DESC LIMIT 20",
        "access_pattern": "99% of reads are: get timeline for user_id ordered by time â€” drives the index design"
      }
    ],
    "components": [
      {
        "name": "Component name matching diagram box exactly",
        "role": "Single responsibility â€” what this service owns and why it is isolated",
        "chosen_tech": "Specific technology e.g. Apache Kafka 3.5",
        "why_chosen": "Specific technical reason for THIS system â€” e.g. log-compaction gives us event replay when notification service crashes; partitioning by user_id gives ordering guarantees per user; consumer groups allow independent scaling of fan-out workers",
        "alternatives": [
          {"name": "Alt 1", "verdict": "tradeoff", "reason": "concrete pro and con vs chosen for this specific workload"},
          {"name": "Alt 2", "verdict": "tradeoff", "reason": "concrete pro and con"},
          {"name": "Alt 3", "verdict": "avoid", "reason": "why this would specifically fail for this system"}
        ]
      }
    ]
  },

  "step6_deep_dives": [
    {
      "topic": "Specific problem title â€” e.g. Fan-out for users with 50M followers",
      "nfr_addressed": "exact NFR from step1 this hardens",
      "why_hard": "why specifically hard at THIS scale â€” concrete numbers e.g. 50M followers Ã— 1 DB write = 50M synchronous writes = 21 seconds at 2.4M writes/sec Postgres limit",
      "naive_approach": "what a junior engineer implements and EXACTLY how it breaks â€” include numbers showing failure mode",
      "real_solution": "detailed solution with specific tech and algorithm â€” e.g. hybrid push/pull: push to Redis sorted set for users <10K followers async via Kafka; pull+merge at read time for celebrities from tweet store + follow graph",
      "numbers": "concrete numbers proving solution works â€” e.g. 10K followers Ã— 200 byte entry = 2MB Redis per active user; 1M active users Ã— 2MB = 2TB Redis cluster â€” fits in 32 Ã— 64GB nodes",
      "trade_offs": "explicit cost â€” e.g. celebrity followers see up to 500ms delay vs instant for regular users; adds read-time fan-out complexity"
    }
  ],

  "followup_qa": [
    {
      "question": "realistic follow-up an interviewer would ask for THIS specific system",
      "answer": "confident 3-4 sentence answer with specific technologies and numbers â€” no vague statements"
    }
  ],

  "speak_guide": {
    "opening_script": "word-for-word first 60 seconds â€” state the problem, ask 2 clarifying questions, state your approach",
    "key_insight": "the one non-obvious insight that separates a Staff answer â€” something most candidates get wrong",
    "common_mistakes": [
      "specific mistake on THIS problem and exactly what to say instead",
      "another common mistake"
    ],
    "closing_script": "how to close in last 2 minutes â€” what to summarize, what to proactively offer to go deeper on"
  }
}

Produce: exactly 3 FRs (max), 4 NFRs with measurable values, 3-5 entities (nouns only, no fields), 4-5 API endpoints, BOTH diagrams (diagram 2 visibly evolves from diagram 1 with â˜… markers), 3-4 schema tables, 4-6 components each with 3 alternatives, 3-4 deep dives with naive+real+numbers, 5 Q&As. Every answer must be specific to the exact system described â€” zero generic advice.`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ptabBar(pairs){let h='<div class="ptabs">';for(let i=0;i<pairs.length;i+=2)h+=`<div class="ptab${i===0?' on':''}" data-t="${pairs[i]}" onclick="switchP('${pairs[i]}')">${pairs[i+1]}</div>`;return h+'</div>';}
function switchP(id){document.querySelectorAll('.ptab').forEach(t=>t.classList.toggle('on',t.dataset.t===id));document.querySelectorAll('.ppanel').forEach(p=>p.classList.toggle('on',p.id==='pp_'+id));}
function toggleQA(el){el.classList.toggle('open');el.querySelector('.chev').classList.toggle('open');el.nextElementSibling.classList.toggle('open');}
function wireSubTabs(container){
  const tabs=[...container.querySelectorAll(':scope > .stab-row > .stab')];
  const panels=[...container.querySelectorAll(':scope > .spanel')];
  tabs.forEach((t,i)=>{t.onclick=()=>{tabs.forEach(x=>x.classList.remove('on'));panels.forEach(x=>x.classList.remove('on'));t.classList.add('on');panels[i]?.classList.add('on');};});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEAK MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSM(){
  if(!last)return;
  const{mode:m,data:d}=last;let h='';
  if(m==='coding'){
    h+=sc('ğŸ§  How I Approached It',d.thought_process);h+=sc('ğŸ¯ One-Liner',d.summary);h+=sc('ğŸ’¡ Analogy',d.analogy);
    h+=sc('ğŸ”‘ Key Steps',(d.steps||[]).map((s,i)=>(i+1)+'. '+s.title+' â€” '+s.why).join('\n'));
    h+=sc('âš¡ Complexity',d.complexity_explanation);
    h+=sc('âš ï¸ Gotchas',(d.tricky_parts||[]).map(t=>'â€¢ '+t.issue+': '+String(t.explanation).slice(0,140)).join('\n'));
  }else{
    const sg=d.speak_guide||{},r=d.step1_requirements||{};
    h+=sc('ğŸ¬ Opening (say this verbatim)',sg.opening_script||'');
    h+=sc('ğŸ’¡ The Key Insight',sg.key_insight||'');
    h+=sc('ğŸ“‹ Requirements to State',[...(r.functional||[]).map(f=>'ğŸ”µ '+f.req),'â”€',...(r.non_functional||[]).map(n=>'â— '+n.req+' ('+n.value+')')].join('\n'));
    h+=sc('ğŸ—ï¸ Architecture Flow',(d.step4_data_flow?.steps||[]).join('\n'));
    h+=sc('ğŸ”¬ Deep Dives to Hit',(d.step6_deep_dives||[]).map(dd=>'â€¢ '+dd.topic+': '+String(dd.real_solution).slice(0,130)).join('\n'));
    h+=sc('âš ï¸ Mistakes to Avoid',(sg.common_mistakes||[]).map(m=>'â€¢ '+m).join('\n'));
    h+=sc('ğŸ Closing (say this)',sg.closing_script||'');
  }
  document.getElementById('smc').innerHTML=h;document.getElementById('sovl').classList.add('on');
}
function closeSM(){document.getElementById('sovl').classList.remove('on');}
function sc(lbl,txt){return '<div class="sc"><div class="sc-lbl">'+lbl+'</div><div class="sc-txt">'+String(txt||'').replace(/\n/g,'<br>')+'</div></div>';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JAVA RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hl(code){
  const kw=['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','PriorityQueue','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h=code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h=h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h=h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k=>{h=h.replace(new RegExp('\\b('+k+')\\b','g'),'<span style="color:#569cd6">$1</span>');});
  return h;
}
const rx=t=>String(t||'').replace(/`([^`]+)`/g,'<code>$1</code>');
const eh=t=>String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function renderCoding(d){
  const a=document.getElementById('rarea');
  const stH=(d.steps||[]).map((s,i)=>`<div class="card fadein"><div class="card-head"><div class="cnum">${i+1}</div><div>${s.title}</div></div><div class="card-body">${rx(s.what)}<br><br>${rx(s.how)}</div><div class="card-sub">ğŸ’¡ Why: ${s.why}</div></div>`).join('');
  const trH=(d.tricky_parts||[]).map(t=>`<div class="iblock red fadein"><div class="blbl">âš ï¸ ${t.issue}</div>${rx(t.explanation)}</div>`).join('');
  const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${rx(q.answer)}</div></div>`).join('');
  const vl=v=>v==='better'?'âœ“ Better':v==='worse'?'âœ— Worse':'â‡„ Trade-off';
  const vc=v=>v==='better'?'bg':v==='worse'?'bo':'bb';
  const alH=(d.alternatives||[]).map(al=>`<div class="card fadein"><div class="card-head" style="justify-content:space-between"><span>${al.name} <small style="color:var(--ts);font-weight:400">${al.complexity}</small></span><span class="badge ${vc(al.verdict)}">${vl(al.verdict)}</span></div><div class="card-body">${al.when_to_use}</div></div>`).join('');
  a.innerHTML=
    ptabBar(['overview','Overview','code','Code','steps','Walkthrough','tricky','Gotchas','qa','Q&A','alts','Alternatives'])+
    `<div class="ppanel on" id="pp_overview">
      <div class="iblock blue fadein"><div class="blbl">ğŸ§  How I thought about this</div>${d.thought_process}</div>
      <div class="iblock green fadein"><div class="blbl">ğŸ’¡ Real-world analogy</div>${d.analogy}</div>
      <div class="sumbox fadein">${d.summary}</div>
      <div class="mrow"><span class="badge ba">${d.complexity}</span><span class="badge bb">${d.pattern}</span><span class="badge bg">${d.approach}</span></div>
      <div style="font-size:12.5px;line-height:1.7;color:var(--ts);padding:2px 0 14px">${d.complexity_explanation}</div>
      <button class="spk-btn fadein" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>
    <div class="ppanel" id="pp_code">
      <p style="font-size:11px;color:var(--ts);margin-bottom:9px">Lines wrap â€” scroll up/down only. No horizontal scroll.</p>
      <div class="code-outer fadein"><div class="code-hdr"><span class="code-lang">JAVA</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${hl(d.code)}</pre></div></div>
    </div>
    <div class="ppanel" id="pp_steps"><div>${stH}</div></div>
    <div class="ppanel" id="pp_tricky"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Knowing these signals thoroughness.</p>${trH}</div>
    <div class="ppanel" id="pp_qa"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Tap to reveal.</p>${qaH}</div>
    <div class="ppanel" id="pp_alts"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Mentioning trade-offs signals depth.</p>${alH}</div>`;
  a._rawCode=d.code;a.classList.add('on');
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SD RENDER â€” full final render replaces skeleton
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSD(d){
  const a=document.getElementById('rarea');
  const r=d.step1_requirements||{},api=d.step3_api_design||{},flow=d.step4_data_flow||{},hld=d.step5_high_level_design||{},dives=d.step6_deep_dives||[],sg=d.speak_guide||{};

  /* Requirements */
  const funcH=(r.functional||[]).map(f=>`<div class="hrow fadein"><strong>${f.priority==='core'?'ğŸ”µ':'âšª'} ${f.req}</strong>${f.technical_implication?'<br><span style="font-size:11.5px;color:var(--ts)">â†’ '+f.technical_implication+'</span>':''}</div>`).join('');
  const nfrH=(r.non_functional||[]).map(n=>`<div class="hrow fadein">â— <strong>${n.req}</strong> <span class="badge ba">${n.value}</span>${n.tradeoff?'<br><span style="font-size:11.5px;color:var(--ts)">Tradeoff: '+n.tradeoff+'</span>':''}</div>`).join('');
  const oosH=(r.out_of_scope||[]).map(o=>`<span class="pill">âœ— ${o}</span>`).join('');
  const cap=r.capacity||{};
  const capH=cap.write_qps?`
    <div class="iblock orange fadein"><div class="blbl">ğŸ“Œ Hello Interview</div>${r.capacity_note||'Only calculate if the number changes a design decision.'}</div>
    <div class="sublbl">Assumptions</div>${(cap.assumptions||[]).map(a=>'<div class="hrow fadein">'+a+'</div>').join('')}
    <div class="card fadein"><div class="card-body">
      <div style="margin-bottom:5px">âœï¸ <strong>Write QPS:</strong> ${cap.write_qps}</div>
      <div style="margin-bottom:5px">ğŸ“– <strong>Read QPS:</strong> ${cap.read_qps}</div>
      <div style="margin-bottom:5px">ğŸ’¾ <strong>Storage/year:</strong> ${cap.storage_per_year}</div>
      <div>ğŸ¯ <strong>Design impact:</strong> ${cap.design_impact||'â€”'}</div>
    </div></div>`:
    '<div class="iblock orange fadein"><div class="blbl">ğŸ“Œ Hello Interview</div>Skip capacity unless it changes a design decision. State this explicitly to the interviewer.</div>';

  /* Entities â€” nouns only per Evan King step 2. Schema in HLD step 5. */
  const entH=(d.step2_core_entities||[]).map(e=>`
    <div class="card fadein" style="margin-bottom:10px">
      <div class="card-head" style="font-size:14px;font-weight:700">${e.name}</div>
      <div class="card-body">${e.description}</div>
      ${e.note?`<div class="card-sub" style="margin-top:5px">ğŸ’¡ ${e.note}</div>`:''}
    </div>`).join('');

  /* Entities + Schema merged â€” one card per entity showing domain + storage + fields */
  const entSchemaH=(d.step2_core_entities||[]).map(e=>`
    <div class="card fadein" style="margin-bottom:13px">
      <div class="card-head" style="justify-content:space-between;align-items:flex-start">
        <span style="font-size:14px;font-weight:700">${e.name}</span>
        ${e.storage?`<span class="badge bp">${e.storage}</span>`:''}
      </div>
      <div class="card-body" style="margin-bottom:6px">${e.description}</div>
      ${e.note?`<div class="card-sub" style="margin-bottom:8px">ğŸ’¡ ${e.note}</div>`:''}
      ${e.key_fields?`
        <div style="font-size:10px;font-weight:700;color:var(--ts);letter-spacing:.06em;text-transform:uppercase;margin-bottom:4px">Key Fields</div>
        <div style="background:var(--cdbg);border-radius:8px;padding:9px 12px;font-family:'SF Mono',monospace;font-size:11px;line-height:1.85;color:var(--cdtx);word-break:break-word;margin-bottom:7px">${eh(e.key_fields)}</div>
      `:''}
      ${e.key_indexes?`<div style="font-size:11.5px;color:var(--ts);margin-bottom:4px">ğŸ”‘ <strong>Index:</strong> ${e.key_indexes}</div>`:''}
      ${e.relationships?`<div style="font-size:11.5px;color:var(--purple);margin-bottom:6px">ğŸ”— <strong>Relationships:</strong> ${e.relationships}</div>`:''}
      ${e.why_storage?`<div class="iblock green fadein" style="padding:8px 11px;margin-top:6px;margin-bottom:0"><div class="blbl">Why ${e.storage||'this store'}</div>${e.why_storage}</div>`:''}
    </div>`).join('');

  /* Realtime protocol */
  const rt=api.realtime_protocol||{};
  const rtH=rt.chosen?`
    <div class="tech-card fadein" style="border-color:rgba(45,95,160,.35);margin-bottom:14px">
      <div class="tech-top">
        <span class="tech-name">ğŸ”„ Real-time Protocol</span>
        <span class="chosen-tag">âœ“ ${rt.chosen}</span>
      </div>
      <div class="tech-role">${rt.reason||''}</div>
      ${rt.where_in_arch?`<div class="tech-why"><strong>Where it sits:</strong> ${rt.where_in_arch}</div>`:''}
      ${(rt.alternatives||[]).length?`<div class="alt-lbl">Alternatives</div>${(rt.alternatives||[]).map(a=>`
        <div class="alt-row">
          <span class="alt-name">${a.name}</span>
          <span class="av ${a.verdict==='avoid'?'av-avoid':a.verdict==='tradeoff'?'av-trade':'av-ok'}">${a.verdict==='avoid'?'âœ— Avoid':a.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span>
          <span class="alt-why">${a.reason}</span>
        </div>`).join('')}`:''}
    </div>`:'';

  /* API endpoints */
  const apiH=(api.endpoints||[]).map(ep=>`<div class="card fadein" style="margin-bottom:10px">
    <div class="card-head"><span class="badge bb" style="font-family:monospace;font-size:10px">${ep.method}</span> <code style="font-size:12.5px">${ep.path}</code></div>
    <div class="card-body">
      ${ep.auth?'<div style="margin-bottom:4px;font-size:11.5px;color:var(--ts)">ğŸ” '+ep.auth+'</div>':''}
      <strong>Request:</strong> <code>${ep.request||''}</code><br><strong>Response:</strong> <code>${ep.response||''}</code>
      ${ep.note?'<div style="margin-top:4px;font-size:11.5px;color:var(--ts)">'+ep.note+'</div>':''}
    </div></div>`).join('');

  /* Data flow */
  const flowH=flow.needed?`<div class="iblock blue fadein"><div class="blbl">Why data flow here</div>${flow.reason||''}</div>${(flow.steps||[]).map(s=>'<div class="hrow fadein">'+s+'</div>').join('')}`
    :'<div class="iblock green fadein"><div class="blbl">âœ“ Not needed</div>No meaningful processing pipeline here â€” per Hello Interview, skip to HLD for standard CRUD systems.</div>';

  /* Diagram commentary â€” "what to say" callouts per component */
  const commentaryH=arr=>{
    if(!arr||!arr.length)return '';
    return '<div class="sublbl" style="margin-top:10px">ğŸ—£ï¸ What to say while drawing</div>'+
      arr.map(c=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:8px 11px;background:var(--bs);border-radius:8px;margin-bottom:5px;border-left:3px solid var(--blue)">
        <div style="font-size:10px;font-weight:700;color:var(--blue);min-width:90px;padding-top:2px;flex-shrink:0">${c.component}</div>
        <div style="font-size:12.5px;line-height:1.6;color:var(--tp);font-style:italic">"${c.say}"</div>
      </div>`).join('');
  };

  /* TWO DIAGRAMS â€” syntax colouring: [alts]=amber, arrows=blue-grey */
  const colorizeDiag=raw=>{
    let s=eh(raw);
    s=s.replace(/\[([^\]<]+)\]/g,'<span style="color:#e8c060;font-weight:600">[$1]</span>');
    s=s.replace(/([â†’â†“â†â†‘]|â”€â”€â–º?|â”â”)/g,'<span style="color:#7aabcc">$1</span>');
    return s;
  };
  const diagSimple=hld.diagram_simple?`
    <div class="diag-wrap">
      <div class="diag-label">Diagram 1 â€” Baseline Design <span class="diag-pill">satisfies core FRs</span></div>
      <div class="diagram">${colorizeDiag(hld.diagram_simple)}</div>
      ${commentaryH(hld.diagram_simple_commentary)}
    </div>`:'';
  const diagScaled=hld.diagram_scaled?`
    <div class="diag-wrap">
      <div class="diag-label">Diagram 2 â€” Production Design <span class="diag-pill">satisfies NFRs</span> <span class="diag-pill" style="background:var(--os);color:var(--orange)">[amber] = alternatives</span></div>
      <div class="diagram">${colorizeDiag(hld.diagram_scaled)}</div>
      ${commentaryH(hld.diagram_scaled_commentary)}
    </div>`:'';

  /* Schema */
  const schemaH=(hld.schema||[]).map(t=>`<div class="card fadein" style="margin-bottom:10px">
    <div class="card-head">${t.table} <span class="badge bp" style="margin-left:6px">${t.storage}</span></div>
    <div class="card-body">
      <code style="font-size:11px;word-break:break-all;line-height:1.8">${t.key_fields}</code>
      <div class="card-sub">Why ${t.storage}: ${t.why}</div>
      ${t.key_indexes?'<div style="font-size:11.5px;color:var(--ts);margin-top:4px">ğŸ”‘ Index: '+t.key_indexes+'</div>':''}
    </div></div>`).join('');

  /* Components with inline alternatives */
  const compH=(hld.components||[]).map(c=>`
    <div class="tech-card fadein">
      <div class="tech-top"><span class="tech-name">${c.name}</span><span class="chosen-tag">âœ“ ${c.chosen_tech}</span></div>
      <div class="tech-role">${c.role}</div>
      <div class="tech-why"><strong>Why ${c.chosen_tech}:</strong> ${c.why_chosen}</div>
      ${c.alternatives&&c.alternatives.length?`<div class="alt-lbl">Alternatives â€” same line as diagram [brackets]</div>${c.alternatives.map(alt=>`
        <div class="alt-row">
          <span class="alt-name">${alt.name}</span>
          <span class="av ${alt.verdict==='avoid'?'av-avoid':alt.verdict==='tradeoff'?'av-trade':'av-ok'}">${alt.verdict==='avoid'?'âœ— Avoid':alt.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span>
          <span class="alt-why">${alt.reason}</span>
        </div>`).join('')}`:''}
    </div>`).join('');

  /* Deep dives */
  const deepH=dives.map(dd=>`<div class="card fadein" style="margin-bottom:13px">
    <div class="card-head">ğŸ”¬ ${dd.topic}</div>
    ${dd.nfr_addressed?`<div style="margin-bottom:6px"><span class="badge bb">Hardens: ${dd.nfr_addressed}</span></div>`:''}
    <div class="sublbl" style="margin-top:4px">Why It's Hard</div><div class="card-body">${dd.why_hard}</div>
    <div class="sublbl">âŒ Naive Approach & Why It Fails</div>
    <div class="iblock red fadein" style="margin-bottom:8px"><div class="blbl">Junior Engineer approach</div>${dd.naive_approach}</div>
    <div class="sublbl">âœ… The Real Solution</div><div class="card-body">${dd.real_solution}</div>
    ${dd.numbers?`<div class="iblock orange fadein" style="margin-top:8px;padding:8px 12px"><div class="blbl">ğŸ“Š Numbers</div>${dd.numbers}</div>`:''}
    <div class="card-warn" style="margin-top:6px">â‡„ Trade-off: ${dd.trade_offs}</div>
  </div>`).join('');

  /* Q&A */
  const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${q.answer}</div></div>`).join('');

  /* â•â• FULL RENDER â•â• */
  a.innerHTML=
    ptabBar(['overview','Overview','walkthrough','Design Walkthrough','deepdives','Deep Dives','qa','Q&A'])+

    `<div class="ppanel on" id="pp_overview">
      <div class="sumbox fadein">${d.problem_statement}</div>
      <div class="sublbl">Clarifying Questions to Ask First</div>
      ${(d.clarifying_questions||[]).map((q,i)=>'<div class="hrow fadein"><strong>Q'+(i+1)+':</strong> '+q+'</div>').join('')}
      <div class="sublbl">ğŸ”µ Core Functional Requirements</div>
      ${(r.functional||[]).map(f=>'<div class="hrow fadein"><strong>ğŸ”µ '+f.req+'</strong>'+(f.technical_implication?'<br><span style="font-size:11.5px;color:var(--ts)">â†’ '+f.technical_implication+'</span>':'')+'</div>').join('')}
      <div class="sublbl">â— Non-Functional Requirements</div>
      ${(r.non_functional||[]).map(n=>'<div class="hrow fadein">â— <strong>'+n.req+'</strong> <span class="badge ba">'+n.value+'</span>'+(n.tradeoff?'<br><span style="font-size:11.5px;color:var(--orange)">Tradeoff: '+n.tradeoff+'</span>':'')+'</div>').join('')}
      ${cap.write_qps?`<div class="sublbl">ğŸ“Š Scale</div><div style="background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:12px 14px;margin-bottom:10px">
        ${(cap.assumptions||[]).map(a=>'<div style="font-size:11.5px;color:var(--ts);margin-bottom:2px">â€¢ '+a+'</div>').join('')}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <div style="flex:1;min-width:110px;background:var(--os);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">âœï¸ Write QPS</div><div style="font-size:12px;font-weight:600">${cap.write_qps}</div></div>
          <div style="flex:1;min-width:110px;background:var(--bs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ“– Read QPS</div><div style="font-size:12px;font-weight:600">${cap.read_qps}</div></div>
          <div style="flex:1;min-width:110px;background:var(--gs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ’¾ Storage/yr</div><div style="font-size:12px;font-weight:600">${cap.storage_per_year}</div></div>
        </div>
        ${cap.design_impact?'<div style="font-size:11.5px;color:var(--tp);margin-top:8px;font-weight:600">ğŸ¯ '+cap.design_impact+'</div>':''}
      </div>`:''}
      <div class="iblock blue fadein" style="margin-top:4px"><div class="blbl">ğŸ§  How to frame this interview</div>${d.thought_process}</div>
      <button class="spk-btn fadein" style="margin-top:10px" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>

    <div class="ppanel" id="pp_walkthrough">
      <div class="stab-row">
        <div class="stab on"><span class="sn">1</span>Requirements<span class="step-t">~5m</span></div>
        <div class="stab"><span class="sn">2</span>Core Entities<span class="step-t">~2m</span></div>
        <div class="stab"><span class="sn">3</span>API & Protocol<span class="step-t">~5m</span></div>
        <div class="stab"><span class="sn">4</span>Data Flow<span class="step-t">opt</span></div>
        <div class="stab"><span class="sn">5</span>HLD + Diagrams<span class="step-t">~15m</span></div>
      </div>

      <div class="spanel on">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Hello Interview</div>FRs: "Users should be able toâ€¦" â€” max 3, prioritized. NFRs: always include specific numbers (p99 latency, QPS, availability %). Capacity: calculate only if the number changes a design decision â€” state this explicitly.</div>
        <div class="sublbl">ğŸ”µ Functional Requirements</div>${funcH}
        <div class="sublbl">â— Non-Functional Requirements</div>${nfrH}
        <div class="sublbl">âœ— Out of Scope</div><div class="pill-row">${oosH}</div>
        <div class="sublbl">ğŸ“Š Assumptions & Capacity</div>${capH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Hello Interview</div>Step 2 = NOUNS ONLY. No fields yet. List the core domain objects your API will exchange and your system will persist. Fields emerge in HLD (step 5) as you trace each request to the DB. Candidates who dump schema here waste 3-5 minutes and lose the prioritization signal.</div>
        ${entH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>State the real-time protocol upfront â€” it's a design decision that affects the architecture. Then cover REST endpoints: plural nouns, user_id always from JWT.</div>
        ${rtH}
        <div class="sublbl">REST Endpoints <span style="font-size:9px;font-weight:400;color:var(--ts)"> â€” ${api.protocol_choice||'REST'}</span></div>
        ${apiH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Optional â€” only for pipeline/data systems. Skip for standard CRUD products.</div>
        ${flowH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Draw Diagram 1 first, narrate each box as you draw it. Then evolve to Diagram 2, explaining each new component you add. Use the commentary below each diagram as your speaking script.</div>
        ${diagSimple}${diagScaled}
        <div class="sublbl" style="margin-top:14px">Component Decisions <span style="font-size:9.5px;font-weight:400;color:var(--ts)">â€” match [amber brackets] in Diagram 2</span></div>
        <p style="font-size:11px;color:var(--ts);margin-bottom:10px;line-height:1.5">Each card explains the choice and shows alternatives with specific trade-offs inline.</p>
        ${compH}
      </div>
    </div>

    <div class="ppanel" id="pp_deepdives">
      <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>~10 min. Lead proactively for senior roles. Always naive approach first â€” it shows you understand WHY it's hard. Each dive hardens a specific NFR.</div>
      ${deepH}
    </div>

    <div class="ppanel" id="pp_qa">
      <p style="font-size:11.5px;color:var(--ts);margin-bottom:12px">Tap to reveal a confident answer.</p>${qaH}
    </div>`;

  a.classList.add('on');
  wireSubTabs(document.querySelector('#pp_walkthrough'));
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

function copyCode(btn){const a=document.getElementById('rarea');navigator.clipboard.writeText(a._rawCode||'').then(()=>{btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500);});}
document.getElementById('tbox').addEventListener('input',chkBtn);
</script>
</body>
</html>
