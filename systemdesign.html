<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg:#faf9f7; --sf:#ffffff; --br:#e8e5e0;
  --tp:#1a1916; --ts:#7a7670;
  --ac:#c8a96e; --as:#f5f0e8;
  --cdbg:#1a1917; --cdtx:#e8e4dc;
  --green:#3d7a52; --blue:#2d5fa0; --red:#8a3a3a; --purple:#6040a0; --orange:#b06020;
  --gs:#eaf3ee; --bs:#e8f0fb; --rs:#faeaea; --ps:#f2edfb; --os:#fdf0e4;
}
body { font-family:-apple-system,sans-serif; background:var(--bg); color:var(--tp); min-height:100vh; max-width:720px; margin:0 auto; padding:0 0 80px; }

/* â”€â”€ LIST â”€â”€ */
.app-header { padding:52px 24px 14px; border-bottom:1px solid var(--br); position:sticky; top:0; z-index:100; backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); background:rgba(250,249,247,.93); }
.app-title { font-size:28px; font-weight:700; letter-spacing:-.5px; }
.note-count { font-size:13px; color:var(--ts); margin-top:3px; }
.note-row { padding:16px 24px; border-bottom:1px solid var(--br); display:flex; gap:14px; align-items:flex-start; cursor:pointer; width:100%; background:none; border-left:none; border-right:none; border-top:none; text-align:left; }
.note-row:active { background:var(--as); }
.note-icon { width:40px; height:40px; border-radius:10px; background:var(--as); display:flex; align-items:center; justify-content:center; flex-shrink:0; font-size:20px; }
.note-preview { flex:1; min-width:0; }
.note-title { font-size:15px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--tp); }
.note-snippet { font-size:13px; color:var(--ts); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
.note-date { font-size:12px; color:var(--ts); flex-shrink:0; margin-top:2px; }

/* â”€â”€ DETAIL â”€â”€ */
.note-detail { display:none; min-height:100vh; }
.note-detail.open { display:block; }
.detail-header { padding:13px 18px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--br); position:sticky; top:0; background:rgba(250,249,247,.96); backdrop-filter:blur(20px); z-index:10; }
.back-btn { color:var(--ac); font-size:17px; font-weight:600; border:none; background:none; padding:6px 4px; min-width:56px; cursor:pointer; }
.detail-title { flex:1; font-size:14px; font-weight:600; text-align:center; }
.gear-btn { font-size:20px; border:none; background:none; padding:6px; min-width:40px; color:var(--ac); cursor:pointer; }

/* â”€â”€ SETUP â”€â”€ */
.setup-box { margin:12px 20px; padding:14px; background:var(--as); border:1px solid rgba(200,169,110,.3); border-radius:12px; }
.setup-box input { width:100%; padding:9px 11px; border:1px solid var(--br); border-radius:8px; font-size:13px; font-family:monospace; background:#fff; color:var(--tp); outline:none; margin-bottom:7px; -webkit-appearance:none; }
.setup-box button { width:100%; padding:9px; background:var(--tp); color:#fff; border:none; border-radius:7px; font-size:13px; font-weight:600; cursor:pointer; }
.setup-lbl { font-size:12px; font-weight:600; margin-bottom:5px; }
.setup-desc { font-size:11px; color:var(--ts); margin-bottom:8px; line-height:1.5; }

/* â”€â”€ MODE â”€â”€ */
.mode-row { display:flex; margin:12px 20px 8px; background:var(--br); border-radius:11px; padding:3px; gap:2px; }
.mode-btn { flex:1; padding:8px 6px; border-radius:8px; border:none; font-size:11.5px; font-weight:700; cursor:pointer; transition:all .18s; background:none; color:var(--ts); }
.mode-btn.on { background:var(--sf); color:var(--tp); box-shadow:0 1px 4px rgba(0,0,0,.12); }

/* â”€â”€ VOICE â”€â”€ */
.voice-wrap { margin:0 20px 6px; background:var(--sf); border:1px solid var(--br); border-radius:14px; overflow:hidden; }
.voice-top { padding:10px 14px 8px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--br); }
.vlbl { font-size:10px; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--ts); }
.vtimer { font-size:12px; color:var(--ts); font-variant-numeric:tabular-nums; }
.mic-wrap { display:flex; justify-content:center; padding:16px 0 4px; }
.mic-btn { width:68px; height:68px; border-radius:50%; background:var(--as); border:2px solid rgba(200,169,110,.4); font-size:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; user-select:none; }
.mic-btn:active { transform:scale(.92); }
.mic-btn.on { background:#fff0f0; border-color:rgba(200,60,60,.5); animation:mPulse 1s ease-in-out infinite; }
@keyframes mPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
.waveform { display:none; align-items:flex-end; justify-content:center; gap:3px; height:26px; margin:3px auto 0; width:100px; }
.waveform.on { display:flex; }
.wb { width:4px; border-radius:2px; background:var(--ac); animation:wv .9s infinite ease-in-out; }
.wb:nth-child(1){animation-delay:0s}.wb:nth-child(2){animation-delay:.1s}.wb:nth-child(3){animation-delay:.2s}.wb:nth-child(4){animation-delay:.3s}.wb:nth-child(5){animation-delay:.2s}.wb:nth-child(6){animation-delay:.1s}.wb:nth-child(7){animation-delay:0s}
@keyframes wv { 0%,100%{height:4px;opacity:.4} 50%{height:22px;opacity:1} }
.vstatus { text-align:center; font-size:12.5px; color:var(--ts); padding:5px 14px 3px; font-style:italic; min-height:24px; }
.vstatus.on { color:#c0392b; font-style:normal; font-weight:500; }
.tbox { margin:7px 14px 11px; padding:10px 12px; background:var(--bg); border:1px solid var(--br); border-radius:9px; font-size:14px; line-height:1.65; color:var(--tp); min-height:48px; outline:none; -webkit-user-select:text; user-select:text; }
.tbox:empty::before { content:attr(data-ph); color:var(--ts); font-style:italic; }
.vactions { display:flex; gap:8px; padding:0 14px 14px; }
.btn-cl { flex:1; padding:10px; border-radius:8px; font-size:13px; font-weight:600; border:1.5px solid var(--br); background:var(--bg); color:var(--ts); cursor:pointer; }
.btn-go { flex:2; padding:10px; border-radius:8px; font-size:13px; font-weight:700; border:none; background:var(--tp); color:#fff; cursor:pointer; }
.btn-go:disabled { opacity:.35; cursor:not-allowed; }

/* â”€â”€ CHIPS â”€â”€ */
.chips { display:flex; gap:7px; padding:8px 20px 10px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
.chips::-webkit-scrollbar { display:none; }
.chip { padding:6px 13px; border-radius:20px; font-size:11.5px; font-weight:600; border:1.5px solid var(--br); background:var(--sf); color:var(--ts); cursor:pointer; white-space:nowrap; flex-shrink:0; }
.chip.on { background:var(--tp); color:#fff; border-color:var(--tp); }

/* â”€â”€ STREAM BAR â”€â”€ */
.sprog { display:none; margin:0 20px 2px; height:2px; background:var(--br); border-radius:2px; overflow:hidden; }
.sprog.on { display:block; }
.sbar { height:100%; background:linear-gradient(90deg,var(--ac),#e8c878); border-radius:2px; width:0%; transition:width .5s ease; }

/* â”€â”€ THINKING â”€â”€ */
.thinking { display:none; padding:14px 20px; align-items:center; gap:10px; }
.thinking.on { display:flex; }
.dots { display:flex; gap:4px; }
.dot { width:6px; height:6px; border-radius:50%; background:var(--ac); animation:pulse 1.2s infinite; }
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes pulse { 0%,80%,100%{transform:scale(1);opacity:.5} 40%{transform:scale(1.3);opacity:1} }
.ttext { font-size:12.5px; color:var(--ts); font-style:italic; }

/* â”€â”€ RESPONSE â”€â”€ */
.rarea { padding:0 20px 40px; display:none; }
.rarea.on { display:block; }

/* â”€â”€ PRIMARY TABS â”€â”€ */
.ptabs { display:flex; border-bottom:1px solid var(--br); margin:0 -20px; padding:0 10px; overflow-x:auto; margin-top:14px; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
.ptabs::-webkit-scrollbar { display:none; }
.ptab { padding:9px 11px; font-size:11.5px; font-weight:700; color:var(--ts); cursor:pointer; border-bottom:2.5px solid transparent; white-space:nowrap; flex-shrink:0; }
.ptab.on { color:var(--tp); border-bottom-color:var(--ac); }
.ppanel { display:none; padding-top:14px; }
.ppanel.on { display:block; }

/* â”€â”€ SUB-TABS (Hello Interview steps) â”€â”€ */
.stab-row { display:flex; margin:10px -20px 0; padding:0; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; background:var(--sf); border-bottom:1px solid var(--br); }
.stab-row::-webkit-scrollbar { display:none; }
.stab { padding:8px 11px; font-size:10.5px; font-weight:700; color:var(--ts); cursor:pointer; border-bottom:2.5px solid transparent; white-space:nowrap; flex-shrink:0; letter-spacing:.01em; }
.stab.on { color:var(--blue); border-bottom-color:var(--blue); }

/* Step number badge inside sub-tab label */
.stab .sn { display:inline-flex; align-items:center; justify-content:center; width:15px; height:15px; border-radius:50%; background:var(--br); color:var(--ts); font-size:9px; font-weight:800; margin-right:4px; }
.stab.on .sn { background:var(--blue); color:#fff; }

.spanel { display:none; padding-top:12px; }
.spanel.on { display:block; }

/* â”€â”€ CONTENT BLOCKS â”€â”€ */
.iblock { border-radius:0 10px 10px 0; padding:13px 15px; font-size:13.5px; line-height:1.75; margin-bottom:11px; }
.iblock.blue { background:var(--bs); border-left:3px solid var(--blue); }
.iblock.green { background:var(--gs); border-left:3px solid var(--green); }
.iblock.red { background:var(--rs); border-left:3px solid var(--red); }
.iblock.purple { background:var(--ps); border-left:3px solid var(--purple); }
.iblock.orange { background:var(--os); border-left:3px solid var(--orange); }
.blbl { font-size:10px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; margin-bottom:5px; }
.iblock.blue .blbl { color:var(--blue); }
.iblock.green .blbl { color:var(--green); }
.iblock.red .blbl { color:var(--red); }
.iblock.purple .blbl { color:var(--purple); }
.iblock.orange .blbl { color:var(--orange); }

.sumbox { background:var(--as); border:1px solid rgba(200,169,110,.3); border-radius:10px; padding:14px; font-size:14px; line-height:1.7; margin-bottom:12px; }
.mrow { display:flex; gap:7px; flex-wrap:wrap; margin-bottom:12px; }
.badge { font-size:10.5px; padding:3px 9px; border-radius:20px; font-weight:600; }
.bb { background:var(--bs); color:var(--blue); border:1px solid rgba(45,95,160,.2); }
.bg { background:var(--gs); color:var(--green); border:1px solid rgba(61,122,82,.2); }
.ba { background:var(--as); color:var(--ac); border:1px solid rgba(200,169,110,.3); }
.bp { background:var(--ps); color:var(--purple); border:1px solid rgba(96,64,160,.2); }
.bo { background:var(--os); color:var(--orange); border:1px solid rgba(176,96,32,.2); }

.sublbl { font-size:10px; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--ts); margin:16px 0 7px; }
.hrow { background:var(--as); border:1px solid rgba(200,169,110,.22); border-radius:8px; padding:9px 13px; margin-bottom:7px; font-size:13px; line-height:1.6; }
.pill-row { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px; }
.pill { font-size:11.5px; padding:3px 11px; border-radius:20px; border:1px solid var(--br); background:var(--sf); color:var(--tp); font-weight:500; }
.divider { height:1px; background:var(--br); margin:14px 0; }

/* â”€â”€ CARD â”€â”€ */
.card { background:var(--sf); border:1px solid var(--br); border-radius:10px; padding:13px; margin-bottom:9px; }
.card-head { font-size:13px; font-weight:700; margin-bottom:4px; display:flex; align-items:flex-start; gap:8px; }
.cnum { width:22px; height:22px; border-radius:50%; background:var(--ac); color:#fff; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:1px; }
.card-body { font-size:12.5px; line-height:1.65; }
.card-body code { font-family:monospace; font-size:11px; background:var(--as); padding:1px 4px; border-radius:3px; }
.card-sub { font-size:11.5px; color:var(--blue); margin-top:5px; font-style:italic; }
.card-warn { font-size:11.5px; color:var(--red); margin-top:5px; }

/* â”€â”€ TECH CARD (component + inline alternatives) â”€â”€ */
.tech-card { background:var(--sf); border:1px solid var(--br); border-radius:10px; padding:13px; margin-bottom:10px; }
.tech-top { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
.tech-name { font-size:13.5px; font-weight:700; }
.chosen-tag { font-size:10px; padding:2px 8px; border-radius:8px; font-weight:700; background:var(--gs); color:var(--green); }
.tech-role { font-size:12.5px; line-height:1.6; color:var(--tp); margin-bottom:4px; }
.tech-why { font-size:12px; line-height:1.6; color:var(--ts); margin-bottom:8px; }
.alt-lbl { font-size:9.5px; font-weight:700; letter-spacing:.07em; text-transform:uppercase; color:var(--ts); margin-bottom:5px; }
.alt-row { display:flex; align-items:flex-start; gap:7px; padding:6px 9px; background:var(--bg); border-radius:7px; margin-bottom:4px; border:1px solid var(--br); }
.alt-name { font-size:12px; font-weight:600; flex-shrink:0; min-width:90px; }
.av { font-size:9.5px; padding:2px 7px; border-radius:7px; font-weight:700; flex-shrink:0; white-space:nowrap; }
.av-ok { background:var(--bs); color:var(--blue); }
.av-trade { background:var(--os); color:var(--orange); }
.av-avoid { background:var(--rs); color:var(--red); }
.alt-why { font-size:11.5px; color:var(--ts); line-height:1.5; }

/* â”€â”€ CODE (pre-wrap so no horizontal scroll) â”€â”€ */
.code-outer { background:var(--cdbg); border-radius:12px; overflow:hidden; margin-bottom:10px; }
.code-hdr { padding:9px 14px; display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,.05); border-bottom:1px solid rgba(255,255,255,.08); }
.code-lang { font-size:10px; color:#8a8580; font-family:monospace; letter-spacing:.05em; }
.copy-btn { font-size:11px; color:var(--ac); background:none; border:none; cursor:pointer; padding:3px 8px; border-radius:4px; font-weight:500; }
.code-body { padding:14px; }
.code-body pre { font-family:'SF Mono',monospace; font-size:12px; line-height:1.7; color:var(--cdtx); white-space:pre-wrap; word-break:break-word; }

/* â”€â”€ Q&A â”€â”€ */
.qa-item { border:1px solid var(--br); border-radius:10px; overflow:hidden; margin-bottom:9px; }
.qa-q { padding:12px 14px; font-size:13px; font-weight:600; background:var(--sf); cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
.chev { color:var(--ts); transition:transform .2s; font-size:13px; flex-shrink:0; }
.chev.open { transform:rotate(90deg); }
.qa-a { display:none; padding:11px 14px; font-size:12.5px; line-height:1.7; background:var(--bg); border-top:1px solid var(--br); }
.qa-a.open { display:block; }

/* â”€â”€ DIAGRAM â”€â”€ */
.diagram { background:var(--cdbg); border-radius:12px; padding:16px; margin-bottom:11px; font-family:'SF Mono',monospace; font-size:11.5px; line-height:1.85; color:#c8c4bc; white-space:pre-wrap; overflow-x:auto; }

/* â”€â”€ SKELETON â”€â”€ */
.skel { background:linear-gradient(90deg,var(--br) 25%,var(--as) 50%,var(--br) 75%); background-size:200% 100%; animation:sk 1.2s infinite; border-radius:5px; height:13px; margin-bottom:7px; }
@keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* â”€â”€ SPEAK MODE â”€â”€ */
#sovl { display:none; position:fixed; inset:0; background:rgba(12,11,10,.97); z-index:999; flex-direction:column; padding:60px 22px 40px; overflow-y:auto; -webkit-overflow-scrolling:touch; }
#sovl.on { display:flex; }
.sovl-close { position:fixed; top:16px; right:18px; color:var(--ac); font-size:26px; cursor:pointer; background:none; border:none; z-index:1000; padding:8px; }
.sovl-title { font-size:10px; font-weight:700; letter-spacing:.14em; text-transform:uppercase; color:var(--ac); margin-bottom:18px; }
.sc { background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.09); border-radius:13px; padding:16px 18px; margin-bottom:13px; }
.sc-lbl { font-size:9px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--ac); margin-bottom:8px; }
.sc-txt { font-size:15px; line-height:1.9; color:#ede9e2; }

.spk-btn { width:100%; padding:12px; background:var(--as); border:1.5px solid rgba(200,169,110,.4); border-radius:9px; font-size:13px; font-weight:600; color:var(--tp); cursor:pointer; margin-top:4px; }
.err-box { background:#fff0f0; border:1px solid #ffcccc; border-radius:9px; padding:13px 15px; font-size:13px; color:#c0392b; margin-top:10px; }
.fadein { animation:fadeIn .35s ease forwards; }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.toast { position:fixed; bottom:36px; left:50%; transform:translateX(-50%); background:#1a1916; color:#fff; padding:8px 20px; border-radius:20px; font-size:13px; z-index:9999; opacity:0; transition:opacity .25s; white-space:nowrap; pointer-events:none; }

/* Step timing badge */
.step-timing { display:inline-block; font-size:9px; font-weight:600; color:var(--ts); background:var(--br); border-radius:6px; padding:1px 6px; margin-left:6px; vertical-align:middle; }
</style>
</head>
<body>

<!-- LIST -->
<div id="list">
  <div class="app-header">
    <div class="app-title">Notes</div>
    <div class="note-count">4 notes</div>
  </div>
  <div style="padding:6px 0">
    <button class="note-row" onclick="openTool('coding')">
      <div class="note-icon">â˜•</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ Java</div><div class="note-snippet">Tap to solve a coding problemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="openTool('sd')">
      <div class="note-icon">ğŸ—ï¸</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ System Design</div><div class="note-snippet">Tap to design a systemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“‹</div>
      <div class="note-preview"><div class="note-title">Meeting notes â€“ Product sync</div><div class="note-snippet">Roadmap priorities, Q2 milestones</div></div>
      <div class="note-date">Mon</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“</div>
      <div class="note-preview"><div class="note-title">Grocery list</div><div class="note-snippet">Eggs, bread, olive oil, tomatoesâ€¦</div></div>
      <div class="note-date">Sun</div>
    </button>
  </div>
</div>

<!-- TOOL -->
<div id="tool" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">â€¹ Notes</button>
    <div class="detail-title" id="dtitle">Quick Ref</div>
    <button class="gear-btn" onclick="toggleSetup()">âš™ï¸</button>
  </div>

  <div id="setup" class="setup-box" style="display:none;margin-top:12px">
    <div class="setup-lbl">ğŸ”‘ API Key</div>
    <div class="setup-desc">Stored locally only â€” never sent anywhere except Anthropic.</div>
    <input type="password" id="apikey" placeholder="sk-ant-â€¦" autocomplete="off"/>
    <button onclick="saveKey()">Save & Close</button>
  </div>

  <div class="mode-row">
    <button class="mode-btn on" id="mCoding" onclick="setMode('coding')">â˜• Java Coding</button>
    <button class="mode-btn" id="mSD" onclick="setMode('sd')">ğŸ—ï¸ System Design</button>
  </div>

  <div class="voice-wrap">
    <div class="voice-top">
      <span class="vlbl" id="vlbl">ğŸ™ Speak your coding problem</span>
      <span class="vtimer" id="vtimer"></span>
    </div>
    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ™ï¸</button>
    </div>
    <div class="waveform" id="wf">
      <div class="wb" style="height:5px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:25px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:5px"></div>
    </div>
    <div class="vstatus" id="vs">Tap the mic and speak clearly</div>
    <div class="tbox" id="tbox" contenteditable="true" spellcheck="false" data-ph="Tap mic to speakâ€¦"></div>
    <div class="vactions">
      <button class="btn-cl" onclick="clearAll()">Clear</button>
      <button class="btn-go" id="goBtn" onclick="generate()" disabled>Generate âš¡</button>
    </div>
  </div>

  <div class="chips" id="chips">
    <div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
    <div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
    <div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>
  </div>

  <div class="sprog" id="sprog"><div class="sbar" id="sbar"></div></div>
  <div class="thinking" id="thinking"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div class="ttext" id="ttext">Thinkingâ€¦</div></div>
  <div class="rarea" id="rarea"></div>
</div>

<!-- SPEAK MODE -->
<div id="sovl">
  <button class="sovl-close" onclick="closeSM()">âœ•</button>
  <div class="sovl-title">ğŸ“¢ How to Explain This</div>
  <div id="smc"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SK = 'nt_v5';
let mode='coding', depth='interview', last=null;
let rec=null, listening=false, silT=null, timerI=null, elapsed=0, accTxt='';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KEY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getKey = () => localStorage.getItem(SK)||'';
function saveKey() {
  const v=document.getElementById('apikey').value.trim();
  if(!v){toast('Enter a key');return;}
  localStorage.setItem(SK,v);
  document.getElementById('setup').style.display='none';
  toast('Saved âœ“');
}
function toggleSetup() {
  const s=document.getElementById('setup');
  const show=s.style.display==='none';
  s.style.display=show?'block':'none';
  if(show&&getKey()) document.getElementById('apikey').value=getKey();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openTool(m) {
  document.getElementById('list').style.display='none';
  document.getElementById('tool').classList.add('open');
  setMode(m);
  if(!getKey()) document.getElementById('setup').style.display='block';
}
function goBack() {
  stopMic(false);
  document.getElementById('tool').classList.remove('open');
  document.getElementById('list').style.display='block';
  clearAll(); last=null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setMode(m) {
  mode=m;
  document.getElementById('mCoding').classList.toggle('on',m==='coding');
  document.getElementById('mSD').classList.toggle('on',m==='sd');
  document.getElementById('dtitle').textContent=m==='coding'?'Java Coding':'System Design';
  document.getElementById('vlbl').textContent=m==='coding'?'ğŸ™ Speak your coding problem':'ğŸ™ Describe the system to design';
  document.getElementById('tbox').setAttribute('data-ph',m==='coding'?'Tap mic to speak your problemâ€¦':'e.g. "Design Twitter" or "Design a URL shortener"');
  const ch=document.getElementById('chips');
  if(m==='sd'){
    ch.innerHTML=`<div class="chip on" data-d="senior" onclick="setDepth(this)">ğŸ¯ Senior/Staff</div><div class="chip" data-d="mid" onclick="setDepth(this)">ğŸ‘¨â€ğŸ’» Mid-level</div><div class="chip" data-d="deep" onclick="setDepth(this)">ğŸ“– Deep Dive</div>`;
    depth='senior';
  } else {
    ch.innerHTML=`<div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div><div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div><div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>`;
    depth='interview';
  }
  clearAll();
}
function setDepth(el){
  el.closest('.chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on'); depth=el.dataset.d;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST / TIMER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2400);}
function startTimer(){elapsed=0;clearInterval(timerI);timerI=setInterval(()=>{elapsed++;document.getElementById('vtimer').textContent=pad(Math.floor(elapsed/60))+':'+pad(elapsed%60);},1000);}
function stopTimer(){clearInterval(timerI);document.getElementById('vtimer').textContent='';}
const pad=n=>String(n).padStart(2,'0');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MIC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleMic(){listening?stopMic(true):startMic();}
function startMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('Voice not supported â€” type instead');return;}
  accTxt=document.getElementById('tbox').textContent.trim();
  rec=new SR(); rec.continuous=true; rec.interimResults=true; rec.lang='en-US';
  rec.onstart=()=>{
    listening=true;
    document.getElementById('micBtn').classList.add('on');
    document.getElementById('micBtn').textContent='â¹ï¸';
    document.getElementById('wf').classList.add('on');
    document.getElementById('vs').textContent='Listeningâ€¦ speak clearly';
    document.getElementById('vs').classList.add('on');
    startTimer();
  };
  rec.onresult=e=>{
    clearTimeout(silT); silT=setTimeout(()=>stopMic(true),2800);
    let fin=accTxt?accTxt+' ':'', int='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const t=e.results[i][0].transcript;
      e.results[i].isFinal?(fin+=t,accTxt=fin.trim()):int=t;
    }
    document.getElementById('tbox').textContent=(accTxt+(int?' '+int:'')).trim();
    chkBtn();
  };
  rec.onerror=e=>{if(e.error==='not-allowed')toast('Mic blocked â€” allow in Safari settings');stopMic(false);};
  rec.onend=()=>{if(listening){try{rec.start();}catch(e){stopMic(false);}}};
  try{rec.start();}catch(e){toast('Cannot start mic');}
}
function stopMic(auto){
  const was=listening; listening=false; clearTimeout(silT); stopTimer();
  if(rec){try{rec.stop();}catch(e){} rec=null;}
  document.getElementById('micBtn').classList.remove('on');
  document.getElementById('micBtn').textContent='ğŸ™ï¸';
  document.getElementById('wf').classList.remove('on');
  document.getElementById('vs').classList.remove('on');
  const txt=document.getElementById('tbox').textContent.trim();
  if(was&&auto&&txt.length>5){document.getElementById('vs').textContent='Got it â€” generatingâ€¦';setTimeout(generate,500);}
  else{document.getElementById('vs').textContent=txt.length>5?'Ready â€” tap Generate':'Tap the mic and speak clearly';}
}
function chkBtn(){document.getElementById('goBtn').disabled=document.getElementById('tbox').textContent.trim().length<5;}
function clearAll(){
  accTxt='';
  document.getElementById('tbox').textContent='';
  document.getElementById('goBtn').disabled=true;
  document.getElementById('vs').textContent='Tap the mic and speak clearly';
  document.getElementById('rarea').innerHTML='';
  document.getElementById('rarea').classList.remove('on');
  document.getElementById('thinking').classList.remove('on');
  document.getElementById('sprog').classList.remove('on');
  document.getElementById('sbar').style.width='0%';
  last=null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GENERATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generate(){
  const prob=document.getElementById('tbox').textContent.trim();
  if(prob.length<4){toast('Say or type a problem first');return;}
  const key=getKey(); if(!key){toggleSetup();toast('Add API key first');return;}
  document.getElementById('goBtn').disabled=true;
  document.getElementById('rarea').innerHTML='';
  document.getElementById('rarea').classList.remove('on');
  document.getElementById('thinking').classList.add('on');
  document.getElementById('ttext').textContent=mode==='coding'?'Solving your problemâ€¦':'Architecting your systemâ€¦';
  document.getElementById('sprog').classList.add('on');
  const bar=document.getElementById('sbar'); bar.style.width='6%';
  const sys=mode==='coding'?codingPrompt():sdPrompt();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:mode==='coding'?4500:7000,stream:true,system:sys,messages:[{role:'user',content:prob}]})
    });
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'API error');}
    const reader=res.body.getReader(), dec=new TextDecoder();
    let full='', pct=6, done_keys=new Set();
    document.getElementById('thinking').classList.remove('on');
    showSkeleton();
    document.getElementById('rarea').classList.add('on');
    while(true){
      const{done,value}=await reader.read(); if(done) break;
      const lines=dec.decode(value,{stream:true}).split('\n');
      for(const ln of lines){
        if(!ln.startsWith('data: ')) continue;
        const d=ln.slice(6).trim(); if(d==='[DONE]') break;
        try{const ev=JSON.parse(d); if(ev.type==='content_block_delta'&&ev.delta?.text){full+=ev.delta.text;pct=Math.min(90,pct+0.22);bar.style.width=pct+'%';streamPatch(full,done_keys);}}catch(e){}
      }
    }
    bar.style.width='100%';
    setTimeout(()=>{document.getElementById('sprog').classList.remove('on');bar.style.width='0%';},600);
    try{
      const parsed=JSON.parse(full.trim().replace(/^```json\s*/i,'').replace(/\s*```$/,''));
      last={mode,data:parsed};
      mode==='coding'?renderCoding(parsed):renderSD(parsed);
    }catch(e){console.warn('Final parse',e);}
  }catch(err){
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('rarea').innerHTML='<div class="err-box">âš ï¸ '+err.message+'</div>';
    document.getElementById('rarea').classList.add('on');
    document.getElementById('sprog').classList.remove('on');
  }finally{
    document.getElementById('goBtn').disabled=false;
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('vs').textContent='Tap mic to record again';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STREAM PATCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function streamPatch(txt, done){
  const get=key=>{const m=txt.match(new RegExp('"'+key+'"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*)"','s'));return m?m[1].replace(/\\n/g,'\n').replace(/\\"/g,'"'):null;};
  const upd=(id,val,html=false)=>{const el=document.getElementById(id);if(!el)return;html?el.innerHTML=val:el.textContent=val;el.classList.add('fadein');el.closest?.('[data-skel]')?.querySelectorAll('.skel').forEach(s=>s.remove());};
  if(mode==='coding'){
    ['thought_process','analogy','summary','complexity'].forEach(k=>{
      if(!done.has(k)){const v=get(k);if(v&&v.length>15){done.add(k);upd('sk_'+k,v);}}
    });
  } else {
    ['thought_process','problem_statement'].forEach(k=>{
      if(!done.has(k)){const v=get(k);if(v&&v.length>20){done.add(k);upd('sk_'+k,v);}}
    });
    if(!done.has('fr')){
      const m=txt.match(/"functional_requirements"\s*:\s*\[([\s\S]*?)\]/);
      if(m&&m[1].includes('"req"')){done.add('fr');const el=document.getElementById('sk_fr');if(el){el.innerHTML=parseFR(m[1]);el.classList.add('fadein');}}
    }
    if(!done.has('nfr')){
      const m=txt.match(/"non_functional_requirements"\s*:\s*\[([\s\S]*?)\]/);
      if(m&&m[1].includes('"req"')){done.add('nfr');const el=document.getElementById('sk_nfr');if(el){el.innerHTML=parseNFR(m[1]);el.classList.add('fadein');}}
    }
  }
}
function parseFR(raw){
  const reqs=[];let m;const rx=/"req"\s*:\s*"([^"]+)"/g;
  while((m=rx.exec(raw))!==null) reqs.push(m[1]);
  return reqs.map(r=>'<div class="hrow">ğŸ”µ '+r+'</div>').join('');
}
function parseNFR(raw){
  const items=[];let pos=0;
  while(true){const s=raw.indexOf('{',pos);if(s<0)break;const e=raw.indexOf('}',s);if(e<0)break;
    const chunk=raw.slice(s,e+1);
    const r=(chunk.match(/"req"\s*:\s*"([^"]+)"/)||['',''])[1];
    const v=(chunk.match(/"value"\s*:\s*"([^"]+)"/)||['',''])[1];
    if(r)items.push({r,v});pos=e+1;}
  return items.map(i=>'<div class="hrow">â— <strong>'+i.r+'</strong>'+(i.v?' <span class="badge ba">'+i.v+'</span>':'')+'</div>').join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SKELETON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSkeleton(){
  const a=document.getElementById('rarea');
  if(mode==='coding'){
    a.innerHTML=`<div style="padding-top:12px">
      <div class="iblock blue" data-skel><div class="blbl">ğŸ§  How I thought about this</div><div id="sk_thought_process"><div class="skel" style="width:100%"></div><div class="skel" style="width:84%"></div><div class="skel" style="width:66%"></div></div></div>
      <div class="iblock green" data-skel><div class="blbl">ğŸ’¡ Analogy</div><div id="sk_analogy"><div class="skel" style="width:100%"></div><div class="skel" style="width:72%"></div></div></div>
      <div class="sumbox" data-skel id="sk_summary"><div class="skel" style="width:100%"></div><div class="skel" style="width:58%"></div></div>
      <div id="sk_complexity" style="font-size:12.5px;line-height:1.7;color:var(--ts);padding:2px 0 10px"><div class="skel" style="width:78%"></div><div class="skel" style="width:54%"></div></div>
      <div style="text-align:center;font-size:11.5px;color:var(--ts);font-style:italic;padding:6px 0">â³ Code, walkthrough & Q&A loadingâ€¦</div></div>`;
  } else {
    a.innerHTML=`<div style="padding-top:12px">
      <div class="iblock blue" data-skel><div class="blbl">ğŸ§  Interview approach</div><div id="sk_thought_process"><div class="skel" style="width:100%"></div><div class="skel" style="width:88%"></div><div class="skel" style="width:70%"></div><div class="skel" style="width:80%"></div></div></div>
      <div class="sumbox" data-skel id="sk_problem_statement"><div class="skel" style="width:100%"></div><div class="skel" style="width:68%"></div></div>
      <div class="sublbl">ğŸ”µ Functional Requirements</div><div id="sk_fr"><div class="skel" style="width:90%"></div><div class="skel" style="width:76%"></div><div class="skel" style="width:83%"></div></div>
      <div class="sublbl">â— Non-Functional Requirements</div><div id="sk_nfr"><div class="skel" style="width:88%"></div><div class="skel" style="width:72%"></div><div class="skel" style="width:80%"></div></div>
      <div style="text-align:center;font-size:11.5px;color:var(--ts);font-style:italic;padding:14px 0">â³ Full design loadingâ€¦</div></div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROMPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function codingPrompt(){
  const ctx={interview:'Crisp, confident. Anticipate follow-ups.',explain:'Conversational, real-world trade-offs.',beginner:'Simple language, vivid analogies.'}[depth];
  return `Elite Java coding coach. Context: ${ctx}
Return ONLY valid JSON starting with { (no markdown):
{"summary":"One confident sentence","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences WHY","pattern":"Algorithm pattern name","approach":"Core technique","thought_process":"4-5 sentences: aha moment, why naive fails, why this clicks. First person.","analogy":"Vivid 2-3 sentence real-world analogy.","code":"Complete clean well-commented Java code","steps":[{"title":"step title","what":"1-2 sentences what it does","how":"mechanics with backtick \`varName\` formatting","why":"the reasoning behind this choice"}],"tricky_parts":[{"issue":"gotcha name","explanation":"why tricky, exactly how code handles it"}],"followup_qa":[{"question":"realistic interviewer question","answer":"confident 3-4 sentence answer"}],"alternatives":[{"name":"approach name","complexity":"T/S complexity","when_to_use":"when to prefer this","verdict":"better|tradeoff|worse"}]}
5-6 steps, 3 tricky_parts, 5 followup_qa, 3 alternatives. Sound expert and organic.`;
}

function sdPrompt(){
  const ctx={senior:'Senior/Staff level â€” deep technical trade-offs, justify every choice with specific reasoning and numbers.',mid:'Mid-level â€” clear architecture and solid reasoning on key trade-offs.',deep:'Deep walkthrough â€” explain every component and decision thoroughly.'}[depth];
  return `You are a MAANG Staff Engineer expert in system design interviews. Follow the EXACT Hello Interview delivery framework by Evan King â€” the precise sequence is: Requirements (functional + non-functional + capacity estimation inside requirements) â†’ Core Entities â†’ API Design â†’ [Optional] Data Flow â†’ High Level Design (schema evolves here alongside boxes) â†’ Deep Dives.

Context: ${ctx}

CRITICAL RULES:
- Every component must list 2-3 inline alternatives with verdicts and specific reasons
- Capacity numbers must show actual calculations
- Deep dives must show naive approach first, then your real solution
- Schema/data model fields belong inside high_level_design, not as a separate section
- Keep functional requirements to 3 max â€” prioritization is a skill

Return ONLY valid JSON starting with { (no markdown):
{
  "problem_statement": "Precise restatement of what we are building",
  "thought_process": "5-6 sentences â€” how a Staff engineer frames this problem in an interview: what to clarify first, what makes this uniquely hard, the core trade-off (e.g. consistency vs availability), your high-level approach. Sound like you are thinking out loud.",
  "clarifying_questions": [
    "Specific question you'd ask the interviewer to scope the problem",
    "Another scoping question",
    "Question to surface a key trade-off"
  ],

  "step1_requirements": {
    "functional": [
      {"req": "Users should be able to...", "priority": "core", "technical_implication": "what this means for the design"}
    ],
    "non_functional": [
      {"req": "The system should...", "value": "specific measurable target e.g. p99 < 200ms", "tradeoff": "what we sacrifice for this"}
    ],
    "out_of_scope": ["item explicitly excluded"],
    "capacity_note": "One sentence on whether estimation is needed here and why â€” per Hello Interview, skip unless the number changes a design decision",
    "capacity": {
      "assumptions": ["100M DAU", "avg 10 reads/user/day", "avg 1 write/user/day"],
      "write_qps": "~1,160 writes/sec (100M Ã— 1 / 86,400)",
      "read_qps": "~11,600 reads/sec (100M Ã— 10 / 86,400)",
      "storage_per_year": "~X TB/year â€” show calculation",
      "design_impact": "Does this number change a design decision? If yes, what?"
    }
  },

  "step2_core_entities": [
    {"name": "EntityName", "description": "What this entity represents in the system", "note": "Key naming or modeling decision"}
  ],

  "step3_api_design": {
    "protocol_choice": "REST (default) | GraphQL | gRPC â€” and one sentence on why",
    "endpoints": [
      {
        "method": "POST",
        "path": "/v1/tweets",
        "auth": "JWT â€” derive user_id from token, never from body",
        "request": "{ text: string }",
        "response": "{ id: uuid, created_at: timestamp }",
        "note": "Rate limited. Returns 201."
      }
    ]
  },

  "step4_data_flow": {
    "needed": true,
    "reason": "One sentence on why data flow is worth stating for this specific system",
    "steps": [
      "1. Client sends POST /v1/tweets",
      "2. API Gateway authenticates via JWT...",
      "3. ..."
    ]
  },

  "step5_high_level_design": {
    "approach": "One sentence: how you build this up endpoint by endpoint",
    "ascii_diagram": "Clear ASCII diagram of all components with â†’ arrows. Include: Client, API Gateway/LB, core services, databases, caches, queues.",
    "schema": [
      {
        "table": "TableName",
        "key_fields": "id UUID PK, user_id UUID FK, content TEXT, created_at TIMESTAMP, [other design-relevant fields]",
        "storage": "PostgreSQL | DynamoDB | Cassandra | S3 etc.",
        "why": "Specific reason for this storage choice",
        "key_indexes": "INDEX on (user_id, created_at DESC) â€” why this index matters"
      }
    ],
    "components": [
      {
        "name": "Component Name",
        "role": "What this component does and why it is a separate service",
        "chosen_tech": "Specific technology e.g. Apache Kafka",
        "why_chosen": "Specific reason â€” e.g. Kafka log-based storage gives replay and ordering guarantees within partitions",
        "alternatives": [
          {"name": "RabbitMQ", "verdict": "tradeoff", "reason": "Better for complex routing logic; worse for high-throughput fan-out â€” no consumer replay"},
          {"name": "AWS SQS", "verdict": "tradeoff", "reason": "Fully managed, less ops burden; no replay, 256KB message limit"},
          {"name": "Redis Pub/Sub", "verdict": "avoid", "reason": "No persistence â€” messages lost if consumer is offline"}
        ]
      }
    ]
  },

  "step6_deep_dives": [
    {
      "topic": "Specific hard problem title e.g. Fan-out for Celebrity Accounts",
      "nfr_addressed": "Which NFR from step 1 this hardens",
      "why_hard": "Why this is specifically hard at the scale of this system",
      "naive_approach": "What a junior engineer would do and exactly why it breaks at scale",
      "real_solution": "Your solution â€” specific technologies, algorithms, data structures",
      "numbers": "Concrete numbers showing the solution works e.g. 10M followers Ã— 100 bytes = 1 GB â€” manageable with Redis cluster",
      "trade_offs": "What you give up with this solution"
    }
  ],

  "followup_qa": [
    {"question": "Specific technical follow-up an interviewer would ask", "answer": "Confident, specific, 3-4 sentence answer showing depth"}
  ],

  "speak_guide": {
    "opening_script": "Word-for-word what to say in the first 60 seconds of the interview",
    "key_insight": "The one non-obvious insight that distinguishes a great answer â€” what most candidates miss",
    "common_mistakes": ["Specific mistake and what to do instead", "Another common mistake"],
    "closing_script": "How to wrap up confidently in the last 2 minutes"
  }
}

Requirements: 3 func reqs max, 4 NFRs, 3-4 core entities, 3-4 API endpoints, data flow only if relevant, 4-6 components each with 3 inline alternatives, 3-4 deep dives, 5 Q&As. Make everything specific to THIS problem.`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ptabBar(pairs){
  let h='<div class="ptabs">';
  for(let i=0;i<pairs.length;i+=2) h+=`<div class="ptab${i===0?' on':''}" data-t="${pairs[i]}" onclick="switchP('${pairs[i]}')">${pairs[i+1]}</div>`;
  return h+'</div>';
}
function switchP(id){
  document.querySelectorAll('.ptab').forEach(t=>t.classList.toggle('on',t.dataset.t===id));
  document.querySelectorAll('.ppanel').forEach(p=>p.classList.toggle('on',p.id==='pp_'+id));
}
function toggleQA(el){el.classList.toggle('open');el.querySelector('.chev').classList.toggle('open');el.nextElementSibling.classList.toggle('open');}

/* Sub-tabs wired after render */
function wireSubTabs(containerSelector){
  const container=document.querySelector(containerSelector);
  if(!container) return;
  const tabs=[...container.querySelectorAll('.stab')];
  const panels=[...container.querySelectorAll('.spanel')];
  tabs.forEach((t,i)=>{
    t.onclick=()=>{
      tabs.forEach(x=>x.classList.remove('on'));
      panels.forEach(x=>x.classList.remove('on'));
      t.classList.add('on');
      panels[i]?.classList.add('on');
    };
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPEAK MODE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSM(){
  if(!last) return;
  const{mode:m,data:d}=last;
  let h='';
  if(m==='coding'){
    h+=sc('ğŸ§  How I Approached It',d.thought_process);
    h+=sc('ğŸ¯ One-Liner',d.summary);
    h+=sc('ğŸ’¡ Analogy',d.analogy);
    h+=sc('ğŸ”‘ Key Steps',(d.steps||[]).map((s,i)=>(i+1)+'. '+s.title+' â€” '+s.why).join('\n'));
    h+=sc('âš¡ On Complexity',d.complexity_explanation);
    h+=sc('âš ï¸ Gotchas',(d.tricky_parts||[]).map(t=>'â€¢ '+t.issue+': '+String(t.explanation).slice(0,140)).join('\n'));
  } else {
    const sg=d.speak_guide||{};
    h+=sc('ğŸ¬ Opening Script',sg.opening_script||'');
    h+=sc('ğŸ’¡ Key Insight',sg.key_insight||'');
    const fr=(d.step1_requirements?.functional||[]).map(r=>'ğŸ”µ '+r.req);
    const nfr=(d.step1_requirements?.non_functional||[]).map(r=>'â— '+r.req+' ('+r.value+')');
    h+=sc('ğŸ“‹ Requirements to State',[...fr,'â”€',...nfr].join('\n'));
    h+=sc('ğŸ—ï¸ Architecture Flow',(d.step4_data_flow?.steps||d.step5_high_level_design?.approach||'').replace(/,/g,'\n'));
    h+=sc('ğŸ”¬ Deep Dives',(d.step6_deep_dives||[]).map(dd=>'â€¢ '+dd.topic+': '+String(dd.real_solution).slice(0,130)).join('\n'));
    h+=sc('âš ï¸ Mistakes to Avoid',(sg.common_mistakes||[]).map(m=>'â€¢ '+m).join('\n'));
    h+=sc('ğŸ Closing',sg.closing_script||'');
  }
  document.getElementById('smc').innerHTML=h;
  document.getElementById('sovl').classList.add('on');
}
function closeSM(){document.getElementById('sovl').classList.remove('on');}
function sc(lbl,txt){return '<div class="sc"><div class="sc-lbl">'+lbl+'</div><div class="sc-txt">'+String(txt||'').replace(/\n/g,'<br>')+'</div></div>';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVA RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hl(code){
  const kw=['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h=code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h=h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h=h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k=>{h=h.replace(new RegExp('\\b('+k+')\\b','g'),'<span style="color:#569cd6">$1</span>');});
  return h;
}
const rx=t=>String(t||'').replace(/`([^`]+)`/g,'<code>$1</code>');
const eh=t=>String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function renderCoding(d){
  const a=document.getElementById('rarea');
  const stH=(d.steps||[]).map((s,i)=>`<div class="card fadein"><div class="card-head"><div class="cnum">${i+1}</div><div>${s.title}</div></div><div class="card-body">${rx(s.what)}<br><br>${rx(s.how)}</div><div class="card-sub">ğŸ’¡ Why: ${s.why}</div></div>`).join('');
  const trH=(d.tricky_parts||[]).map(t=>`<div class="iblock red fadein"><div class="blbl">âš ï¸ ${t.issue}</div>${rx(t.explanation)}</div>`).join('');
  const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${rx(q.answer)}</div></div>`).join('');
  const vl=v=>v==='better'?'âœ“ Better':v==='worse'?'âœ— Worse':'â‡„ Trade-off';
  const vc=v=>v==='better'?'bg':v==='worse'?'bo':'bb';
  const alH=(d.alternatives||[]).map(a=>`<div class="card fadein"><div class="card-head" style="justify-content:space-between"><span>${a.name} <small style="color:var(--ts);font-weight:400">${a.complexity}</small></span><span class="badge ${vc(a.verdict)}">${vl(a.verdict)}</span></div><div class="card-body">${a.when_to_use}</div></div>`).join('');

  a.innerHTML=
    ptabBar(['overview','Overview','code','Code','steps','Walkthrough','tricky','Gotchas','qa','Q&A','alts','Alternatives'])+
    `<div class="ppanel on" id="pp_overview">
      <div class="iblock blue fadein"><div class="blbl">ğŸ§  How I thought about this</div>${d.thought_process}</div>
      <div class="iblock green fadein"><div class="blbl">ğŸ’¡ Real-world analogy</div>${d.analogy}</div>
      <div class="sumbox fadein">${d.summary}</div>
      <div class="mrow"><span class="badge ba">${d.complexity}</span><span class="badge bb">${d.pattern}</span><span class="badge bg">${d.approach}</span></div>
      <div style="font-size:12.5px;line-height:1.7;color:var(--ts);padding:2px 0 14px">${d.complexity_explanation}</div>
      <button class="spk-btn fadein" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>
    <div class="ppanel" id="pp_code">
      <p style="font-size:11.5px;color:var(--ts);margin-bottom:10px;line-height:1.5">Lines wrap fully â€” scroll up/down only.</p>
      <div class="code-outer fadein"><div class="code-hdr"><span class="code-lang">JAVA</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${hl(d.code)}</pre></div></div>
    </div>
    <div class="ppanel" id="pp_steps"><div>${stH}</div></div>
    <div class="ppanel" id="pp_tricky"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Knowing these signals thoroughness.</p>${trH}</div>
    <div class="ppanel" id="pp_qa"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Tap to reveal a confident answer.</p>${qaH}</div>
    <div class="ppanel" id="pp_alts"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Mentioning trade-offs signals depth.</p>${alH}</div>`;
  a._rawCode=d.code;
  a.classList.add('on');
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SD RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSD(d){
  const a=document.getElementById('rarea');
  const r=d.step1_requirements||{};
  const entities=d.step2_core_entities||[];
  const api=d.step3_api_design||{};
  const flow=d.step4_data_flow||{};
  const hld=d.step5_high_level_design||{};
  const dives=d.step6_deep_dives||[];
  const sg=d.speak_guide||{};

  /* â”€â”€ Step 1: Requirements â”€â”€ */
  const funcH=(r.functional||[]).map(f=>
    `<div class="hrow fadein"><strong>${f.priority==='core'?'ğŸ”µ':'âšª'} ${f.req}</strong>${f.technical_implication?'<br><span style="font-size:11.5px;color:var(--ts)">â†’ '+f.technical_implication+'</span>':''}</div>`).join('');
  const nfrH=(r.non_functional||[]).map(n=>
    `<div class="hrow fadein">â— <strong>${n.req}</strong> <span class="badge ba">${n.value}</span>${n.tradeoff?'<br><span style="font-size:11.5px;color:var(--ts)">Tradeoff: '+n.tradeoff+'</span>':''}</div>`).join('');
  const oosH=(r.out_of_scope||[]).map(o=>`<span class="pill">âœ— ${o}</span>`).join('');
  const cap=r.capacity||{};
  const capH=cap.write_qps?`
    <div class="iblock orange fadein"><div class="blbl">ğŸ“Š When to do this math</div>${r.capacity_note||'Only calculate when the number changes a design decision.'}</div>
    <div class="sublbl">Assumptions</div>${(cap.assumptions||[]).map(a=>'<div class="hrow fadein">'+a+'</div>').join('')}
    <div class="sublbl">Numbers</div>
    <div class="card fadein"><div class="card-body">
      <div style="margin-bottom:5px">âœï¸ <strong>Write QPS:</strong> ${cap.write_qps}</div>
      <div style="margin-bottom:5px">ğŸ“– <strong>Read QPS:</strong> ${cap.read_qps}</div>
      <div style="margin-bottom:5px">ğŸ’¾ <strong>Storage/year:</strong> ${cap.storage_per_year}</div>
      <div>ğŸ¯ <strong>Design impact:</strong> ${cap.design_impact||'â€”'}</div>
    </div></div>`:'<div class="iblock orange fadein"><div class="blbl">ğŸ’¡ Hello Interview note</div>Skip capacity estimation unless the number directly changes a design decision. State this explicitly to the interviewer.</div>';

  /* â”€â”€ Step 2: Core Entities â”€â”€ */
  const entH=entities.map(e=>
    `<div class="card fadein"><div class="card-head">${e.name}</div><div class="card-body">${e.description}${e.note?'<div class="card-sub">'+e.note+'</div>':''}</div></div>`).join('');

  /* â”€â”€ Step 3: API Design â”€â”€ */
  const apiH=(api.endpoints||[]).map(ep=>
    `<div class="card fadein" style="margin-bottom:10px">
      <div class="card-head"><span class="badge bb" style="font-family:monospace;font-size:10px">${ep.method}</span> <code style="font-size:12.5px">${ep.path}</code></div>
      <div class="card-body">
        ${ep.auth?'<div style="margin-bottom:4px;font-size:11.5px;color:var(--ts)">ğŸ” '+ep.auth+'</div>':''}
        <strong>Request:</strong> <code>${ep.request||''}</code><br>
        <strong>Response:</strong> <code>${ep.response||''}</code>
        ${ep.note?'<div style="margin-top:4px;font-size:11.5px;color:var(--ts)">'+ep.note+'</div>':''}
      </div>
    </div>`).join('');

  /* â”€â”€ Step 4: Data Flow (optional) â”€â”€ */
  const flowH=flow.needed?`
    <div class="iblock blue fadein"><div class="blbl">Why data flow matters here</div>${flow.reason||''}</div>
    ${(flow.steps||[]).map(s=>'<div class="hrow fadein">'+s+'</div>').join('')}`
    :'<div class="iblock green fadein"><div class="blbl">âœ“ Not needed here</div>This problem does not involve a complex data pipeline, so we skip to High Level Design. Hello Interview says to include this only when there is a meaningful processing sequence.</div>';

  /* â”€â”€ Step 5: High Level Design â”€â”€ */
  const diagH=hld.ascii_diagram?`<div class="diagram fadein">${eh(hld.ascii_diagram)}</div>`:'';
  const schemaH=(hld.schema||[]).map(t=>
    `<div class="card fadein" style="margin-bottom:10px">
      <div class="card-head">${t.table} <span class="badge bp" style="margin-left:6px">${t.storage}</span></div>
      <div class="card-body">
        <code style="font-size:11px;word-break:break-all;line-height:1.8">${t.key_fields}</code>
        <div class="card-sub">Why ${t.storage}: ${t.why}</div>
        ${t.key_indexes?'<div style="font-size:11.5px;color:var(--ts);margin-top:4px">ğŸ”‘ Index: '+t.key_indexes+'</div>':''}
      </div>
    </div>`).join('');
  const compH=(hld.components||[]).map(c=>`
    <div class="tech-card fadein">
      <div class="tech-top"><span class="tech-name">${c.name}</span><span class="chosen-tag">âœ“ ${c.chosen_tech}</span></div>
      <div class="tech-role">${c.role}</div>
      <div class="tech-why"><strong>Why ${c.chosen_tech}:</strong> ${c.why_chosen}</div>
      ${c.alternatives&&c.alternatives.length?`<div class="alt-lbl">Alternative Options</div>${c.alternatives.map(alt=>`
        <div class="alt-row">
          <span class="alt-name">${alt.name}</span>
          <span class="av ${alt.verdict==='avoid'?'av-avoid':alt.verdict==='tradeoff'?'av-trade':'av-ok'}">${alt.verdict==='avoid'?'âœ— Avoid':alt.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span>
          <span class="alt-why">${alt.reason}</span>
        </div>`).join('')}`:''}
    </div>`).join('');

  /* â”€â”€ Step 6: Deep Dives â”€â”€ */
  const deepH=dives.map(dd=>`
    <div class="card fadein" style="margin-bottom:13px">
      <div class="card-head">ğŸ”¬ ${dd.topic}</div>
      ${dd.nfr_addressed?`<div style="margin-bottom:6px"><span class="badge bb">Hardens NFR: ${dd.nfr_addressed}</span></div>`:''}
      <div class="sublbl" style="margin-top:4px">Why It's Hard</div><div class="card-body">${dd.why_hard}</div>
      <div class="sublbl">Naive Approach & Why It Fails</div>
      <div class="iblock red fadein" style="margin-bottom:8px"><div class="blbl">âŒ What a junior engineer does</div>${dd.naive_approach}</div>
      <div class="sublbl">The Real Solution</div><div class="card-body">${dd.real_solution}</div>
      ${dd.numbers?`<div class="iblock orange fadein" style="margin-top:8px;padding:8px 12px"><div class="blbl">ğŸ“Š Numbers</div>${dd.numbers}</div>`:''}
      <div class="card-warn" style="margin-top:6px">â‡„ Trade-off: ${dd.trade_offs}</div>
    </div>`).join('');

  /* â”€â”€ Q&A â”€â”€ */
  const qaH=(d.followup_qa||[]).map(q=>`
    <div class="qa-item fadein">
      <div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div>
      <div class="qa-a">${q.answer}</div>
    </div>`).join('');

  /* â•â• ASSEMBLE â€” Overview + 6 sub-tabs exactly matching Hello Interview steps â•â• */
  a.innerHTML=
    ptabBar(['overview','Overview','walkthrough','Design Walkthrough','deepdives','Deep Dives','qa','Q&A'])+

    /* OVERVIEW â€” streams in first, can talk immediately */
    `<div class="ppanel on" id="pp_overview">
      <div class="iblock blue fadein"><div class="blbl">ğŸ§  How to frame this interview</div>${d.thought_process}</div>
      <div class="sumbox fadein">${d.problem_statement}</div>
      <div class="sublbl">Clarifying Questions to Ask First</div>${(d.clarifying_questions||[]).map((q,i)=>'<div class="hrow fadein"><strong>Q'+(i+1)+':</strong> '+q+'</div>').join('')}
      <div class="sublbl">ğŸ”µ Core Functional Requirements</div>${(r.functional||[]).filter(f=>f.priority==='core').map(f=>'<div class="hrow fadein">ğŸ”µ '+f.req+'</div>').join('')}
      <div class="sublbl">â— Key NFRs</div>${(r.non_functional||[]).slice(0,4).map(n=>'<div class="hrow fadein">â— '+n.req+' <span class="badge ba">'+n.value+'</span></div>').join('')}
      <button class="spk-btn fadein" style="margin-top:14px" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>

    /* DESIGN WALKTHROUGH â€” 6 sub-tabs matching exact Hello Interview sequence */
    <div class="ppanel" id="pp_walkthrough">
      <div class="stab-row">
        <div class="stab on"><span class="sn">1</span>Requirements<span class="step-timing">~5 min</span></div>
        <div class="stab"><span class="sn">2</span>Core Entities<span class="step-timing">~2 min</span></div>
        <div class="stab"><span class="sn">3</span>API Design<span class="step-timing">~5 min</span></div>
        <div class="stab"><span class="sn">4</span>Data Flow<span class="step-timing">optional</span></div>
        <div class="stab"><span class="sn">5</span>High Level Design<span class="step-timing">~15 min</span></div>
        <div class="stab"><span class="sn">6</span>Schema<span class="step-timing">inside HLD</span></div>
      </div>

      <div class="spanel on">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>State functional requirements as "Users should be able toâ€¦" statements. Keep to 3 max â€” prioritisation is itself a signal. Include NFRs with specific numbers. Capacity estimation lives here but skip it unless the result changes a design decision.</div>
        <div class="sublbl">ğŸ”µ Functional Requirements</div>${funcH}
        <div class="sublbl">â— Non-Functional Requirements</div>${nfrH}
        <div class="sublbl">âœ— Out of Scope</div><div class="pill-row">${oosH}</div>
        <div class="sublbl">ğŸ“Š Capacity Estimation</div>${capH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>List core entities as simple nouns â€” no fields yet. These are the nouns your API will exchange and your system will persist. Fields get filled in during HLD as you trace each request.</div>
        ${entH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Default to REST. Use plural resource nouns. Derive the current user from the JWT auth token â€” never from the request body. Design endpoints to satisfy each functional requirement one by one.</div>
        <div class="sublbl">Protocol: ${api.protocol_choice||'REST (default)'}</div>
        ${apiH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Data flow is optional â€” only include it for backend/data-pipeline systems where there is a meaningful sequence of transformations. Skip for standard product CRUD systems.</div>
        ${flowH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Build boxes and arrows to satisfy each API endpoint in turn. Keep it simple first â€” satisfy the core functional requirements, then layer complexity in Deep Dives. Call out caches and queues verbally and come back to them later.</div>
        ${diagH}
        <div class="sublbl">Architecture & Components</div>
        <p style="font-size:11.5px;color:var(--ts);margin-bottom:10px;line-height:1.5">Each card shows chosen tech + why, with inline alternatives so you never have to go hunting.</p>
        ${compH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Schema evolves during HLD as you trace each request to the persistence layer. Only document fields relevant to your design â€” skip obvious ones like name, email, created_at. Place schema notes beside the database in your diagram.</div>
        ${schemaH}
      </div>
    </div>

    /* DEEP DIVES */
    <div class="ppanel" id="pp_deepdives">
      <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Hello Interview guidance</div>Use the remaining ~10 minutes to harden your design. Proactively lead this section for senior roles. Always show the naive approach first â€” it proves you understand why the problem is hard. Each dive should address a specific NFR from Step 1.</div>
      ${deepH}
    </div>

    /* Q&A */
    <div class="ppanel" id="pp_qa">
      <p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Tap to reveal a confident, specific answer.</p>
      ${qaH}
    </div>`;

  a.classList.add('on');
  wireSubTabs('#pp_walkthrough');
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

function copyCode(btn){const a=document.getElementById('rarea');navigator.clipboard.writeText(a._rawCode||'').then(()=>{btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500);});}
document.getElementById('tbox').addEventListener('input',chkBtn);
</script>
</body>
</html>
