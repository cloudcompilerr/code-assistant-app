<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  :root {
    --bg: #faf9f7; --surface: #ffffff; --border: #e8e5e0;
    --text-primary: #1a1916; --text-secondary: #7a7670;
    --accent: #c8a96e; --accent-soft: #f5f0e8;
    --code-bg: #1e1c1a; --code-text: #e8e4dc;
    --green: #4a7c59; --blue: #3a5f8a; --red: #8a4a4a; --purple: #6b4a8a;
    --green-soft: #edf4f0; --blue-soft: #edf2f8; --red-soft: #f8edf0; --purple-soft: #f3edf8;
  }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-primary); min-height: 100vh; max-width: 700px; margin: 0 auto; padding: 0 0 100px; }

  /* â”€â”€ NOTES LIST â”€â”€ */
  .app-header { padding: 56px 24px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(250,249,247,0.93); }
  .header-row { display: flex; align-items: center; justify-content: space-between; }
  .app-title { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .note-count { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
  .notes-list { padding: 8px 0; }
  .note-row { padding: 18px 24px; border-bottom: 1px solid var(--border); display: flex; gap: 14px; align-items: flex-start; cursor: pointer; -webkit-tap-highlight-color: rgba(200,169,110,0.15); width: 100%; background: none; border-left: none; border-right: none; border-top: none; text-align: left; }
  .note-row:active { background: var(--accent-soft); }
  .note-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--accent-soft); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 20px; }
  .note-preview { flex: 1; min-width: 0; }
  .note-title { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
  .note-snippet { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 3px; }
  .note-date { font-size: 12px; color: var(--text-secondary); flex-shrink: 0; margin-top: 2px; }

  /* â”€â”€ DETAIL VIEW â”€â”€ */
  .note-detail { display: none; min-height: 100vh; background: var(--bg); }
  .note-detail.open { display: block; }
  .detail-header { padding: 14px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(250,249,247,0.96); backdrop-filter: blur(20px); z-index: 10; }
  .back-btn { color: var(--accent); font-size: 17px; cursor: pointer; border: none; background: none; font-weight: 600; padding: 8px 4px; min-width: 60px; }
  .detail-title { flex: 1; font-size: 14px; font-weight: 600; text-align: center; }
  .gear-btn { font-size: 20px; cursor: pointer; border: none; background: none; padding: 8px; min-width: 44px; color: var(--accent); }

  /* â”€â”€ MODE TOGGLE â”€â”€ */
  .mode-toggle { display: flex; margin: 14px 24px; background: var(--border); border-radius: 12px; padding: 3px; gap: 3px; }
  .mode-btn { flex: 1; padding: 9px 8px; border-radius: 9px; border: none; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.18s; background: none; color: var(--text-secondary); }
  .mode-btn.active { background: var(--surface); color: var(--text-primary); box-shadow: 0 1px 4px rgba(0,0,0,0.12); }

  /* â”€â”€ API SETUP â”€â”€ */
  .setup-note { margin: 0 24px 14px; padding: 16px; background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 12px; }
  .setup-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .setup-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
  .api-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: monospace; background: var(--surface); color: var(--text-primary); outline: none; margin-bottom: 8px; -webkit-appearance: none; }
  .save-btn { padding: 10px 16px; background: var(--text-primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%; }

  /* â”€â”€ VOICE AREA â”€â”€ */
  .voice-area { margin: 0 24px 4px; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  .voice-top { padding: 12px 16px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
  .voice-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); }
  .timer { font-size: 12px; color: var(--text-secondary); font-variant-numeric: tabular-nums; }
  .mic-wrap { display: flex; justify-content: center; padding: 20px 0 6px; }
  .mic-btn { width: 76px; height: 76px; border-radius: 50%; background: var(--accent-soft); border: 2px solid rgba(200,169,110,0.4); font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.15s, background 0.2s; -webkit-tap-highlight-color: transparent; user-select: none; }
  .mic-btn:active { transform: scale(0.92); }
  .mic-btn.listening { background: #fff0f0; border-color: rgba(200,60,60,0.5); animation: micPulse 1s ease-in-out infinite; }
  @keyframes micPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
  .waveform { display: none; align-items: flex-end; justify-content: center; gap: 3px; height: 28px; margin: 4px auto 0; width: 110px; }
  .waveform.active { display: flex; }
  .wave-bar { width: 4px; border-radius: 2px; background: var(--accent); animation: wave 0.9s infinite ease-in-out; }
  .wave-bar:nth-child(1){animation-delay:0s}.wave-bar:nth-child(2){animation-delay:0.1s}.wave-bar:nth-child(3){animation-delay:0.2s}.wave-bar:nth-child(4){animation-delay:0.3s}.wave-bar:nth-child(5){animation-delay:0.2s}.wave-bar:nth-child(6){animation-delay:0.1s}.wave-bar:nth-child(7){animation-delay:0s}
  @keyframes wave { 0%,100%{height:5px;opacity:0.4} 50%{height:24px;opacity:1} }
  .voice-status { text-align: center; font-size: 13px; color: var(--text-secondary); padding: 6px 16px 4px; font-style: italic; min-height: 26px; }
  .voice-status.listening { color: #c0392b; font-style: normal; font-weight: 500; }
  .transcript-box { margin: 8px 16px 12px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; font-size: 14px; line-height: 1.65; color: var(--text-primary); min-height: 52px; outline: none; -webkit-user-select: text; user-select: text; }
  .transcript-box:empty::before { content: 'Tap mic to speak your problemâ€¦'; color: var(--text-secondary); font-style: italic; }
  .voice-actions { display: flex; gap: 10px; padding: 0 16px 16px; }
  .btn-clear { flex: 1; padding: 11px; border-radius: 9px; font-size: 13px; font-weight: 600; border: 1.5px solid var(--border); background: var(--bg); color: var(--text-secondary); cursor: pointer; }
  .btn-generate { flex: 2; padding: 11px; border-radius: 9px; font-size: 13px; font-weight: 700; border: none; background: var(--text-primary); color: white; cursor: pointer; }
  .btn-generate:disabled { opacity: 0.38; cursor: not-allowed; }

  /* â”€â”€ DEPTH â”€â”€ */
  .depth-row { display: flex; gap: 8px; padding: 12px 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .depth-chip { padding: 7px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1.5px solid var(--border); background: var(--surface); color: var(--text-secondary); cursor: pointer; white-space: nowrap; flex-shrink: 0; }
  .depth-chip.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }

  /* â”€â”€ STREAMING PROGRESS BAR â”€â”€ */
  .stream-progress { display: none; margin: 0 24px; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .stream-progress.active { display: block; }
  .stream-bar { height: 100%; background: linear-gradient(90deg, var(--accent), #e8c878); border-radius: 2px; width: 0%; transition: width 0.4s ease; animation: streamShimmer 1.5s infinite; }
  @keyframes streamShimmer { 0%,100%{opacity:1} 50%{opacity:0.7} }

  /* â”€â”€ SECTION STREAM CARDS â”€â”€ */
  .stream-section { animation: fadeSlideIn 0.35s ease forwards; opacity: 0; transform: translateY(8px); }
  @keyframes fadeSlideIn { to { opacity: 1; transform: translateY(0); } }

  /* â”€â”€ THINKING â”€â”€ */
  .thinking { display: none; padding: 16px 24px; align-items: center; gap: 12px; }
  .thinking.active { display: flex; }
  .thinking-dots { display: flex; gap: 4px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.2s infinite; }
  .dot:nth-child(2){animation-delay:0.2s}.dot:nth-child(3){animation-delay:0.4s}
  @keyframes pulse { 0%,80%,100%{transform:scale(1);opacity:0.5} 40%{transform:scale(1.3);opacity:1} }
  .thinking-text { font-size: 13px; color: var(--text-secondary); font-style: italic; }

  /* â”€â”€ RESPONSE â”€â”€ */
  .response-area { padding: 0 24px 40px; display: none; }
  .response-area.visible { display: block; }

  /* â”€â”€ TABS â”€â”€ */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); margin: 0 -24px; padding: 0 12px; overflow-x: auto; margin-top: 18px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .tab-bar::-webkit-scrollbar { display: none; }
  .tab { padding: 10px 12px; font-size: 11.5px; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2.5px solid transparent; white-space: nowrap; flex-shrink: 0; transition: color 0.15s; }
  .tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
  .tab-panel { display: none; padding-top: 16px; }
  .tab-panel.active { display: block; }

  /* â”€â”€ SHARED CONTENT â”€â”€ */
  .section-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
  .info-block { border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; margin-bottom: 12px; }
  .info-block.blue { background: var(--blue-soft); border-left: 3px solid var(--blue); }
  .info-block.blue .section-label { color: var(--blue); }
  .info-block.green { background: var(--green-soft); border-left: 3px solid var(--green); }
  .info-block.green .section-label { color: var(--green); }
  .info-block.purple { background: var(--purple-soft); border-left: 3px solid var(--purple); }
  .info-block.purple .section-label { color: var(--purple); }
  .info-block.red { background: var(--red-soft); border-left: 3px solid var(--red); }
  .info-block.red .section-label { color: var(--red); }
  .summary-box { background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 10px; padding: 16px; font-size: 14px; line-height: 1.7; margin-bottom: 14px; }
  .meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .badge { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
  .badge-blue { background: var(--blue-soft); color: var(--blue); border: 1px solid rgba(58,95,138,0.2); }
  .badge-green { background: var(--green-soft); color: var(--green); border: 1px solid rgba(74,124,89,0.2); }
  .badge-accent { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(200,169,110,0.3); }
  .badge-purple { background: var(--purple-soft); color: var(--purple); border: 1px solid rgba(107,74,138,0.2); }
  .card-list { display: flex; flex-direction: column; gap: 10px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
  .card-head { font-size: 13.5px; font-weight: 700; margin-bottom: 5px; display: flex; align-items: flex-start; gap: 10px; }
  .card-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .card-body { font-size: 13px; line-height: 1.65; }
  .card-body code { font-family: monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .card-sub { font-size: 12px; color: var(--blue); margin-top: 5px; font-style: italic; }
  .card-warn { font-size: 12px; color: var(--red); margin-top: 5px; font-style: italic; }
  .code-block { background: var(--code-bg); border-radius: 12px; overflow: hidden; margin-bottom: 10px; }
  .code-header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
  .code-lang { font-size: 11px; color: #8a8580; font-family: monospace; }
  .copy-btn { font-size: 11px; color: var(--accent); background: none; border: none; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-weight: 500; }
  .code-content { padding: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .code-content pre { font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.7; color: var(--code-text); white-space: pre; }
  .qa-item { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
  .qa-q { padding: 14px 16px; font-size: 13px; font-weight: 600; background: var(--surface); cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  .qa-q .chevron { color: var(--text-secondary); transition: transform 0.2s; font-size: 14px; flex-shrink: 0; }
  .qa-q.open .chevron { transform: rotate(90deg); }
  .qa-a { display: none; padding: 12px 16px; font-size: 13px; line-height: 1.7; background: var(--bg); border-top: 1px solid var(--border); }
  .qa-a.open { display: block; }
  .qa-a code { font-family: monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .tradeoff-table { width: 100%; border-collapse: collapse; font-size: 12.5px; margin-bottom: 12px; }
  .tradeoff-table th { text-align: left; padding: 8px 10px; background: var(--bg); font-size: 11px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
  .tradeoff-table td { padding: 10px; border-bottom: 1px solid var(--border); line-height: 1.5; vertical-align: top; }
  .tradeoff-table tr:last-child td { border-bottom: none; }
  .verdict-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; display: inline-block; }
  .v-rec { background: var(--green-soft); color: var(--green); }
  .v-alt { background: var(--accent-soft); color: var(--accent); }
  .v-avoid { background: var(--red-soft); color: var(--red); }
  .diagram-box { background: var(--code-bg); border-radius: 12px; padding: 20px 16px; margin-bottom: 12px; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.8; color: #c8c4bc; white-space: pre; overflow-x: auto; }
  .highlight-row { background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.25); border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; font-size: 13px; line-height: 1.6; }
  .sub-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); margin: 18px 0 8px; }
  .pill-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .pill { font-size: 12px; padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface); color: var(--text-primary); font-weight: 500; }
  .divider { height: 1px; background: var(--border); margin: 16px 0; }
  .speak-btn { width: 100%; padding: 13px; background: var(--accent-soft); border: 1.5px solid rgba(200,169,110,0.4); border-radius: 10px; font-size: 13px; font-weight: 600; color: var(--text-primary); cursor: pointer; margin-top: 4px; }
  .error-box { background: #fff0f0; border: 1px solid #ffcccc; border-radius: 10px; padding: 14px 16px; font-size: 13px; color: #c0392b; margin-top: 12px; }

  /* â”€â”€ STREAMING SKELETON â”€â”€ */
  .skel { background: linear-gradient(90deg, var(--border) 25%, var(--accent-soft) 50%, var(--border) 75%); background-size: 200% 100%; animation: skelShimmer 1.2s infinite; border-radius: 6px; height: 14px; margin-bottom: 8px; }
  .skel.w60 { width: 60%; } .skel.w80 { width: 80%; } .skel.w40 { width: 40%; } .skel.w100 { width: 100%; }
  @keyframes skelShimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .skel-block { padding: 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }

  /* â”€â”€ SPEAK MODE â”€â”€ */
  #speakOverlay { display: none; position: fixed; inset: 0; background: rgba(16,15,14,0.97); z-index: 999; flex-direction: column; padding: 64px 24px 40px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  #speakOverlay.open { display: flex; }
  .speak-close { position: fixed; top: 18px; right: 20px; color: var(--accent); font-size: 28px; cursor: pointer; background: none; border: none; z-index: 1000; padding: 8px; }
  .speak-title { font-size: 11px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--accent); margin-bottom: 20px; }
  .speak-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.09); border-radius: 14px; padding: 18px 20px; margin-bottom: 14px; }
  .speak-card-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .speak-card-text { font-size: 16px; line-height: 1.9; color: #ede9e2; }
  .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #1a1916; color: white; padding: 9px 22px; border-radius: 22px; font-size: 13px; z-index: 9999; opacity: 0; transition: opacity 0.25s; white-space: nowrap; pointer-events: none; }
</style>
</head>
<body>

<!-- â•â• NOTES LIST â•â• -->
<div id="notesList">
  <div class="app-header">
    <div class="header-row"><div class="app-title">Notes</div></div>
    <div class="note-count">4 notes</div>
  </div>
  <div class="notes-list">
    <button class="note-row" onclick="openTool('coding')">
      <div class="note-icon">â˜•</div>
      <div class="note-preview">
        <div class="note-title">Quick Ref â€“ Java</div>
        <div class="note-snippet">Tap to solve a coding problemâ€¦</div>
      </div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="openTool('sysdesign')">
      <div class="note-icon">ğŸ—ï¸</div>
      <div class="note-preview">
        <div class="note-title">Quick Ref â€“ System Design</div>
        <div class="note-snippet">Tap to design a systemâ€¦</div>
      </div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“‹</div>
      <div class="note-preview">
        <div class="note-title">Meeting notes â€“ Product sync</div>
        <div class="note-snippet">Discussed roadmap priorities and Q2 milestones</div>
      </div>
      <div class="note-date">Mon</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“</div>
      <div class="note-preview">
        <div class="note-title">Grocery list</div>
        <div class="note-snippet">Eggs, bread, olive oil, tomatoesâ€¦</div>
      </div>
      <div class="note-date">Sun</div>
    </button>
  </div>
</div>

<!-- â•â• TOOL VIEW â•â• -->
<div id="noteDetail" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">â€¹ Notes</button>
    <div class="detail-title" id="detailTitle">Quick Ref</div>
    <button class="gear-btn" onclick="toggleSetup()">âš™ï¸</button>
  </div>

  <div id="setupArea" class="setup-note" style="display:none;">
    <div class="setup-title">ğŸ”‘ API Key</div>
    <div class="setup-desc">Your Anthropic API key â€” saved locally on this device only.</div>
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-â€¦" autocomplete="off"/>
    <button class="save-btn" onclick="saveApiKey()">Save & Close</button>
  </div>

  <div class="mode-toggle">
    <button class="mode-btn active" id="modeCoding" onclick="switchMode('coding')">â˜• Java Coding</button>
    <button class="mode-btn" id="modeSysdesign" onclick="switchMode('sysdesign')">ğŸ—ï¸ System Design</button>
  </div>

  <div class="voice-area">
    <div class="voice-top">
      <span class="voice-label" id="voiceLabel">ğŸ™ Speak your coding problem</span>
      <span class="timer" id="timerDisplay"></span>
    </div>
    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()">ğŸ™ï¸</button>
    </div>
    <div class="waveform" id="waveform">
      <div class="wave-bar" style="height:6px"></div><div class="wave-bar" style="height:12px"></div>
      <div class="wave-bar" style="height:20px"></div><div class="wave-bar" style="height:26px"></div>
      <div class="wave-bar" style="height:20px"></div><div class="wave-bar" style="height:12px"></div>
      <div class="wave-bar" style="height:6px"></div>
    </div>
    <div class="voice-status" id="voiceStatus">Tap the mic and speak clearly</div>
    <div class="transcript-box" id="transcriptBox" contenteditable="true" spellcheck="false"></div>
    <div class="voice-actions">
      <button class="btn-clear" onclick="clearAll()">Clear</button>
      <button class="btn-generate" id="generateBtn" onclick="generate()" disabled>Generate âš¡</button>
    </div>
  </div>

  <div class="depth-row" id="depthRow">
    <div class="depth-chip active" data-depth="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
    <div class="depth-chip" data-depth="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
    <div class="depth-chip" data-depth="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>
  </div>

  <!-- Streaming progress bar -->
  <div class="stream-progress" id="streamProgress"><div class="stream-bar" id="streamBar"></div></div>

  <div class="thinking" id="thinking">
    <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="thinking-text" id="thinkingText">Startingâ€¦</div>
  </div>

  <div class="response-area" id="responseArea"></div>
</div>

<!-- â•â• SPEAK MODE â•â• -->
<div id="speakOverlay">
  <button class="speak-close" onclick="closeSpeakMode()">âœ•</button>
  <div class="speak-title">ğŸ“¢ How to Explain This</div>
  <div id="speakContent"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORAGE_KEY = 'nts_cfg_v4';
let currentMode = 'coding';
let currentDepth = 'interview';
let lastResult = null;
let recognition = null;
let isListening = false;
let silenceTimer = null;
let timerInterval = null;
let elapsed = 0;
let accumulatedText = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getApiKey() { return localStorage.getItem(STORAGE_KEY) || ''; }
function saveApiKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) { showToast('Please enter a key'); return; }
  localStorage.setItem(STORAGE_KEY, k);
  document.getElementById('setupArea').style.display = 'none';
  showToast('API key saved âœ“');
}
function toggleSetup() {
  const a = document.getElementById('setupArea');
  const show = a.style.display === 'none';
  a.style.display = show ? 'block' : 'none';
  if (show && getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openTool(mode) {
  document.getElementById('notesList').style.display = 'none';
  document.getElementById('noteDetail').classList.add('open');
  switchMode(mode);
  if (!getApiKey()) document.getElementById('setupArea').style.display = 'block';
}
function goBack() {
  stopListening(false);
  document.getElementById('noteDetail').classList.remove('open');
  document.getElementById('notesList').style.display = 'block';
  clearAll(); lastResult = null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchMode(mode) {
  currentMode = mode;
  document.getElementById('modeCoding').classList.toggle('active', mode === 'coding');
  document.getElementById('modeSysdesign').classList.toggle('active', mode === 'sysdesign');
  document.getElementById('detailTitle').textContent = mode === 'coding' ? 'Java Coding' : 'System Design';
  document.getElementById('voiceLabel').textContent = mode === 'coding' ? 'ğŸ™ Speak your coding problem' : 'ğŸ™ Describe the system to design';
  const row = document.getElementById('depthRow');
  if (mode === 'sysdesign') {
    row.innerHTML = `
      <div class="depth-chip active" data-depth="senior" onclick="setDepth(this)">ğŸ¯ Senior/Staff</div>
      <div class="depth-chip" data-depth="mid" onclick="setDepth(this)">ğŸ‘¨â€ğŸ’» Mid-level</div>
      <div class="depth-chip" data-depth="walkthrough" onclick="setDepth(this)">ğŸ“– Deep Walkthrough</div>`;
    currentDepth = 'senior';
  } else {
    row.innerHTML = `
      <div class="depth-chip active" data-depth="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
      <div class="depth-chip" data-depth="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
      <div class="depth-chip" data-depth="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>`;
    currentDepth = 'interview';
  }
  clearAll();
}
function setDepth(el) {
  el.closest('.depth-row').querySelectorAll('.depth-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active'); currentDepth = el.dataset.depth;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST / TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.opacity = '1';
  clearTimeout(t._to); t._to = setTimeout(() => t.style.opacity = '0', 2400);
}
function startTimer() {
  elapsed = 0; clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsed++;
    document.getElementById('timerDisplay').textContent =
      String(Math.floor(elapsed/60)).padStart(2,'0') + ':' + String(elapsed%60).padStart(2,'0');
  }, 1000);
}
function stopTimer() { clearInterval(timerInterval); document.getElementById('timerDisplay').textContent = ''; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOICE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleVoice() { isListening ? stopListening(true) : startListening(); }
function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showToast('Voice not supported â€” type your problem'); return; }
  accumulatedText = document.getElementById('transcriptBox').textContent.trim();
  recognition = new SR();
  recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'en-US';
  recognition.onstart = () => {
    isListening = true;
    document.getElementById('micBtn').classList.add('listening');
    document.getElementById('micBtn').textContent = 'â¹ï¸';
    document.getElementById('waveform').classList.add('active');
    document.getElementById('voiceStatus').textContent = 'Listeningâ€¦ speak clearly';
    document.getElementById('voiceStatus').classList.add('listening');
    startTimer();
  };
  recognition.onresult = (e) => {
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(() => stopListening(true), 2800);
    let final = accumulatedText ? accumulatedText + ' ' : '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) { final += t; accumulatedText = final.trim(); } else { interim = t; }
    }
    document.getElementById('transcriptBox').textContent = (accumulatedText + (interim ? ' '+interim : '')).trim();
    updateGenerateBtn();
  };
  recognition.onerror = (e) => {
    if (e.error === 'not-allowed') showToast('Mic blocked â€” allow in Safari settings');
    else if (e.error !== 'aborted' && e.error !== 'no-speech') showToast('Mic error: '+e.error);
    stopListening(false);
  };
  recognition.onend = () => { if (isListening) { try { recognition.start(); } catch(e) { stopListening(false); } } };
  try { recognition.start(); } catch(e) { showToast('Could not access microphone'); }
}
function stopListening(autoGen) {
  const was = isListening; isListening = false; clearTimeout(silenceTimer); stopTimer();
  if (recognition) { try { recognition.stop(); } catch(e){} recognition = null; }
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('micBtn').textContent = 'ğŸ™ï¸';
  document.getElementById('waveform').classList.remove('active');
  document.getElementById('voiceStatus').classList.remove('listening');
  const text = document.getElementById('transcriptBox').textContent.trim();
  if (was && autoGen && text.length > 5) {
    document.getElementById('voiceStatus').textContent = 'Got it â€” generatingâ€¦';
    setTimeout(generate, 500);
  } else {
    document.getElementById('voiceStatus').textContent = text.length > 5 ? 'Ready â€” tap Generate' : 'Tap the mic and speak clearly';
  }
}
function updateGenerateBtn() {
  document.getElementById('generateBtn').disabled = document.getElementById('transcriptBox').textContent.trim().length < 5;
}
function clearAll() {
  accumulatedText = '';
  document.getElementById('transcriptBox').textContent = '';
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('voiceStatus').textContent = 'Tap the mic and speak clearly';
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('thinking').classList.remove('active');
  document.getElementById('streamProgress').classList.remove('active');
  document.getElementById('streamBar').style.width = '0%';
  lastResult = null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAMING GENERATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generate() {
  const problem = document.getElementById('transcriptBox').textContent.trim();
  if (problem.length < 4) { showToast('Speak or type a problem first'); return; }
  const apiKey = getApiKey();
  if (!apiKey) { toggleSetup(); showToast('Add your API key first'); return; }

  // Reset UI
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('thinking').classList.add('active');
  document.getElementById('thinkingText').textContent = currentMode === 'coding' ? 'Thinking through your problemâ€¦' : 'Architecting your systemâ€¦';

  // Show progress bar
  const bar = document.getElementById('streamBar');
  document.getElementById('streamProgress').classList.add('active');
  bar.style.width = '8%';

  const sys = currentMode === 'coding' ? getCodingPrompt() : getSysDesignPrompt();

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: currentMode === 'coding' ? 4500 : 6000,
        stream: true,
        system: sys,
        messages: [{ role: 'user', content: problem }]
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || 'API error');
    }

    // Stream the response
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    let renderedKeys = new Set();
    let progressPct = 8;

    // Show skeleton immediately
    document.getElementById('thinking').classList.remove('active');
    showStreamingSkeleton();
    document.getElementById('responseArea').classList.add('visible');

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (data === '[DONE]') break;
        try {
          const evt = JSON.parse(data);
          if (evt.type === 'content_block_delta' && evt.delta?.text) {
            fullText += evt.delta.text;
            // Advance progress bar naturally
            progressPct = Math.min(92, progressPct + 0.3);
            bar.style.width = progressPct + '%';
            // Try to render sections as they complete
            tryRenderSections(fullText, renderedKeys);
          }
        } catch(e) { /* partial JSON line, skip */ }
      }
    }

    // Final render with complete JSON
    bar.style.width = '100%';
    setTimeout(() => {
      document.getElementById('streamProgress').classList.remove('active');
      bar.style.width = '0%';
    }, 600);

    try {
      let clean = fullText.trim().replace(/^```json\s*/i,'').replace(/\s*```$/,'');
      const parsed = JSON.parse(clean);
      lastResult = { mode: currentMode, data: parsed };
      currentMode === 'coding' ? renderCoding(parsed) : renderSysDesign(parsed);
    } catch(e) {
      // If JSON parse fails, show what we have
      console.warn('Final parse failed, showing streamed content');
    }

  } catch(err) {
    document.getElementById('thinking').classList.remove('active');
    document.getElementById('responseArea').innerHTML = '<div class="error-box">âš ï¸ ' + err.message + '</div>';
    document.getElementById('responseArea').classList.add('visible');
    document.getElementById('streamProgress').classList.remove('active');
  } finally {
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('thinking').classList.remove('active');
    document.getElementById('voiceStatus').textContent = 'Tap mic to record again';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESSIVE SECTION RENDERING
   Parses partial JSON as fields complete
   and updates the skeleton cards live
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tryRenderSections(text, rendered) {
  // Extract completed string fields from partial JSON
  const extractField = (key) => {
    const rx = new RegExp('"' + key + '"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*)"', 's');
    const m = text.match(rx);
    return m ? m[1].replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\\\/g,'\\') : null;
  };

  if (currentMode === 'coding') {
    // Render thought_process as soon as it arrives
    if (!rendered.has('thought_process')) {
      const v = extractField('thought_process');
      if (v && v.length > 30) {
        rendered.add('thought_process');
        updateStreamCard('stream_thought', v);
      }
    }
    // Render analogy
    if (!rendered.has('analogy')) {
      const v = extractField('analogy');
      if (v && v.length > 10) {
        rendered.add('analogy');
        updateStreamCard('stream_analogy', v);
      }
    }
    // Render summary
    if (!rendered.has('summary')) {
      const v = extractField('summary');
      if (v && v.length > 10) {
        rendered.add('summary');
        updateStreamCard('stream_summary', v);
      }
    }
    // Render complexity
    if (!rendered.has('complexity')) {
      const v = extractField('complexity');
      if (v) {
        rendered.add('complexity');
        updateStreamCard('stream_complexity', v);
      }
    }
  } else {
    // SD: render thought_process first
    if (!rendered.has('thought_process')) {
      const v = extractField('thought_process');
      if (v && v.length > 30) {
        rendered.add('thought_process');
        updateStreamCard('stream_thought', v);
      }
    }
    if (!rendered.has('problem_statement')) {
      const v = extractField('problem_statement');
      if (v && v.length > 10) {
        rendered.add('problem_statement');
        updateStreamCard('stream_problem', v);
      }
    }
  }
}

function updateStreamCard(id, content) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = content.replace(/\n/g,'<br>');
  el.classList.add('stream-section');
  // Remove skeleton shimmer from parent
  const parent = el.closest('.skel-block');
  if (parent) {
    parent.querySelectorAll('.skel').forEach(s => s.remove());
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETON UI â€” shown immediately on stream start
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showStreamingSkeleton() {
  const area = document.getElementById('responseArea');
  if (currentMode === 'coding') {
    area.innerHTML = `
      <div style="padding-top:16px">
        <div class="skel-block info-block blue" style="min-height:80px">
          <div class="section-label" style="color:var(--blue)">ğŸ§  How I thought about this</div>
          <div id="stream_thought" style="font-size:13.5px;line-height:1.75;color:var(--text-primary)">
            <div class="skel w100"></div><div class="skel w80"></div><div class="skel w60"></div>
          </div>
        </div>
        <div class="skel-block info-block green" style="min-height:60px">
          <div class="section-label" style="color:var(--green)">ğŸ’¡ Real-world analogy</div>
          <div id="stream_analogy" style="font-size:13.5px;line-height:1.75">
            <div class="skel w100"></div><div class="skel w70" style="width:70%"></div>
          </div>
        </div>
        <div class="summary-box" id="stream_summary" style="min-height:44px">
          <div class="skel w100"></div><div class="skel w60"></div>
        </div>
        <div class="meta-row">
          <div class="skel" style="width:140px;height:26px;border-radius:20px"></div>
          <div class="skel" style="width:100px;height:26px;border-radius:20px"></div>
          <div class="skel" style="width:110px;height:26px;border-radius:20px"></div>
        </div>
        <div id="stream_complexity" style="font-size:13px;line-height:1.7;color:var(--text-secondary);padding:2px 0 8px">
          <div class="skel w80"></div><div class="skel w60"></div>
        </div>
        <div style="padding:10px 0 6px;color:var(--text-secondary);font-size:12px;font-style:italic;text-align:center">â³ Code & explanation loadingâ€¦</div>
      </div>`;
  } else {
    area.innerHTML = `
      <div style="padding-top:16px">
        <div class="skel-block info-block blue" style="min-height:80px">
          <div class="section-label" style="color:var(--blue)">ğŸ§  How to approach this</div>
          <div id="stream_thought" style="font-size:13.5px;line-height:1.75">
            <div class="skel w100"></div><div class="skel w80"></div><div class="skel w60"></div>
          </div>
        </div>
        <div class="summary-box" id="stream_problem" style="min-height:44px">
          <div class="skel w100"></div><div class="skel w70" style="width:70%"></div>
        </div>
        <div style="padding:10px 0 6px;color:var(--text-secondary);font-size:12px;font-style:italic;text-align:center">â³ Full architecture loadingâ€¦</div>
      </div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCodingPrompt() {
  const d = { interview:'Crisp, confident, precise. Anticipate interviewer follow-ups.', explain:'Conversational, practical, real-world trade-offs.', beginner:'Simple language, no jargon, vivid analogies.' };
  return `You are an elite Java coding coach. Context: ${d[currentDepth]}
Return ONLY valid JSON (no markdown, no preamble, start with {):
{"summary":"One confident sentence as if user just thought of it","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences WHY the complexity is what it is","pattern":"Algorithm pattern","approach":"Core technique","thought_process":"4-5 sentences: aha moment, why naive fails, why this clicks. First person.","analogy":"Vivid 2-3 sentence real-world analogy.","code":"Complete clean well-commented Java code","steps":[{"title":"title","what":"1-2 sentences","how":"code mechanics with backtick \`varName\` formatting","why":"reasoning not mechanics"}],"tricky_parts":[{"issue":"gotcha","explanation":"why tricky, how handled"}],"followup_qa":[{"question":"realistic follow-up","answer":"confident 2-4 sentence answer"}],"alternatives":[{"name":"approach","complexity":"Time/Space","when_to_use":"when better/worse","verdict":"better|tradeoff|worse"}]}
5-6 steps, 2-3 tricky_parts, 4 followup_qa, 2-3 alternatives.`;
}

function getSysDesignPrompt() {
  const d = { senior:'Senior/Staff level. Deep trade-offs, justify every choice, scale numbers.', mid:'Mid-level. Clear architecture, solid reasoning, key trade-offs.', walkthrough:'Deep walkthrough. Explain every component as if teaching.' };
  return `You are a MAANG Staff Engineer expert in Hello Interview system design delivery framework. Produce a world-class MAANG-grade system design answer.
Context: ${d[currentDepth]}
Return ONLY valid JSON (no markdown, no preamble, start with {):
{"problem_statement":"Restated clearly","thought_process":"4-5 sentences: interview approach, what to clarify, traps to avoid","functional_requirements":[{"req":"Users should be able to...","priority":"core|nice-to-have","note":"rationale"}],"non_functional_requirements":[{"req":"NFR","value":"specific number e.g. 99.99% uptime","why":"why it matters"}],"out_of_scope":["item"],"capacity_estimation":{"assumptions":["100M DAU","10 reads/user/day"],"qps":"reads: X/s, writes: Y/s","storage":"Z TB/year with reasoning","bandwidth":"ingress/egress"},"api_design":[{"method":"GET|POST|PUT|DELETE","endpoint":"/api/v1/...","request":"key params","response":"key fields","notes":"auth, rate limit"}],"data_model":{"entities":[{"name":"Table","fields":"id, user_id, ...","storage":"PostgreSQL|DynamoDB|Cassandra","why":"reason"}],"indexing":["index with rationale"],"sharding_strategy":"how and why"},"high_level_design":{"components":[{"name":"Component","role":"what it does","technology":"specific tech","why":"why this tech"}],"ascii_diagram":"ASCII art of full architecture with â†’ arrows","data_flow":"1. Client â†’ 2. LB â†’ 3. Service..."},"deep_dives":[{"topic":"Challenge title","problem":"what breaks at scale","solution":"specific solution with tech","trade_offs":"what you give up"}],"trade_offs":[{"decision":"decision made","chosen":"what chosen","alternatives":"what else","why_chosen":"key reason","verdict":"recommended|tradeoff|situational"}],"followup_qa":[{"question":"interviewer follow-up","answer":"confident 2-4 sentence answer"}],"speak_guide":{"opening":"how to open interview","key_insight":"the one insight that shows depth","common_mistakes":["mistake 1","mistake 2"],"how_to_close":"how to wrap up confidently"}}
3-4 functional_requirements, 3-4 non_functional_requirements, realistic capacity, 2-3 api_design, 3-5 entities, 4-6 components, 3-4 deep_dives, 3-4 trade_offs, 4-5 followup_qa. Be specific and opinionated.`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel_'+id));
}
function toggleQA(el) { el.classList.toggle('open'); el.nextElementSibling.classList.toggle('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEAK MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSpeakMode() {
  if (!lastResult) return;
  const { mode, data: d } = lastResult;
  let html = '';
  if (mode === 'coding') {
    html += sc('ğŸ§  How I Approached It', d.thought_process);
    html += sc('ğŸ¯ One-Liner', d.summary);
    html += sc('ğŸ’¡ Analogy', d.analogy);
    html += sc('ğŸ”‘ Key Points', (d.steps||[]).map((s,i)=>(i+1)+'. '+s.title+' â€” '+s.why).join('\n'));
    html += sc('âš¡ On Complexity', d.complexity_explanation);
    html += sc('âš ï¸ Gotchas', (d.tricky_parts||[]).map(t=>'â€¢ '+t.issue+': '+String(t.explanation).substring(0,130)).join('\n'));
    html += sc('ğŸ”„ Alternatives', (d.alternatives||[]).map(a=>'â€¢ '+a.name+' ('+a.complexity+') â€” '+a.when_to_use).join('\n'));
  } else {
    const sg = d.speak_guide || {};
    html += sc('ğŸ¬ Opening Statement', sg.opening || '');
    html += sc('ğŸ’¡ Key Insight', sg.key_insight || '');
    html += sc('ğŸ“‹ Requirements', [...(d.functional_requirements||[]).map(r=>'ğŸ”µ '+r.req),'â€”',...(d.non_functional_requirements||[]).map(r=>'â— '+r.req+' ('+r.value+')')].join('\n'));
    html += sc('ğŸ—ï¸ Architecture in Words', d.high_level_design ? d.high_level_design.data_flow : '');
    html += sc('ğŸ”¬ Deep Dives', (d.deep_dives||[]).map(dd=>'â€¢ '+dd.topic+': '+String(dd.solution).substring(0,120)).join('\n'));
    html += sc('âš ï¸ Mistakes to Avoid', (sg.common_mistakes||[]).map(m=>'â€¢ '+m).join('\n'));
    html += sc('ğŸ How to Close', sg.how_to_close || '');
  }
  document.getElementById('speakContent').innerHTML = html;
  document.getElementById('speakOverlay').classList.add('open');
}
function closeSpeakMode() { document.getElementById('speakOverlay').classList.remove('open'); }
function sc(label, text) {
  return '<div class="speak-card"><div class="speak-card-label">'+label+'</div><div class="speak-card-text">'+String(text||'').replace(/\n/g,'<br>')+'</div></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER â€” CODING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hl(code) {
  const kw = ['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h = h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h = h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k => { h = h.replace(new RegExp('\\b('+k+')\\b','g'),'<span style="color:#569cd6">$1</span>'); });
  return h;
}
function rx(t) { return String(t||'').replace(/`([^`]+)`/g,'<code>$1</code>'); }

function renderCoding(d) {
  const area = document.getElementById('responseArea');
  const stepsHTML = (d.steps||[]).map((s,i) =>
    '<div class="card stream-section"><div class="card-head"><div class="card-num">'+(i+1)+'</div><div>'+s.title+'</div></div><div class="card-body">'+rx(s.what)+'<br><br>'+rx(s.how)+'</div><div class="card-sub">ğŸ’¡ Why: '+s.why+'</div></div>'
  ).join('');
  const trickyHTML = (d.tricky_parts||[]).map(t =>
    '<div class="info-block red stream-section"><div class="section-label">âš ï¸ '+t.issue+'</div>'+rx(t.explanation)+'</div>'
  ).join('');
  const qaHTML = (d.followup_qa||[]).map(q =>
    '<div class="qa-item stream-section"><div class="qa-q" onclick="toggleQA(this)"><span>'+q.question+'</span><span class="chevron">â€º</span></div><div class="qa-a">'+rx(q.answer)+'</div></div>'
  ).join('');
  const vl = v => v==='better'?'âœ“ Better':v==='worse'?'âœ— Worse':'â‡„ Trade-off';
  const vc = v => v==='better'?'v-rec':v==='worse'?'v-avoid':'v-alt';
  const altHTML = (d.alternatives||[]).map(a =>
    '<div class="card stream-section"><div class="card-head" style="justify-content:space-between"><span>'+a.name+' <small style="color:var(--text-secondary);font-weight:400">'+a.complexity+'</small></span><span class="verdict-badge '+vc(a.verdict)+'">'+vl(a.verdict)+'</span></div><div class="card-body">'+a.when_to_use+'</div></div>'
  ).join('');

  area.innerHTML =
    tabBar(['overview','Overview','code','Code','walkthrough','Walkthrough','tricky','Gotchas','qa','Q&A','alts','Alternatives']) +
    '<div class="tab-panel active" id="panel_overview">'+
      '<div class="info-block blue stream-section"><div class="section-label">ğŸ§  How I thought about this</div>'+d.thought_process+'</div>'+
      '<div class="info-block green stream-section"><div class="section-label">ğŸ’¡ Real-world analogy</div>'+d.analogy+'</div>'+
      '<div class="summary-box stream-section">'+d.summary+'</div>'+
      '<div class="meta-row"><span class="badge badge-accent">'+d.complexity+'</span><span class="badge badge-blue">'+d.pattern+'</span><span class="badge badge-green">'+d.approach+'</span></div>'+
      '<div style="font-size:13px;line-height:1.7;color:var(--text-secondary);padding:2px 0 16px;">'+d.complexity_explanation+'</div>'+
      '<button class="speak-btn stream-section" onclick="openSpeakMode()">ğŸ“¢ Open Speak Mode</button>'+
    '</div>'+
    '<div class="tab-panel" id="panel_code">'+
      '<div class="code-block stream-section"><div class="code-header"><span class="code-lang">Java</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-content"><pre>'+hl(d.code)+'</pre></div></div>'+
    '</div>'+
    '<div class="tab-panel" id="panel_walkthrough"><div class="card-list">'+stepsHTML+'</div></div>'+
    '<div class="tab-panel" id="panel_tricky"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing these makes you sound thorough.</p>'+trickyHTML+'</div>'+
    '<div class="tab-panel" id="panel_qa"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Tap to reveal a confident answer.</p>'+qaHTML+'</div>'+
    '<div class="tab-panel" id="panel_alts"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Mentioning trade-offs signals real depth.</p><div class="card-list">'+altHTML+'</div></div>';

  area._rawCode = d.code;
  area.classList.add('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER â€” SYSTEM DESIGN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSysDesign(d) {
  const area = document.getElementById('responseArea');
  const hd = d.high_level_design || {};
  const dm = d.data_model || {};
  const cap = d.capacity_estimation || {};
  const sg = d.speak_guide || {};

  const funcReqs = (d.functional_requirements||[]).map(r =>
    '<div class="highlight-row stream-section"><strong>'+(r.priority==='core'?'ğŸ”µ':'âšª')+' '+r.req+'</strong>'+(r.note?'<br><span style="font-size:12px;color:var(--text-secondary)">'+r.note+'</span>':'')+'</div>'
  ).join('');
  const nfrs = (d.non_functional_requirements||[]).map(r =>
    '<div class="highlight-row stream-section"><strong>'+r.req+'</strong> <span class="badge badge-accent">'+r.value+'</span><br><span style="font-size:12px;color:var(--text-secondary)">'+r.why+'</span></div>'
  ).join('');
  const oos = (d.out_of_scope||[]).map(o => '<span class="pill">âœ— '+o+'</span>').join('');
  const capHTML = cap.assumptions ? `
    <div class="sub-label">Assumptions</div>${(cap.assumptions||[]).map(a=>'<div class="highlight-row stream-section">'+a+'</div>').join('')}
    <div class="sub-label">Numbers</div>
    <div class="card stream-section"><div class="card-body"><strong>QPS:</strong> ${cap.qps||'â€”'}<br><strong>Storage:</strong> ${cap.storage||'â€”'}<br><strong>Bandwidth:</strong> ${cap.bandwidth||'â€”'}</div></div>` : '';

  const apiHTML = (d.api_design||[]).map(a =>
    '<div class="card stream-section" style="margin-bottom:10px"><div class="card-head"><span class="badge badge-blue" style="font-family:monospace">'+a.method+'</span> <code style="font-family:monospace;font-size:13px">'+a.endpoint+'</code></div><div class="card-body"><strong>Request:</strong> '+a.request+'<br><strong>Response:</strong> '+a.response+(a.notes?'<br><span style="color:var(--text-secondary)">'+a.notes+'</span>':'')+'</div></div>'
  ).join('');

  const entitiesHTML = (dm.entities||[]).map(e =>
    '<div class="card stream-section" style="margin-bottom:10px"><div class="card-head">'+e.name+' <span class="badge badge-purple" style="margin-left:6px">'+e.storage+'</span></div><div class="card-body"><code style="font-size:11.5px;word-break:break-all">'+e.fields+'</code><div class="card-sub" style="margin-top:6px">Why '+e.storage+': '+e.why+'</div></div></div>'
  ).join('');
  const indexHTML = (dm.indexing||[]).map(i => '<div class="highlight-row stream-section">'+i+'</div>').join('');

  const compHTML = (hd.components||[]).map(c =>
    '<div class="card stream-section" style="margin-bottom:10px"><div class="card-head">'+c.name+' <span class="badge badge-blue" style="margin-left:6px">'+c.technology+'</span></div><div class="card-body">'+c.role+'<div class="card-sub">Why: '+c.why+'</div></div></div>'
  ).join('');
  const diagHTML = hd.ascii_diagram ? '<div class="diagram-box stream-section">'+eh(hd.ascii_diagram)+'</div>' : '';
  const flowHTML = hd.data_flow ? '<div class="info-block blue stream-section"><div class="section-label">ğŸ“¡ Data Flow</div>'+hd.data_flow.replace(/\n/g,'<br>')+'</div>' : '';

  const deepHTML = (d.deep_dives||[]).map(dd =>
    '<div class="card stream-section" style="margin-bottom:12px"><div class="card-head">ğŸ”¬ '+dd.topic+'</div><div class="sub-label" style="margin-top:4px">The Problem</div><div class="card-body">'+dd.problem+'</div><div class="sub-label">The Solution</div><div class="card-body">'+dd.solution+'</div><div class="card-warn">â‡„ Trade-off: '+dd.trade_offs+'</div></div>'
  ).join('');

  const tradeRows = (d.trade_offs||[]).map(t =>
    '<tr><td><strong>'+t.decision+'</strong></td><td>'+t.chosen+'</td><td>'+t.alternatives+'</td><td><span class="verdict-badge '+(t.verdict==='recommended'?'v-rec':t.verdict==='tradeoff'?'v-alt':'v-avoid')+'">'+(t.verdict==='recommended'?'âœ“ Pick':t.verdict==='tradeoff'?'â‡„ Depends':'âš  Avoid')+'</span></td></tr>'
  ).join('');

  const qaHTML = (d.followup_qa||[]).map(q =>
    '<div class="qa-item stream-section"><div class="qa-q" onclick="toggleQA(this)"><span>'+q.question+'</span><span class="chevron">â€º</span></div><div class="qa-a">'+q.answer+'</div></div>'
  ).join('');

  area.innerHTML =
    tabBar(['overview','Overview','requirements','Requirements','api','API Design','datamodel','Data Model','architecture','Architecture','deepdives','Deep Dives','tradeoffs','Trade-offs','qa','Q&A']) +

    '<div class="tab-panel active" id="panel_overview">'+
      '<div class="info-block blue stream-section"><div class="section-label">ğŸ§  How to approach this</div>'+d.thought_process+'</div>'+
      '<div class="summary-box stream-section">'+d.problem_statement+'</div>'+
      '<div class="sub-label">Core Requirements</div>'+(d.functional_requirements||[]).filter(r=>r.priority==='core').map(r=>'<div class="highlight-row stream-section">ğŸ”µ '+r.req+'</div>').join('')+
      '<div class="sub-label">Key NFRs</div>'+(d.non_functional_requirements||[]).map(r=>'<div class="highlight-row stream-section">â— '+r.req+' <span class="badge badge-accent">'+r.value+'</span></div>').join('')+
      '<button class="speak-btn stream-section" style="margin-top:16px" onclick="openSpeakMode()">ğŸ“¢ Open Speak Mode</button>'+
    '</div>'+

    '<div class="tab-panel" id="panel_requirements">'+
      '<div class="sub-label">ğŸ”µ Functional Requirements</div>'+funcReqs+
      '<div class="sub-label">â— Non-Functional Requirements</div>'+nfrs+
      '<div class="sub-label">âœ— Out of Scope</div><div class="pill-row">'+oos+'</div>'+
      '<div class="divider"></div><div class="sub-label">ğŸ“Š Capacity Estimation</div>'+capHTML+
    '</div>'+

    '<div class="tab-panel" id="panel_api"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing your APIs shows you think in contracts.</p>'+apiHTML+'</div>'+

    '<div class="tab-panel" id="panel_datamodel">'+
      '<div class="sub-label">Entities & Storage</div>'+entitiesHTML+
      '<div class="sub-label">Indexes</div>'+indexHTML+
      '<div class="sub-label">Sharding Strategy</div>'+
      '<div class="info-block purple stream-section"><div class="section-label">ğŸ”€ Sharding</div>'+(dm.sharding_strategy||'N/A')+'</div>'+
    '</div>'+

    '<div class="tab-panel" id="panel_architecture">'+diagHTML+flowHTML+'<div class="sub-label">Components</div>'+compHTML+'</div>'+

    '<div class="tab-panel" id="panel_deepdives"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Bring these up proactively â€” they separate senior from mid-level.</p>'+deepHTML+'</div>'+

    '<div class="tab-panel" id="panel_tradeoffs"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing why you chose what you chose signals real experience.</p><div style="overflow-x:auto"><table class="tradeoff-table"><thead><tr><th>Decision</th><th>Chosen</th><th>Alternatives</th><th>Verdict</th></tr></thead><tbody>'+tradeRows+'</tbody></table></div></div>'+

    '<div class="tab-panel" id="panel_qa"><p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Tap to reveal a confident answer.</p>'+qaHTML+'</div>';

  area.classList.add('visible');
  setTimeout(() => area.scrollIntoView({behavior:'smooth',block:'start'}), 100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tabBar(pairs) {
  let t = '<div class="tab-bar">';
  for (let i = 0; i < pairs.length; i += 2)
    t += '<div class="tab'+(i===0?' active':'')+'" data-tab="'+pairs[i]+'" onclick="switchTab(\''+pairs[i]+'\')">'+pairs[i+1]+'</div>';
  return t + '</div>';
}
function eh(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function copyCode(btn) {
  const a = document.getElementById('responseArea');
  navigator.clipboard.writeText(a._rawCode||'').then(()=>{ btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',1500); });
}
document.getElementById('transcriptBox').addEventListener('input', updateGenerateBtn);
</script>
</body>
</html>
