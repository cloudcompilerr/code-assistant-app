<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#faf9f7;--sf:#ffffff;--br:#e8e5e0;
  --tp:#1a1916;--ts:#7a7670;
  --ac:#c8a96e;--as:#f5f0e8;
  --cdbg:#1a1917;--cdtx:#e8e4dc;
  --green:#3d7a52;--blue:#2d5fa0;--red:#8a3a3a;--purple:#6040a0;--orange:#b06020;
  --gs:#eaf3ee;--bs:#e8f0fb;--rs:#faeaea;--ps:#f2edfb;--os:#fdf0e4;
}
body{font-family:-apple-system,sans-serif;background:var(--bg);color:var(--tp);min-height:100vh;max-width:720px;margin:0 auto;padding:0 0 80px;}

/* LIST */
.app-header{padding:52px 24px 14px;border-bottom:1px solid var(--br);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(250,249,247,.93);}
.app-title{font-size:28px;font-weight:700;letter-spacing:-.5px;}
.note-count{font-size:13px;color:var(--ts);margin-top:3px;}
.note-row{padding:16px 24px;border-bottom:1px solid var(--br);display:flex;gap:14px;align-items:flex-start;cursor:pointer;width:100%;background:none;border-left:none;border-right:none;border-top:none;text-align:left;}
.note-row:active{background:var(--as);}
.note-icon{width:40px;height:40px;border-radius:10px;background:var(--as);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;}
.note-preview{flex:1;min-width:0;}
.note-title{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--tp);}
.note-snippet{font-size:13px;color:var(--ts);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.note-date{font-size:12px;color:var(--ts);flex-shrink:0;margin-top:2px;}

/* DETAIL */
.note-detail{display:none;min-height:100vh;}
.note-detail.open{display:block;}
.detail-header{padding:13px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--br);position:sticky;top:0;background:rgba(250,249,247,.96);backdrop-filter:blur(20px);z-index:10;}
.back-btn{color:var(--ac);font-size:17px;font-weight:600;border:none;background:none;padding:6px 4px;min-width:56px;cursor:pointer;}
.detail-title{flex:1;font-size:14px;font-weight:600;text-align:center;}
.gear-btn{font-size:20px;border:none;background:none;padding:6px;min-width:40px;color:var(--ac);cursor:pointer;}

/* SETUP */
.setup-box{margin:12px 20px;padding:14px;background:var(--as);border:1px solid rgba(200,169,110,.3);border-radius:12px;}
.setup-box input{width:100%;padding:9px 11px;border:1px solid var(--br);border-radius:8px;font-size:13px;font-family:monospace;background:#fff;color:var(--tp);outline:none;margin-bottom:7px;-webkit-appearance:none;}
.setup-box button{width:100%;padding:9px;background:var(--tp);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;}
.setup-lbl{font-size:12px;font-weight:600;margin-bottom:5px;}
.setup-desc{font-size:11px;color:var(--ts);margin-bottom:8px;line-height:1.5;}

/* MODE */
.mode-row{display:flex;margin:12px 20px 8px;background:var(--br);border-radius:11px;padding:3px;gap:2px;}
.mode-btn{flex:1;padding:8px 6px;border-radius:8px;border:none;font-size:11.5px;font-weight:700;cursor:pointer;transition:all .18s;background:none;color:var(--ts);}
.mode-btn.on{background:var(--sf);color:var(--tp);box-shadow:0 1px 4px rgba(0,0,0,.12);}

/* VOICE */
.voice-wrap{margin:0 20px 6px;background:var(--sf);border:1px solid var(--br);border-radius:14px;overflow:hidden;}
.voice-top{padding:10px 14px 8px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--br);}
.vlbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);}
.vtimer{font-size:12px;color:var(--ts);font-variant-numeric:tabular-nums;}
.mic-wrap{display:flex;justify-content:center;padding:16px 0 4px;}
.mic-btn{width:68px;height:68px;border-radius:50%;background:var(--as);border:2px solid rgba(200,169,110,.4);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;}
.mic-btn:active{transform:scale(.92);}
.mic-btn.on{background:#fff0f0;border-color:rgba(200,60,60,.5);animation:mPulse 1s ease-in-out infinite;}
@keyframes mPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.waveform{display:none;align-items:flex-end;justify-content:center;gap:3px;height:26px;margin:3px auto 0;width:100px;}
.waveform.on{display:flex;}
.wb{width:4px;border-radius:2px;background:var(--ac);animation:wv .9s infinite ease-in-out;}
.wb:nth-child(1){animation-delay:0s}.wb:nth-child(2){animation-delay:.1s}.wb:nth-child(3){animation-delay:.2s}.wb:nth-child(4){animation-delay:.3s}.wb:nth-child(5){animation-delay:.2s}.wb:nth-child(6){animation-delay:.1s}.wb:nth-child(7){animation-delay:0s}
@keyframes wv{0%,100%{height:4px;opacity:.4}50%{height:22px;opacity:1}}
.vstatus{text-align:center;font-size:12.5px;color:var(--ts);padding:5px 14px 3px;font-style:italic;min-height:24px;}
.vstatus.on{color:#c0392b;font-style:normal;font-weight:500;}
.tbox{margin:7px 14px 11px;padding:10px 12px;background:var(--bg);border:1px solid var(--br);border-radius:9px;font-size:14px;line-height:1.65;color:var(--tp);min-height:48px;outline:none;-webkit-user-select:text;user-select:text;}
.tbox:empty::before{content:attr(data-ph);color:var(--ts);font-style:italic;}
.vactions{display:flex;gap:8px;padding:0 14px 14px;}
.btn-cl{flex:1;padding:10px;border-radius:8px;font-size:13px;font-weight:600;border:1.5px solid var(--br);background:var(--bg);color:var(--ts);cursor:pointer;}
.btn-go{flex:2;padding:10px;border-radius:8px;font-size:13px;font-weight:700;border:none;background:var(--tp);color:#fff;cursor:pointer;}
.btn-go:disabled{opacity:.35;cursor:not-allowed;}

/* CHIPS */
.chips{display:flex;gap:7px;padding:8px 20px 10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.chips::-webkit-scrollbar{display:none;}
.chip{padding:6px 13px;border-radius:20px;font-size:11.5px;font-weight:600;border:1.5px solid var(--br);background:var(--sf);color:var(--ts);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.chip.on{background:var(--tp);color:#fff;border-color:var(--tp);}

/* STREAM */
.sprog{display:none;margin:0 20px 2px;height:2px;background:var(--br);border-radius:2px;overflow:hidden;}
.sprog.on{display:block;}
.sbar{height:100%;background:linear-gradient(90deg,var(--ac),#e8c878);border-radius:2px;width:0%;transition:width .4s ease;}

/* THINKING */
.thinking{display:none;padding:14px 20px;align-items:center;gap:10px;}
.thinking.on{display:flex;}
.dots{display:flex;gap:4px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--ac);animation:pulse 1.2s infinite;}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{transform:scale(1);opacity:.5}40%{transform:scale(1.3);opacity:1}}
.ttext{font-size:12.5px;color:var(--ts);font-style:italic;}

/* RESPONSE */
.rarea{padding:0 20px 40px;display:none;}
.rarea.on{display:block;}

/* PRIMARY TABS */
.ptabs{display:flex;border-bottom:1px solid var(--br);margin:0 -20px;padding:0 10px;overflow-x:auto;margin-top:14px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.ptabs::-webkit-scrollbar{display:none;}
.ptab{padding:9px 11px;font-size:11.5px;font-weight:700;color:var(--ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;}
.ptab.on{color:var(--tp);border-bottom-color:var(--ac);}
.ppanel{display:none;padding-top:14px;}
.ppanel.on{display:block;}

/* SUB-TABS */
.stab-row{display:flex;margin:10px -20px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;background:var(--sf);border-bottom:1px solid var(--br);}
.stab-row::-webkit-scrollbar{display:none;}
.stab{padding:8px 11px;font-size:10.5px;font-weight:700;color:var(--ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:4px;}
.stab.on{color:var(--blue);border-bottom-color:var(--blue);}
.sn{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(--br);color:var(--ts);font-size:9px;font-weight:800;flex-shrink:0;}
.stab.on .sn{background:var(--blue);color:#fff;}
.step-t{font-size:9px;font-weight:400;color:var(--ts);margin-left:2px;}
.spanel{display:none;padding-top:12px;}
.spanel.on{display:block;}

/* CONTENT BLOCKS */
.iblock{border-radius:0 10px 10px 0;padding:13px 15px;font-size:13px;line-height:1.75;margin-bottom:11px;}
.iblock.blue{background:var(--bs);border-left:3px solid var(--blue);}
.iblock.green{background:var(--gs);border-left:3px solid var(--green);}
.iblock.red{background:var(--rs);border-left:3px solid var(--red);}
.iblock.purple{background:var(--ps);border-left:3px solid var(--purple);}
.iblock.orange{background:var(--os);border-left:3px solid var(--orange);}
.blbl{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.iblock.blue .blbl{color:var(--blue);}
.iblock.green .blbl{color:var(--green);}
.iblock.red .blbl{color:var(--red);}
.iblock.purple .blbl{color:var(--purple);}
.iblock.orange .blbl{color:var(--orange);}

.sumbox{background:var(--as);border:1px solid rgba(200,169,110,.3);border-radius:10px;padding:14px;font-size:14px;line-height:1.7;margin-bottom:12px;}
.mrow{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.badge{font-size:10.5px;padding:3px 9px;border-radius:20px;font-weight:600;}
.bb{background:var(--bs);color:var(--blue);border:1px solid rgba(45,95,160,.2);}
.bg{background:var(--gs);color:var(--green);border:1px solid rgba(61,122,82,.2);}
.ba{background:var(--as);color:var(--ac);border:1px solid rgba(200,169,110,.3);}
.bp{background:var(--ps);color:var(--purple);border:1px solid rgba(96,64,160,.2);}
.bo{background:var(--os);color:var(--orange);border:1px solid rgba(176,96,32,.2);}

.sublbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);margin:16px 0 7px;}
.hrow{background:var(--as);border:1px solid rgba(200,169,110,.22);border-radius:8px;padding:9px 13px;margin-bottom:7px;font-size:13px;line-height:1.6;}
.pill-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.pill{font-size:11.5px;padding:3px 11px;border-radius:20px;border:1px solid var(--br);background:var(--sf);color:var(--tp);font-weight:500;}
.divider{height:1px;background:var(--br);margin:14px 0;}

/* CARD */
.card{background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:13px;margin-bottom:9px;}
.card-head{font-size:13px;font-weight:700;margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}
.cnum{width:22px;height:22px;border-radius:50%;background:var(--ac);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.card-body{font-size:12.5px;line-height:1.65;}
.card-body code{font-family:monospace;font-size:11px;background:var(--as);padding:1px 4px;border-radius:3px;}
.card-sub{font-size:11.5px;color:var(--blue);margin-top:5px;font-style:italic;}
.card-warn{font-size:11.5px;color:var(--red);margin-top:5px;}

/* TECH CARD with inline alts */
.tech-card{background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:13px;margin-bottom:10px;}
.tech-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.tech-name{font-size:13.5px;font-weight:700;}
.chosen-tag{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700;background:var(--gs);color:var(--green);}
.tech-role{font-size:12.5px;line-height:1.6;color:var(--tp);margin-bottom:3px;}
.tech-why{font-size:12px;line-height:1.6;color:var(--ts);margin-bottom:8px;border-left:2px solid var(--green);padding-left:8px;}
.alt-lbl{font-size:9.5px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--ts);margin-bottom:5px;}
.alt-row{display:flex;align-items:flex-start;gap:7px;padding:6px 9px;background:var(--bg);border-radius:7px;margin-bottom:4px;border:1px solid var(--br);}
.alt-name{font-size:12px;font-weight:600;flex-shrink:0;min-width:90px;}
.av{font-size:9.5px;padding:2px 7px;border-radius:7px;font-weight:700;flex-shrink:0;white-space:nowrap;}
.av-ok{background:var(--bs);color:var(--blue);}
.av-trade{background:var(--os);color:var(--orange);}
.av-avoid{background:var(--rs);color:var(--red);}
.alt-why{font-size:11.5px;color:var(--ts);line-height:1.5;}

/* DIAGRAM â€” two diagrams stacked, pre-wrap so no horizontal scroll */
.diag-wrap{margin-bottom:14px;}
.diag-label{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ts);margin-bottom:5px;display:flex;align-items:center;gap:6px;}
.diag-pill{font-size:9px;padding:2px 7px;border-radius:10px;background:var(--bs);color:var(--blue);font-weight:600;}
.diagram{background:var(--cdbg);border-radius:12px;padding:14px 16px;font-family:'SF Mono',monospace;font-size:11.5px;line-height:1.9;color:#c8c4bc;white-space:pre-wrap;word-break:break-word;overflow-x:auto;}
/* colour accents inside diagram */
.diagram .chosen{color:#7ec87e;}
.diagram .alt{color:#e8c878;}

/* CODE â€” pre-wrap no horizontal scroll */
.code-outer{background:var(--cdbg);border-radius:12px;overflow:hidden;margin-bottom:10px;}
.code-hdr{padding:9px 14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.08);}
.code-lang{font-size:10px;color:#8a8580;font-family:monospace;letter-spacing:.05em;}
.copy-btn{font-size:11px;color:var(--ac);background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:4px;font-weight:500;}
.code-body{padding:14px;}
.code-body pre{font-family:'SF Mono',monospace;font-size:12px;line-height:1.7;color:var(--cdtx);white-space:pre-wrap;word-break:break-word;}

/* Q&A */
.qa-item{border:1px solid var(--br);border-radius:10px;overflow:hidden;margin-bottom:9px;}
.qa-q{padding:12px 14px;font-size:13px;font-weight:600;background:var(--sf);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px;}
.chev{color:var(--ts);transition:transform .2s;font-size:13px;flex-shrink:0;}
.chev.open{transform:rotate(90deg);}
.qa-a{display:none;padding:11px 14px;font-size:12.5px;line-height:1.7;background:var(--bg);border-top:1px solid var(--br);}
.qa-a.open{display:block;}

/* SKELETON shimmer */
.skel{background:linear-gradient(90deg,var(--br) 25%,var(--as) 50%,var(--br) 75%);background-size:200% 100%;animation:sk 1.2s infinite;border-radius:5px;height:13px;margin-bottom:7px;}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* SPEAK MODE */
#sovl{display:none;position:fixed;inset:0;background:rgba(12,11,10,.97);z-index:999;flex-direction:column;padding:60px 22px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
#sovl.on{display:flex;}
.sovl-close{position:fixed;top:16px;right:18px;color:var(--ac);font-size:26px;cursor:pointer;background:none;border:none;z-index:1000;padding:8px;}
.sovl-title{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--ac);margin-bottom:18px;}
.sc{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:13px;padding:16px 18px;margin-bottom:13px;}
.sc-lbl{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ac);margin-bottom:8px;}
.sc-txt{font-size:15px;line-height:1.9;color:#ede9e2;}

.spk-btn{width:100%;padding:12px;background:var(--as);border:1.5px solid rgba(200,169,110,.4);border-radius:9px;font-size:13px;font-weight:600;color:var(--tp);cursor:pointer;margin-top:4px;}
.err-box{background:#fff0f0;border:1px solid #ffcccc;border-radius:9px;padding:13px 15px;font-size:13px;color:#c0392b;margin-top:10px;}
.fadein{animation:fadeIn .3s ease forwards;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.toast{position:fixed;bottom:36px;left:50%;transform:translateX(-50%);background:#1a1916;color:#fff;padding:8px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .25s;white-space:nowrap;pointer-events:none;}
</style>
</head>
<body>

<!-- LIST -->
<div id="list">
  <div class="app-header">
    <div class="app-title">Notes</div>
    <div class="note-count">4 notes</div>
  </div>
  <div style="padding:6px 0">
    <button class="note-row" id="btn_coding">
      <div class="note-icon">â˜•</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ Java</div><div class="note-snippet">Tap to solve a coding problemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" id="btn_sd">
      <div class="note-icon">ğŸ—ï¸</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ System Design</div><div class="note-snippet">Tap to design a systemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“‹</div>
      <div class="note-preview"><div class="note-title">Meeting notes â€“ Product sync</div><div class="note-snippet">Roadmap priorities, Q2 milestones</div></div>
      <div class="note-date">Mon</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“</div>
      <div class="note-preview"><div class="note-title">Grocery list</div><div class="note-snippet">Eggs, bread, olive oil, tomatoesâ€¦</div></div>
      <div class="note-date">Sun</div>
    </button>
  </div>
</div>

<!-- TOOL -->
<div id="tool" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">â€¹ Notes</button>
    <div class="detail-title" id="dtitle">Quick Ref</div>
    <button class="gear-btn" onclick="toggleSetup()">âš™ï¸</button>
  </div>

  <div id="setup" class="setup-box" style="display:none;margin-top:12px">
    <div class="setup-lbl">ğŸ”‘ API Key</div>
    <div class="setup-desc">Stored locally â€” never sent anywhere except Anthropic.</div>
    <input type="password" id="apikey" placeholder="sk-ant-â€¦" autocomplete="off"/>
    <button onclick="saveKey()">Save & Close</button>
  </div>

  <div class="mode-row">
    <button class="mode-btn on" id="mCoding" onclick="setMode('coding')">â˜• Java Coding</button>
    <button class="mode-btn" id="mSD" onclick="setMode('sd')">ğŸ—ï¸ System Design</button>
  </div>

  <div class="voice-wrap">
    <div class="voice-top">
      <span class="vlbl" id="vlbl">ğŸ™ Speak your coding problem</span>
      <span class="vtimer" id="vtimer"></span>
    </div>
    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ™ï¸</button>
    </div>
    <div class="waveform" id="wf">
      <div class="wb" style="height:5px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:25px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:5px"></div>
    </div>
    <div class="vstatus" id="vs">Tap the mic and speak clearly</div>
    <div class="tbox" id="tbox" contenteditable="true" spellcheck="false" data-ph="Tap mic to speakâ€¦"></div>
    <div class="vactions">
      <button class="btn-cl" onclick="clearAll()">Clear</button>
      <button class="btn-go" id="goBtn" onclick="generate()" disabled>Generate âš¡</button>
    </div>
  </div>

  <div class="chips" id="chips">
    <div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
    <div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
    <div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>
  </div>

  <div class="sprog" id="sprog"><div class="sbar" id="sbar"></div></div>
  <div class="thinking" id="thinking"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div class="ttext" id="ttext">Thinkingâ€¦</div></div>
  <div class="rarea" id="rarea"></div>
</div>

<!-- SPEAK MODE -->
<div id="sovl">
  <button class="sovl-close" onclick="closeSM()">âœ•</button>
  <div class="sovl-title">ğŸ“¢ How to Explain This</div>
  <div id="smc"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â• STATE â•â•â• */
const SK='nt_v6';
let mode='coding',depth='interview',last=null;
let rec=null,listening=false,silT=null,timerI=null,elapsed=0,accTxt='';

/* â•â•â• KEY â•â•â• */
let _memKey='';
const getKey=()=>{try{return localStorage.getItem(SK)||_memKey;}catch(e){return _memKey;}};
const setKey=v=>{_memKey=v;try{localStorage.setItem(SK,v);}catch(e){}};
function saveKey(){const v=document.getElementById('apikey').value.trim();if(!v){toast('Enter a key');return;}setKey(v);document.getElementById('setup').style.display='none';toast('Saved âœ“');}
function toggleSetup(){const s=document.getElementById('setup');const show=s.style.display==='none';s.style.display=show?'block':'none';if(show&&getKey())document.getElementById('apikey').value=getKey();}

/* â•â•â• NAV â•â•â• */
function openTool(m){document.getElementById('list').style.display='none';document.getElementById('tool').classList.add('open');setMode(m);if(!getKey())document.getElementById('setup').style.display='block';}
function goBack(){stopMic(false);document.getElementById('tool').classList.remove('open');document.getElementById('list').style.display='block';clearAll();last=null;}

/* â•â•â• MODE â•â•â• */
function setMode(m){
  mode=m;
  document.getElementById('mCoding').classList.toggle('on',m==='coding');
  document.getElementById('mSD').classList.toggle('on',m==='sd');
  document.getElementById('dtitle').textContent=m==='coding'?'Java Coding':'System Design';
  document.getElementById('vlbl').textContent=m==='coding'?'ğŸ™ Speak your coding problem':'ğŸ™ Describe the system to design';
  document.getElementById('tbox').setAttribute('data-ph',m==='coding'?'Tap mic to speak your problemâ€¦':'e.g. "Design Twitter" or "Design a URL shortener"');
  const ch=document.getElementById('chips');
  if(m==='sd'){ch.innerHTML=`<div class="chip on" data-d="senior" onclick="setDepth(this)">ğŸ¯ Senior/Staff</div><div class="chip" data-d="mid" onclick="setDepth(this)">ğŸ‘¨â€ğŸ’» Mid-level</div><div class="chip" data-d="deep" onclick="setDepth(this)">ğŸ“– Deep Dive</div>`;depth='senior';}
  else{ch.innerHTML=`<div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div><div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div><div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>`;depth='interview';}
  clearAll();
}
function setDepth(el){el.closest('.chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));el.classList.add('on');depth=el.dataset.d;}

/* â•â•â• TOAST / TIMER â•â•â• */
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2400);}
function startTimer(){elapsed=0;clearInterval(timerI);timerI=setInterval(()=>{elapsed++;document.getElementById('vtimer').textContent=pad(Math.floor(elapsed/60))+':'+pad(elapsed%60);},1000);}
function stopTimer(){clearInterval(timerI);document.getElementById('vtimer').textContent='';}
const pad=n=>String(n).padStart(2,'0');

/* â•â•â• MIC â•â•â• */
function toggleMic(){listening?stopMic(true):startMic();}
function startMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('Voice not supported â€” type instead');return;}
  accTxt=document.getElementById('tbox').textContent.trim();
  rec=new SR();rec.continuous=true;rec.interimResults=true;rec.lang='en-US';
  rec.onstart=()=>{listening=true;document.getElementById('micBtn').classList.add('on');document.getElementById('micBtn').textContent='â¹ï¸';document.getElementById('wf').classList.add('on');document.getElementById('vs').textContent='Listeningâ€¦ speak clearly';document.getElementById('vs').classList.add('on');startTimer();};
  rec.onresult=e=>{
    clearTimeout(silT);silT=setTimeout(()=>stopMic(true),2800);
    let fin=accTxt?accTxt+' ':'',int='';
    for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;e.results[i].isFinal?(fin+=t,accTxt=fin.trim()):int=t;}
    document.getElementById('tbox').textContent=(accTxt+(int?' '+int:'')).trim();chkBtn();
  };
  rec.onerror=e=>{if(e.error==='not-allowed')toast('Mic blocked â€” allow in Safari settings');stopMic(false);};
  rec.onend=()=>{if(listening){try{rec.start();}catch(e){stopMic(false);}}};
  try{rec.start();}catch(e){toast('Cannot start mic');}
}
function stopMic(auto){
  const was=listening;listening=false;clearTimeout(silT);stopTimer();
  if(rec){try{rec.stop();}catch(e){}rec=null;}
  document.getElementById('micBtn').classList.remove('on');document.getElementById('micBtn').textContent='ğŸ™ï¸';
  document.getElementById('wf').classList.remove('on');document.getElementById('vs').classList.remove('on');
  const txt=document.getElementById('tbox').textContent.trim();
  if(was&&auto&&txt.length>5){document.getElementById('vs').textContent='Got it â€” generatingâ€¦';setTimeout(generate,500);}
  else{document.getElementById('vs').textContent=txt.length>5?'Ready â€” tap Generate':'Tap the mic and speak clearly';}
}
function chkBtn(){document.getElementById('goBtn').disabled=document.getElementById('tbox').textContent.trim().length<5;}
function clearAll(){accTxt='';document.getElementById('tbox').textContent='';document.getElementById('goBtn').disabled=true;document.getElementById('vs').textContent='Tap the mic and speak clearly';document.getElementById('rarea').innerHTML='';document.getElementById('rarea').classList.remove('on');document.getElementById('thinking').classList.remove('on');document.getElementById('sprog').classList.remove('on');document.getElementById('sbar').style.width='0%';last=null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE â€” STREAMING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generate(){
  const prob=document.getElementById('tbox').textContent.trim();
  if(prob.length<4){toast('Say or type a problem first');return;}
  const key=getKey();if(!key){toggleSetup();toast('Add API key first');return;}
  document.getElementById('goBtn').disabled=true;
  document.getElementById('rarea').innerHTML='';
  document.getElementById('rarea').classList.remove('on');
  document.getElementById('thinking').classList.add('on');
  document.getElementById('ttext').textContent=mode==='coding'?'Solving your problemâ€¦':'Architecting your systemâ€¦';
  document.getElementById('sprog').classList.add('on');
  const bar=document.getElementById('sbar');bar.style.width='5%';
  const sys=mode==='coding'?codingPrompt():sdPrompt();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:mode==='coding'?4500:12000,stream:true,system:sys,messages:[{role:'user',content:prob}]})
    });
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'API error '+res.status);}
    const reader=res.body.getReader(),dec=new TextDecoder();
    let full='',pct=5,dk=new Set(),lineBuf='';
    /* Show skeleton immediately */
    document.getElementById('thinking').classList.remove('on');
    showSkeleton();
    document.getElementById('rarea').classList.add('on');

    while(true){
      const{done,value}=await reader.read();
      /* Flush decoder on final read â€” no stream:true drains internal buffer */
      const chunk=value?dec.decode(value,{stream:true}):(done?dec.decode():'');
      lineBuf+=chunk;
      const lines=lineBuf.split('\n');
      lineBuf=lines.pop()||'';
      for(const ln of lines){
        if(!ln.startsWith('data: '))continue;
        const d=ln.slice(6).trim();
        if(d==='[DONE]')continue;
        try{
          const ev=JSON.parse(d);
          if(ev.type==='content_block_delta'&&ev.delta?.text){
            full+=ev.delta.text;
            pct=Math.min(90,pct+0.15);
            bar.style.width=pct+'%';
            patch(full,dk);
          }
        }catch(e){}
      }
      if(done)break;
    }
    /* Drain any remaining line buffer */
    if(lineBuf.startsWith('data: ')){
      const d=lineBuf.slice(6).trim();
      if(d&&d!=='[DONE]'){try{const ev=JSON.parse(d);if(ev.type==='content_block_delta'&&ev.delta?.text)full+=ev.delta.text;}catch(e){}}
    }

    bar.style.width='100%';
    setTimeout(()=>{document.getElementById('sprog').classList.remove('on');bar.style.width='0%';},500);

    /* Multi-strategy JSON parse */
    let parsed=null;
    const tryP=s=>{try{return JSON.parse(s);}catch(e){return null;}};
    let c=full.trim().replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
    parsed=tryP(c);
    if(!parsed){const fi=c.indexOf('{'),la=c.lastIndexOf('}');if(fi>=0&&la>fi)parsed=tryP(c.slice(fi,la+1));}
    if(!parsed){try{parsed=tryP(c.replace(/,\s*([}\]])/g,'$1'));}catch(e){}}

    if(parsed){
      last={mode,data:parsed};
      mode==='coding'?renderCoding(parsed):renderSD(parsed);
    }else{
      document.getElementById('rarea').innerHTML=
        '<div class="err-box">&#9888; Could not parse response.'+(full.length<50?' Response empty â€” check API key.':' Model returned unexpected format. Tap Generate to retry.')+'<br><br>'+
        '<details><summary style="cursor:pointer;font-weight:600">Show raw response</summary>'+
        '<pre style="white-space:pre-wrap;word-break:break-word;font-size:10px;margin-top:6px;max-height:180px;overflow-y:auto">'+
        full.slice(0,800).replace(/&/g,'&amp;').replace(/</g,'&lt;')+
        '</pre></details></div>';
    }
  }catch(err){
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('rarea').innerHTML='<div class="err-box">âš ï¸ '+err.message+'</div>';
    document.getElementById('rarea').classList.add('on');
    document.getElementById('sprog').classList.remove('on');
  }finally{
    document.getElementById('goBtn').disabled=false;
    document.getElementById('thinking').classList.remove('on');
    document.getElementById('vs').textContent='Tap mic to record again';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAM PATCH â€” renders content progressively as tokens arrive.
   Uses TWO extraction strategies:
   A) strComplete â€” only fires when JSON string is fully closed (safe for short fields)
   B) strPartial  â€” fires as soon as MIN_CHARS arrived (for long fields like thought_process)
   Priority: problem_statement (partial, ~40 chars) â†’ FR items â†’ NFR items â†’ thought_process
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function patch(txt,dk){
  /* A: fully-closed string â€” safe value */
  const strComplete=key=>{
    const m=txt.match(new RegExp('"'+key+'"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*?)"\\s*[,}\\n]','s'));
    return m?unescape(m[1]):null;
  };
  /* B: partial string â€” grab whatever has arrived so far (no closing quote required) */
  const strPartial=(key,minLen=40)=>{
    const m=txt.match(new RegExp('"'+key+'"\\s*:\\s*"((?:[^"\\\\]|\\\\.){'+minLen+',})','s'));
    return m?unescape(m[1]):null;
  };
  const unescape=s=>s.replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\\\/g,'\\');

  /* Write to a named slot, removing skeleton shimmer lines */
  const slot=(id,html)=>{
    const el=document.getElementById(id);
    if(!el||el.dataset.filled)return;
    el.dataset.filled='1';
    el.innerHTML=html;
    el.classList.add('fadein');
  };

  if(mode==='coding'){
    ['thought_process','analogy','summary','complexity'].forEach(k=>{
      if(!dk.has(k)){
        const v=strComplete(k)||strPartial(k,30);
        if(v&&v.length>15){dk.add(k);slot('sk_'+k,v.replace(/\n/g,'<br>'));}
      }
    });
    return;
  }

  /* â”€â”€ SD mode â”€â”€ */

  /* PRIORITY 1: problem_statement â€” partial, fires as soon as ~50 chars arrive (~1s) */
  if(!dk.has('ps')){
    const v=strComplete('problem_statement')||strPartial('problem_statement',50);
    if(v&&v.length>15){dk.add('ps');slot('sk_ps',v);}
  }

  /* PRIORITY 2: functional requirements â€” parse objects as each closes */
  if(!dk.has('fr')){
    const m=txt.match(/"functional"\s*:\s*\[([\s\S]*?)(?:\]|(?="non_functional"))/);
    if(m&&m[1]){
      const reqs=[];let rx2=/"req"\s*:\s*"([^"\\\\]+)"/g,hit;
      while((hit=rx2.exec(m[1]))!==null)reqs.push(hit[1]);
      if(reqs.length>=1){
        dk.add('fr');
        /* Don't lock â€” keep updating until NFR starts */
        const el=document.getElementById('sk_fr');
        if(el){el.innerHTML=reqs.map(r=>'<div class="hrow fadein">ğŸ”µ '+r+'</div>').join('');el.classList.add('fadein');}
      }
    }
  }

  /* PRIORITY 3: NFRs â€” same rolling parse */
  if(!dk.has('nfr')){
    const m=txt.match(/"non_functional"\s*:\s*\[([\s\S]*?)(?:\]|(?="out_of_scope"))/);
    if(m&&m[1]){
      const items=[];let pos=0;
      while(true){
        const s=m[1].indexOf('"req"',pos);if(s<0)break;
        const rM=m[1].slice(s).match(/"req"\s*:\s*"([^"\\\\]+)"/);
        const vM=m[1].slice(s).match(/"value"\s*:\s*"([^"\\\\]+)"/);
        if(rM)items.push({r:rM[1],v:vM?vM[1]:''});
        pos=s+5;
      }
      if(items.length>=1){
        dk.add('nfr');
        const el=document.getElementById('sk_nfr');
        if(el){el.innerHTML=items.map(i=>'<div class="hrow fadein">â— <strong>'+i.r+'</strong>'+(i.v?' <span class="badge ba">'+i.v+'</span>':'')+'</div>').join('');el.classList.add('fadein');}
      }
    }
  }

  /* PRIORITY 4: capacity â€” plain_english text first, then number tiles */
  if(!dk.has('cap_text')){
    const pe=strComplete('plain_english')||strPartial('plain_english',60);
    if(pe&&pe.length>30){
      dk.add('cap_text');
      const el=document.getElementById('sk_cap');
      if(el){el.innerHTML='<div style="font-size:12.5px;line-height:1.75;color:var(--tp)">'+pe+'</div>';el.classList.add('fadein');}
    }
  }
  /* PRIORITY 5: capacity number tiles */
  if(!dk.has('cap')){
    const wq=strComplete('write_qps'), rq=strComplete('read_qps'), st=strComplete('storage_per_year');
    const assM=txt.match(/"assumptions"\s*:\s*\[([\s\S]*?)(?:\])/);
    const assumptions=[];
    if(assM){let rx3=/"([^"]+)"/g,h2;while((h2=rx3.exec(assM[1]))!==null)assumptions.push(h2[1]);}
    if(wq&&rq){
      dk.add('cap');
      const el=document.getElementById('sk_cap');
      if(el){
        el.innerHTML=
          (assumptions.length?assumptions.map(a=>'<div style="font-size:11.5px;color:var(--ts);margin-bottom:3px">â€¢ '+a+'</div>').join(''):'') +
          '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">'+
          '<div style="flex:1;min-width:110px;background:var(--os);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">âœï¸ Write QPS</div><div style="font-size:12px;font-weight:700">'+wq+'</div></div>'+
          '<div style="flex:1;min-width:110px;background:var(--bs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ“– Read QPS</div><div style="font-size:12px;font-weight:700">'+rq+'</div></div>'+
          (st?'<div style="flex:1;min-width:110px;background:var(--gs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ’¾ Storage/yr</div><div style="font-size:12px;font-weight:700">'+st+'</div></div>':'')+
          '</div>';
        el.classList.add('fadein');
      }
    }
  }

  /* PRIORITY 5: thought_process â€” partial after 80 chars (~5-6s) */
  if(!dk.has('tp')){
    const v=strComplete('thought_process')||strPartial('thought_process',80);
    if(v&&v.length>40){dk.add('tp');slot('sk_tp',v.replace(/\n/g,'<br>'));}
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETON â€” shown instantly before any stream arrives
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSkeleton(){
  const a=document.getElementById('rarea');
  if(mode==='coding'){
    a.innerHTML=`<div style="padding-top:12px">
      <div class="iblock blue"><div class="blbl">ğŸ§  Approach</div><div id="sk_thought_process"><div class="skel" style="width:100%"></div><div class="skel" style="width:84%"></div><div class="skel" style="width:66%"></div></div></div>
      <div class="iblock green"><div class="blbl">ğŸ’¡ Analogy</div><div id="sk_analogy"><div class="skel" style="width:100%"></div><div class="skel" style="width:72%"></div></div></div>
      <div class="sumbox" id="sk_summary"><div class="skel" style="width:100%"></div><div class="skel" style="width:55%"></div></div>
      <div id="sk_complexity" style="font-size:12.5px;color:var(--ts);padding:2px 0 10px"><div class="skel" style="width:76%"></div><div class="skel" style="width:52%"></div></div>
      <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:6px 0">â³ Code & walkthrough loadingâ€¦</div></div>`;
  } else {
    a.innerHTML=`<div style="padding-top:12px">
      <!-- Problem statement arrives FIRST ~1-2s -->
      <div class="sumbox" id="sk_ps" style="min-height:52px"><div class="skel" style="width:100%"></div><div class="skel" style="width:68%"></div></div>

      <!-- FRs stream in ~2-3s -->
      <div class="sublbl">ğŸ”µ Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
      <div id="sk_fr"><div class="skel" style="width:90%"></div><div class="skel" style="width:76%"></div><div class="skel" style="width:83%"></div></div>

      <!-- NFRs stream in ~3-4s -->
      <div class="sublbl">â— Non-Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
      <div id="sk_nfr"><div class="skel" style="width:86%"></div><div class="skel" style="width:72%"></div><div class="skel" style="width:79%"></div></div>

      <!-- Capacity numbers stream in ~4-5s -->
      <div class="sublbl">ğŸ“Š Scale Assumptions & QPS</div>
      <div id="sk_cap" style="background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:11px 13px;margin-bottom:10px">
        <div class="skel" style="width:80%;margin-bottom:6px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
          <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
        </div>
      </div>

      <!-- Interview framing ~5-6s -->
      <div class="sublbl">ğŸ§  Interview Framing</div>
      <div class="iblock blue" id="sk_tp"><div class="skel" style="width:100%"></div><div class="skel" style="width:88%"></div><div class="skel" style="width:70%"></div><div class="skel" style="width:80%"></div></div>

      <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:10px 0">â³ Diagrams, components & deep dives loadingâ€¦</div></div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function codingPrompt(){
  const ctx={interview:'Crisp, confident. Anticipate follow-ups.',explain:'Conversational, real-world trade-offs.',beginner:'Simple language, vivid analogies.'}[depth];
  return `Elite Java coding coach. Context: ${ctx}
Return ONLY valid JSON starting with { :
{"summary":"confident one-liner","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences WHY","pattern":"algorithm pattern","approach":"core technique","thought_process":"4-5 sentences first-person: aha moment, why naive fails, why this clicks","analogy":"vivid 2-3 sentence real-world analogy","code":"complete clean well-commented Java â€” use meaningful variable names","steps":[{"title":"title","what":"1-2 sentences","how":"mechanics with backtick \`varName\`","why":"reasoning"}],"tricky_parts":[{"issue":"gotcha","explanation":"why tricky, exactly how handled"}],"followup_qa":[{"question":"realistic question","answer":"confident 3-4 sentence answer"}],"alternatives":[{"name":"approach","complexity":"T/S","when_to_use":"when to prefer","verdict":"better|tradeoff|worse"}]}
5-6 steps, 3 tricky_parts, 5 followup_qa, 3 alternatives.`;
}

function sdPrompt(){
  const lvl={
    senior:'Senior/Staff â€” deep trade-offs, real numbers, justify every choice.',
    mid:'Mid-level â€” clear architecture, solid reasoning on key trade-offs.',
    deep:'Deep walkthrough â€” explain every component as if teaching.'
  }[depth]||'Senior/Staff.';

  return `You are Evan King from Hello Interview. You wrote the definitive FAANG system design guide. Match the quality of your hellointerview.com breakdowns for Uber and Ad Click Aggregator exactly.

LEVEL: ${lvl}

HELLO INTERVIEW FRAMEWORK â€” EXACT STRUCTURE

STEP 1 â€” REQUIREMENTS
FRs: "Users should be able toâ€¦" max 3. Rest go "below the line (out of scope)".
NFRs with specific numbers. From your Ad Click guide: "Scalable to 10k clicks/sec", "Sub-second analytics queries", "Fault tolerant â€” no data loss", "Idempotent click tracking".
Capacity: plain English first. Example: "We design for 10M active ads, peak 10k clicks/sec, 100M clicks/day. At 500B per event thats 18TB/year. At 10k writes/sec PostgreSQL maxes at 5k TPS â€” this drives us to use a queue and stream processor."

STEP 2 â€” CORE ENTITIES (nouns only, no fields)
Like Uber guide: "Rider, Driver, Fare, Ride, Location" â€” one sentence role each. No fields, no schema here.

STEP 3 â€” API / SYSTEM INTERFACE
Data systems: define Input and Output explicitly. Example: "Input: {adId, userId, timestamp, sourceUrl}. Output: {adId, clickCount, timeWindow}."
Product systems: REST endpoints. userId always from JWT not body â€” always say why (client is untrusted).

STEP 4 â€” HLD BUILT ONE FR AT A TIME (exactly like Uber guide)
For each FR: add only components needed for THAT requirement. Walk through request step by step. State one key insight per FR.
Example from Uber (FR: fare estimate):
  what_to_draw: "Client, API Gateway, Ride Service, Maps API, Database"
  narrative: "Ride Service calls Maps for distance/ETA, applies pricing, stores Fare entity, returns to client."
  flow: ["1. Client POSTs /fare", "2. API GW auth to Ride Service", "3. Calls Maps API", "4. Creates Fare in DB", "5. Returns Fare"]
  key_point: "We store Fare so client sends fareId only â€” prevents price tampering since price always comes from our DB."

STEP 5 â€” TWO DIAGRAMS
Diagram 1: baseline satisfying FRs, 6-8 boxes, simple flow.
Diagram 2: evolves Diagram 1 â€” same boxes plus new ones marked with a star. Each new component annotated with arrow and text showing which NFR it satisfies.
Box style: draw boxes with proper box-drawing characters. Label every arrow with what flows on it. Show alternatives in [brackets] on same line as component.

STEP 6 â€” DEEP DIVES: BAD TO GOOD TO GREAT
Always this progression. Example from Ad Click guide:
  BAD Direct DB writes: "PostgreSQL 5k TPS vs 10k clicks/sec = 50 percent data loss."
  GOOD Batch processing: "5s batches cut writes 50x but 5s lag and crash loses the batch."
  GREAT Kafka + Flink + ClickHouse: "Kafka handles 10k/sec partitioned by adId. Flink 1-min tumbling windows with exactly-once semantics. ClickHouse ingests 100k rows/sec. Kafka 7-day retention means Flink replays on crash â€” no data loss."

QUALITY BAR â€” from your actual guides:
Bad: "use a database" / "add a cache" / "use a queue"
Good: "ClickHouse columnar OLAP â€” aggregation on (adId, window_start) runs under 100ms vs seconds on PostgreSQL row scan"
Good: "Redis GEOADD handles 2M location updates/sec, GEOSEARCH finds nearby in O(log N), TTL auto-expires stale drivers after 30s"
Good: "Redis distributed lock 10s TTL â€” if service crashes lock auto-expires, next driver notified, no manual cleanup"

JSON FORMAT â€” return valid JSON starting with {
{
  "problem_statement": "2-3 sentences: what we build, core challenge, dominant constraint",
  "thought_process": "5-6 sentences first-person: what makes this hard, read/write asymmetry, core trade-off, what candidates miss, your planned approach",
  "clarifying_questions": [
    {"q": "What scale â€” DAU or peak QPS?", "why": "changes every architectural decision"},
    {"q": "scope question", "why": "determines which components are needed"},
    {"q": "trade-off question", "why": "surfaces key design decision"}
  ],
  "step1_requirements": {
    "functional": [
      {"req": "Users should be able to [verb] [noun]", "priority": "core", "technical_implication": "specific architectural consequence"}
    ],
    "non_functional": [
      {"req": "Scalable to peak load", "value": "e.g. 10k clicks/sec", "tradeoff": "queue plus stream processor complexity"},
      {"req": "Low latency reads", "value": "sub-second query response", "tradeoff": "pre-aggregation storage cost"},
      {"req": "Fault tolerant", "value": "no data loss on node failure", "tradeoff": "replication overhead"},
      {"req": "Idempotent", "value": "no duplicate counting", "tradeoff": "Redis dedup storage cost"}
    ],
    "out_of_scope": ["excluded feature with reason", "another exclusion"],
    "capacity": {
      "plain_english": "Story: We design for [X]. That means [Y] writes/sec and [Z] reads/sec. At [Y] writes/sec [tech] hits [limit] â€” this drives [decision].",
      "assumptions": ["e.g. 10M active ads", "peak 10k clicks/sec", "100M clicks/day", "500B avg event"],
      "write_qps": "~10,000 per second at peak",
      "read_qps": "~100 per second from advertisers â€” asymmetric",
      "storage_per_year": "~18 TB per year",
      "design_impact": "Write-heavy asymmetry drives: queue plus stream processor plus OLAP instead of transactional DB"
    }
  },
  "step2_core_entities": [
    {"name": "EntityName", "description": "domain role in one sentence", "note": "key modeling insight"}
  ],
  "step3_api_design": {
    "system_interface": "Input: {fields}. Output: {fields}. OR REST endpoints for product systems.",
    "protocol_choice": "REST or event-driven â€” one sentence why for THIS system",
    "realtime_protocol": {
      "needed": false,
      "chosen": "None",
      "reason": "specific reason",
      "where_in_arch": "where it sits if needed",
      "alternatives": [
        {"name": "WebSocket", "verdict": "tradeoff", "reason": "specific for this system"},
        {"name": "Long Polling", "verdict": "avoid", "reason": "specific failure at this scale"}
      ]
    },
    "endpoints": [
      {"method": "POST", "path": "/v1/resource", "auth": "JWT â€” userId from token never body", "request": "{ field: type }", "response": "{ id, created_at }", "note": "idempotency and rate limit note"}
    ]
  },
  "hld_fr_walkthroughs": [
    {
      "fr": "Users should be able to [verb] [noun]",
      "what_to_draw": "Exact boxes to add: Draw [A] then [B] then [C]. Specific to THIS system.",
      "narrative": "2-3 sentences how these components satisfy this FR. Conversational like your guides.",
      "flow": ["1. Actor sends X to Y", "2. Y does Z", "3. Returns response"],
      "key_point": "The non-obvious insight â€” what separates great from good on this FR."
    }
  ],
  "step5_high_level_design": {
    "diagram_simple": "DIAGRAM 1. Box chars: use box-drawing characters for each component box. Arrow down vertical, right horizontal. Label every arrow. 6-8 boxes. 100% specific to THIS system.",
    "diagram_simple_commentary": [
      {"component": "box name", "say": "role and why here and what it does"},
      {"component": "box name", "say": "the bottleneck this creates at scale"}
    ],
    "diagram_scaled": "DIAGRAM 2. Evolves Diagram 1. Same core boxes plus new ones marked with star prefix. Each new component has annotation showing which NFR it satisfies. Label every arrow. Show alternatives in brackets. Split write and read paths where they diverge.",
    "diagram_scaled_commentary": [
      {"component": "star component name", "say": "WHY added â€” NFR satisfied plus bottleneck removed plus numbers"},
      {"component": "star component name", "say": "connection to previous component plus trade-off introduced"}
    ],
    "schema": [
      {
        "table": "TableName",
        "storage": "PostgreSQL or DynamoDB or Cassandra or Redis or ClickHouse or S3 or Elasticsearch",
        "why": "specific reason â€” e.g. columnar OLAP for aggregation queries not row-store",
        "key_fields": "id UUID PK, ad_id UUID NOT NULL, click_count INT, window_start TIMESTAMPTZ",
        "key_indexes": "INDEX on ad_id and window_start DESC â€” feeds: SELECT sum(click_count) WHERE ad_id equals X",
        "access_pattern": "primary query pattern that drives this index design"
      }
    ],
    "components": [
      {
        "name": "Component matching diagram exactly",
        "role": "single responsibility in one sentence",
        "chosen_tech": "Specific tech e.g. Apache Flink 1.18",
        "why_chosen": "specific reason for THIS system â€” e.g. exactly-once tumbling windows for 1-min aggregation, Kafka offset replay on crash prevents data loss",
        "alternatives": [
          {"name": "Alt 1", "verdict": "tradeoff", "reason": "concrete pro and con for this workload"},
          {"name": "Alt 2", "verdict": "tradeoff", "reason": "concrete pro and con"},
          {"name": "Alt 3", "verdict": "avoid", "reason": "specific failure mode for this system"}
        ]
      }
    ]
  },
  "step6_deep_dives": [
    {
      "topic": "How do we solve [specific hard problem]?",
      "nfr_addressed": "exact NFR from step1",
      "bad": {"label": "Bad Solution: name", "approach": "what it looks like", "why_fails": "specific failure with numbers"},
      "good": {"label": "Good Solution: name", "approach": "the improvement", "limitation": "what is still wrong"},
      "great": {"label": "Great Solution: name", "approach": "production solution with specific tech", "numbers": "concrete proof with numbers", "trade_offs": "explicit cost"}
    }
  ],
  "followup_qa": [
    {"question": "realistic follow-up for THIS system", "answer": "3-4 sentence answer with specific tech and numbers"}
  ],
  "speak_guide": {
    "opening_script": "word-for-word first 60 seconds of the interview",
    "key_insight": "the one thing most candidates miss on this specific problem",
    "common_mistakes": ["mistake specific to this problem and what to say instead", "another mistake"],
    "closing_script": "how to wrap up in 2 minutes"
  }
}

Rules: 3 FRs max, 4 NFRs with numbers, 3-5 entities nouns only no fields, one hld_fr_walkthrough per FR, BOTH diagrams with Diagram 2 evolving from Diagram 1 using star markers and NFR annotations, schema for each storage system used, 4-6 components with 3 alternatives each, 3-4 deep dives with bad and good and great tiers, 5 Q&As. Zero generic advice â€” every sentence specific to the exact system described.`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ptabBar(pairs){let h='<div class="ptabs">';for(let i=0;i<pairs.length;i+=2)h+=`<div class="ptab${i===0?' on':''}" data-t="${pairs[i]}" onclick="switchP('${pairs[i]}')">${pairs[i+1]}</div>`;return h+'</div>';}
function switchP(id){document.querySelectorAll('.ptab').forEach(t=>t.classList.toggle('on',t.dataset.t===id));document.querySelectorAll('.ppanel').forEach(p=>p.classList.toggle('on',p.id==='pp_'+id));}
function toggleQA(el){el.classList.toggle('open');el.querySelector('.chev').classList.toggle('open');el.nextElementSibling.classList.toggle('open');}
function wireSubTabs(container){
  const tabs=[...container.querySelectorAll(':scope > .stab-row > .stab')];
  const panels=[...container.querySelectorAll(':scope > .spanel')];
  tabs.forEach((t,i)=>{t.onclick=()=>{tabs.forEach(x=>x.classList.remove('on'));panels.forEach(x=>x.classList.remove('on'));t.classList.add('on');panels[i]?.classList.add('on');};});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEAK MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSM(){
  if(!last)return;
  const{mode:m,data:d}=last;let h='';
  if(m==='coding'){
    h+=sc('ğŸ§  How I Approached It',d.thought_process);h+=sc('ğŸ¯ One-Liner',d.summary);h+=sc('ğŸ’¡ Analogy',d.analogy);
    h+=sc('ğŸ”‘ Key Steps',(d.steps||[]).map((s,i)=>(i+1)+'. '+s.title+' â€” '+s.why).join('\n'));
    h+=sc('âš¡ Complexity',d.complexity_explanation);
    h+=sc('âš ï¸ Gotchas',(d.tricky_parts||[]).map(t=>'â€¢ '+t.issue+': '+String(t.explanation).slice(0,140)).join('\n'));
  }else{
    const sg=d.speak_guide||{},r=d.step1_requirements||{};
    h+=sc('ğŸ¬ Opening (say this verbatim)',sg.opening_script||'');
    h+=sc('ğŸ’¡ The Key Insight',sg.key_insight||'');
    h+=sc('ğŸ“‹ Requirements to State',[...(r.functional||[]).map(f=>'ğŸ”µ '+f.req),'â”€',...(r.non_functional||[]).map(n=>'â— '+n.req+' ('+n.value+')')].join('\n'));
    const allFlow=[];(d.hld_sections||[]).forEach(s=>(s.flow_steps||[]).forEach(f=>allFlow.push(f)));h+=sc('ğŸ—ï¸ FR-by-FR Flow',allFlow.join('\n'));
    h+=sc('ğŸ”¬ Deep Dives to Hit',(d.step6_deep_dives||[]).map(dd=>'â€¢ '+dd.topic+': '+String(dd.real_solution).slice(0,130)).join('\n'));
    h+=sc('âš ï¸ Mistakes to Avoid',(sg.common_mistakes||[]).map(m=>'â€¢ '+m).join('\n'));
    h+=sc('ğŸ Closing (say this)',sg.closing_script||'');
  }
  document.getElementById('smc').innerHTML=h;document.getElementById('sovl').classList.add('on');
}
function closeSM(){document.getElementById('sovl').classList.remove('on');}
function sc(lbl,txt){return '<div class="sc"><div class="sc-lbl">'+lbl+'</div><div class="sc-txt">'+String(txt||'').replace(/\n/g,'<br>')+'</div></div>';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JAVA RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hl(code){
  const kw=['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','PriorityQueue','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h=code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h=h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h=h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h=h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k=>{h=h.replace(new RegExp('\\b('+k+')\\b','g'),'<span style="color:#569cd6">$1</span>');});
  return h;
}
const rx=t=>String(t||'').replace(/`([^`]+)`/g,'<code>$1</code>');
const eh=t=>String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function renderCoding(d){
  const a=document.getElementById('rarea');
  const stH=(d.steps||[]).map((s,i)=>`<div class="card fadein"><div class="card-head"><div class="cnum">${i+1}</div><div>${s.title}</div></div><div class="card-body">${rx(s.what)}<br><br>${rx(s.how)}</div><div class="card-sub">ğŸ’¡ Why: ${s.why}</div></div>`).join('');
  const trH=(d.tricky_parts||[]).map(t=>`<div class="iblock red fadein"><div class="blbl">âš ï¸ ${t.issue}</div>${rx(t.explanation)}</div>`).join('');
  const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${rx(q.answer)}</div></div>`).join('');
  const vl=v=>v==='better'?'âœ“ Better':v==='worse'?'âœ— Worse':'â‡„ Trade-off';
  const vc=v=>v==='better'?'bg':v==='worse'?'bo':'bb';
  const alH=(d.alternatives||[]).map(al=>`<div class="card fadein"><div class="card-head" style="justify-content:space-between"><span>${al.name} <small style="color:var(--ts);font-weight:400">${al.complexity}</small></span><span class="badge ${vc(al.verdict)}">${vl(al.verdict)}</span></div><div class="card-body">${al.when_to_use}</div></div>`).join('');
  a.innerHTML=
    ptabBar(['overview','Overview','code','Code','steps','Walkthrough','tricky','Gotchas','qa','Q&A','alts','Alternatives'])+
    `<div class="ppanel on" id="pp_overview">
      <div class="iblock blue fadein"><div class="blbl">ğŸ§  How I thought about this</div>${d.thought_process}</div>
      <div class="iblock green fadein"><div class="blbl">ğŸ’¡ Real-world analogy</div>${d.analogy}</div>
      <div class="sumbox fadein">${d.summary}</div>
      <div class="mrow"><span class="badge ba">${d.complexity}</span><span class="badge bb">${d.pattern}</span><span class="badge bg">${d.approach}</span></div>
      <div style="font-size:12.5px;line-height:1.7;color:var(--ts);padding:2px 0 14px">${d.complexity_explanation}</div>
      <button class="spk-btn fadein" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>
    <div class="ppanel" id="pp_code">
      <p style="font-size:11px;color:var(--ts);margin-bottom:9px">Lines wrap â€” scroll up/down only. No horizontal scroll.</p>
      <div class="code-outer fadein"><div class="code-hdr"><span class="code-lang">JAVA</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${hl(d.code)}</pre></div></div>
    </div>
    <div class="ppanel" id="pp_steps"><div>${stH}</div></div>
    <div class="ppanel" id="pp_tricky"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Knowing these signals thoroughness.</p>${trH}</div>
    <div class="ppanel" id="pp_qa"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Tap to reveal.</p>${qaH}</div>
    <div class="ppanel" id="pp_alts"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Mentioning trade-offs signals depth.</p>${alH}</div>`;
  a._rawCode=d.code;a.classList.add('on');
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SD RENDER â€” full final render replaces skeleton
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSD(d){
  const a=document.getElementById('rarea');
  const r=d.step1_requirements||{},api=d.step3_api_design||{};
  const hlds=d.hld_sections||[],dives=d.step6_deep_dives||[],sg=d.speak_guide||{};
  const cap=r.capacity||{};
  const eh2=t=>String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  /* Requirements */
  const funcH=(r.functional||[]).map(f=>`<div class="hrow fadein"><strong>${f.priority==='core'?'ğŸ”µ':'âšª'} ${f.req}</strong>${f.technical_implication?`<div style="font-size:11.5px;color:var(--ts);margin-top:2px">â†’ ${f.technical_implication}</div>`:''}</div>`).join('');
  const nfrH=(r.non_functional||[]).map(n=>`<div class="hrow fadein">â— <strong>${n.req}</strong> <span class="badge ba">${n.value}</span>${n.tradeoff?`<div style="font-size:11.5px;color:var(--orange);margin-top:2px">Trade-off: ${n.tradeoff}</div>`:''}</div>`).join('');
  const oosH=(r.out_of_scope||[]).map(o=>`<span class="pill">âœ— ${o}</span>`).join('');

  /* Capacity â€” plain English first */
  const capH=cap.write_qps?`<div style="background:var(--as);border:1px solid rgba(200,169,110,.3);border-radius:10px;padding:13px 14px;margin-bottom:12px">
    ${cap.plain_english?`<div style="font-size:13px;line-height:1.75;color:var(--tp);margin-bottom:10px">${cap.plain_english}</div>`:''}
    <div style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">Assumptions</div>
    ${(cap.assumptions||[]).map(a=>`<div style="font-size:11.5px;color:var(--ts);margin-bottom:2px">â€¢ ${a}</div>`).join('')}
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-top:9px">
      <div style="flex:1;min-width:100px;background:var(--os);border-radius:8px;padding:9px 11px"><div style="font-size:9px;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px">âœï¸ Write QPS</div><div style="font-size:13px;font-weight:700">${cap.write_qps}</div></div>
      <div style="flex:1;min-width:100px;background:var(--bs);border-radius:8px;padding:9px 11px"><div style="font-size:9px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px">ğŸ“– Read QPS</div><div style="font-size:13px;font-weight:700">${cap.read_qps}</div></div>
      <div style="flex:1;min-width:100px;background:var(--gs);border-radius:8px;padding:9px 11px"><div style="font-size:9px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px">ğŸ’¾ Storage/yr</div><div style="font-size:13px;font-weight:700">${cap.storage_per_year}</div></div>
    </div>
    ${cap.design_impact?`<div style="font-size:12px;font-weight:600;color:var(--tp);background:var(--sf);border-radius:7px;padding:8px 11px;margin-top:8px">ğŸ¯ ${cap.design_impact}</div>`:''}
  </div>`:'<div class="iblock orange fadein"><div class="blbl">ğŸ“Œ Hello Interview</div>Skip capacity unless it changes a design decision â€” say this explicitly.</div>';

  /* Entities */
  const entH=(d.step2_core_entities||[]).map(e=>`<div class="card fadein" style="margin-bottom:9px"><div class="card-head" style="font-weight:700">${e.name}</div><div class="card-body">${e.description}</div>${e.note?`<div class="card-sub">ğŸ’¡ ${e.note}</div>`:''}</div>`).join('');

  /* Real-time protocol */
  const rt=api.realtime_protocol||{};
  const rtH=(rt.chosen&&rt.chosen!=='None')?`<div class="tech-card fadein" style="border-color:rgba(45,95,160,.35);margin-bottom:14px">
    <div class="tech-top"><span class="tech-name">ğŸ”„ Real-time: ${rt.chosen}</span><span class="chosen-tag">âœ“ chosen</span></div>
    <div class="tech-role">${rt.reason||''}</div>
    ${rt.where_in_arch?`<div class="tech-why"><strong>Where:</strong> ${rt.where_in_arch}</div>`:''}
    ${(rt.alternatives||[]).length?`<div class="alt-lbl">Alternatives</div>${rt.alternatives.map(a=>`<div class="alt-row"><span class="alt-name">${a.name}</span><span class="av ${a.verdict==='avoid'?'av-avoid':a.verdict==='tradeoff'?'av-trade':'av-ok'}">${a.verdict==='avoid'?'âœ— Avoid':a.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span><span class="alt-why">${a.reason}</span></div>`).join('')}`:''}
  </div>`:`<div class="iblock green fadein"><div class="blbl">Real-time</div>Standard REST â€” no persistent connection needed.</div>`;

  /* API endpoints */
  const apiH=(api.endpoints||[]).map(ep=>`<div class="card fadein" style="margin-bottom:10px">
    <div class="card-head"><span class="badge bb" style="font-family:monospace;font-size:10px">${ep.method}</span> <code style="font-size:12.5px">${ep.path}</code></div>
    <div class="card-body">${ep.auth?`<div style="font-size:11.5px;color:var(--ts);margin-bottom:4px">ğŸ” ${ep.auth}</div>`:''}<strong>Request:</strong> <code>${ep.request||''}</code><br><strong>Response:</strong> <code>${ep.response||''}</code>${ep.note?`<div style="font-size:11.5px;color:var(--ts);margin-top:4px">${ep.note}</div>`:''}</div>
  </div>`).join('');

  /* Clarifying questions */
  const cqH=(d.clarifying_questions||[]).map((q,i)=>{
    const qq=typeof q==='string'?{q,why:''}:(q||{});
    return `<div class="hrow fadein"><strong>Q${i+1}:</strong> ${qq.q||q}${qq.why?`<div style="font-size:11.5px;color:var(--ts);margin-top:2px">Why ask: ${qq.why}</div>`:''}</div>`;
  }).join('');

  /* HLD â€” FR by FR, Evan King style */
  const colorizeDiag=raw=>{
    let s=eh2(raw);
    s=s.replace(/\[([^\]<]+)\]/g,'<span style="color:#e8c060;font-weight:600">[$1]</span>');
    s=s.replace(/([â†’â†“â†â†‘])/g,'<span style="color:#7aabcc;font-weight:700">$1</span>');
    s=s.replace(/(â˜…[^\nâ”‚â”Œâ”â””â”˜â”œâ”¤â•­â•®â•°â•¯]+)/g,'<span style="color:#e87840;font-weight:700">$1</span>');
    return s;
  };

  const hldH=hlds.map((sec,i)=>`<div style="margin-bottom:22px">
    <div style="font-size:13px;font-weight:700;padding:9px 13px;background:var(--as);border-radius:9px;border-left:3px solid var(--ac);margin-bottom:10px">${sec.fr_title||'Section '+(i+1)}</div>
    ${sec.narrative?`<div style="font-size:13px;line-height:1.78;color:var(--tp);margin-bottom:11px">${sec.narrative}</div>`:''}
    ${(sec.new_components||[]).length?`<div style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">New components</div>
      ${sec.new_components.map(c=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:9px 12px;background:var(--sf);border:1px solid var(--br);border-radius:8px;margin-bottom:5px">
        <div style="font-size:11.5px;font-weight:700;color:var(--tp);min-width:120px;flex-shrink:0">${c.name}</div>
        <div style="font-size:12px;color:var(--ts);line-height:1.6">${c.role}</div>
      </div>`).join('')}`:''}
    ${(sec.flow_steps||[]).length?`<div style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.07em;margin:11px 0 6px">Step-by-step flow</div>
      ${sec.flow_steps.map(s=>`<div style="display:flex;gap:9px;padding:6px 0;border-bottom:1px solid var(--br);font-size:12.5px;line-height:1.65">
        <span style="color:var(--ac);font-weight:700;flex-shrink:0;min-width:16px">${s.match(/^\d+/)?.[0]||''}</span>
        <span style="color:var(--tp)">${s.replace(/^\d+\.\s*/,'')}</span>
      </div>`).join('')}`:''}
    ${sec.diagram?`<div style="margin-top:13px"><div style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px">Diagram after this FR <span style="font-weight:400;color:var(--orange);font-style:normal">â˜… = new this FR</span></div><div class="diagram">${colorizeDiag(sec.diagram)}</div></div>`:''}
  </div>`).join('<hr style="border:none;border-top:2px solid var(--br);margin:4px 0 22px">');

  /* Diagram 2 scaled with commentary */
  const d2c=d.diagram_scaled_commentary||[];
  const diagScaledH=d.diagram_scaled?`<div class="diag-wrap">
    <div class="diag-label">Diagram 2 â€” Production Design
      <span class="diag-pill">satisfies NFRs</span>
      <span class="diag-pill" style="background:var(--os);color:var(--orange)">â˜… = evolved from Diagram 1</span>
      <span class="diag-pill" style="background:rgba(232,192,96,.15);color:#9a7820">[amber] = alternatives</span>
    </div>
    <div class="diagram">${colorizeDiag(d.diagram_scaled)}</div>
  </div>
  ${d2c.length?`<div style="margin-top:11px"><div style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px">ğŸ—£ï¸ Say while drawing each new component</div>
  ${d2c.map(c=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:9px 12px;background:var(--bs);border-radius:8px;margin-bottom:5px;border-left:3px solid var(--blue)">
    <div style="font-size:10px;font-weight:700;color:var(--blue);min-width:88px;padding-top:1px;flex-shrink:0;text-transform:uppercase;letter-spacing:.04em">${c.component}</div>
    <div style="font-size:12.5px;line-height:1.65;color:var(--tp);font-style:italic">"${c.say}"</div>
  </div>`).join('')}</div>`:''}`:'' ;

  /* Schema */
  const schemaH=(d.schema||[]).map(t=>`<div class="card fadein" style="margin-bottom:11px">
    <div class="card-head" style="justify-content:space-between"><span style="font-weight:700">${t.table}</span><span class="badge bp">${t.storage}</span></div>
    <div class="card-body">
      ${t.access_pattern?`<div style="font-size:11.5px;color:var(--blue);margin-bottom:7px;font-weight:600">ğŸ“Š ${t.access_pattern}</div>`:''}
      <div style="background:var(--cdbg);border-radius:7px;padding:9px 12px;font-family:'SF Mono',monospace;font-size:11px;line-height:1.85;color:var(--cdtx);word-break:break-word;margin-bottom:7px">${eh2(t.key_fields||'')}</div>
      ${t.key_indexes?`<div style="font-size:11.5px;color:var(--ts);margin-bottom:4px">ğŸ”‘ ${t.key_indexes}</div>`:''}
      <div class="card-sub">Why ${t.storage}: ${t.why}</div>
    </div>
  </div>`).join('');

  /* Components */
  const compH=(d.components||[]).map(c=>`<div class="tech-card fadein">
    <div class="tech-top"><span class="tech-name">${c.name}</span><span class="chosen-tag">âœ“ ${c.chosen_tech}</span></div>
    <div class="tech-role">${c.role}</div>
    <div class="tech-why"><strong>Why ${c.chosen_tech}:</strong> ${c.why_chosen}</div>
    ${c.alternatives&&c.alternatives.length?`<div class="alt-lbl">Alternatives</div>${c.alternatives.map(alt=>`<div class="alt-row"><span class="alt-name">${alt.name}</span><span class="av ${alt.verdict==='avoid'?'av-avoid':alt.verdict==='tradeoff'?'av-trade':'av-ok'}">${alt.verdict==='avoid'?'âœ— Avoid':alt.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span><span class="alt-why">${alt.reason}</span></div>`).join('')}`:''}
  </div>`).join('');

  /* Deep dives â€” Bad/Good/Great */
  const deepH=dives.map(dd=>`<div class="card fadein" style="margin-bottom:18px">
    <div class="card-head" style="flex-direction:column;align-items:flex-start;gap:5px">
      <div style="font-size:14px;font-weight:700">ğŸ”¬ ${dd.topic}</div>
      ${dd.nfr_addressed?`<span class="badge bb" style="font-weight:500">Hardens: ${dd.nfr_addressed}</span>`:''}
    </div>
    <div class="card-body" style="margin-bottom:9px"><strong>Why hard:</strong> ${dd.why_hard}</div>
    ${dd.bad_solution?`<div style="background:var(--rs);border-radius:9px;padding:10px 13px;margin-bottom:7px"><div style="font-size:9.5px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">âŒ Bad solution â€” why it fails</div><div style="font-size:12.5px;line-height:1.68">${dd.bad_solution}</div></div>`:''}
    ${dd.good_solution?`<div style="background:var(--os);border-radius:9px;padding:10px 13px;margin-bottom:7px"><div style="font-size:9.5px;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">ğŸŸ¡ Good solution</div><div style="font-size:12.5px;line-height:1.68">${dd.good_solution}</div></div>`:''}
    <div style="background:var(--gs);border-radius:9px;padding:10px 13px;margin-bottom:7px"><div style="font-size:9.5px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px">âœ… Great solution</div><div style="font-size:12.5px;line-height:1.68">${dd.great_solution||dd.real_solution||''}</div></div>
    ${dd.numbers?`<div class="iblock orange fadein" style="padding:8px 12px;margin-bottom:7px"><div class="blbl">ğŸ“Š The numbers</div>${dd.numbers}</div>`:''}
    <div class="card-warn">â‡„ Trade-off: ${dd.trade_offs||''}</div>
  </div>`).join('');

  /* Q&A */
  const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${q.answer}</div></div>`).join('');

  /* â•â• FULL RENDER â•â• */
  a.innerHTML=
    ptabBar(['overview','Overview','walkthrough','Design Walkthrough','deepdives','Deep Dives','qa','Q&A'])+

    `<div class="ppanel on" id="pp_overview">
      <div class="sumbox fadein">${d.problem_statement}</div>
      <div class="sublbl">Clarifying Questions</div>${cqH}
      <div class="sublbl">ğŸ”µ Functional Requirements</div>${funcH}
      <div class="sublbl">â— Non-Functional Requirements</div>${nfrH}
      <div class="sublbl">ğŸ“Š Scale & Capacity</div>${capH}
      <div class="sublbl">âœ— Out of Scope</div><div class="pill-row">${oosH}</div>
      <div class="iblock blue fadein" style="margin-top:10px"><div class="blbl">ğŸ§  Interview framing</div>${d.thought_process||''}</div>
      <button class="spk-btn fadein" style="margin-top:10px" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
    </div>

    <div class="ppanel" id="pp_walkthrough">
      <div class="stab-row">
        <div class="stab on"><span class="sn">1</span>Entities<span class="step-t">~2m</span></div>
        <div class="stab"><span class="sn">2</span>API & Protocol<span class="step-t">~5m</span></div>
        <div class="stab"><span class="sn">3</span>HLD â€” FR by FR<span class="step-t">~15m</span></div>
        <div class="stab"><span class="sn">4</span>Scaled Design<span class="step-t">~5m</span></div>
        <div class="stab"><span class="sn">5</span>Schema<span class="step-t">in HLD</span></div>
      </div>

      <div class="spanel on">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Entities first</div>List core domain nouns only â€” no fields yet. Talk through each briefly. Fields emerge when you trace each API request in HLD step 3.</div>
        ${entH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” API design</div>State real-time protocol choice upfront â€” shapes the whole architecture. REST endpoints: plural nouns, user_id from JWT never body, note security on each.</div>
        ${rtH}
        <div class="sublbl">Endpoints â€” ${api.protocol_choice||'REST'}</div>${apiH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” HLD: FR by FR</div>Satisfy each FR one at a time. Narrative â†’ new components â†’ numbered flow â†’ cumulative diagram. Each diagram includes ALL previous components plus â˜… new ones.</div>
        ${hldH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Scaled design</div>Start from your final FR diagram. Layer in production components explaining which NFR each satisfies. Use the speaking script below each component.</div>
        ${diagScaledH}
        <div class="sublbl" style="margin-top:16px">Component Decisions <span style="font-size:9.5px;font-weight:400;color:var(--ts)">â€” match â˜… components in diagram above</span></div>
        ${compH}
      </div>

      <div class="spanel">
        <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Schema</div>Introduce fields only as you trace the write path to the DB in each FR section. Only show fields that affect query patterns or storage decisions.</div>
        ${schemaH}
      </div>
    </div>

    <div class="ppanel" id="pp_deepdives">
      <div class="iblock blue fadein"><div class="blbl">ğŸ“Œ Evan King â€” Deep dives</div>Each dive answers "How do we...?" for a specific NFR. Always Bad solution first â€” it shows you understand WHY it is hard. Then Good, then Great. Lead proactively at senior+ level.</div>
      ${deepH}
    </div>

    <div class="ppanel" id="pp_qa">
      <p style="font-size:11.5px;color:var(--ts);margin-bottom:12px">Tap to reveal a confident answer.</p>${qaH}
    </div>`;

  a.classList.add('on');
  wireSubTabs(document.querySelector('#pp_walkthrough'));
  setTimeout(()=>a.scrollIntoView({behavior:'smooth',block:'start'}),120);
}

function copyCode(btn){const a=document.getElementById('rarea');navigator.clipboard.writeText(a._rawCode||'').then(()=>{btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy',1500);});}

/* â•â•â• HOME BUTTONS â•â•â• */
(function(){
  var bc=document.getElementById('btn_coding');
  var bs=document.getElementById('btn_sd');
  if(bc) bc.addEventListener('click',function(){openTool('coding');});
  if(bs) bs.addEventListener('click',function(){openTool('sd');});
})();
document.getElementById('tbox').addEventListener('input',chkBtn);
</script>
</body>
</html>
