<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notes</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  :root {
    --bg: #faf9f7; --surface: #ffffff; --border: #e8e5e0;
    --text-primary: #1a1916; --text-secondary: #7a7670;
    --accent: #c8a96e; --accent-soft: #f5f0e8;
    --code-bg: #1e1c1a; --code-text: #e8e4dc;
    --green: #5a8a5a; --blue: #4a6fa5; --red: #a05a5a;
    --green-soft: #eef4ee; --blue-soft: #eef2fa; --red-soft: #faf0f0;
  }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-primary); min-height: 100vh; max-width: 700px; margin: 0 auto; padding: 0 0 100px; }

  /* ‚îÄ‚îÄ HEADER (looks like Notes app) ‚îÄ‚îÄ */
  .app-header { padding: 56px 24px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(250,249,247,0.93); }
  .header-row { display: flex; align-items: center; justify-content: space-between; }
  .app-title { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .icon-btn { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--accent); font-size: 20px; border-radius: 50%; border: none; background: none; }
  .note-count { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

  /* ‚îÄ‚îÄ NOTES LIST ‚îÄ‚îÄ */
  .notes-list { padding: 8px 0; }
  .note-row { padding: 14px 24px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: background 0.1s; }
  .note-row:active { background: var(--accent-soft); }
  .note-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--accent-soft); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; }
  .note-preview { flex: 1; min-width: 0; }
  .note-title { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-snippet { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
  .note-date { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; margin-top: 2px; }

  /* ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ */
  .note-detail { display: none; min-height: 100vh; background: var(--bg); }
  .note-detail.open { display: block; }
  .detail-header { padding: 16px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(250,249,247,0.96); backdrop-filter: blur(20px); z-index: 10; }
  .back-btn { color: var(--accent); font-size: 15px; cursor: pointer; border: none; background: none; font-weight: 500; padding: 4px 0; }
  .detail-title-display { flex: 1; font-size: 15px; font-weight: 600; }

  /* ‚îÄ‚îÄ API SETUP ‚îÄ‚îÄ */
  .setup-note { margin: 16px 24px; padding: 16px; background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 12px; }
  .setup-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .setup-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
  .api-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: monospace; background: var(--surface); color: var(--text-primary); outline: none; }
  .save-btn { margin-top: 8px; padding: 8px 16px; background: var(--text-primary); color: white; border: none; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; width: 100%; }

  /* ‚îÄ‚îÄ INPUT AREA ‚îÄ‚îÄ */
  .problem-area { padding: 20px 24px 12px; border-bottom: 1px solid var(--border); }
  .problem-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; }
  .problem-input { width: 100%; min-height: 80px; border: none; background: none; font-family: inherit; font-size: 15px; color: var(--text-primary); resize: none; outline: none; line-height: 1.6; }
  .problem-input::placeholder { color: var(--text-secondary); }

  /* ‚îÄ‚îÄ DEPTH SELECTOR ‚îÄ‚îÄ */
  .depth-row { display: flex; gap: 8px; padding: 10px 24px; border-bottom: 1px solid var(--border); overflow-x: auto; }
  .depth-chip { padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1.5px solid var(--border); background: var(--surface); color: var(--text-secondary); cursor: pointer; white-space: nowrap; transition: all 0.15s; flex-shrink: 0; }
  .depth-chip.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }

  /* ‚îÄ‚îÄ GENERATE BUTTON ‚îÄ‚îÄ */
  .generate-btn { margin: 14px 24px; padding: 13px 24px; background: var(--text-primary); color: var(--bg); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; width: calc(100% - 48px); display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.15s; }
  .generate-btn:disabled { opacity: 0.45; cursor: not-allowed; }

  /* ‚îÄ‚îÄ THINKING ‚îÄ‚îÄ */
  .thinking { display: none; padding: 20px 24px; align-items: center; gap: 12px; }
  .thinking.active { display: flex; }
  .thinking-dots { display: flex; gap: 4px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.2s infinite; }
  .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse { 0%,80%,100%{transform:scale(1);opacity:0.5} 40%{transform:scale(1.3);opacity:1} }
  .thinking-text { font-size: 13px; color: var(--text-secondary); font-style: italic; }

  /* ‚îÄ‚îÄ RESPONSE ‚îÄ‚îÄ */
  .response-area { padding: 0 24px 40px; display: none; }
  .response-area.visible { display: block; }

  /* ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); margin: 0 -24px; padding: 0 24px; overflow-x: auto; gap: 0; margin-top: 20px; }
  .tab { padding: 10px 14px; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.15s; }
  .tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }

  /* ‚îÄ‚îÄ TAB PANELS ‚îÄ‚îÄ */
  .tab-panel { display: none; padding-top: 16px; }
  .tab-panel.active { display: block; }

  /* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
  .summary-box { background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 10px; padding: 16px; font-size: 14px; line-height: 1.7; margin-bottom: 14px; }
  .meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 600; }
  .badge-complexity { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(200,169,110,0.3); }
  .badge-pattern { background: var(--blue-soft); color: var(--blue); border: 1px solid rgba(74,111,165,0.2); }
  .badge-approach { background: var(--green-soft); color: var(--green); border: 1px solid rgba(90,138,90,0.2); }

  /* ‚îÄ‚îÄ THOUGHT PROCESS ‚îÄ‚îÄ */
  .thought-block { background: var(--blue-soft); border-left: 3px solid var(--blue); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; color: var(--text-primary); margin-bottom: 12px; }
  .thought-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--blue); margin-bottom: 6px; }

  /* ‚îÄ‚îÄ ANALOGY ‚îÄ‚îÄ */
  .analogy-block { background: var(--green-soft); border-left: 3px solid var(--green); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; color: var(--text-primary); margin-bottom: 12px; }
  .analogy-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--green); margin-bottom: 6px; }

  /* ‚îÄ‚îÄ CODE ‚îÄ‚îÄ */
  .code-block { background: var(--code-bg); border-radius: 12px; overflow: hidden; margin-bottom: 8px; }
  .code-header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
  .code-lang { font-size: 11px; color: #8a8580; font-family: monospace; }
  .copy-btn { font-size: 11px; color: var(--accent); background: none; border: none; cursor: pointer; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
  .code-content { padding: 16px; overflow-x: auto; }
  .code-content pre { font-family: 'SF Mono', monospace; font-size: 12.5px; line-height: 1.7; color: var(--code-text); white-space: pre; }

  /* ‚îÄ‚îÄ WALKTHROUGH STEPS ‚îÄ‚îÄ */
  .section-header { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-secondary); margin: 20px 0 10px; }
  .steps-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
  .step-item { display: flex; gap: 12px; align-items: flex-start; padding: 14px; background: var(--surface); border-radius: 10px; border: 1px solid var(--border); }
  .step-num { width: 26px; height: 26px; border-radius: 50%; background: var(--accent); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .step-body { flex: 1; }
  .step-title { font-size: 13.5px; font-weight: 700; margin-bottom: 4px; }
  .step-desc { font-size: 13px; line-height: 1.65; color: var(--text-primary); }
  .step-desc code { font-family: 'SF Mono', monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .step-why { font-size: 12px; color: var(--blue); margin-top: 6px; font-style: italic; }

  /* ‚îÄ‚îÄ TRICKY PARTS ‚îÄ‚îÄ */
  .tricky-item { padding: 14px; background: var(--red-soft); border: 1px solid rgba(160,90,90,0.2); border-radius: 10px; margin-bottom: 10px; }
  .tricky-head { font-size: 13px; font-weight: 700; color: var(--red); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
  .tricky-desc { font-size: 13px; line-height: 1.65; }
  .tricky-desc code { font-family: monospace; font-size: 11.5px; background: rgba(160,90,90,0.1); padding: 1px 5px; border-radius: 4px; }

  /* ‚îÄ‚îÄ FOLLOW-UP Q&A ‚îÄ‚îÄ */
  .qa-item { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
  .qa-q { padding: 12px 16px; font-size: 13.5px; font-weight: 600; background: var(--surface); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .qa-q .chevron { color: var(--text-secondary); transition: transform 0.2s; font-size: 12px; }
  .qa-q.open .chevron { transform: rotate(90deg); }
  .qa-a { display: none; padding: 12px 16px; font-size: 13px; line-height: 1.7; color: var(--text-primary); background: var(--bg); border-top: 1px solid var(--border); }
  .qa-a code { font-family: monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .qa-a.open { display: block; }

  /* ‚îÄ‚îÄ ALTERNATIVES ‚îÄ‚îÄ */
  .alt-item { padding: 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
  .alt-head { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; }
  .alt-desc { font-size: 13px; line-height: 1.65; color: var(--text-primary); }
  .alt-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .better { background: var(--green-soft); color: var(--green); }
  .tradeoff { background: var(--accent-soft); color: var(--accent); }
  .worse { background: var(--red-soft); color: var(--red); }

  /* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
  .error-box { background: #fff0f0; border: 1px solid #ffcccc; border-radius: 10px; padding: 14px 16px; font-size: 13px; color: #c0392b; margin-top: 12px; }

  /* ‚îÄ‚îÄ SPEAK MODE OVERLAY ‚îÄ‚îÄ */
  #speakOverlay { display: none; position: fixed; inset: 0; background: rgba(26,25,22,0.96); z-index: 999; flex-direction: column; padding: 60px 28px 40px; overflow-y: auto; }
  #speakOverlay.open { display: flex; }
  .speak-close { position: fixed; top: 20px; right: 24px; color: var(--accent); font-size: 24px; cursor: pointer; background: none; border: none; z-index: 1000; }
  .speak-title { font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 24px; }
  .speak-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 20px; margin-bottom: 16px; }
  .speak-card-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .speak-card-text { font-size: 16px; line-height: 1.8; color: #f0ede8; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê NOTES LIST VIEW ‚ïê‚ïê -->
<div id="notesList">
  <div class="app-header">
    <div class="header-row">
      <div class="app-title">Notes</div>
      <button class="icon-btn" onclick="openTool()">‚úèÔ∏è</button>
    </div>
    <div class="note-count">3 notes</div>
  </div>
  <div class="notes-list">
    <div class="note-row" onclick="openTool()">
      <div class="note-icon">‚öôÔ∏è</div>
      <div class="note-preview">
        <div class="note-title">Quick Reference</div>
        <div class="note-snippet">Type your problem to get Java code...</div>
      </div>
      <div class="note-date">Now</div>
    </div>
    <div class="note-row">
      <div class="note-icon">üìã</div>
      <div class="note-preview">
        <div class="note-title">Meeting notes ‚Äì Product sync</div>
        <div class="note-snippet">Discussed roadmap priorities and Q2 milestones</div>
      </div>
      <div class="note-date">Mon</div>
    </div>
    <div class="note-row">
      <div class="note-icon">üìù</div>
      <div class="note-preview">
        <div class="note-title">Grocery list</div>
        <div class="note-snippet">Eggs, bread, olive oil, tomatoes...</div>
      </div>
      <div class="note-date">Sun</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê DETAIL / TOOL VIEW ‚ïê‚ïê -->
<div id="noteDetail" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">‚Äπ Notes</button>
    <div class="detail-title-display">Quick Reference</div>
    <button class="icon-btn" onclick="toggleSetup()">‚öô</button>
  </div>

  <div id="setupArea" class="setup-note" style="display:none;">
    <div class="setup-title">üîë API Configuration</div>
    <div class="setup-desc">Enter your Anthropic API key. Stored locally only, never shared.</div>
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-..." />
    <button class="save-btn" onclick="saveApiKey()">Save</button>
  </div>

  <div class="problem-area">
    <div class="problem-label">Problem Statement</div>
    <textarea class="problem-input" id="problemInput" placeholder="Describe your coding problem in plain English‚Ä¶ e.g. 'Find the longest substring without repeating characters'" rows="4"></textarea>
  </div>

  <!-- Explanation depth selector -->
  <div class="depth-row">
    <div class="depth-chip active" data-depth="interview" onclick="setDepth(this)">üéØ Interview</div>
    <div class="depth-chip" data-depth="explain" onclick="setDepth(this)">üó£Ô∏è Explain to team</div>
    <div class="depth-chip" data-depth="beginner" onclick="setDepth(this)">üìñ Beginner-friendly</div>
  </div>

  <button class="generate-btn" id="generateBtn" onclick="generate()">
    <span>‚ö°</span><span id="btnText">Generate Java Code</span>
  </button>

  <div class="thinking" id="thinking">
    <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="thinking-text" id="thinkingText">Building your complete explanation...</div>
  </div>

  <div class="response-area" id="responseArea"></div>
</div>

<!-- ‚ïê‚ïê SPEAK MODE OVERLAY (reads like your own notes) ‚ïê‚ïê -->
<div id="speakOverlay">
  <button class="speak-close" onclick="closeSpeakMode()">‚úï</button>
  <div class="speak-title">üì¢ How to Explain This</div>
  <div id="speakContent"></div>
</div>

<script>
const STORAGE_KEY = 'nts_cfg_key';
let currentDepth = 'interview';
let lastResult = null;

function getApiKey() { return localStorage.getItem(STORAGE_KEY) || ''; }
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (key) { localStorage.setItem(STORAGE_KEY, key); document.getElementById('setupArea').style.display = 'none'; showToast('Saved ‚úì'); }
}
function toggleSetup() {
  const area = document.getElementById('setupArea');
  const hidden = area.style.display === 'none';
  area.style.display = hidden ? 'block' : 'none';
  if (hidden && getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
}
function openTool() {
  document.getElementById('notesList').style.display = 'none';
  document.getElementById('noteDetail').classList.add('open');
  if (!getApiKey()) document.getElementById('setupArea').style.display = 'block';
}
function goBack() {
  document.getElementById('noteDetail').classList.remove('open');
  document.getElementById('notesList').style.display = 'block';
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('thinking').classList.remove('active');
  document.getElementById('problemInput').value = '';
  lastResult = null;
}
function setDepth(el) {
  document.querySelectorAll('.depth-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentDepth = el.dataset.depth;
}
function showToast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, { position:'fixed', bottom:'90px', left:'50%', transform:'translateX(-50%)', background:'#1a1916', color:'white', padding:'8px 20px', borderRadius:'20px', fontSize:'13px', zIndex:'9999', opacity:'0', transition:'opacity 0.2s', whiteSpace:'nowrap' });
  document.body.appendChild(t);
  setTimeout(() => t.style.opacity = '1', 10);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2200);
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel_' + id));
}

// ‚îÄ‚îÄ ACCORDION for Q&A ‚îÄ‚îÄ
function toggleQA(el) {
  const ans = el.nextElementSibling;
  el.classList.toggle('open');
  ans.classList.toggle('open');
}

// ‚îÄ‚îÄ SPEAK MODE ‚îÄ‚îÄ
function openSpeakMode() {
  if (!lastResult) return;
  const d = lastResult;
  let html = '';
  html += speakCard('üß† How I Approached It', d.thought_process);
  html += speakCard('üéØ One-Liner Summary', d.summary);
  html += speakCard('üí° Real-World Analogy', d.analogy);
  html += speakCard('üîë Key Points to Hit', d.steps.map((s,i) => `${i+1}. ${s.title} ‚Äî ${s.why}`).join('\n'));
  html += speakCard('‚ö° If They Ask About Complexity', d.complexity_explanation);
  html += speakCard('üîÑ If Asked for Alternatives', d.alternatives.map(a => `‚Ä¢ ${a.name}: ${a.when_to_use}`).join('\n'));
  document.getElementById('speakContent').innerHTML = html;
  document.getElementById('speakOverlay').classList.add('open');
}
function closeSpeakMode() { document.getElementById('speakOverlay').classList.remove('open'); }
function speakCard(label, text) {
  return `<div class="speak-card"><div class="speak-card-label">${label}</div><div class="speak-card-text">${text.replace(/\n/g,'<br>')}</div></div>`;
}

// ‚îÄ‚îÄ SYNTAX HIGHLIGHT ‚îÄ‚îÄ
function highlight(code) {
  const kw = ['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','Arrays','Collections','Math','Integer','Character','Optional'];
  let h = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h = h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h = h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k => { h = h.replace(new RegExp(`\\b(${k})\\b`,'g'),'<span style="color:#569cd6">$1</span>'); });
  return h;
}
function renderExpl(t) { return t.replace(/`([^`]+)`/g,'<code>$1</code>'); }

// ‚îÄ‚îÄ MAIN GENERATE ‚îÄ‚îÄ
async function generate() {
  const problem = document.getElementById('problemInput').value.trim();
  if (!problem) { showToast('Enter a problem first'); return; }
  const apiKey = getApiKey();
  if (!apiKey) { toggleSetup(); showToast('Add your API key first'); return; }

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  document.getElementById('btnText').textContent = 'Generating...';
  document.getElementById('thinking').classList.add('active');
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('responseArea').innerHTML = '';

  const depthInstructions = {
    interview: 'The user is in a coding interview. Steps and explanations must be crisp, confident, and precise. Anticipate typical interviewer follow-up questions.',
    explain: 'The user is explaining this to their engineering team. Be conversational, practical, and mention real-world trade-offs they would care about.',
    beginner: 'The user is explaining to a beginner. Use very simple language, avoid jargon, and make the analogy especially vivid and relatable.'
  };

  const systemPrompt = `You are an elite Java coding coach. Given a problem, produce a comprehensive response that lets the user sound like they genuinely thought through and wrote the solution themselves.

Context: ${depthInstructions[currentDepth]}

Return ONLY valid JSON (no markdown fences) with this exact structure:
{
  "summary": "One confident sentence describing the approach, as if you just thought of it",
  "complexity": "Time: O(?) | Space: O(?)",
  "complexity_explanation": "2-3 sentences explaining WHY the complexity is what it is, in plain terms ‚Äî not just stating it",
  "pattern": "Algorithm pattern name",
  "approach": "Core technique used",
  "thought_process": "3-5 sentences describing how a smart engineer would naturally arrive at this solution ‚Äî the 'aha moment', what naive approaches fail, why this approach clicks. Written in first person as if the user is narrating their thinking.",
  "analogy": "A vivid real-world analogy that makes the algorithm intuitive. 2-3 sentences. Should be memorable and make someone say 'oh that makes sense'.",
  "code": "Complete, clean, well-commented Java code",
  "steps": [
    {
      "title": "Short step title",
      "what": "What this step does ‚Äî 1-2 sentences",
      "how": "How it works in code ‚Äî mention specific variable/method names with backtick formatting like \`varName\`",
      "why": "WHY we do it this way ‚Äî the reasoning, not just the mechanics. This is what makes you sound smart."
    }
  ],
  "tricky_parts": [
    {
      "issue": "Name of the tricky edge case or gotcha",
      "explanation": "Why it's tricky and exactly how the code handles it. Mention variable/method names with backtick formatting."
    }
  ],
  "followup_qa": [
    {
      "question": "A realistic follow-up question someone would ask",
      "answer": "A confident, complete answer. 2-4 sentences."
    }
  ],
  "alternatives": [
    {
      "name": "Alternative approach name",
      "complexity": "Time/Space complexity",
      "when_to_use": "When this alternative is better or worse",
      "verdict": "better|tradeoff|worse"
    }
  ]
}

Provide 4-6 steps, 2-3 tricky parts, 3-4 follow-up Q&As, and 2-3 alternatives. Make every explanation feel organic and intelligent ‚Äî not textbook-like.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
      body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:4000, system:systemPrompt, messages:[{role:'user', content:problem}] })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.content[0].text.trim().replace(/^```json\s*/i,'').replace(/\s*```$/,'');
    const parsed = JSON.parse(text);
    lastResult = parsed;
    renderResponse(parsed);
  } catch(err) {
    document.getElementById('responseArea').innerHTML = `<div class="error-box">‚ö†Ô∏è ${err.message}</div>`;
    document.getElementById('responseArea').classList.add('visible');
  } finally {
    btn.disabled = false;
    document.getElementById('btnText').textContent = 'Generate Java Code';
    document.getElementById('thinking').classList.remove('active');
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderResponse(d) {
  const area = document.getElementById('responseArea');

  // Steps
  const stepsHTML = d.steps.map((s,i) => `
    <li class="step-item">
      <div class="step-num">${i+1}</div>
      <div class="step-body">
        <div class="step-title">${s.title}</div>
        <div class="step-desc">${renderExpl(s.what)}<br><br>${renderExpl(s.how)}</div>
        <div class="step-why">üí° Why: ${s.why}</div>
      </div>
    </li>`).join('');

  // Tricky parts
  const trickyHTML = (d.tricky_parts||[]).map(t => `
    <div class="tricky-item">
      <div class="tricky-head">‚ö†Ô∏è ${t.issue}</div>
      <div class="tricky-desc">${renderExpl(t.explanation)}</div>
    </div>`).join('');

  // Follow-up Q&A
  const qaHTML = (d.followup_qa||[]).map(q => `
    <div class="qa-item">
      <div class="qa-q" onclick="toggleQA(this)">
        <span>${q.question}</span>
        <span class="chevron">‚Ä∫</span>
      </div>
      <div class="qa-a">${renderExpl(q.answer)}</div>
    </div>`).join('');

  // Alternatives
  const altHTML = (d.alternatives||[]).map(a => `
    <div class="alt-item">
      <div class="alt-head">
        <span>${a.name} <small style="color:var(--text-secondary);font-weight:400">${a.complexity}</small></span>
        <span class="alt-badge ${a.verdict}">${a.verdict === 'better' ? '‚úì Better case' : a.verdict === 'worse' ? '‚úó Worse' : '‚áÑ Trade-off'}</span>
      </div>
      <div class="alt-desc">${a.when_to_use}</div>
    </div>`).join('');

  area.innerHTML = `
    <!-- TAB BAR -->
    <div class="tab-bar">
      <div class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div>
      <div class="tab" data-tab="code" onclick="switchTab('code')">Code</div>
      <div class="tab" data-tab="walkthrough" onclick="switchTab('walkthrough')">Walkthrough</div>
      <div class="tab" data-tab="tricky" onclick="switchTab('tricky')">Gotchas</div>
      <div class="tab" data-tab="qa" onclick="switchTab('qa')">Q&amp;A</div>
      <div class="tab" data-tab="alts" onclick="switchTab('alts')">Alternatives</div>
    </div>

    <!-- OVERVIEW -->
    <div class="tab-panel active" id="panel_overview">
      <div class="thought-block">
        <div class="thought-label">üß† How I thought about this</div>
        ${d.thought_process}
      </div>
      <div class="analogy-block">
        <div class="analogy-label">üí° Real-world analogy</div>
        ${d.analogy}
      </div>
      <div class="summary-box">${d.summary}</div>
      <div class="meta-row">
        <span class="badge badge-complexity">${d.complexity}</span>
        <span class="badge badge-pattern">${d.pattern}</span>
        <span class="badge badge-approach">${d.approach}</span>
      </div>
      <div style="font-size:13px;line-height:1.7;color:var(--text-secondary);padding:4px 0 16px;">${d.complexity_explanation}</div>
      <button onclick="openSpeakMode()" style="width:100%;padding:12px;background:var(--accent-soft);border:1.5px solid rgba(200,169,110,0.4);border-radius:10px;font-size:13px;font-weight:600;color:var(--text-primary);cursor:pointer;">üì¢ Open Speak Mode</button>
    </div>

    <!-- CODE -->
    <div class="tab-panel" id="panel_code">
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Java</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <div class="code-content"><pre>${highlight(d.code)}</pre></div>
      </div>
    </div>

    <!-- WALKTHROUGH -->
    <div class="tab-panel" id="panel_walkthrough">
      <ul class="steps-list">${stepsHTML}</ul>
    </div>

    <!-- TRICKY PARTS -->
    <div class="tab-panel" id="panel_tricky">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">These are the parts that trip people up ‚Äî knowing these makes you sound thorough.</div>
      ${trickyHTML}
    </div>

    <!-- Q&A -->
    <div class="tab-panel" id="panel_qa">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Tap a question to see a confident answer you can give on the spot.</div>
      ${qaHTML}
    </div>

    <!-- ALTERNATIVES -->
    <div class="tab-panel" id="panel_alts">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing trade-offs shows depth. Mention these proactively.</div>
      ${altHTML}
    </div>
  `;

  area._rawCode = d.code;
  area.classList.add('visible');
}

function copyCode(btn) {
  const area = document.getElementById('responseArea');
  navigator.clipboard.writeText(area._rawCode||'').then(() => { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); });
}

document.getElementById('problemInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.shiftKey) { e.preventDefault(); generate(); }
});
</script>
</body>
</html>
