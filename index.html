<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#faf9f7;--sf:#ffffff;--br:#e8e5e0;
  --tp:#1a1916;--ts:#7a7670;
  --ac:#c8a96e;--as:#f5f0e8;
  --cdbg:#1a1917;--cdtx:#e8e4dc;
  --green:#3d7a52;--blue:#2d5fa0;--red:#8a3a3a;--purple:#6040a0;--orange:#b06020;
  --gs:#eaf3ee;--bs:#e8f0fb;--rs:#faeaea;--ps:#f2edfb;--os:#fdf0e4;
}
body{font-family:-apple-system,sans-serif;background:var(--bg);color:var(--tp);min-height:100vh;max-width:720px;margin:0 auto;padding:0 0 80px;}

/* LIST */
.app-header{padding:52px 24px 14px;border-bottom:1px solid var(â€“br);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(250,249,247,.93);}
.app-title{font-size:28px;font-weight:700;letter-spacing:-.5px;}
.note-count{font-size:13px;color:var(â€“ts);margin-top:3px;}
.note-row{padding:16px 24px;border-bottom:1px solid var(â€“br);display:flex;gap:14px;align-items:flex-start;cursor:pointer;width:100%;background:none;border-left:none;border-right:none;border-top:none;text-align:left;}
.note-row:active{background:var(â€“as);}
.note-icon{width:40px;height:40px;border-radius:10px;background:var(â€“as);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;}
.note-preview{flex:1;min-width:0;}
.note-title{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(â€“tp);}
.note-snippet{font-size:13px;color:var(â€“ts);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.note-date{font-size:12px;color:var(â€“ts);flex-shrink:0;margin-top:2px;}

/* DETAIL */
.note-detail{display:none;min-height:100vh;}
.note-detail.open{display:block;}
.detail-header{padding:13px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(â€“br);position:sticky;top:0;background:rgba(250,249,247,.96);backdrop-filter:blur(20px);z-index:10;}
.back-btn{color:var(â€“ac);font-size:17px;font-weight:600;border:none;background:none;padding:6px 4px;min-width:56px;cursor:pointer;}
.detail-title{flex:1;font-size:14px;font-weight:600;text-align:center;}
.gear-btn{font-size:20px;border:none;background:none;padding:6px;min-width:40px;color:var(â€“ac);cursor:pointer;}

/* SETUP */
.setup-box{margin:12px 20px;padding:14px;background:var(â€“as);border:1px solid rgba(200,169,110,.3);border-radius:12px;}
.setup-box input{width:100%;padding:9px 11px;border:1px solid var(â€“br);border-radius:8px;font-size:13px;font-family:monospace;background:#fff;color:var(â€“tp);outline:none;margin-bottom:7px;-webkit-appearance:none;}
.setup-box button{width:100%;padding:9px;background:var(â€“tp);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;}
.setup-lbl{font-size:12px;font-weight:600;margin-bottom:5px;}
.setup-desc{font-size:11px;color:var(â€“ts);margin-bottom:8px;line-height:1.5;}

/* MODE */
.mode-row{display:flex;margin:12px 20px 8px;background:var(â€“br);border-radius:11px;padding:3px;gap:2px;}
.mode-btn{flex:1;padding:8px 6px;border-radius:8px;border:none;font-size:11.5px;font-weight:700;cursor:pointer;transition:all .18s;background:none;color:var(â€“ts);}
.mode-btn.on{background:var(â€“sf);color:var(â€“tp);box-shadow:0 1px 4px rgba(0,0,0,.12);}

/* VOICE */
.voice-wrap{margin:0 20px 6px;background:var(â€“sf);border:1px solid var(â€“br);border-radius:14px;overflow:hidden;}
.voice-top{padding:10px 14px 8px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(â€“br);}
.vlbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(â€“ts);}
.vtimer{font-size:12px;color:var(â€“ts);font-variant-numeric:tabular-nums;}
.mic-wrap{display:flex;justify-content:center;padding:16px 0 4px;}
.mic-btn{width:68px;height:68px;border-radius:50%;background:var(â€“as);border:2px solid rgba(200,169,110,.4);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;}
.mic-btn:active{transform:scale(.92);}
.mic-btn.on{background:#fff0f0;border-color:rgba(200,60,60,.5);animation:mPulse 1s ease-in-out infinite;}
@keyframes mPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.waveform{display:none;align-items:flex-end;justify-content:center;gap:3px;height:26px;margin:3px auto 0;width:100px;}
.waveform.on{display:flex;}
.wb{width:4px;border-radius:2px;background:var(â€“ac);animation:wv .9s infinite ease-in-out;}
.wb:nth-child(1){animation-delay:0s}.wb:nth-child(2){animation-delay:.1s}.wb:nth-child(3){animation-delay:.2s}.wb:nth-child(4){animation-delay:.3s}.wb:nth-child(5){animation-delay:.2s}.wb:nth-child(6){animation-delay:.1s}.wb:nth-child(7){animation-delay:0s}
@keyframes wv{0%,100%{height:4px;opacity:.4}50%{height:22px;opacity:1}}
.vstatus{text-align:center;font-size:12.5px;color:var(â€“ts);padding:5px 14px 3px;font-style:italic;min-height:24px;}
.vstatus.on{color:#c0392b;font-style:normal;font-weight:500;}
.tbox{margin:7px 14px 11px;padding:10px 12px;background:var(â€“bg);border:1px solid var(â€“br);border-radius:9px;font-size:14px;line-height:1.65;color:var(â€“tp);min-height:48px;outline:none;-webkit-user-select:text;user-select:text;}
.tbox:empty::before{content:attr(data-ph);color:var(â€“ts);font-style:italic;}
.vactions{display:flex;gap:8px;padding:0 14px 14px;}
.btn-cl{flex:1;padding:10px;border-radius:8px;font-size:13px;font-weight:600;border:1.5px solid var(â€“br);background:var(â€“bg);color:var(â€“ts);cursor:pointer;}
.btn-go{flex:2;padding:10px;border-radius:8px;font-size:13px;font-weight:700;border:none;background:var(â€“tp);color:#fff;cursor:pointer;}
.btn-go:disabled{opacity:.35;cursor:not-allowed;}

/* CHIPS */
.chips{display:flex;gap:7px;padding:8px 20px 10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.chips::-webkit-scrollbar{display:none;}
.chip{padding:6px 13px;border-radius:20px;font-size:11.5px;font-weight:600;border:1.5px solid var(â€“br);background:var(â€“sf);color:var(â€“ts);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.chip.on{background:var(â€“tp);color:#fff;border-color:var(â€“tp);}

/* STREAM */
.sprog{display:none;margin:0 20px 2px;height:2px;background:var(â€“br);border-radius:2px;overflow:hidden;}
.sprog.on{display:block;}
.sbar{height:100%;background:linear-gradient(90deg,var(â€“ac),#e8c878);border-radius:2px;width:0%;transition:width .4s ease;}

/* THINKING */
.thinking{display:none;padding:14px 20px;align-items:center;gap:10px;}
.thinking.on{display:flex;}
.dots{display:flex;gap:4px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(â€“ac);animation:pulse 1.2s infinite;}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{transform:scale(1);opacity:.5}40%{transform:scale(1.3);opacity:1}}
.ttext{font-size:12.5px;color:var(â€“ts);font-style:italic;}

/* RESPONSE */
.rarea{padding:0 20px 40px;display:none;}
.rarea.on{display:block;}

/* PRIMARY TABS */
.ptabs{display:flex;border-bottom:1px solid var(â€“br);margin:0 -20px;padding:0 10px;overflow-x:auto;margin-top:14px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.ptabs::-webkit-scrollbar{display:none;}
.ptab{padding:9px 11px;font-size:11.5px;font-weight:700;color:var(â€“ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;}
.ptab.on{color:var(â€“tp);border-bottom-color:var(â€“ac);}
.ppanel{display:none;padding-top:14px;}
.ppanel.on{display:block;}

/* SUB-TABS */
.stab-row{display:flex;margin:10px -20px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;background:var(â€“sf);border-bottom:1px solid var(â€“br);}
.stab-row::-webkit-scrollbar{display:none;}
.stab{padding:8px 11px;font-size:10.5px;font-weight:700;color:var(â€“ts);cursor:pointer;border-bottom:2.5px solid transparent;white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:4px;}
.stab.on{color:var(â€“blue);border-bottom-color:var(â€“blue);}
.sn{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(â€“br);color:var(â€“ts);font-size:9px;font-weight:800;flex-shrink:0;}
.stab.on .sn{background:var(â€“blue);color:#fff;}
.step-t{font-size:9px;font-weight:400;color:var(â€“ts);margin-left:2px;}
.spanel{display:none;padding-top:12px;}
.spanel.on{display:block;}

/* CONTENT BLOCKS */
.iblock{border-radius:0 10px 10px 0;padding:13px 15px;font-size:13px;line-height:1.75;margin-bottom:11px;}
.iblock.blue{background:var(â€“bs);border-left:3px solid var(â€“blue);}
.iblock.green{background:var(â€“gs);border-left:3px solid var(â€“green);}
.iblock.red{background:var(â€“rs);border-left:3px solid var(â€“red);}
.iblock.purple{background:var(â€“ps);border-left:3px solid var(â€“purple);}
.iblock.orange{background:var(â€“os);border-left:3px solid var(â€“orange);}
.blbl{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.iblock.blue .blbl{color:var(â€“blue);}
.iblock.green .blbl{color:var(â€“green);}
.iblock.red .blbl{color:var(â€“red);}
.iblock.purple .blbl{color:var(â€“purple);}
.iblock.orange .blbl{color:var(â€“orange);}

.sumbox{background:var(â€“as);border:1px solid rgba(200,169,110,.3);border-radius:10px;padding:14px;font-size:14px;line-height:1.7;margin-bottom:12px;}
.mrow{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.badge{font-size:10.5px;padding:3px 9px;border-radius:20px;font-weight:600;}
.bb{background:var(â€“bs);color:var(â€“blue);border:1px solid rgba(45,95,160,.2);}
.bg{background:var(â€“gs);color:var(â€“green);border:1px solid rgba(61,122,82,.2);}
.ba{background:var(â€“as);color:var(â€“ac);border:1px solid rgba(200,169,110,.3);}
.bp{background:var(â€“ps);color:var(â€“purple);border:1px solid rgba(96,64,160,.2);}
.bo{background:var(â€“os);color:var(â€“orange);border:1px solid rgba(176,96,32,.2);}

.sublbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(â€“ts);margin:16px 0 7px;}
.hrow{background:var(â€“as);border:1px solid rgba(200,169,110,.22);border-radius:8px;padding:9px 13px;margin-bottom:7px;font-size:13px;line-height:1.6;}
.pill-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.pill{font-size:11.5px;padding:3px 11px;border-radius:20px;border:1px solid var(â€“br);background:var(â€“sf);color:var(â€“tp);font-weight:500;}
.divider{height:1px;background:var(â€“br);margin:14px 0;}

/* CARD */
.card{background:var(â€“sf);border:1px solid var(â€“br);border-radius:10px;padding:13px;margin-bottom:9px;}
.card-head{font-size:13px;font-weight:700;margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}
.cnum{width:22px;height:22px;border-radius:50%;background:var(â€“ac);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.card-body{font-size:12.5px;line-height:1.65;}
.card-body code{font-family:monospace;font-size:11px;background:var(â€“as);padding:1px 4px;border-radius:3px;}
.card-sub{font-size:11.5px;color:var(â€“blue);margin-top:5px;font-style:italic;}
.card-warn{font-size:11.5px;color:var(â€“red);margin-top:5px;}

/* TECH CARD with inline alts */
.tech-card{background:var(â€“sf);border:1px solid var(â€“br);border-radius:10px;padding:13px;margin-bottom:10px;}
.tech-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.tech-name{font-size:13.5px;font-weight:700;}
.chosen-tag{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700;background:var(â€“gs);color:var(â€“green);}
.tech-role{font-size:12.5px;line-height:1.6;color:var(â€“tp);margin-bottom:3px;}
.tech-why{font-size:12px;line-height:1.6;color:var(â€“ts);margin-bottom:8px;border-left:2px solid var(â€“green);padding-left:8px;}
.alt-lbl{font-size:9.5px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(â€“ts);margin-bottom:5px;}
.alt-row{display:flex;align-items:flex-start;gap:7px;padding:6px 9px;background:var(â€“bg);border-radius:7px;margin-bottom:4px;border:1px solid var(â€“br);}
.alt-name{font-size:12px;font-weight:600;flex-shrink:0;min-width:90px;}
.av{font-size:9.5px;padding:2px 7px;border-radius:7px;font-weight:700;flex-shrink:0;white-space:nowrap;}
.av-ok{background:var(â€“bs);color:var(â€“blue);}
.av-trade{background:var(â€“os);color:var(â€“orange);}
.av-avoid{background:var(â€“rs);color:var(â€“red);}
.alt-why{font-size:11.5px;color:var(â€“ts);line-height:1.5;}

/* DIAGRAM â€” two diagrams stacked, pre-wrap so no horizontal scroll */
.diag-wrap{margin-bottom:14px;}
.diag-label{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(â€“ts);margin-bottom:5px;display:flex;align-items:center;gap:6px;}
.diag-pill{font-size:9px;padding:2px 7px;border-radius:10px;background:var(â€“bs);color:var(â€“blue);font-weight:600;}
.diagram{background:var(â€“cdbg);border-radius:12px;padding:14px 16px;font-family:â€˜SF Monoâ€™,monospace;font-size:11.5px;line-height:1.9;color:#c8c4bc;white-space:pre-wrap;word-break:break-word;overflow-x:auto;}
/* colour accents inside diagram */
.diagram .chosen{color:#7ec87e;}
.diagram .alt{color:#e8c878;}

/* CODE â€” pre-wrap no horizontal scroll */
.code-outer{background:var(â€“cdbg);border-radius:12px;overflow:hidden;margin-bottom:10px;}
.code-hdr{padding:9px 14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.08);}
.code-lang{font-size:10px;color:#8a8580;font-family:monospace;letter-spacing:.05em;}
.copy-btn{font-size:11px;color:var(â€“ac);background:none;border:none;cursor:pointer;padding:3px 8px;border-radius:4px;font-weight:500;}
.code-body{padding:14px;}
.code-body pre{font-family:â€˜SF Monoâ€™,monospace;font-size:12px;line-height:1.7;color:var(â€“cdtx);white-space:pre-wrap;word-break:break-word;}

/* Q&A */
.qa-item{border:1px solid var(â€“br);border-radius:10px;overflow:hidden;margin-bottom:9px;}
.qa-q{padding:12px 14px;font-size:13px;font-weight:600;background:var(â€“sf);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px;}
.chev{color:var(â€“ts);transition:transform .2s;font-size:13px;flex-shrink:0;}
.chev.open{transform:rotate(90deg);}
.qa-a{display:none;padding:11px 14px;font-size:12.5px;line-height:1.7;background:var(â€“bg);border-top:1px solid var(â€“br);}
.qa-a.open{display:block;}

/* SKELETON shimmer */
.skel{background:linear-gradient(90deg,var(â€“br) 25%,var(â€“as) 50%,var(â€“br) 75%);background-size:200% 100%;animation:sk 1.2s infinite;border-radius:5px;height:13px;margin-bottom:7px;}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* SPEAK MODE */
#sovl{display:none;position:fixed;inset:0;background:rgba(12,11,10,.97);z-index:999;flex-direction:column;padding:60px 22px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
#sovl.on{display:flex;}
.sovl-close{position:fixed;top:16px;right:18px;color:var(â€“ac);font-size:26px;cursor:pointer;background:none;border:none;z-index:1000;padding:8px;}
.sovl-title{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(â€“ac);margin-bottom:18px;}
.sc{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:13px;padding:16px 18px;margin-bottom:13px;}
.sc-lbl{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(â€“ac);margin-bottom:8px;}
.sc-txt{font-size:15px;line-height:1.9;color:#ede9e2;}

.spk-btn{width:100%;padding:12px;background:var(â€“as);border:1.5px solid rgba(200,169,110,.4);border-radius:9px;font-size:13px;font-weight:600;color:var(â€“tp);cursor:pointer;margin-top:4px;}
.err-box{background:#fff0f0;border:1px solid #ffcccc;border-radius:9px;padding:13px 15px;font-size:13px;color:#c0392b;margin-top:10px;}
.fadein{animation:fadeIn .3s ease forwards;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.toast{position:fixed;bottom:36px;left:50%;transform:translateX(-50%);background:#1a1916;color:#fff;padding:8px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .25s;white-space:nowrap;pointer-events:none;}
</style>

</head>
<body>

<!-- LIST -->

<div id="list">
  <div class="app-header">
    <div class="app-title">Notes</div>
    <div class="note-count">4 notes</div>
  </div>
  <div style="padding:6px 0">
    <button class="note-row" onclick="openTool('coding')">
      <div class="note-icon">â˜•</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ Java</div><div class="note-snippet">Tap to solve a coding problemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="openTool('sd')">
      <div class="note-icon">ğŸ—ï¸</div>
      <div class="note-preview"><div class="note-title">Quick Ref â€“ System Design</div><div class="note-snippet">Tap to design a systemâ€¦</div></div>
      <div class="note-date">Now</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“‹</div>
      <div class="note-preview"><div class="note-title">Meeting notes â€“ Product sync</div><div class="note-snippet">Roadmap priorities, Q2 milestones</div></div>
      <div class="note-date">Mon</div>
    </button>
    <button class="note-row" onclick="void(0)">
      <div class="note-icon">ğŸ“</div>
      <div class="note-preview"><div class="note-title">Grocery list</div><div class="note-snippet">Eggs, bread, olive oil, tomatoesâ€¦</div></div>
      <div class="note-date">Sun</div>
    </button>
  </div>
</div>

<!-- TOOL -->

<div id="tool" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">â€¹ Notes</button>
    <div class="detail-title" id="dtitle">Quick Ref</div>
    <button class="gear-btn" onclick="toggleSetup()">âš™ï¸</button>
  </div>

  <div id="setup" class="setup-box" style="display:none;margin-top:12px">
    <div class="setup-lbl">ğŸ”‘ API Key</div>
    <div class="setup-desc">Stored locally â€” never sent anywhere except Anthropic.</div>
    <input type="password" id="apikey" placeholder="sk-ant-â€¦" autocomplete="off"/>
    <button onclick="saveKey()">Save & Close</button>
  </div>

  <div class="mode-row">
    <button class="mode-btn on" id="mCoding" onclick="setMode('coding')">â˜• Java Coding</button>
    <button class="mode-btn" id="mSD" onclick="setMode('sd')">ğŸ—ï¸ System Design</button>
  </div>

  <div class="voice-wrap">
    <div class="voice-top">
      <span class="vlbl" id="vlbl">ğŸ™ Speak your coding problem</span>
      <span class="vtimer" id="vtimer"></span>
    </div>
    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ™ï¸</button>
    </div>
    <div class="waveform" id="wf">
      <div class="wb" style="height:5px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:25px"></div>
      <div class="wb" style="height:19px"></div><div class="wb" style="height:11px"></div>
      <div class="wb" style="height:5px"></div>
    </div>
    <div class="vstatus" id="vs">Tap the mic and speak clearly</div>
    <div class="tbox" id="tbox" contenteditable="true" spellcheck="false" data-ph="Tap mic to speakâ€¦"></div>
    <div class="vactions">
      <button class="btn-cl" onclick="clearAll()">Clear</button>
      <button class="btn-go" id="goBtn" onclick="generate()" disabled>Generate âš¡</button>
    </div>
  </div>

  <div class="chips" id="chips">
    <div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div>
    <div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div>
    <div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>
  </div>

  <div class="sprog" id="sprog"><div class="sbar" id="sbar"></div></div>
  <div class="thinking" id="thinking"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div class="ttext" id="ttext">Thinkingâ€¦</div></div>
  <div class="rarea" id="rarea"></div>
</div>

<!-- SPEAK MODE -->

<div id="sovl">
  <button class="sovl-close" onclick="closeSM()">âœ•</button>
  <div class="sovl-title">ğŸ“¢ How to Explain This</div>
  <div id="smc"></div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â• STATE â•â•â• */
const SK='nt_v6';
let mode='coding',depth='interview',last=null;
let rec=null,listening=false,silT=null,timerI=null,elapsed=0,accTxt='';

/* â•â•â• KEY â€” localStorage wrapped in try/catch for sandboxed iframes â•â•â• */
let _memKey='';
const getKey=()=>{try{return localStorage.getItem(SK)||_memKey;}catch(e){return _memKey;}};
const setKey=v=>{_memKey=v;try{localStorage.setItem(SK,v);}catch(e){}};
function saveKey(){const v=document.getElementById('apikey').value.trim();if(!v){toast('Enter a key');return;}setKey(v);document.getElementById('setup').style.display='none';toast('Saved âœ“');}
function toggleSetup(){const s=document.getElementById('setup');const show=s.style.display==='none';s.style.display=show?'block':'none';if(show&&getKey())document.getElementById('apikey').value=getKey();}

/* â•â•â• NAV â•â•â• */
function openTool(m){document.getElementById('list').style.display='none';document.getElementById('tool').classList.add('open');setMode(m);if(!getKey())document.getElementById('setup').style.display='block';}
function goBack(){stopMic(false);document.getElementById('tool').classList.remove('open');document.getElementById('list').style.display='block';clearAll();last=null;}

/* â•â•â• MODE â•â•â• */
function setMode(m){
  mode=m;
  document.getElementById('mCoding').classList.toggle('on',m==='coding');
  document.getElementById('mSD').classList.toggle('on',m==='sd');
  document.getElementById('dtitle').textContent=m==='coding'?'Java Coding':'System Design';
  document.getElementById('vlbl').textContent=m==='coding'?'ğŸ™ Speak your coding problem':'ğŸ™ Describe the system to design';
  document.getElementById('tbox').setAttribute('data-ph',m==='coding'?'Tap mic to speak your problemâ€¦':'e.g. "Design Twitter" or "Design a URL shortener"');
  const ch=document.getElementById('chips');
  if(m==='sd'){ch.innerHTML=`<div class="chip on" data-d="senior" onclick="setDepth(this)">ğŸ¯ Senior/Staff</div><div class="chip" data-d="mid" onclick="setDepth(this)">ğŸ‘¨â€ğŸ’» Mid-level</div><div class="chip" data-d="deep" onclick="setDepth(this)">ğŸ“– Deep Dive</div>`;depth='senior';}
  else{ch.innerHTML=`<div class="chip on" data-d="interview" onclick="setDepth(this)">ğŸ¯ Interview</div><div class="chip" data-d="explain" onclick="setDepth(this)">ğŸ—£ï¸ Team</div><div class="chip" data-d="beginner" onclick="setDepth(this)">ğŸ“– Beginner</div>`;depth='interview';}
  clearAll();
}
function setDepth(el){el.closest('.chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));el.classList.add('on');depth=el.dataset.d;}

/* â•â•â• TOAST / TIMER â•â•â• */
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity='0',2400);}
function startTimer(){elapsed=0;clearInterval(timerI);timerI=setInterval(()=>{elapsed++;document.getElementById('vtimer').textContent=pad(Math.floor(elapsed/60))+':'+pad(elapsed%60);},1000);}
function stopTimer(){clearInterval(timerI);document.getElementById('vtimer').textContent='';}
const pad=n=>String(n).padStart(2,'0');

/* â•â•â• MIC â•â•â• */
function toggleMic(){listening?stopMic(true):startMic();}
function startMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('Voice not supported â€” type instead');return;}
  accTxt=document.getElementById('tbox').textContent.trim();
  rec=new SR();rec.continuous=true;rec.interimResults=true;rec.lang='en-US';
  rec.onstart=()=>{listening=true;document.getElementById('micBtn').classList.add('on');document.getElementById('micBtn').textContent='â¹ï¸';document.getElementById('wf').classList.add('on');document.getElementById('vs').textContent='Listeningâ€¦ speak clearly';document.getElementById('vs').classList.add('on');startTimer();};
  rec.onresult=e=>{
    clearTimeout(silT);silT=setTimeout(()=>stopMic(true),2800);
    let fin=accTxt?accTxt+' ':'',int='';
    for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;e.results[i].isFinal?(fin+=t,accTxt=fin.trim()):int=t;}
    document.getElementById('tbox').textContent=(accTxt+(int?' '+int:'')).trim();chkBtn();
  };
  rec.onerror=e=>{if(e.error==='not-allowed')toast('Mic blocked â€” allow in Safari settings');stopMic(false);};
  rec.onend=()=>{if(listening){try{rec.start();}catch(e){stopMic(false);}}};
  try{rec.start();}catch(e){toast('Cannot start mic');}
}
function stopMic(auto){
  const was=listening;listening=false;clearTimeout(silT);stopTimer();
  if(rec){try{rec.stop();}catch(e){}rec=null;}
  document.getElementById('micBtn').classList.remove('on');document.getElementById('micBtn').textContent='ğŸ™ï¸';
  document.getElementById('wf').classList.remove('on');document.getElementById('vs').classList.remove('on');
  const txt=document.getElementById('tbox').textContent.trim();
  if(was&&auto&&txt.length>5){document.getElementById('vs').textContent='Got it â€” generatingâ€¦';setTimeout(generate,500);}
  else{document.getElementById('vs').textContent=txt.length>5?'Ready â€” tap Generate':'Tap the mic and speak clearly';}
}
function chkBtn(){document.getElementById('goBtn').disabled=document.getElementById('tbox').textContent.trim().length<5;}
function clearAll(){accTxt='';document.getElementById('tbox').textContent='';document.getElementById('goBtn').disabled=true;document.getElementById('vs').textContent='Tap the mic and speak clearly';document.getElementById('rarea').innerHTML='';document.getElementById('rarea').classList.remove('on');document.getElementById('thinking').classList.remove('on');document.getElementById('sprog').classList.remove('on');document.getElementById('sbar').style.width='0%';last=null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE â€” STREAMING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generate(){
  const prob=document.getElementById('tbox').textContent.trim();
  if(prob.length<4){toast('Say or type a problem first');return;}
  const key=getKey();if(!key){toggleSetup();toast('Add API key first');return;}
  document.getElementById('goBtn').disabled=true;
  document.getElementById('rarea').innerHTML='';
  document.getElementById('rarea').classList.remove('on');
  document.getElementById('thinking').classList.add('on');
  document.getElementById('ttext').textContent=mode==='coding'?'Solving your problemâ€¦':'Architecting your systemâ€¦';
  document.getElementById('sprog').classList.add('on');
  const bar=document.getElementById('sbar');bar.style.width='5%';
  const sys=mode==='coding'?codingPrompt():sdPrompt();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:mode==='coding'?4500:12000,stream:true,system:sys,messages:[{role:'user',content:prob}]})
    });
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'API error '+res.status);}
    const reader=res.body.getReader(),dec=new TextDecoder();
    let full='',pct=5,dk=new Set(),lineBuf='';
    /* Show skeleton immediately */
    document.getElementById('thinking').classList.remove('on');
    showSkeleton();
    document.getElementById('rarea').classList.add('on');

    while(true){
      const{done,value}=await reader.read();
      /* Flush decoder on final read â€” no stream:true drains internal buffer */
      const chunk=value?dec.decode(value,{stream:true}):(done?dec.decode():'');
      lineBuf+=chunk;
      const lines=lineBuf.split('\n');
      lineBuf=lines.pop()||'';
      for(const ln of lines){
        if(!ln.startsWith('data: '))continue;
        const d=ln.slice(6).trim();
        if(d==='[DONE]')continue;
        try{
          const ev=JSON.parse(d);
          if(ev.type==='content_block_delta'&&ev.delta?.text){
            full+=ev.delta.text;
            pct=Math.min(90,pct+0.15);
            bar.style.width=pct+'%';
            patch(full,dk);
          }
        }catch(e){}
      }
      if(done)break;
    }
    /* Drain any remaining line buffer */
    if(lineBuf.startsWith('data: ')){
      const d=lineBuf.slice(6).trim();
      if(d&&d!=='[DONE]'){try{const ev=JSON.parse(d);if(ev.type==='content_block_delta'&&ev.delta?.text)full+=ev.delta.text;}catch(e){}}
    }

    bar.style.width='100%';
    setTimeout(()=>{document.getElementById('sprog').classList.remove('on');bar.style.width='0%';},500);

    /* Multi-strategy JSON parse */
    let parsed=null;
    const tryP=s=>{try{return JSON.parse(s);}catch(e){return null;}};
    let c=full.trim().replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
    parsed=tryP(c);
    if(!parsed){const fi=c.indexOf('{'),la=c.lastIndexOf('}');if(fi>=0&&la>fi)parsed=tryP(c.slice(fi,la+1));}
    if(!parsed){try{parsed=tryP(c.replace(/,\s*([}\]])/g,'$1'));}catch(e){}}

    if(parsed){
      last={mode,data:parsed};
      mode==='coding'?renderCoding(parsed):renderSD(parsed);
    }else{
      document.getElementById('rarea').innerHTML=
        '<div class="err-box">&#9888; Could not parse response.'+(full.length<50?' Response empty â€” check API key.':' Model returned unexpected format. Tap Generate to retry.')+'<br><br>'+
        '<details><summary style="cursor:pointer;font-weight:600">Show raw response</summary>'+
        '<pre style="white-space:pre-wrap;word-break:break-word;font-size:10px;margin-top:6px;max-height:180px;overflow-y:auto">'+
        full.slice(0,800).replace(/&/g,'&amp;').replace(/</g,'&lt;')+
        '</pre></details></div>';

```
}
```

}catch(err){
document.getElementById(â€˜thinkingâ€™).classList.remove(â€˜onâ€™);
document.getElementById(â€˜rareaâ€™).innerHTML=â€™<div class="err-box">âš ï¸ â€˜+err.message+â€™</div>â€™;
document.getElementById(â€˜rareaâ€™).classList.add(â€˜onâ€™);
document.getElementById(â€˜sprogâ€™).classList.remove(â€˜onâ€™);
}finally{
document.getElementById(â€˜goBtnâ€™).disabled=false;
document.getElementById(â€˜thinkingâ€™).classList.remove(â€˜onâ€™);
document.getElementById(â€˜vsâ€™).textContent=â€˜Tap mic to record againâ€™;
}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STREAM PATCH â€” renders content progressively as tokens arrive.
Uses TWO extraction strategies:
A) strComplete â€” only fires when JSON string is fully closed (safe for short fields)
B) strPartial  â€” fires as soon as MIN_CHARS arrived (for long fields like thought_process)
Priority: problem_statement (partial, ~40 chars) â†’ FR items â†’ NFR items â†’ thought_process
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function patch(txt,dk){
/* A: fully-closed string â€” safe value */
const strComplete=key=>{
const m=txt.match(new RegExp(â€™â€â€™+key+â€™â€\s*:\s*â€((?:[^â€\\]|\\.)*?)â€\s*[,}\n]â€™,â€˜sâ€™));
return m?unescape(m[1]):null;
};
/* B: partial string â€” grab whatever has arrived so far (no closing quote required) */
const strPartial=(key,minLen=40)=>{
const m=txt.match(new RegExp(â€™â€â€™+key+â€™â€\s*:\s*â€((?:[^â€\\]|\\.){â€™+minLen+â€™,})â€™,â€˜sâ€™));
return m?unescape(m[1]):null;
};
const unescape=s=>s.replace(/\n/g,â€™\nâ€™).replace(/\â€/g,â€™â€â€™).replace(/\\/g,â€™\â€™);

/* Write to a named slot, removing skeleton shimmer lines */
const slot=(id,html)=>{
const el=document.getElementById(id);
if(!el||el.dataset.filled)return;
el.dataset.filled=â€˜1â€™;
el.innerHTML=html;
el.classList.add(â€˜fadeinâ€™);
};

if(mode===â€˜codingâ€™){
[â€˜thought_processâ€™,â€˜analogyâ€™,â€˜summaryâ€™,â€˜complexityâ€™].forEach(k=>{
if(!dk.has(k)){
const v=strComplete(k)||strPartial(k,30);
if(v&&v.length>15){dk.add(k);slot(â€˜sk_â€™+k,v.replace(/\n/g,â€™<br>â€™));}
}
});
return;
}

/* â”€â”€ SD mode â”€â”€ */

/* PRIORITY 1: problem_statement â€” partial, fires as soon as ~50 chars arrive (~1s) */
if(!dk.has(â€˜psâ€™)){
const v=strComplete(â€˜problem_statementâ€™)||strPartial(â€˜problem_statementâ€™,50);
if(v&&v.length>15){dk.add(â€˜psâ€™);slot(â€˜sk_psâ€™,v);}
}

/* PRIORITY 2: functional requirements â€” parse objects as each closes */
if(!dk.has(â€˜frâ€™)){
const m=txt.match(/â€œfunctionalâ€\s*:\s*[([\s\S]*?)(?:]|(?=â€œnon_functionalâ€))/);
if(m&&m[1]){
const reqs=[];let rx2=/â€œreqâ€\s*:\s*â€([^â€\\]+)â€/g,hit;
while((hit=rx2.exec(m[1]))!==null)reqs.push(hit[1]);
if(reqs.length>=1){
dk.add(â€˜frâ€™);
/* Donâ€™t lock â€” keep updating until NFR starts */
const el=document.getElementById(â€˜sk_frâ€™);
if(el){el.innerHTML=reqs.map(r=>â€™<div class="hrow fadein">ğŸ”µ â€˜+r+â€™</div>â€™).join(â€™â€™);el.classList.add(â€˜fadeinâ€™);}
}
}
}

/* PRIORITY 3: NFRs â€” same rolling parse */
if(!dk.has(â€˜nfrâ€™)){
const m=txt.match(/â€œnon_functionalâ€\s*:\s*[([\s\S]*?)(?:]|(?=â€œout_of_scopeâ€))/);
if(m&&m[1]){
const items=[];let pos=0;
while(true){
const s=m[1].indexOf(â€™â€œreqâ€â€™,pos);if(s<0)break;
const rM=m[1].slice(s).match(/â€œreqâ€\s*:\s*â€([^â€\\]+)â€/);
const vM=m[1].slice(s).match(/â€œvalueâ€\s*:\s*â€([^â€\\]+)â€/);
if(rM)items.push({r:rM[1],v:vM?vM[1]:â€™â€™});
pos=s+5;
}
if(items.length>=1){
dk.add(â€˜nfrâ€™);
const el=document.getElementById(â€˜sk_nfrâ€™);
if(el){el.innerHTML=items.map(i=>â€™<div class="hrow fadein">â— <strong>â€™+i.r+â€™</strong>â€™+(i.v?â€™ <span class="badge ba">â€™+i.v+â€™</span>â€™:â€™â€™)+â€™</div>â€™).join(â€™â€™);el.classList.add(â€˜fadeinâ€™);}
}
}
}

/* PRIORITY 4: capacity numbers â€” parse as soon as write_qps appears */
if(!dk.has(â€˜capâ€™)){
const wq=strComplete(â€˜write_qpsâ€™), rq=strComplete(â€˜read_qpsâ€™), st=strComplete(â€˜storage_per_yearâ€™);
const assM=txt.match(/â€œassumptionsâ€\s*:\s*[([\s\S]*?)(?:])/);
const assumptions=[];
if(assM){let rx3=/â€([^â€]+)â€/g,h2;while((h2=rx3.exec(assM[1]))!==null)assumptions.push(h2[1]);}
if(wq&&rq){
dk.add(â€˜capâ€™);
const el=document.getElementById(â€˜sk_capâ€™);
if(el){
el.innerHTML=
(assumptions.length?assumptions.map(a=>â€™<div style="font-size:11.5px;color:var(--ts);margin-bottom:3px">â€¢ â€˜+a+â€™</div>â€™).join(â€™â€™):â€™â€™) +
â€˜<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">â€™+
â€˜<div style="flex:1;min-width:110px;background:var(--os);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">âœï¸ Write QPS</div><div style="font-size:12px;font-weight:700">â€™+wq+â€™</div></div>â€™+
â€˜<div style="flex:1;min-width:110px;background:var(--bs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ“– Read QPS</div><div style="font-size:12px;font-weight:700">â€™+rq+â€™</div></div>â€™+
(st?â€™<div style="flex:1;min-width:110px;background:var(--gs);border-radius:7px;padding:8px 10px"><div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ’¾ Storage/yr</div><div style="font-size:12px;font-weight:700">â€™+st+â€™</div></div>â€™:â€™â€™)+
â€˜</div>â€™;
el.classList.add(â€˜fadeinâ€™);
}
}
}

/* PRIORITY 5: thought_process â€” partial after 80 chars (~5-6s) */
if(!dk.has(â€˜tpâ€™)){
const v=strComplete(â€˜thought_processâ€™)||strPartial(â€˜thought_processâ€™,80);
if(v&&v.length>40){dk.add(â€˜tpâ€™);slot(â€˜sk_tpâ€™,v.replace(/\n/g,â€™<br>â€™));}
}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SKELETON â€” shown instantly before any stream arrives
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSkeleton(){
const a=document.getElementById(â€˜rareaâ€™);
if(mode===â€˜codingâ€™){
a.innerHTML=`<div style="padding-top:12px"> <div class="iblock blue"><div class="blbl">ğŸ§  Approach</div><div id="sk_thought_process"><div class="skel" style="width:100%"></div><div class="skel" style="width:84%"></div><div class="skel" style="width:66%"></div></div></div> <div class="iblock green"><div class="blbl">ğŸ’¡ Analogy</div><div id="sk_analogy"><div class="skel" style="width:100%"></div><div class="skel" style="width:72%"></div></div></div> <div class="sumbox" id="sk_summary"><div class="skel" style="width:100%"></div><div class="skel" style="width:55%"></div></div> <div id="sk_complexity" style="font-size:12.5px;color:var(--ts);padding:2px 0 10px"><div class="skel" style="width:76%"></div><div class="skel" style="width:52%"></div></div> <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:6px 0">â³ Code & walkthrough loadingâ€¦</div></div>`;
} else {
a.innerHTML=`<div style="padding-top:12px">
<!-- Problem statement arrives FIRST ~1-2s -->
<div class="sumbox" id="sk_ps" style="min-height:52px"><div class="skel" style="width:100%"></div><div class="skel" style="width:68%"></div></div>

```
  <!-- FRs stream in ~2-3s -->
  <div class="sublbl">ğŸ”µ Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
  <div id="sk_fr"><div class="skel" style="width:90%"></div><div class="skel" style="width:76%"></div><div class="skel" style="width:83%"></div></div>

  <!-- NFRs stream in ~3-4s -->
  <div class="sublbl">â— Non-Functional Requirements <span style="font-size:9px;font-weight:400;color:var(--ts)">(streamingâ€¦)</span></div>
  <div id="sk_nfr"><div class="skel" style="width:86%"></div><div class="skel" style="width:72%"></div><div class="skel" style="width:79%"></div></div>

  <!-- Capacity numbers stream in ~4-5s -->
  <div class="sublbl">ğŸ“Š Scale Assumptions & QPS</div>
  <div id="sk_cap" style="background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:11px 13px;margin-bottom:10px">
    <div class="skel" style="width:80%;margin-bottom:6px"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
      <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
      <div style="flex:1;min-width:120px"><div class="skel" style="width:100%;height:32px;border-radius:6px"></div></div>
    </div>
  </div>

  <!-- Interview framing ~5-6s -->
  <div class="sublbl">ğŸ§  Interview Framing</div>
  <div class="iblock blue" id="sk_tp"><div class="skel" style="width:100%"></div><div class="skel" style="width:88%"></div><div class="skel" style="width:70%"></div><div class="skel" style="width:80%"></div></div>

  <div style="text-align:center;font-size:11px;color:var(--ts);font-style:italic;padding:10px 0">â³ Diagrams, components & deep dives loadingâ€¦</div></div>`;
```

}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PROMPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function codingPrompt(){
const ctx={interview:â€˜Crisp, confident. Anticipate follow-ups.â€™,explain:â€˜Conversational, real-world trade-offs.â€™,beginner:â€˜Simple language, vivid analogies.â€™}[depth];
return `Elite Java coding coach. Context: ${ctx} Return ONLY valid JSON starting with { : {"summary":"confident one-liner","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences WHY","pattern":"algorithm pattern","approach":"core technique","thought_process":"4-5 sentences first-person: aha moment, why naive fails, why this clicks","analogy":"vivid 2-3 sentence real-world analogy","code":"complete clean well-commented Java â€” use meaningful variable names","steps":[{"title":"title","what":"1-2 sentences","how":"mechanics with backtick \`varName`â€,â€œwhyâ€:â€œreasoningâ€}],â€œtricky_partsâ€:[{â€œissueâ€:â€œgotchaâ€,â€œexplanationâ€:â€œwhy tricky, exactly how handledâ€}],â€œfollowup_qaâ€:[{â€œquestionâ€:â€œrealistic questionâ€,â€œanswerâ€:â€œconfident 3-4 sentence answerâ€}],â€œalternativesâ€:[{â€œnameâ€:â€œapproachâ€,â€œcomplexityâ€:â€œT/Sâ€,â€œwhen_to_useâ€:â€œwhen to preferâ€,â€œverdictâ€:â€œbetter|tradeoff|worseâ€}]}
5-6 steps, 3 tricky_parts, 5 followup_qa, 3 alternatives.`;
}

function sdPrompt(){
const lvl={
senior:â€˜Senior/Staff Engineer level â€” deep trade-offs, real numbers, justify EVERY decision.â€™,
mid:â€˜Mid-level â€” clear architecture with solid reasoning on key trade-offs.â€™,
deep:â€˜Thorough walkthrough â€” explain every component as if teaching a principal engineer.â€™
}[depth]||â€˜Senior/Staff Engineer level.â€™;

return `You are a principal engineer who has conducted 200+ FAANG system design interviews. You follow Evan Kingâ€™s Hello Interview framework EXACTLY. Your answers are the benchmark candidates are measured against.

LEVEL: ${lvl}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EVAN KINGâ€™S HELLO INTERVIEW FRAMEWORK â€” STRICT ORDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Step 1: Requirements (FRs + NFRs + capacity)
Step 2: Core Entities â€” nouns ONLY, no fields yet
Step 3: API Design â€” REST endpoints + real-time protocol
Step 4: High-Level Design â€” draw boxes and arrows, schema emerges HERE as you trace each request
Step 5: Deep Dives â€” harden specific NFRs

IMPORTANT on Entities vs Schema:

- Step 2 entities = NOUNS ONLY. â€œUser, Tweet, Follow, Timelineâ€. NO fields. Fields belong in HLD.
- Schema lives in step5_high_level_design, NOT in step2. You introduce fields only when you trace the write path through each service to the DB.
- This separation is deliberate â€” Evan King explicitly teaches it. Candidates who dump fields in step 2 waste time and lose signal on prioritization.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DIAGRAM RULES â€” CRITICAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Produce TWO diagrams. Diagram 2 MUST visibly EVOLVE from Diagram 1 â€” same core boxes, with new layers added on top.

DIAGRAM 1 â€” Baseline (satisfies core FRs only, simple monolith path):
Use this style. Every box must be drawn with â”Œâ”€â”â””â”€â”˜â”‚ box-drawing chars. Arrows must be â†“ or â†’ never plain dashes.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  (Web / Mobile)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer (Nginx)     â”‚  â€” horizontal scale, health checks
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Server                â”‚  â€” stateless, JWT auth
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†“ (write)   â†“ (read)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Primary DB  (PostgreSQL)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DIAGRAM 2 â€” Production (evolves diagram 1, every NEW component labelled with WHY it was added):

- Keep the SAME core boxes from Diagram 1
- Add new layers above/below with a comment showing what NFR it satisfies
- Every component that has alternatives: show on same line in [brackets]
- Mark new additions with â˜… prefix so evolution is clear

Example evolution annotation style:
â˜… CDN [CloudFront|Akamai|Fastly]   â† satisfies: p99 latency < 100ms for global users
â˜… Kafka [RabbitMQ|SQS]             â† satisfies: async fan-out, decouples write latency
â˜… Redis Cache [Memcached]          â† satisfies: read QPS 100k/s without DB overload

BOTH diagrams must be 100% accurate for the specific system â€” do NOT use Twitter/feed as a template for a URL shortener.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUALITY BAR â€” what separates Staff from Mid answers
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- Never say â€œuse a databaseâ€. Say â€œPostgreSQL with a composite index on (user_id, created_at DESC) because our read pattern is always per-user ordered by timeâ€
- Never say â€œadd a cacheâ€. Say â€œRedis with write-through strategy, TTL 5 min, ~95% hit rate at 100K read QPS eliminates the need for read replicas in early stagesâ€
- Never say â€œuse a queueâ€. Say â€œKafka with 3 partitions keyed by user_id â€” gives us ordered fan-out per user and consumer group replay if the notification service crashesâ€
- Capacity numbers must drive decisions: â€œat 10K write QPS a single Postgres instance hits ~8K TPS limit â€” this is why we add read replicasâ€
- Always state the bottleneck and how you resolved it

Return ONLY valid JSON, starting with {, no markdown fences, no preamble:
{
â€œproblem_statementâ€: â€œ2-3 sentences: exactly what we are building, the core scale challenge, and the dominant technical constraint (read-heavy? write-heavy? consistency? latency?)â€,

â€œthought_processâ€: â€œ5-6 sentences, first-person Staff engineer thinking out loud: 1) what makes this uniquely hard 2) the core trade-off (e.g. consistency vs availability) 3) read/write ratio and how it drives architecture 4) the one insight most candidates miss 5) your high-level approachâ€,

â€œclarifying_questionsâ€: [
â€œDAU / MAU â€” sets scale tier (10M vs 500M changes every decision)â€,
â€œone question scoping a key feature boundaryâ€,
â€œone question surfacing the dominant trade-off (e.g. is eventual consistency acceptable?)â€
],

â€œstep1_requirementsâ€: {
â€œfunctionalâ€: [
{â€œreqâ€: â€œUsers should be able to [verb] [noun]â€, â€œpriorityâ€: â€œcoreâ€, â€œtechnical_implicationâ€: â€œspecific architectural consequence â€” e.g. fan-out on write required, or requires low-latency read pathâ€}
],
â€œnon_functionalâ€: [
{â€œreqâ€: â€œSystem must achieve [measurable quality]â€, â€œvalueâ€: â€œconcrete number e.g. p99 write latency < 500msâ€, â€œtradeoffâ€: â€œwhat we sacrifice â€” e.g. strong consistency traded for availabilityâ€},
{â€œreqâ€: â€œSystem must handle [scale]â€, â€œvalueâ€: â€œe.g. 100K read QPS at peakâ€, â€œtradeoffâ€: â€œcost of caching layerâ€},
{â€œreqâ€: â€œSystem must be [reliability]â€, â€œvalueâ€: â€œ99.99% availability (< 52 min downtime/year)â€, â€œtradeoffâ€: â€œcomplexity of multi-region failoverâ€},
{â€œreqâ€: â€œData must be [durability]â€, â€œvalueâ€: â€œno data loss on single node failureâ€, â€œtradeoffâ€: â€œreplication overheadâ€}
],
â€œout_of_scopeâ€: [â€œspecific excluded feature â€” e.g. analytics/reporting dashboardâ€, â€œanother exclusionâ€],
â€œcapacityâ€: {
â€œassumptionsâ€: [â€œe.g. 100M DAUâ€, â€œe.g. avg 2 writes/user/dayâ€, â€œe.g. avg 20 reads/user/dayâ€, â€œe.g. avg object size 1KBâ€],
â€œwrite_qpsâ€: â€œ~2,300/s (100M Ã— 2 / 86,400) â€” show the actual calcâ€,
â€œread_qpsâ€: â€œ~23,000/s (100M Ã— 20 / 86,400) â€” 10:1 read/write ratioâ€,
â€œstorage_per_yearâ€: â€œ~72 TB/year (2,300 writes/s Ã— 1KB Ã— 31.5M seconds)â€,
â€œdesign_impactâ€: â€œRead/write ratio of 10:1 â†’ add read replicas and Redis cache. Storage of 72TB/yr â†’ consider object store for large blobs.â€
}
},

â€œstep2_core_entitiesâ€: [
{
â€œnameâ€: â€œEntityNameâ€,
â€œdescriptionâ€: â€œwhat this noun represents â€” one sentence on its domain roleâ€,
â€œnoteâ€: â€œthe non-obvious modeling insight â€” e.g. why this is a separate entity vs embedded, or why it is denormalizedâ€
}
],

â€œstep3_api_designâ€: {
â€œprotocol_choiceâ€: â€œREST â€” default. One sentence why REST over gRPC/GraphQL for this specific system.â€,
â€œrealtime_protocolâ€: {
â€œneededâ€: true,
â€œchosenâ€: â€œSSE | WebSocket | Long Polling | Noneâ€,
â€œreasonâ€: â€œspecific reason matched to this system â€” e.g. SSE because updates are serverâ†’client only (notifications/feed), auto-reconnects, simpler than WS when client never sendsâ€,
â€œwhere_in_archâ€: â€œexactly where it plugs in â€” e.g. Client keeps open SSE connection to Notification Service through API Gateway; fan-out worker pushes events to Redis Pub/Sub â†’ Notification Service â†’ clientâ€,
â€œalternativesâ€: [
{â€œnameâ€: â€œWebSocketâ€, â€œverdictâ€: â€œtradeoffâ€, â€œreasonâ€: â€œbetter for bi-directional (chat, collaborative editing); overhead not justified when client only receivesâ€},
{â€œnameâ€: â€œLong Pollingâ€, â€œverdictâ€: â€œavoidâ€, â€œreasonâ€: â€œreconnects every 30s, 100K concurrent users = 3.3K reconnects/sec hammering API Gateway â€” wasteful vs persistent SSEâ€},
{â€œnameâ€: â€œPollingâ€, â€œverdictâ€: â€œavoidâ€, â€œreasonâ€: â€œfixed interval polling at 100K users even at 30s interval = 3.3K req/s wasted on empty responsesâ€}
]
},
â€œendpointsâ€: [
{
â€œmethodâ€: â€œPOST|GET|PUT|DELETEâ€,
â€œpathâ€: â€œ/v1/resourceâ€,
â€œauthâ€: â€œJWT Bearer â€” user_id derived from token, NEVER from request bodyâ€,
â€œrequestâ€: â€œ{ field: type, field2: type }â€,
â€œresponseâ€: â€œ{ id: uuid, â€¦relevant fields, created_at: ISO8601 }â€,
â€œnoteâ€: â€œRate limit: X req/min. Key design note â€” e.g. idempotency key required to prevent double-submitâ€
}
]
},

â€œstep4_data_flowâ€: {
â€œneededâ€: true,
â€œreasonâ€: â€œone sentence why the flow matters â€” e.g. fan-out complexity, async processing pipelineâ€,
â€œstepsâ€: [
â€œ1. Client â†’ POST /v1/[resource] with JWT Bearer tokenâ€,
â€œ2. API Gateway validates JWT, applies rate limit (token bucket), routes to Write Serviceâ€,
â€œ3. Write Service validates payload, writes to Primary DB (synchronous, durability guarantee)â€,
â€œ4. Write Service publishes event to Kafka topic (async, fire-and-forget after DB ack)â€,
â€œ5. Fan-out Worker consumes event, updates derived caches / search index / notification queueâ€,
â€œ6. Read path: Client GET â†’ API GW â†’ Read Service â†’ Redis cache (hit ~95%) â†’ on miss: Read Replica â†’ cache back-fillâ€
]
},

â€œstep5_high_level_designâ€: {
â€œdiagram_simpleâ€: â€œDraw Diagram 1 here â€” baseline satisfying core FRs only. Use â”Œâ”€â”â””â”€â”˜â”‚â†“â†’ box-drawing. Show: Client â†’ Load Balancer â†’ API Server â†’ Primary DB. Label EVERY arrow with what flows (e.g. HTTP/REST, SQL query). Keep it to 6-8 boxes maximum. Make it specific to this system, not generic.â€,
â€œdiagram_simple_commentaryâ€: [
{â€œcomponentâ€: â€œname of first key boxâ€, â€œsayâ€: â€œword-for-word what to say while drawing this â€” explain its role and why itâ€™s hereâ€},
{â€œcomponentâ€: â€œname of second key boxâ€, â€œsayâ€: â€œword-for-word what to say â€” include the specific trade-off this component introducesâ€},
{â€œcomponentâ€: â€œPrimary DBâ€, â€œsayâ€: â€œword-for-word â€” name the specific DB, why it was chosen, and what the bottleneck will be at scaleâ€}
],
â€œdiagram_scaledâ€: â€œDraw Diagram 2 here â€” EVOLUTION of Diagram 1. Keep the same core boxes. Add new components with â˜… prefix and a comment showing which NFR each satisfies. Show write path (left side) and read path (right side) diverging from API Gateway. Use â”Œâ”€â”â””â”€â”˜â”‚â†“â†’ box-drawing. Label EVERY arrow. Show [Alt1|Alt2] on every component that has alternatives.â€,
â€œdiagram_scaled_commentaryâ€: [
{â€œcomponentâ€: â€œâ˜… first new component addedâ€, â€œsayâ€: â€œexplain WHY this was added â€” connect it to the specific NFR it satisfies and the bottleneck it solvesâ€},
{â€œcomponentâ€: â€œâ˜… second new componentâ€, â€œsayâ€: â€œexplain the trade-off â€” what complexity it adds and why itâ€™s worth it at this scaleâ€},
{â€œcomponentâ€: â€œâ˜… third new componentâ€, â€œsayâ€: â€œexplain how it connects to the component before it in the flowâ€}
],
â€œschemaâ€: [
{
â€œtableâ€: â€œTableNameâ€,
â€œstorageâ€: â€œPostgreSQL | DynamoDB | Cassandra | Redis | S3â€,
â€œwhyâ€: â€œspecific reason â€” e.g. relational model needed for foreign key constraints on user/tweet / wide-column for time-series append-only / key-value for O(1) session lookupâ€,
â€œkey_fieldsâ€: â€œid UUID PK, user_id UUID FK NOT NULL, content VARCHAR(280), status ENUM(â€˜activeâ€™,â€˜deletedâ€™) DEFAULT â€˜activeâ€™, created_at TIMESTAMPTZ DEFAULT NOW()â€,
â€œkey_indexesâ€: â€œINDEX (user_id, created_at DESC) â€” feeds query pattern: SELECT â€¦ WHERE user_id = ? ORDER BY created_at DESC LIMIT 20â€,
â€œaccess_patternâ€: â€œ99% of reads are: get timeline for user_id ordered by time â€” drives the index designâ€
}
],
â€œcomponentsâ€: [
{
â€œnameâ€: â€œComponent name matching diagram box exactlyâ€,
â€œroleâ€: â€œSingle responsibility â€” what this service owns and why it is isolatedâ€,
â€œchosen_techâ€: â€œSpecific technology e.g. Apache Kafka 3.5â€,
â€œwhy_chosenâ€: â€œSpecific technical reason for THIS system â€” e.g. log-compaction gives us event replay when notification service crashes; partitioning by user_id gives ordering guarantees per user; consumer groups allow independent scaling of fan-out workersâ€,
â€œalternativesâ€: [
{â€œnameâ€: â€œAlt 1â€, â€œverdictâ€: â€œtradeoffâ€, â€œreasonâ€: â€œconcrete pro and con vs chosen for this specific workloadâ€},
{â€œnameâ€: â€œAlt 2â€, â€œverdictâ€: â€œtradeoffâ€, â€œreasonâ€: â€œconcrete pro and conâ€},
{â€œnameâ€: â€œAlt 3â€, â€œverdictâ€: â€œavoidâ€, â€œreasonâ€: â€œwhy this would specifically fail for this systemâ€}
]
}
]
},

â€œstep6_deep_divesâ€: [
{
â€œtopicâ€: â€œSpecific problem title â€” e.g. Fan-out for users with 50M followersâ€,
â€œnfr_addressedâ€: â€œexact NFR from step1 this hardensâ€,
â€œwhy_hardâ€: â€œwhy specifically hard at THIS scale â€” concrete numbers e.g. 50M followers Ã— 1 DB write = 50M synchronous writes = 21 seconds at 2.4M writes/sec Postgres limitâ€,
â€œnaive_approachâ€: â€œwhat a junior engineer implements and EXACTLY how it breaks â€” include numbers showing failure modeâ€,
â€œreal_solutionâ€: â€œdetailed solution with specific tech and algorithm â€” e.g. hybrid push/pull: push to Redis sorted set for users <10K followers async via Kafka; pull+merge at read time for celebrities from tweet store + follow graphâ€,
â€œnumbersâ€: â€œconcrete numbers proving solution works â€” e.g. 10K followers Ã— 200 byte entry = 2MB Redis per active user; 1M active users Ã— 2MB = 2TB Redis cluster â€” fits in 32 Ã— 64GB nodesâ€,
â€œtrade_offsâ€: â€œexplicit cost â€” e.g. celebrity followers see up to 500ms delay vs instant for regular users; adds read-time fan-out complexityâ€
}
],

â€œfollowup_qaâ€: [
{
â€œquestionâ€: â€œrealistic follow-up an interviewer would ask for THIS specific systemâ€,
â€œanswerâ€: â€œconfident 3-4 sentence answer with specific technologies and numbers â€” no vague statementsâ€
}
],

â€œspeak_guideâ€: {
â€œopening_scriptâ€: â€œword-for-word first 60 seconds â€” state the problem, ask 2 clarifying questions, state your approachâ€,
â€œkey_insightâ€: â€œthe one non-obvious insight that separates a Staff answer â€” something most candidates get wrongâ€,
â€œcommon_mistakesâ€: [
â€œspecific mistake on THIS problem and exactly what to say insteadâ€,
â€œanother common mistakeâ€
],
â€œclosing_scriptâ€: â€œhow to close in last 2 minutes â€” what to summarize, what to proactively offer to go deeper onâ€
}
}

Produce: exactly 3 FRs (max), 4 NFRs with measurable values, 3-5 entities (nouns only, no fields), 4-5 API endpoints, BOTH diagrams (diagram 2 visibly evolves from diagram 1 with â˜… markers), 3-4 schema tables, 4-6 components each with 3 alternatives, 3-4 deep dives with naive+real+numbers, 5 Q&As. Every answer must be specific to the exact system described â€” zero generic advice.`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAB HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ptabBar(pairs){let h=â€™<div class="ptabs">â€™;for(let i=0;i<pairs.length;i+=2)h+=`<div class="ptab${i===0?' on':''}" data-t="${pairs[i]}" onclick="switchP('${pairs[i]}')">${pairs[i+1]}</div>`;return h+â€™</div>â€™;}
function switchP(id){document.querySelectorAll(â€™.ptabâ€™).forEach(t=>t.classList.toggle(â€˜onâ€™,t.dataset.t===id));document.querySelectorAll(â€™.ppanelâ€™).forEach(p=>p.classList.toggle(â€˜onâ€™,p.id===â€˜pp_â€™+id));}
function toggleQA(el){el.classList.toggle(â€˜openâ€™);el.querySelector(â€™.chevâ€™).classList.toggle(â€˜openâ€™);el.nextElementSibling.classList.toggle(â€˜openâ€™);}
function wireSubTabs(container){
const tabs=[â€¦container.querySelectorAll(â€™:scope > .stab-row > .stabâ€™)];
const panels=[â€¦container.querySelectorAll(â€™:scope > .spanelâ€™)];
tabs.forEach((t,i)=>{t.onclick=()=>{tabs.forEach(x=>x.classList.remove(â€˜onâ€™));panels.forEach(x=>x.classList.remove(â€˜onâ€™));t.classList.add(â€˜onâ€™);panels[i]?.classList.add(â€˜onâ€™);};});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SPEAK MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSM(){
if(!last)return;
const{mode:m,data:d}=last;let h=â€™â€™;
if(m===â€˜codingâ€™){
h+=sc(â€˜ğŸ§  How I Approached Itâ€™,d.thought_process);h+=sc(â€˜ğŸ¯ One-Linerâ€™,d.summary);h+=sc(â€˜ğŸ’¡ Analogyâ€™,d.analogy);
h+=sc(â€˜ğŸ”‘ Key Stepsâ€™,(d.steps||[]).map((s,i)=>(i+1)+â€™. â€˜+s.title+â€™ â€” â€˜+s.why).join(â€™\nâ€™));
h+=sc(â€˜âš¡ Complexityâ€™,d.complexity_explanation);
h+=sc(â€˜âš ï¸ Gotchasâ€™,(d.tricky_parts||[]).map(t=>â€™â€¢ â€˜+t.issue+â€™: â€˜+String(t.explanation).slice(0,140)).join(â€™\nâ€™));
}else{
const sg=d.speak_guide||{},r=d.step1_requirements||{};
h+=sc(â€˜ğŸ¬ Opening (say this verbatim)â€™,sg.opening_script||â€™â€™);
h+=sc(â€˜ğŸ’¡ The Key Insightâ€™,sg.key_insight||â€™â€™);
h+=sc(â€˜ğŸ“‹ Requirements to Stateâ€™,[â€¦(r.functional||[]).map(f=>â€˜ğŸ”µ â€˜+f.req),â€˜â”€â€™,â€¦(r.non_functional||[]).map(n=>â€˜â— â€˜+n.req+â€™ (â€™+n.value+â€™)â€™)].join(â€™\nâ€™));
h+=sc(â€˜ğŸ—ï¸ Architecture Flowâ€™,(d.step4_data_flow?.steps||[]).join(â€™\nâ€™));
h+=sc(â€˜ğŸ”¬ Deep Dives to Hitâ€™,(d.step6_deep_dives||[]).map(dd=>â€™â€¢ â€˜+dd.topic+â€™: â€˜+String(dd.real_solution).slice(0,130)).join(â€™\nâ€™));
h+=sc(â€˜âš ï¸ Mistakes to Avoidâ€™,(sg.common_mistakes||[]).map(m=>â€™â€¢ â€˜+m).join(â€™\nâ€™));
h+=sc(â€˜ğŸ Closing (say this)â€™,sg.closing_script||â€™â€™);
}
document.getElementById(â€˜smcâ€™).innerHTML=h;document.getElementById(â€˜sovlâ€™).classList.add(â€˜onâ€™);
}
function closeSM(){document.getElementById(â€˜sovlâ€™).classList.remove(â€˜onâ€™);}
function sc(lbl,txt){return â€˜<div class="sc"><div class="sc-lbl">â€™+lbl+â€™</div><div class="sc-txt">â€™+String(txt||â€™â€™).replace(/\n/g,â€™<br>â€™)+â€™</div></div>â€™;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
JAVA RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hl(code){
const kw=[â€˜publicâ€™,â€˜privateâ€™,â€˜protectedâ€™,â€˜classâ€™,â€˜interfaceâ€™,â€˜extendsâ€™,â€˜implementsâ€™,â€˜newâ€™,â€˜returnâ€™,â€˜ifâ€™,â€˜elseâ€™,â€˜forâ€™,â€˜whileâ€™,â€˜doâ€™,â€˜switchâ€™,â€˜caseâ€™,â€˜defaultâ€™,â€˜breakâ€™,â€˜continueâ€™,â€˜nullâ€™,â€˜trueâ€™,â€˜falseâ€™,â€˜voidâ€™,â€˜staticâ€™,â€˜finalâ€™,â€˜abstractâ€™,â€˜importâ€™,â€˜packageâ€™,â€˜throwsâ€™,â€˜throwâ€™,â€˜tryâ€™,â€˜catchâ€™,â€˜finallyâ€™,â€˜intâ€™,â€˜longâ€™,â€˜doubleâ€™,â€˜floatâ€™,â€˜booleanâ€™,â€˜charâ€™,â€˜Stringâ€™,â€˜Listâ€™,â€˜Mapâ€™,â€˜Setâ€™,â€˜ArrayListâ€™,â€˜HashMapâ€™,â€˜HashSetâ€™,â€˜LinkedListâ€™,â€˜Stackâ€™,â€˜Queueâ€™,â€˜TreeMapâ€™,â€˜TreeSetâ€™,â€˜PriorityQueueâ€™,â€˜Arraysâ€™,â€˜Collectionsâ€™,â€˜Mathâ€™,â€˜Integerâ€™,â€˜Characterâ€™,â€˜Optionalâ€™,â€˜varâ€™];
let h=code.replace(/&/g,â€™&â€™).replace(/</g,â€™<â€™).replace(/>/g,â€™>â€™);
h=h.replace(/(//[^\n]*)/g,â€™<span style="color:#6a9955">$1</span>â€™);
h=h.replace(/(/*[\s\S]*?*/)/g,â€™<span style="color:#6a9955">$1</span>â€™);
h=h.replace(/(â€(?:[^â€\]|\.)*â€)/g,â€™<span style="color:#ce9178">$1</span>â€™);
h=h.replace(/\b(\d+)\b/g,â€™<span style="color:#b5cea8">$1</span>â€™);
kw.forEach(k=>{h=h.replace(new RegExp(â€™\b(â€™+k+â€™)\bâ€™,â€˜gâ€™),â€™<span style="color:#569cd6">$1</span>â€™);});
return h;
}
const rx=t=>String(t||â€™â€™).replace(/`([^`]+)`/g,â€™<code>$1</code>â€™);
const eh=t=>String(t||â€™â€™).replace(/&/g,â€™&â€™).replace(/</g,â€™<â€™).replace(/>/g,â€™>â€™);

function renderCoding(d){
const a=document.getElementById(â€˜rareaâ€™);
const stH=(d.steps||[]).map((s,i)=>`<div class="card fadein"><div class="card-head"><div class="cnum">${i+1}</div><div>${s.title}</div></div><div class="card-body">${rx(s.what)}<br><br>${rx(s.how)}</div><div class="card-sub">ğŸ’¡ Why: ${s.why}</div></div>`).join(â€™â€™);
const trH=(d.tricky_parts||[]).map(t=>`<div class="iblock red fadein"><div class="blbl">âš ï¸ ${t.issue}</div>${rx(t.explanation)}</div>`).join(â€™â€™);
const qaH=(d.followup_qa||[]).map(q=>`<div class="qa-item fadein"><div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div><div class="qa-a">${rx(q.answer)}</div></div>`).join(â€™â€™);
const vl=v=>v===â€˜betterâ€™?â€˜âœ“ Betterâ€™:v===â€˜worseâ€™?â€˜âœ— Worseâ€™:â€˜â‡„ Trade-offâ€™;
const vc=v=>v===â€˜betterâ€™?â€˜bgâ€™:v===â€˜worseâ€™?â€˜boâ€™:â€˜bbâ€™;
const alH=(d.alternatives||[]).map(al=>`<div class="card fadein"><div class="card-head" style="justify-content:space-between"><span>${al.name} <small style="color:var(--ts);font-weight:400">${al.complexity}</small></span><span class="badge ${vc(al.verdict)}">${vl(al.verdict)}</span></div><div class="card-body">${al.when_to_use}</div></div>`).join(â€™â€™);
a.innerHTML=
ptabBar([â€˜overviewâ€™,â€˜Overviewâ€™,â€˜codeâ€™,â€˜Codeâ€™,â€˜stepsâ€™,â€˜Walkthroughâ€™,â€˜trickyâ€™,â€˜Gotchasâ€™,â€˜qaâ€™,â€˜Q&Aâ€™,â€˜altsâ€™,â€˜Alternativesâ€™])+
`<div class="ppanel on" id="pp_overview"> <div class="iblock blue fadein"><div class="blbl">ğŸ§  How I thought about this</div>${d.thought_process}</div> <div class="iblock green fadein"><div class="blbl">ğŸ’¡ Real-world analogy</div>${d.analogy}</div> <div class="sumbox fadein">${d.summary}</div> <div class="mrow"><span class="badge ba">${d.complexity}</span><span class="badge bb">${d.pattern}</span><span class="badge bg">${d.approach}</span></div> <div style="font-size:12.5px;line-height:1.7;color:var(--ts);padding:2px 0 14px">${d.complexity_explanation}</div> <button class="spk-btn fadein" onclick="openSM()">ğŸ“¢ Open Speak Mode</button> </div> <div class="ppanel" id="pp_code"> <p style="font-size:11px;color:var(--ts);margin-bottom:9px">Lines wrap â€” scroll up/down only. No horizontal scroll.</p> <div class="code-outer fadein"><div class="code-hdr"><span class="code-lang">JAVA</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-body"><pre>${hl(d.code)}</pre></div></div> </div> <div class="ppanel" id="pp_steps"><div>${stH}</div></div> <div class="ppanel" id="pp_tricky"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Knowing these signals thoroughness.</p>${trH}</div> <div class="ppanel" id="pp_qa"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Tap to reveal.</p>${qaH}</div> <div class="ppanel" id="pp_alts"><p style="font-size:11.5px;color:var(--ts);margin-bottom:12px;line-height:1.5">Mentioning trade-offs signals depth.</p>${alH}</div>`;
a._rawCode=d.code;a.classList.add(â€˜onâ€™);
setTimeout(()=>a.scrollIntoView({behavior:â€˜smoothâ€™,block:â€˜startâ€™}),120);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SD RENDER â€” full final render replaces skeleton
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSD(d){
const a=document.getElementById(â€˜rareaâ€™);
const r=d.step1_requirements||{},
api=d.step3_api_design||{},
hld=d.step5_high_level_design||{},
dives=d.step6_deep_dives||[],
sg=d.speak_guide||{},
walkthroughs=d.hld_fr_walkthroughs||[];

const cap=r.capacity||{};

/* â”€â”€ helpers â”€â”€ */
const badge=(cls,txt)=>`<span class="badge ${cls}">${txt}</span>`;
const iblock=(cls,lbl,body)=>`<div class="iblock ${cls} fadein"><div class="blbl">${lbl}</div>${body}</div>`;
const hrow=(body)=>`<div class="hrow fadein">${body}</div>`;
const sublbl=(t,sub=â€™â€™)=>`<div class="sublbl">${t}${sub?` <span style="font-size:9px;font-weight:400;color:var(--ts)">${sub}</span>`:''}</div>`;

/* â”€â”€ FUNCTIONAL REQUIREMENTS â”€â”€ */
const funcH=(r.functional||[]).map(f=>
hrow(`<strong>ğŸ”µ ${f.req}</strong>${f.technical_implication?`<br><span style="font-size:11.5px;color:var(--ts)">â†’ ${f.technical_implication}</span>`:''}`)
).join(â€™â€™);

/* â”€â”€ NON-FUNCTIONAL REQUIREMENTS â”€â”€ */
const nfrH=(r.non_functional||[]).map(n=>
hrow(`â— <strong>${n.req}</strong> ${badge('ba',n.value)}${n.tradeoff?`<br><span style="font-size:11.5px;color:var(--orange)">Trade-off: ${n.tradeoff}</span>`:''}`)
).join(â€™â€™);

const oosH=(r.out_of_scope||[]).map(o=>`<span class="pill">âœ— ${o}</span>`).join(â€™â€™);

/* â”€â”€ CAPACITY â€” plain english first, then numbers â”€â”€ */
const capH=cap.write_qps?` ${iblock('orange','ğŸ“Œ Hello Interview â€” Capacity',cap.plain_english||'Calculate only if the number changes a design decision â€” state this explicitly.')} ${sublbl('Assumptions')} ${(cap.assumptions||[]).map(a=>hrow(a)).join('')} <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px"> <div style="flex:1;min-width:100px;background:var(--os);border-radius:8px;padding:9px 11px"> <div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:3px">âœï¸ Write QPS</div> <div style="font-size:13px;font-weight:700">${cap.write_qps}</div> </div> <div style="flex:1;min-width:100px;background:var(--bs);border-radius:8px;padding:9px 11px"> <div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:3px">ğŸ“– Read QPS</div> <div style="font-size:13px;font-weight:700">${cap.read_qps}</div> </div> <div style="flex:1;min-width:100px;background:var(--gs);border-radius:8px;padding:9px 11px"> <div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:3px">ğŸ’¾ Storage/yr</div> <div style="font-size:13px;font-weight:700">${cap.storage_per_year}</div> </div> </div> ${cap.design_impact?hrow(`ğŸ¯ <strong>Design impact:</strong> ${cap.design_impact}`):''} `:`${iblock('orange','ğŸ“Œ Hello Interview','Skip capacity unless it changes a design decision. State this explicitly to your interviewer.')}`;

/* â”€â”€ ENTITIES (nouns only, step 2) â”€â”€ */
const entH=(d.step2_core_entities||[]).map(e=>` <div class="card fadein" style="margin-bottom:9px"> <div class="card-head" style="font-size:14px;font-weight:700">${e.name}</div> <div class="card-body">${e.description}</div> ${e.note?`<div class="card-sub" style="margin-top:4px">ğŸ’¡ ${e.note}</div>`:''} </div>`).join(â€™â€™);

/* â”€â”€ REALTIME PROTOCOL â”€â”€ */
const rt=api.realtime_protocol||{};
const rtH=rt.chosen&&rt.chosen!==â€˜Noneâ€™?` <div class="tech-card fadein" style="border-color:rgba(45,95,160,.4);margin-bottom:12px"> <div class="tech-top"><span class="tech-name">ğŸ”„ Real-time Protocol</span><span class="chosen-tag">âœ“ ${rt.chosen}</span></div> <div class="tech-role">${rt.reason||''}</div> ${rt.where_in_arch?`<div class="tech-why"><strong>Where it sits:</strong> ${rt.where_in_arch}</div>`:''} ${(rt.alternatives||[]).length?`<div class="alt-lbl">Alternatives</div>
${(rt.alternatives||[]).map(alt=>`<div class="alt-row"> <span class="alt-name">${alt.name}</span> <span class="av ${alt.verdict==='avoid'?'av-avoid':alt.verdict==='tradeoff'?'av-trade':'av-ok'}">${alt.verdict==='avoid'?'âœ— Avoid':alt.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span> <span class="alt-why">${alt.reason}</span> </div>`).join(â€™â€™)}`:''} </div>`:
`<div style="font-size:12.5px;color:var(--ts);margin-bottom:10px;padding:8px 0">No persistent real-time protocol needed for this system â€” standard HTTP polling sufficient.</div>`;

/* â”€â”€ API ENDPOINTS â”€â”€ */
const apiH=(api.endpoints||[]).map(ep=>` <div class="card fadein" style="margin-bottom:9px"> <div class="card-head">${badge('bb',ep.method)} <code style="font-size:12.5px">${ep.path}</code></div> <div class="card-body"> ${ep.auth?`<div style="font-size:11.5px;color:var(--ts);margin-bottom:4px">ğŸ” ${ep.auth}</div>`:''} <strong>Req:</strong> <code>${ep.request||''}</code><br> <strong>Res:</strong> <code>${ep.response||''}</code> ${ep.note?`<div style="margin-top:4px;font-size:11.5px;color:var(--ts)">${ep.note}</div>`:''} </div> </div>`).join(â€™â€™);

/* â”€â”€ HLD FR WALKTHROUGHS â€” flow description + diagram per FR â”€â”€ */
const walkH=walkthroughs.length?walkthroughs.map((w,i)=>` <div style="margin-bottom:18px;border-left:3px solid var(--ac);padding-left:12px"> <div style="font-size:11px;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">FR ${i+1}</div> <div style="font-size:14px;font-weight:700;color:var(--tp);margin-bottom:8px">ğŸ”µ ${w.fr}</div> ${w.what_to_draw?iblock('orange','âœï¸ What to draw first',w.what_to_draw):''} ${(w.flow_steps||[]).length?`
<div style="font-size:10px;font-weight:700;color:var(--ts);letter-spacing:.06em;text-transform:uppercase;margin:8px 0 5px">Request flow</div>
${w.flow_steps.map(s=>hrow(s)).join(â€™â€™)}`:''} ${w.key_point?iblock('blue','ğŸ’¡ Say this aloud â€” shows seniority',w.key_point):''} </div>`).join(â€™â€™):â€™â€™;

/* â”€â”€ DIAGRAM HELPERS â”€â”€ */
const colorizeDiag=raw=>{
let s=eh(raw);
// Color â˜… new components in green
s=s.replace(/â˜…/g,â€™<span style="color:var(--green);font-weight:700">â˜…</span>â€™);
// Color [alternatives] in amber
s=s.replace(/[([^]<]+)]/g,â€™<span style="color:#e8c060;font-weight:600">[$1]</span>â€™);
// Color arrows in blue-grey
s=s.replace(/([â†’â†“â†â†‘])/g,â€™<span style="color:#7aabcc;font-weight:700">$1</span>â€™);
// Color â† annotations in green (the â€œsatisfies: â€¦â€ notes)
s=s.replace(/(â†[^<\n]+)/g,â€™<span style="color:var(--green);font-size:10px;font-style:italic">$1</span>â€™);
return s;
};

const commentaryH=arr=>{
if(!arr||!arr.length)return â€˜â€™;
return `<div style="margin-top:10px"> <div style="font-size:10px;font-weight:700;color:var(--ts);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px">ğŸ—£ï¸ What to say while drawing each component</div> ${arr.map(c=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:8px 11px;background:var(--bs);border-radius:8px;margin-bottom:5px;border-left:3px solid var(--blue)">
<div style="font-size:10px;font-weight:700;color:var(--blue);min-width:100px;padding-top:1px;flex-shrink:0;line-height:1.4">${c.component}</div>
<div style="font-size:12px;line-height:1.6;color:var(--tp);font-style:italic">â€${c.say}â€</div>
</div>`).join('')} </div>`;
};

const diagSimple=hld.diagram_simple?` <div class="diag-wrap"> <div class="diag-label">Diagram 1 â€” Baseline Design <span class="diag-pill">satisfies core FRs</span></div> <div style="font-size:11.5px;color:var(--ts);line-height:1.6;margin-bottom:8px;font-style:italic">Start by drawing this simple path. Narrate as you go using the speaking notes below. This is the foundation â€” Diagram 2 will evolve from it.</div> <div class="diagram">${colorizeDiag(hld.diagram_simple)}</div> ${commentaryH(hld.diagram_simple_commentary)} </div>`:â€™â€™;

const diagScaled=hld.diagram_scaled?` <div class="diag-wrap" style="margin-top:16px"> <div class="diag-label">Diagram 2 â€” Production Design <span class="diag-pill">evolves Diagram 1</span> <span class="diag-pill" style="background:var(--gs);color:var(--green)">â˜… = new component</span> <span class="diag-pill" style="background:var(--os);color:var(--orange)">[amber] = alternatives</span></div> <div style="font-size:11.5px;color:var(--ts);line-height:1.6;margin-bottom:8px;font-style:italic">Now evolve your diagram. For each â˜… component you add, say WHY â€” which NFR it satisfies and what bottleneck it removes. The â˜… components are the ones interviewers care most about.</div> <div class="diagram">${colorizeDiag(hld.diagram_scaled)}</div> ${commentaryH(hld.diagram_scaled_commentary)} </div>`:â€™â€™

/* â”€â”€ SCHEMA â”€â”€ */
const schemaH=(hld.schema||[]).map(t=>` <div class="card fadein" style="margin-bottom:10px"> <div class="card-head" style="justify-content:space-between"> <span>${t.table}</span>${badge('bp',t.storage)} </div> <div class="card-body"> <div style="background:var(--cdbg);border-radius:7px;padding:8px 11px;font-family:'SF Mono',monospace;font-size:11px;line-height:1.85;color:var(--cdtx);word-break:break-word;margin-bottom:6px">${eh(t.key_fields||'')}</div> ${t.key_indexes?`<div style="font-size:11.5px;color:var(--ts);margin-bottom:3px">ğŸ”‘ <strong>Index:</strong> ${t.key_indexes}</div>`:''} ${t.access_pattern?`<div style="font-size:11.5px;color:var(--purple);margin-bottom:4px">ğŸ“Š <strong>Access pattern:</strong> ${t.access_pattern}</div>`:''} <div class="card-sub">Why ${t.storage}: ${t.why}</div> </div> </div>`).join(â€™â€™);

/* â”€â”€ COMPONENTS â”€â”€ */
const compH=(hld.components||[]).map(c=>` <div class="tech-card fadein"> <div class="tech-top"><span class="tech-name">${c.name}</span><span class="chosen-tag">âœ“ ${c.chosen_tech}</span></div> <div class="tech-role">${c.role}</div> <div class="tech-why"><strong>Why ${c.chosen_tech}:</strong> ${c.why_chosen}</div> ${(c.alternatives||[]).length?`<div class="alt-lbl">Alternatives â€” shown as [brackets] in diagram</div>
${c.alternatives.map(alt=>`<div class="alt-row"> <span class="alt-name">${alt.name}</span> <span class="av ${alt.verdict==='avoid'?'av-avoid':alt.verdict==='tradeoff'?'av-trade':'av-ok'}">${alt.verdict==='avoid'?'âœ— Avoid':alt.verdict==='tradeoff'?'â‡„ Trade-off':'âœ“ OK'}</span> <span class="alt-why">${alt.reason}</span> </div>`).join(â€™â€™)}`:''} </div>`).join(â€™â€™);

/* â”€â”€ DEEP DIVES (bad â†’ good â†’ great) â”€â”€ */
const deepH=dives.map(dd=>` <div class="card fadein" style="margin-bottom:14px"> <div class="card-head">ğŸ”¬ ${dd.topic}</div> ${dd.nfr_addressed?`<div style="margin-bottom:7px">${badge(â€˜bbâ€™,`Hardens: ${dd.nfr_addressed}`)}</div>`:''} ${dd.bad?`
<div class="sublbl" style="margin-top:2px">âŒ Bad Solution</div>
<div class="iblock red fadein" style="margin-bottom:8px">
<div class="blbl">Naive approach</div>
<div style="margin-bottom:5px">${dd.bad.approach}</div>
<div style="font-size:11.5px;color:var(--red);font-weight:600">Why it fails: ${dd.bad.why_fails}</div>
</div>`:''} ${dd.good?`
<div class="sublbl">âœ… Good Solution</div>
<div class="iblock orange fadein" style="margin-bottom:8px">
<div class="blbl">Better approach</div>
<div style="margin-bottom:5px">${dd.good.approach}</div>
${dd.good.limitation?`<div style="font-size:11.5px;color:var(--orange);font-weight:600">Limitation: ${dd.good.limitation}</div>`:â€™â€™}
</div>`:''} ${dd.great?`
<div class="sublbl">ğŸš€ Great Solution (Staff level)</div>
<div class="iblock green fadein">
<div class="blbl">Production approach</div>
<div style="margin-bottom:5px">${dd.great.approach}</div>
${dd.great.numbers?`<div style="font-size:11.5px;background:rgba(0,0,0,.08);border-radius:5px;padding:5px 8px;margin:5px 0;font-family:monospace">ğŸ“Š ${dd.great.numbers}</div>`:â€™â€™}
${dd.great.trade_offs?`<div style="font-size:11.5px;color:var(--green);font-weight:600">Trade-off: ${dd.great.trade_offs}</div>`:â€™â€™}
</div>`:''} ${dd.naive_approach&&!dd.bad?`
<div class="sublbl">âŒ Naive Approach</div>
<div class="iblock red fadein"><div class="blbl">Junior approach</div>${dd.naive_approach}</div>
<div class="sublbl">âœ… Real Solution</div>
<div class="card-body">${dd.real_solution||â€™â€™}</div>
${dd.numbers?`<div class="iblock orange fadein" style="padding:8px 12px"><div class="blbl">ğŸ“Š Numbers</div>${dd.numbers}</div>`:â€™â€™}
<div class="card-warn" style="margin-top:6px">â‡„ Trade-off: ${dd.trade_offs||â€™â€™}</div>`:''} </div>`).join(â€™â€™);

/* â”€â”€ Q&A â”€â”€ */
const qaH=(d.followup_qa||[]).map(q=>` <div class="qa-item fadein"> <div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chev">â€º</span></div> <div class="qa-a">${q.answer}</div> </div>`).join(â€™â€™);

/* â”€â”€ CLARIFYING QUESTIONS â€” handle both {q,why} and plain string â”€â”€ */
const clarifyH=(d.clarifying_questions||[]).map((q,i)=>{
const qtext=typeof q===â€˜stringâ€™?q:(q.q||â€™â€™);
const qwhy=typeof q===â€˜stringâ€™?â€™â€™:(q.why||â€™â€™);
return hrow(`<strong>Q${i+1}:</strong> ${qtext}${qwhy?`<br><span style="font-size:11.5px;color:var(--ts)">Why ask: ${qwhy}</span>`:''}`);
}).join(â€™â€™);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FULL RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
a.innerHTML=
ptabBar([â€˜overviewâ€™,â€˜Overviewâ€™,â€˜walkthroughâ€™,â€˜Design Walkthroughâ€™,â€˜deepdivesâ€™,â€˜Deep Divesâ€™,â€˜qaâ€™,â€˜Q&Aâ€™])+

```
/* â”€â”€ OVERVIEW â”€â”€ */
`<div class="ppanel on" id="pp_overview">
  <div class="sumbox fadein">${d.problem_statement}</div>

  ${sublbl('Clarifying Questions to Ask First')}
  ${clarifyH}

  ${sublbl('ğŸ”µ Functional Requirements')}
  ${funcH}

  ${sublbl('â— Non-Functional Requirements')}
  ${nfrH}

  ${sublbl('âœ— Out of Scope')}<div class="pill-row">${oosH}</div>

  ${cap.write_qps?`
    ${sublbl('ğŸ“Š Back-of-Envelope')}
    <div style="background:var(--sf);border:1px solid var(--br);border-radius:10px;padding:12px 14px;margin-bottom:10px">
      <div style="font-size:13px;line-height:1.7;color:var(--tp);margin-bottom:10px">${cap.plain_english||''}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:100px;background:var(--os);border-radius:7px;padding:8px 10px">
          <div style="font-size:9px;font-weight:700;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">âœï¸ Write QPS</div>
          <div style="font-size:13px;font-weight:700">${cap.write_qps}</div>
        </div>
        <div style="flex:1;min-width:100px;background:var(--bs);border-radius:7px;padding:8px 10px">
          <div style="font-size:9px;font-weight:700;color:var(--blue);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ“– Read QPS</div>
          <div style="font-size:13px;font-weight:700">${cap.read_qps}</div>
        </div>
        <div style="flex:1;min-width:100px;background:var(--gs);border-radius:7px;padding:8px 10px">
          <div style="font-size:9px;font-weight:700;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px">ğŸ’¾ Storage/yr</div>
          <div style="font-size:13px;font-weight:700">${cap.storage_per_year}</div>
        </div>
      </div>
      ${cap.design_impact?`<div style="font-size:12.5px;color:var(--tp);margin-top:8px;font-weight:600">ğŸ¯ ${cap.design_impact}</div>`:''}
    </div>`:''}

  ${iblock('blue','ğŸ§  How to frame this interview',d.thought_process)}
  <button class="spk-btn fadein" style="margin-top:10px" onclick="openSM()">ğŸ“¢ Open Speak Mode</button>
</div>

<div class="ppanel" id="pp_walkthrough">
  <div class="stab-row">
    <div class="stab on"><span class="sn">1</span>Requirements<span class="step-t">~5m</span></div>
    <div class="stab"><span class="sn">2</span>Core Entities<span class="step-t">~2m</span></div>
    <div class="stab"><span class="sn">3</span>API Design<span class="step-t">~5m</span></div>
    <div class="stab"><span class="sn">4</span>HLD Walkthrough<span class="step-t">~15m</span></div>
    <div class="stab"><span class="sn">5</span>Diagrams<span class="step-t">draw</span></div>
  </div>

  <!-- Step 1: Requirements -->
  <div class="spanel on">
    ${iblock('blue','ğŸ“Œ Evan King','FRs: "Users should be able toâ€¦" max 3, prioritized. NFRs: always measurable numbers. Capacity: only if the number changes a design decision â€” say this explicitly.')}
    ${sublbl('ğŸ”µ Functional Requirements')}${funcH}
    ${sublbl('â— Non-Functional Requirements')}${nfrH}
    ${sublbl('âœ— Out of Scope')}<div class="pill-row">${oosH}</div>
    ${sublbl('ğŸ“Š Capacity Estimation')}${capH}
  </div>

  <!-- Step 2: Core Entities -->
  <div class="spanel">
    ${iblock('blue','ğŸ“Œ Evan King','Step 2 = NOUNS ONLY. No fields yet. Just list the core domain objects. Fields emerge in HLD (step 4) as you trace each request to the DB. Spending time on fields here is a common mistake.')}
    ${entH}
  </div>

  <!-- Step 3: API Design -->
  <div class="spanel">
    ${iblock('blue','ğŸ“Œ Evan King','Default REST. user_id always from JWT â€” never from request body (untrusted). Define the security implications of each endpoint. State real-time protocol choice upfront.')}
    ${rtH}
    ${sublbl('REST Endpoints',`â€” ${api.protocol_choice||'REST'}`)}
    ${apiH}
  </div>

  <!-- Step 4: HLD Walkthrough (FR by FR) -->
  <div class="spanel">
    ${iblock('blue','ğŸ“Œ Evan King','Build the diagram FR by FR. For each FR, say what you are drawing, trace the request end-to-end in plain English, then say the key insight. Schema fields emerge here as you trace to the DB.')}
    ${walkH||'<div style="color:var(--ts);font-style:italic;font-size:12.5px">Walkthroughs will appear here once generated.</div>'}
    ${sublbl('Schema',`â€” emerges during HLD, not before`)}
    ${schemaH}
    ${sublbl('Component Decisions',`â€” match [brackets] in diagrams`)}
    ${compH}
  </div>

  <!-- Step 5: Diagrams -->
  <div class="spanel">
    ${iblock('blue','ğŸ“Œ Evan King','Draw Diagram 1 baseline first â€” narrate as you go. Then evolve to Diagram 2 by adding â˜… components one at a time, explaining which NFR each satisfies. The evolution story is what separates Staff from Mid.')}
    ${diagSimple}
    ${diagScaled}
  </div>
</div>

<div class="ppanel" id="pp_deepdives">
  ${iblock('blue','ğŸ“Œ Evan King','~10 min. Lead proactively for senior+ roles. Always show Bad â†’ Good â†’ Great progression. This progression signals you understand the problem space, not just the solution.')}
  ${deepH}
</div>

<div class="ppanel" id="pp_qa">
  <p style="font-size:11.5px;color:var(--ts);margin-bottom:12px">Tap to reveal a confident answer.</p>
  ${qaH}
</div>`;
```

a.classList.add(â€˜onâ€™);
wireSubTabs(document.querySelector(â€™#pp_walkthroughâ€™));
setTimeout(()=>a.scrollIntoView({behavior:â€˜smoothâ€™,block:â€˜startâ€™}),120);
}

function copyCode(btn){const a=document.getElementById(â€˜rareaâ€™);navigator.clipboard.writeText(a._rawCode||â€™â€™).then(()=>{btn.textContent=â€˜Copied!â€™;setTimeout(()=>btn.textContent=â€˜Copyâ€™,1500);});}
document.getElementById(â€˜tboxâ€™).addEventListener(â€˜inputâ€™,chkBtn);
</script>

</body>
</html>