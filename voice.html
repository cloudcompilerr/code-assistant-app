<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  :root {
    --bg: #faf9f7; --surface: #ffffff; --border: #e8e5e0;
    --text-primary: #1a1916; --text-secondary: #7a7670;
    --accent: #c8a96e; --accent-soft: #f5f0e8;
    --code-bg: #1e1c1a; --code-text: #e8e4dc;
    --green: #5a8a5a; --blue: #4a6fa5; --red: #a05a5a;
    --green-soft: #eef4ee; --blue-soft: #eef2fa; --red-soft: #faf0f0;
  }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-primary); min-height: 100vh; max-width: 700px; margin: 0 auto; padding: 0 0 100px; }

  /* ‚îÄ‚îÄ NOTES LIST ‚îÄ‚îÄ */
  .app-header { padding: 56px 24px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(250,249,247,0.93); }
  .header-row { display: flex; align-items: center; justify-content: space-between; }
  .app-title { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .icon-btn { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--accent); font-size: 20px; border-radius: 50%; border: none; background: none; }
  .note-count { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
  .notes-list { padding: 8px 0; }
  .note-row { padding: 14px 24px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: background 0.1s; }
  .note-row:active { background: var(--accent-soft); }
  .note-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--accent-soft); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; }
  .note-preview { flex: 1; min-width: 0; }
  .note-title { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-snippet { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
  .note-date { font-size: 11px; color: var(--text-secondary); flex-shrink: 0; margin-top: 2px; }

  /* ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ */
  .note-detail { display: none; min-height: 100vh; background: var(--bg); }
  .note-detail.open { display: block; }
  .detail-header { padding: 16px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(250,249,247,0.96); backdrop-filter: blur(20px); z-index: 10; }
  .back-btn { color: var(--accent); font-size: 15px; cursor: pointer; border: none; background: none; font-weight: 500; padding: 4px 0; }
  .detail-title-display { flex: 1; font-size: 15px; font-weight: 600; }

  /* ‚îÄ‚îÄ API SETUP ‚îÄ‚îÄ */
  .setup-note { margin: 16px 24px; padding: 16px; background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 12px; }
  .setup-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .setup-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
  .api-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: monospace; background: var(--surface); color: var(--text-primary); outline: none; margin-bottom: 6px; }
  .save-btn { padding: 8px 16px; background: var(--text-primary); color: white; border: none; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; width: 100%; }

  /* ‚îÄ‚îÄ VOICE INPUT AREA ‚Äî looks like a voice memo ‚îÄ‚îÄ */
  .voice-area {
    margin: 20px 24px 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .voice-top {
    padding: 14px 16px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .voice-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); }

  /* The mic button ‚Äî central, obvious, looks like voice memo button */
  .mic-ring {
    width: 72px; height: 72px;
    margin: 20px auto;
    display: flex; align-items: center; justify-content: center;
    position: relative;
    cursor: pointer;
  }

  .mic-ring::before {
    content: '';
    position: absolute; inset: 0;
    border-radius: 50%;
    background: var(--accent-soft);
    border: 2px solid rgba(200,169,110,0.3);
    transition: transform 0.2s, background 0.2s;
  }

  .mic-ring.listening::before {
    background: #fff0f0;
    border-color: rgba(200,80,80,0.4);
    animation: micPulse 1s infinite;
  }

  @keyframes micPulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }

  .mic-icon {
    font-size: 28px;
    position: relative;
    z-index: 1;
    user-select: none;
    transition: transform 0.15s;
  }

  .mic-ring:active .mic-icon { transform: scale(0.9); }

  /* Waveform ‚Äî shown while listening */
  .waveform {
    display: none;
    align-items: flex-end;
    justify-content: center;
    gap: 3px;
    height: 28px;
    margin: 0 auto 12px;
    width: 120px;
  }
  .waveform.active { display: flex; }
  .wave-bar {
    width: 4px;
    border-radius: 2px;
    background: var(--accent);
    animation: wave 0.8s infinite ease-in-out;
  }
  .wave-bar:nth-child(1) { animation-delay: 0s; }
  .wave-bar:nth-child(2) { animation-delay: 0.1s; }
  .wave-bar:nth-child(3) { animation-delay: 0.2s; }
  .wave-bar:nth-child(4) { animation-delay: 0.3s; }
  .wave-bar:nth-child(5) { animation-delay: 0.2s; }
  .wave-bar:nth-child(6) { animation-delay: 0.1s; }
  .wave-bar:nth-child(7) { animation-delay: 0s; }
  @keyframes wave {
    0%,100% { height: 6px; opacity: 0.4; }
    50% { height: 22px; opacity: 1; }
  }

  .voice-status {
    text-align: center;
    font-size: 13px;
    color: var(--text-secondary);
    padding: 0 16px 8px;
    min-height: 20px;
    font-style: italic;
  }

  .voice-status.listening { color: #c0392b; font-style: normal; font-weight: 500; }

  /* Transcript area ‚Äî looks like a note being typed */
  .transcript-box {
    margin: 0 16px 14px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.65;
    color: var(--text-primary);
    min-height: 44px;
    cursor: text;
    transition: border-color 0.15s;
    outline: none;
  }

  .transcript-box:focus { border-color: var(--accent); }
  .transcript-box:empty::before { content: 'Tap mic to speak your problem‚Ä¶'; color: var(--text-secondary); }

  .voice-actions {
    display: flex;
    gap: 8px;
    padding: 0 16px 16px;
  }

  .voice-action-btn {
    flex: 1;
    padding: 10px;
    border-radius: 9px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .voice-action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-clear { background: var(--bg); border: 1px solid var(--border) !important; color: var(--text-secondary); }
  .btn-generate { background: var(--text-primary); color: white; }

  /* depth chips */
  .depth-row { display: flex; gap: 8px; padding: 10px 24px 14px; overflow-x: auto; }
  .depth-chip { padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1.5px solid var(--border); background: var(--surface); color: var(--text-secondary); cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: all 0.15s; }
  .depth-chip.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }

  /* ‚îÄ‚îÄ THINKING ‚îÄ‚îÄ */
  .thinking { display: none; padding: 20px 24px; align-items: center; gap: 12px; }
  .thinking.active { display: flex; }
  .thinking-dots { display: flex; gap: 4px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.2s infinite; }
  .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse { 0%,80%,100%{transform:scale(1);opacity:0.5} 40%{transform:scale(1.3);opacity:1} }
  .thinking-text { font-size: 13px; color: var(--text-secondary); font-style: italic; }

  /* ‚îÄ‚îÄ RESPONSE ‚îÄ‚îÄ */
  .response-area { padding: 0 24px 40px; display: none; }
  .response-area.visible { display: block; }

  /* ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); margin: 0 -24px; padding: 0 24px; overflow-x: auto; margin-top: 20px; }
  .tab { padding: 10px 14px; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.15s; }
  .tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
  .tab-panel { display: none; padding-top: 16px; }
  .tab-panel.active { display: block; }

  /* ‚îÄ‚îÄ CONTENT BLOCKS ‚îÄ‚îÄ */
  .summary-box { background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 10px; padding: 16px; font-size: 14px; line-height: 1.7; margin-bottom: 14px; }
  .meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 600; }
  .badge-complexity { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(200,169,110,0.3); }
  .badge-pattern { background: var(--blue-soft); color: var(--blue); border: 1px solid rgba(74,111,165,0.2); }
  .badge-approach { background: var(--green-soft); color: var(--green); border: 1px solid rgba(90,138,90,0.2); }
  .thought-block { background: var(--blue-soft); border-left: 3px solid var(--blue); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; margin-bottom: 12px; }
  .thought-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--blue); margin-bottom: 6px; }
  .analogy-block { background: var(--green-soft); border-left: 3px solid var(--green); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; margin-bottom: 12px; }
  .analogy-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--green); margin-bottom: 6px; }
  .code-block { background: var(--code-bg); border-radius: 12px; overflow: hidden; margin-bottom: 8px; }
  .code-header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
  .code-lang { font-size: 11px; color: #8a8580; font-family: monospace; }
  .copy-btn { font-size: 11px; color: var(--accent); background: none; border: none; cursor: pointer; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
  .code-content { padding: 16px; overflow-x: auto; }
  .code-content pre { font-family: 'SF Mono', monospace; font-size: 12.5px; line-height: 1.7; color: var(--code-text); white-space: pre; }
  .steps-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
  .step-item { display: flex; gap: 12px; align-items: flex-start; padding: 14px; background: var(--surface); border-radius: 10px; border: 1px solid var(--border); }
  .step-num { width: 26px; height: 26px; border-radius: 50%; background: var(--accent); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .step-body { flex: 1; }
  .step-title { font-size: 13.5px; font-weight: 700; margin-bottom: 4px; }
  .step-desc { font-size: 13px; line-height: 1.65; }
  .step-desc code, .step-why code, .tricky-desc code, .qa-a code, .alt-desc code { font-family: monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .step-why { font-size: 12px; color: var(--blue); margin-top: 6px; font-style: italic; }
  .tricky-item { padding: 14px; background: var(--red-soft); border: 1px solid rgba(160,90,90,0.2); border-radius: 10px; margin-bottom: 10px; }
  .tricky-head { font-size: 13px; font-weight: 700; color: var(--red); margin-bottom: 6px; }
  .tricky-desc { font-size: 13px; line-height: 1.65; }
  .qa-item { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
  .qa-q { padding: 12px 16px; font-size: 13.5px; font-weight: 600; background: var(--surface); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .qa-q .chevron { color: var(--text-secondary); transition: transform 0.2s; font-size: 12px; }
  .qa-q.open .chevron { transform: rotate(90deg); }
  .qa-a { display: none; padding: 12px 16px; font-size: 13px; line-height: 1.7; background: var(--bg); border-top: 1px solid var(--border); }
  .qa-a.open { display: block; }
  .alt-item { padding: 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
  .alt-head { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; }
  .alt-desc { font-size: 13px; line-height: 1.65; }
  .alt-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .better { background: var(--green-soft); color: var(--green); }
  .tradeoff { background: var(--accent-soft); color: var(--accent); }
  .worse { background: var(--red-soft); color: var(--red); }
  .error-box { background: #fff0f0; border: 1px solid #ffcccc; border-radius: 10px; padding: 14px 16px; font-size: 13px; color: #c0392b; margin-top: 12px; }

  /* ‚îÄ‚îÄ SPEAK MODE ‚îÄ‚îÄ */
  #speakOverlay { display: none; position: fixed; inset: 0; background: rgba(26,25,22,0.97); z-index: 999; flex-direction: column; padding: 60px 28px 40px; overflow-y: auto; }
  #speakOverlay.open { display: flex; }
  .speak-close { position: fixed; top: 20px; right: 24px; color: var(--accent); font-size: 24px; cursor: pointer; background: none; border: none; z-index: 1000; }
  .speak-title { font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 24px; }
  .speak-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 20px; margin-bottom: 16px; }
  .speak-card-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .speak-card-text { font-size: 16px; line-height: 1.85; color: #f0ede8; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1a1916; color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; z-index: 9999; opacity: 0; transition: opacity 0.2s; white-space: nowrap; pointer-events: none; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê NOTES LIST ‚ïê‚ïê -->
<div id="notesList">
  <div class="app-header">
    <div class="header-row">
      <div class="app-title">Notes</div>
      <button class="icon-btn" onclick="openTool()">‚úèÔ∏è</button>
    </div>
    <div class="note-count">3 notes</div>
  </div>
  <div class="notes-list">
    <div class="note-row" onclick="openTool()">
      <div class="note-icon">üéôÔ∏è</div>
      <div class="note-preview">
        <div class="note-title">Voice Memo ‚Äì Quick Ref</div>
        <div class="note-snippet">Tap mic to record your question.</div>
      </div>
      <div class="note-date">Now</div>
    </div>
    <div class="note-row">
      <div class="note-icon">üìã</div>
      <div class="note-preview">
        <div class="note-title">Meeting notes ‚Äì Product sync</div>
        <div class="note-snippet">Discussed roadmap priorities and Q2 milestones</div>
      </div>
      <div class="note-date">Mon</div>
    </div>
    <div class="note-row">
      <div class="note-icon">üìù</div>
      <div class="note-preview">
        <div class="note-title">Grocery list</div>
        <div class="note-snippet">Eggs, bread, olive oil, tomatoes‚Ä¶</div>
      </div>
      <div class="note-date">Sun</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TOOL / DETAIL VIEW ‚ïê‚ïê -->
<div id="noteDetail" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">‚Äπ Notes</button>
    <div class="detail-title-display">Voice Memo ‚Äì Quick Ref</div>
    <button class="icon-btn" onclick="toggleSetup()">‚öô</button>
  </div>

  <!-- API Setup -->
  <div id="setupArea" class="setup-note" style="display:none;">
    <div class="setup-title">üîë API Configuration</div>
    <div class="setup-desc">Your Anthropic API key ‚Äî stored locally only, never shared.</div>
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-‚Ä¶" />
    <button class="save-btn" onclick="saveApiKey()">Save</button>
  </div>

  <!-- Voice input ‚Äî looks like a voice memo recorder -->
  <div class="voice-area">
    <div class="voice-top">
      <span class="voice-label">üéô Voice Input</span>
      <span id="timerDisplay" style="font-size:12px;color:var(--text-secondary);font-variant-numeric:tabular-nums;"></span>
    </div>

    <!-- Mic button -->
    <div class="mic-ring" id="micRing" onclick="toggleVoice()">
      <span class="mic-icon" id="micIcon">üéôÔ∏è</span>
    </div>

    <!-- Animated waveform while listening -->
    <div class="waveform" id="waveform">
      <div class="wave-bar" style="height:8px"></div>
      <div class="wave-bar" style="height:14px"></div>
      <div class="wave-bar" style="height:20px"></div>
      <div class="wave-bar" style="height:26px"></div>
      <div class="wave-bar" style="height:20px"></div>
      <div class="wave-bar" style="height:14px"></div>
      <div class="wave-bar" style="height:8px"></div>
    </div>

    <div class="voice-status" id="voiceStatus">Tap mic and speak your problem</div>

    <!-- Editable transcript ‚Äî looks like note content -->
    <div class="transcript-box" id="transcriptBox" contenteditable="true" spellcheck="false"></div>

    <div class="voice-actions">
      <button class="voice-action-btn btn-clear" onclick="clearAll()">Clear</button>
      <button class="voice-action-btn btn-generate" id="generateBtn" onclick="generate()" disabled>Generate ‚ö°</button>
    </div>
  </div>

  <!-- Depth chips -->
  <div class="depth-row">
    <div class="depth-chip active" data-depth="interview" onclick="setDepth(this)">üéØ Interview</div>
    <div class="depth-chip" data-depth="explain" onclick="setDepth(this)">üó£Ô∏è Team</div>
    <div class="depth-chip" data-depth="beginner" onclick="setDepth(this)">üìñ Beginner</div>
  </div>

  <!-- Thinking indicator -->
  <div class="thinking" id="thinking">
    <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="thinking-text">Building your complete explanation‚Ä¶</div>
  </div>

  <!-- Results -->
  <div class="response-area" id="responseArea"></div>
</div>

<!-- ‚ïê‚ïê SPEAK MODE ‚ïê‚ïê -->
<div id="speakOverlay">
  <button class="speak-close" onclick="closeSpeakMode()">‚úï</button>
  <div class="speak-title">üì¢ How to Explain This</div>
  <div id="speakContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
const STORAGE_KEY = 'nts_cfg_key';
let currentDepth = 'interview';
let lastResult = null;
let recognition = null;
let isListening = false;
let silenceTimer = null;
let timerInterval = null;
let elapsed = 0;
let interimResult = '';

/* ‚îÄ‚îÄ‚îÄ API KEY ‚îÄ‚îÄ‚îÄ */
function getApiKey() { return localStorage.getItem(STORAGE_KEY) || ''; }
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (key) { localStorage.setItem(STORAGE_KEY, key); document.getElementById('setupArea').style.display = 'none'; showToast('Saved ‚úì'); }
}
function toggleSetup() {
  const area = document.getElementById('setupArea');
  const hidden = area.style.display === 'none';
  area.style.display = hidden ? 'block' : 'none';
  if (hidden && getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
}

/* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
function openTool() {
  document.getElementById('notesList').style.display = 'none';
  document.getElementById('noteDetail').classList.add('open');
  if (!getApiKey()) document.getElementById('setupArea').style.display = 'block';
}
function goBack() {
  stopListening();
  document.getElementById('noteDetail').classList.remove('open');
  document.getElementById('notesList').style.display = 'block';
  clearAll();
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('thinking').classList.remove('active');
  lastResult = null;
}
function setDepth(el) {
  document.querySelectorAll('.depth-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentDepth = el.dataset.depth;
}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  setTimeout(() => t.style.opacity = '0', 2200);
}

/* ‚îÄ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ */
function startTimer() {
  elapsed = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsed++;
    const m = String(Math.floor(elapsed/60)).padStart(2,'0');
    const s = String(elapsed%60).padStart(2,'0');
    document.getElementById('timerDisplay').textContent = `${m}:${s}`;
  }, 1000);
}
function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('timerDisplay').textContent = '';
}

/* ‚îÄ‚îÄ‚îÄ VOICE RECOGNITION ‚îÄ‚îÄ‚îÄ */
function supportsVoice() {
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function toggleVoice() {
  if (isListening) { stopListening(); }
  else { startListening(); }
}

function startListening() {
  if (!supportsVoice()) { showToast('Voice not supported ‚Äî type your problem'); return; }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  recognition.maxAlternatives = 1;

  // Preserve existing text
  const existing = document.getElementById('transcriptBox').textContent.trim();

  recognition.onstart = () => {
    isListening = true;
    document.getElementById('micRing').classList.add('listening');
    document.getElementById('micIcon').textContent = '‚èπÔ∏è';
    document.getElementById('waveform').classList.add('active');
    document.getElementById('voiceStatus').textContent = 'Listening‚Ä¶ speak your problem';
    document.getElementById('voiceStatus').classList.add('listening');
    startTimer();
  };

  recognition.onresult = (e) => {
    // Reset silence auto-stop
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(() => stopListening(), 3000);

    let interim = '';
    let final = existing ? existing + ' ' : '';

    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) { final += t; }
      else { interim = t; }
    }

    const box = document.getElementById('transcriptBox');
    box.textContent = final + (interim ? interim : '');

    // Enable generate once there's content
    document.getElementById('generateBtn').disabled = box.textContent.trim().length < 5;
  };

  recognition.onerror = (e) => {
    if (e.error === 'not-allowed') showToast('Mic access denied ‚Äî enable in browser settings');
    else if (e.error !== 'aborted') showToast('Mic error: ' + e.error);
    stopListening();
  };

  recognition.onend = () => {
    // Auto-restart if still in listening mode (iOS cuts off every ~60s)
    if (isListening) {
      try { recognition.start(); }
      catch(e) { stopListeningUI(); }
    }
  };

  try { recognition.start(); }
  catch(e) { showToast('Could not start microphone'); }
}

function stopListening() {
  isListening = false;
  clearTimeout(silenceTimer);
  stopTimer();
  if (recognition) { try { recognition.stop(); } catch(e){} recognition = null; }
  stopListeningUI();
  // Auto-generate if there's a transcript
  const text = document.getElementById('transcriptBox').textContent.trim();
  if (text.length > 5) {
    document.getElementById('voiceStatus').textContent = 'Got it! Generating‚Ä¶';
    setTimeout(generate, 400);
  }
}

function stopListeningUI() {
  document.getElementById('micRing').classList.remove('listening');
  document.getElementById('micIcon').textContent = 'üéôÔ∏è';
  document.getElementById('waveform').classList.remove('active');
  document.getElementById('voiceStatus').textContent = 'Tap mic to record again';
  document.getElementById('voiceStatus').classList.remove('listening');
}

function clearAll() {
  stopListening();
  document.getElementById('transcriptBox').textContent = '';
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('voiceStatus').textContent = 'Tap mic and speak your problem';
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  lastResult = null;
}

/* ‚îÄ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ */
async function generate() {
  const problem = document.getElementById('transcriptBox').textContent.trim();
  if (!problem || problem.length < 4) { showToast('Speak or type a problem first'); return; }
  const apiKey = getApiKey();
  if (!apiKey) { toggleSetup(); showToast('Add your API key first'); return; }

  document.getElementById('generateBtn').disabled = true;
  document.getElementById('thinking').classList.add('active');
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('responseArea').innerHTML = '';

  const depthMap = {
    interview: 'The user is in a coding interview. Steps must be crisp, confident, precise. Anticipate typical interviewer follow-ups.',
    explain: 'The user is explaining to their engineering team. Be conversational, practical, mention real-world trade-offs.',
    beginner: 'The user explains to a beginner. Use simple language, no jargon, vivid relatable analogies.'
  };

  const sys = `You are an elite Java coding coach. Given a problem, produce a response so thorough that the user sounds like they deeply thought through and wrote the solution themselves.

Context: ${depthMap[currentDepth]}

Return ONLY valid JSON (no markdown, no fences):
{
  "summary": "One confident sentence describing the approach as if the user just thought of it",
  "complexity": "Time: O(?) | Space: O(?)",
  "complexity_explanation": "2-3 sentences explaining WHY the complexity is what it is, in plain terms",
  "pattern": "Algorithm pattern name",
  "approach": "Core technique used",
  "thought_process": "4-5 sentences: how a smart engineer naturally arrives at this solution ‚Äî the aha moment, why naive approaches fail, why this clicks. First person, as if user is narrating.",
  "analogy": "Vivid 2-3 sentence real-world analogy that makes the algorithm intuitive and memorable.",
  "code": "Complete, clean, well-commented Java code",
  "steps": [
    {
      "title": "Short step title",
      "what": "What this step does ‚Äî 1-2 sentences",
      "how": "How it works in code ‚Äî mention specific variable/method names with backtick formatting like \`varName\`",
      "why": "WHY we do it this way ‚Äî the reasoning, not just mechanics. This is what makes you sound smart."
    }
  ],
  "tricky_parts": [
    {
      "issue": "Name of the tricky edge case or gotcha",
      "explanation": "Why it is tricky and exactly how the code handles it. Use backtick formatting for variable/method names."
    }
  ],
  "followup_qa": [
    {
      "question": "Realistic follow-up someone would ask",
      "answer": "Confident, complete answer. 2-4 sentences."
    }
  ],
  "alternatives": [
    {
      "name": "Alternative approach name",
      "complexity": "Time/Space",
      "when_to_use": "When better or worse and why",
      "verdict": "better|tradeoff|worse"
    }
  ]
}
Provide 5-6 steps, 2-3 tricky parts, 4 follow-up Q&As, 2-3 alternatives. Every explanation must feel organic and intelligent, not textbook-like.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-api-key':apiKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
      body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:4500, system:sys, messages:[{role:'user',content:problem}] })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.content[0].text.trim().replace(/^```json\s*/i,'').replace(/\s*```$/,'');
    const parsed = JSON.parse(text);
    lastResult = parsed;
    renderResponse(parsed);
  } catch(err) {
    document.getElementById('responseArea').innerHTML = `<div class="error-box">‚ö†Ô∏è ${err.message}</div>`;
    document.getElementById('responseArea').classList.add('visible');
  } finally {
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('thinking').classList.remove('active');
    document.getElementById('voiceStatus').textContent = 'Tap mic to record again';
  }
}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel_' + id));
}

/* ‚îÄ‚îÄ‚îÄ Q&A ACCORDION ‚îÄ‚îÄ‚îÄ */
function toggleQA(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}

/* ‚îÄ‚îÄ‚îÄ SPEAK MODE ‚îÄ‚îÄ‚îÄ */
function openSpeakMode() {
  if (!lastResult) return;
  const d = lastResult;
  let html = speakCard('üß† How I Approached It', d.thought_process);
  html += speakCard('üéØ One-Liner', d.summary);
  html += speakCard('üí° Analogy to Use', d.analogy);
  html += speakCard('üîë Key Points', d.steps.map((s,i)=>`${i+1}. ${s.title} ‚Äî ${s.why}`).join('\n'));
  html += speakCard('‚ö° On Complexity', d.complexity_explanation);
  html += speakCard('‚ö†Ô∏è Tricky Parts to Mention', (d.tricky_parts||[]).map(t=>`‚Ä¢ ${t.issue}: ${t.explanation.substring(0,120)}‚Ä¶`).join('\n'));
  html += speakCard('üîÑ If Asked for Alternatives', (d.alternatives||[]).map(a=>`‚Ä¢ ${a.name} (${a.complexity}) ‚Äî ${a.when_to_use}`).join('\n'));
  document.getElementById('speakContent').innerHTML = html;
  document.getElementById('speakOverlay').classList.add('open');
}
function closeSpeakMode() { document.getElementById('speakOverlay').classList.remove('open'); }
function speakCard(label, text) {
  return `<div class="speak-card"><div class="speak-card-label">${label}</div><div class="speak-card-text">${String(text).replace(/\n/g,'<br>')}</div></div>`;
}

/* ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ */
function highlight(code) {
  const kw = ['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h = h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h = h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k => { h = h.replace(new RegExp(`\\b(${k})\\b`,'g'),'<span style="color:#569cd6">$1</span>'); });
  return h;
}
function renderExpl(t) { return String(t).replace(/`([^`]+)`/g,'<code>$1</code>'); }

function renderResponse(d) {
  const area = document.getElementById('responseArea');

  const stepsHTML = (d.steps||[]).map((s,i) => `
    <li class="step-item">
      <div class="step-num">${i+1}</div>
      <div class="step-body">
        <div class="step-title">${s.title}</div>
        <div class="step-desc">${renderExpl(s.what)}<br><br>${renderExpl(s.how)}</div>
        <div class="step-why">üí° Why: ${s.why}</div>
      </div>
    </li>`).join('');

  const trickyHTML = (d.tricky_parts||[]).map(t => `
    <div class="tricky-item">
      <div class="tricky-head">‚ö†Ô∏è ${t.issue}</div>
      <div class="tricky-desc">${renderExpl(t.explanation)}</div>
    </div>`).join('');

  const qaHTML = (d.followup_qa||[]).map(q => `
    <div class="qa-item">
      <div class="qa-q" onclick="toggleQA(this)"><span>${q.question}</span><span class="chevron">‚Ä∫</span></div>
      <div class="qa-a">${renderExpl(q.answer)}</div>
    </div>`).join('');

  const altHTML = (d.alternatives||[]).map(a => `
    <div class="alt-item">
      <div class="alt-head">
        <span>${a.name} <small style="color:var(--text-secondary);font-weight:400">${a.complexity}</small></span>
        <span class="alt-badge ${a.verdict}">${a.verdict==='better'?'‚úì Better':'a.verdict==='worse'?'‚úó Worse':'‚áÑ Trade-off'}</span>
      </div>
      <div class="alt-desc">${a.when_to_use}</div>
    </div>`).join('');

  area.innerHTML = `
    <div class="tab-bar">
      <div class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div>
      <div class="tab" data-tab="code" onclick="switchTab('code')">Code</div>
      <div class="tab" data-tab="walkthrough" onclick="switchTab('walkthrough')">Walkthrough</div>
      <div class="tab" data-tab="tricky" onclick="switchTab('tricky')">Gotchas</div>
      <div class="tab" data-tab="qa" onclick="switchTab('qa')">Q&amp;A</div>
      <div class="tab" data-tab="alts" onclick="switchTab('alts')">Alternatives</div>
    </div>

    <div class="tab-panel active" id="panel_overview">
      <div class="thought-block"><div class="thought-label">üß† How I thought about this</div>${d.thought_process}</div>
      <div class="analogy-block"><div class="analogy-label">üí° Real-world analogy</div>${d.analogy}</div>
      <div class="summary-box">${d.summary}</div>
      <div class="meta-row">
        <span class="badge badge-complexity">${d.complexity}</span>
        <span class="badge badge-pattern">${d.pattern}</span>
        <span class="badge badge-approach">${d.approach}</span>
      </div>
      <div style="font-size:13px;line-height:1.7;color:var(--text-secondary);padding:4px 0 16px;">${d.complexity_explanation}</div>
      <button onclick="openSpeakMode()" style="width:100%;padding:12px;background:var(--accent-soft);border:1.5px solid rgba(200,169,110,0.4);border-radius:10px;font-size:13px;font-weight:600;color:var(--text-primary);cursor:pointer;">üì¢ Open Speak Mode</button>
    </div>

    <div class="tab-panel" id="panel_code">
      <div class="code-block">
        <div class="code-header"><span class="code-lang">Java</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
        <div class="code-content"><pre>${highlight(d.code)}</pre></div>
      </div>
    </div>

    <div class="tab-panel" id="panel_walkthrough">
      <ul class="steps-list">${stepsHTML}</ul>
    </div>

    <div class="tab-panel" id="panel_tricky">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing these makes you sound thorough and experienced.</div>
      ${trickyHTML}
    </div>

    <div class="tab-panel" id="panel_qa">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Tap to see a confident answer ready to deliver.</div>
      ${qaHTML}
    </div>

    <div class="tab-panel" id="panel_alts">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Mentioning trade-offs proactively signals deep understanding.</div>
      ${altHTML}
    </div>
  `;

  area._rawCode = d.code;
  area.classList.add('visible');

  // Scroll to results smoothly
  setTimeout(() => area.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

function copyCode(btn) {
  const area = document.getElementById('responseArea');
  navigator.clipboard.writeText(area._rawCode||'').then(() => { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); });
}

// Allow manual typing too
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('transcriptBox');
  box.addEventListener('input', () => {
    document.getElementById('generateBtn').disabled = box.textContent.trim().length < 5;
  });
});
</script>
</body>
</html>
