<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Notes</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  :root {
    --bg: #faf9f7; --surface: #ffffff; --border: #e8e5e0;
    --text-primary: #1a1916; --text-secondary: #7a7670;
    --accent: #c8a96e; --accent-soft: #f5f0e8;
    --code-bg: #1e1c1a; --code-text: #e8e4dc;
    --green: #5a8a5a; --blue: #4a6fa5; --red: #a05a5a;
    --green-soft: #eef4ee; --blue-soft: #eef2fa; --red-soft: #faf0f0;
  }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-primary); min-height: 100vh; max-width: 700px; margin: 0 auto; padding: 0 0 100px; }

  .app-header { padding: 56px 24px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(250,249,247,0.93); }
  .header-row { display: flex; align-items: center; justify-content: space-between; }
  .app-title { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .note-count { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
  .notes-list { padding: 8px 0; }

  .note-row {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 14px;
    align-items: flex-start;
    cursor: pointer;
    -webkit-tap-highlight-color: rgba(200,169,110,0.15);
    transition: background 0.15s;
    text-decoration: none;
    color: inherit;
    width: 100%;
    background: none;
    border-left: none;
    border-right: none;
    border-top: none;
    text-align: left;
  }
  .note-row:active { background: var(--accent-soft); }

  .note-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--accent-soft); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 20px; }
  .note-preview { flex: 1; min-width: 0; }
  .note-title { font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
  .note-snippet { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 3px; }
  .note-date { font-size: 12px; color: var(--text-secondary); flex-shrink: 0; margin-top: 2px; }

  /* DETAIL */
  .note-detail { display: none; min-height: 100vh; background: var(--bg); }
  .note-detail.open { display: block; }
  .detail-header { padding: 16px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(250,249,247,0.96); backdrop-filter: blur(20px); z-index: 10; }
  .back-btn { color: var(--accent); font-size: 17px; cursor: pointer; border: none; background: none; font-weight: 600; padding: 8px 4px; min-width: 60px; }
  .detail-title { flex: 1; font-size: 15px; font-weight: 600; text-align: center; }
  .gear-btn { font-size: 20px; cursor: pointer; border: none; background: none; padding: 8px; min-width: 44px; color: var(--accent); }

  /* SETUP */
  .setup-note { margin: 16px 24px; padding: 16px; background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 12px; }
  .setup-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .setup-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
  .api-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: monospace; background: var(--surface); color: var(--text-primary); outline: none; margin-bottom: 8px; -webkit-appearance: none; }
  .save-btn { padding: 10px 16px; background: var(--text-primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%; }

  /* VOICE AREA */
  .voice-area { margin: 20px 24px 0; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  .voice-top { padding: 14px 16px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
  .voice-label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); }
  .timer { font-size: 12px; color: var(--text-secondary); font-variant-numeric: tabular-nums; }

  .mic-wrap { display: flex; justify-content: center; padding: 24px 0 8px; }
  .mic-btn {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: var(--accent-soft);
    border: 2px solid rgba(200,169,110,0.4);
    font-size: 32px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, background 0.2s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .mic-btn:active { transform: scale(0.92); }
  .mic-btn.listening {
    background: #fff0f0;
    border-color: rgba(200,60,60,0.5);
    animation: micPulse 1s ease-in-out infinite;
  }
  @keyframes micPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }

  .waveform { display: none; align-items: flex-end; justify-content: center; gap: 3px; height: 30px; margin: 4px auto 0; width: 110px; }
  .waveform.active { display: flex; }
  .wave-bar { width: 4px; border-radius: 2px; background: var(--accent); animation: wave 0.9s infinite ease-in-out; }
  .wave-bar:nth-child(1){animation-delay:0s} .wave-bar:nth-child(2){animation-delay:0.1s} .wave-bar:nth-child(3){animation-delay:0.2s} .wave-bar:nth-child(4){animation-delay:0.3s} .wave-bar:nth-child(5){animation-delay:0.2s} .wave-bar:nth-child(6){animation-delay:0.1s} .wave-bar:nth-child(7){animation-delay:0s}
  @keyframes wave { 0%,100%{height:5px;opacity:0.4} 50%{height:24px;opacity:1} }

  .voice-status { text-align: center; font-size: 13px; color: var(--text-secondary); padding: 8px 16px 4px; font-style: italic; min-height: 28px; }
  .voice-status.listening { color: #c0392b; font-style: normal; font-weight: 500; }

  .transcript-box { margin: 10px 16px 14px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; font-size: 14px; line-height: 1.65; color: var(--text-primary); min-height: 52px; outline: none; -webkit-user-select: text; user-select: text; }
  .transcript-box:empty::before { content: 'Tap mic to speak your problem‚Ä¶'; color: var(--text-secondary); font-style: italic; }

  .voice-actions { display: flex; gap: 10px; padding: 0 16px 18px; }
  .btn-clear { flex: 1; padding: 11px; border-radius: 9px; font-size: 13px; font-weight: 600; border: 1.5px solid var(--border); background: var(--bg); color: var(--text-secondary); cursor: pointer; }
  .btn-generate { flex: 2; padding: 11px; border-radius: 9px; font-size: 13px; font-weight: 700; border: none; background: var(--text-primary); color: white; cursor: pointer; }
  .btn-generate:disabled { opacity: 0.38; cursor: not-allowed; }

  /* DEPTH */
  .depth-row { display: flex; gap: 8px; padding: 14px 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .depth-chip { padding: 7px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1.5px solid var(--border); background: var(--surface); color: var(--text-secondary); cursor: pointer; white-space: nowrap; flex-shrink: 0; -webkit-tap-highlight-color: transparent; }
  .depth-chip.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }

  /* THINKING */
  .thinking { display: none; padding: 20px 24px; align-items: center; gap: 12px; }
  .thinking.active { display: flex; }
  .thinking-dots { display: flex; gap: 4px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.2s infinite; }
  .dot:nth-child(2){animation-delay:0.2s} .dot:nth-child(3){animation-delay:0.4s}
  @keyframes pulse { 0%,80%,100%{transform:scale(1);opacity:0.5} 40%{transform:scale(1.3);opacity:1} }
  .thinking-text { font-size: 13px; color: var(--text-secondary); font-style: italic; }

  /* RESPONSE */
  .response-area { padding: 0 24px 40px; display: none; }
  .response-area.visible { display: block; }

  /* TABS */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); margin: 0 -24px; padding: 0 16px; overflow-x: auto; margin-top: 20px; -webkit-overflow-scrolling: touch; }
  .tab { padding: 11px 12px; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; flex-shrink: 0; }
  .tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
  .tab-panel { display: none; padding-top: 16px; }
  .tab-panel.active { display: block; }

  /* CONTENT */
  .summary-box { background: var(--accent-soft); border: 1px solid rgba(200,169,110,0.3); border-radius: 10px; padding: 16px; font-size: 14px; line-height: 1.7; margin-bottom: 14px; }
  .meta-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .badge { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
  .badge-complexity { background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(200,169,110,0.3); }
  .badge-pattern { background: var(--blue-soft); color: var(--blue); border: 1px solid rgba(74,111,165,0.2); }
  .badge-approach { background: var(--green-soft); color: var(--green); border: 1px solid rgba(90,138,90,0.2); }
  .thought-block { background: var(--blue-soft); border-left: 3px solid var(--blue); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; margin-bottom: 12px; }
  .thought-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--blue); margin-bottom: 6px; }
  .analogy-block { background: var(--green-soft); border-left: 3px solid var(--green); border-radius: 0 10px 10px 0; padding: 14px 16px; font-size: 13.5px; line-height: 1.75; margin-bottom: 12px; }
  .analogy-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--green); margin-bottom: 6px; }
  .code-block { background: var(--code-bg); border-radius: 12px; overflow: hidden; margin-bottom: 8px; }
  .code-header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
  .code-lang { font-size: 11px; color: #8a8580; font-family: monospace; }
  .copy-btn { font-size: 11px; color: var(--accent); background: none; border: none; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-weight: 500; }
  .code-content { padding: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .code-content pre { font-family: 'SF Mono', monospace; font-size: 12.5px; line-height: 1.7; color: var(--code-text); white-space: pre; }
  .steps-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
  .step-item { display: flex; gap: 12px; align-items: flex-start; padding: 14px; background: var(--surface); border-radius: 10px; border: 1px solid var(--border); }
  .step-num { width: 26px; height: 26px; border-radius: 50%; background: var(--accent); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .step-body { flex: 1; }
  .step-title { font-size: 13.5px; font-weight: 700; margin-bottom: 4px; }
  .step-desc { font-size: 13px; line-height: 1.65; }
  .step-desc code, .step-why code, .tricky-desc code, .qa-a code { font-family: monospace; font-size: 11.5px; background: var(--accent-soft); padding: 1px 5px; border-radius: 4px; }
  .step-why { font-size: 12px; color: var(--blue); margin-top: 6px; font-style: italic; }
  .tricky-item { padding: 14px; background: var(--red-soft); border: 1px solid rgba(160,90,90,0.2); border-radius: 10px; margin-bottom: 10px; }
  .tricky-head { font-size: 13px; font-weight: 700; color: var(--red); margin-bottom: 6px; }
  .tricky-desc { font-size: 13px; line-height: 1.65; }
  .qa-item { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
  .qa-q { padding: 14px 16px; font-size: 13.5px; font-weight: 600; background: var(--surface); cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  .qa-q .chevron { color: var(--text-secondary); transition: transform 0.2s; font-size: 14px; flex-shrink: 0; }
  .qa-q.open .chevron { transform: rotate(90deg); }
  .qa-a { display: none; padding: 12px 16px; font-size: 13px; line-height: 1.7; background: var(--bg); border-top: 1px solid var(--border); }
  .qa-a.open { display: block; }
  .alt-item { padding: 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
  .alt-head { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .alt-desc { font-size: 13px; line-height: 1.65; }
  .alt-badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 600; flex-shrink: 0; }
  .better { background: var(--green-soft); color: var(--green); }
  .tradeoff { background: var(--accent-soft); color: var(--accent); }
  .worse { background: var(--red-soft); color: var(--red); }
  .error-box { background: #fff0f0; border: 1px solid #ffcccc; border-radius: 10px; padding: 14px 16px; font-size: 13px; color: #c0392b; margin-top: 12px; }
  .speak-btn { width: 100%; padding: 13px; background: var(--accent-soft); border: 1.5px solid rgba(200,169,110,0.4); border-radius: 10px; font-size: 13px; font-weight: 600; color: var(--text-primary); cursor: pointer; margin-top: 4px; }

  /* SPEAK MODE */
  #speakOverlay { display: none; position: fixed; inset: 0; background: rgba(20,19,18,0.97); z-index: 999; flex-direction: column; padding: 64px 24px 40px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  #speakOverlay.open { display: flex; }
  .speak-close { position: fixed; top: 18px; right: 20px; color: var(--accent); font-size: 28px; cursor: pointer; background: none; border: none; z-index: 1000; padding: 8px; }
  .speak-title { font-size: 12px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent); margin-bottom: 20px; }
  .speak-card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 18px 20px; margin-bottom: 14px; }
  .speak-card-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
  .speak-card-text { font-size: 16px; line-height: 1.85; color: #ede9e2; }

  .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #1a1916; color: white; padding: 9px 22px; border-radius: 22px; font-size: 13px; z-index: 9999; opacity: 0; transition: opacity 0.25s; white-space: nowrap; pointer-events: none; }
</style>
</head>
<body>

<!-- NOTES LIST -->
<div id="notesList">
  <div class="app-header">
    <div class="header-row">
      <div class="app-title">Notes</div>
    </div>
    <div class="note-count">3 notes</div>
  </div>
  <div class="notes-list">

    <button class="note-row" onclick="openTool()">
      <div class="note-icon">üéôÔ∏è</div>
      <div class="note-preview">
        <div class="note-title">Voice Memo ‚Äì Quick Ref</div>
        <div class="note-snippet">Tap to record your question‚Ä¶</div>
      </div>
      <div class="note-date">Now</div>
    </button>

    <button class="note-row" onclick="void(0)">
      <div class="note-icon">üìã</div>
      <div class="note-preview">
        <div class="note-title">Meeting notes ‚Äì Product sync</div>
        <div class="note-snippet">Discussed roadmap priorities and Q2 milestones</div>
      </div>
      <div class="note-date">Mon</div>
    </button>

    <button class="note-row" onclick="void(0)">
      <div class="note-icon">üìù</div>
      <div class="note-preview">
        <div class="note-title">Grocery list</div>
        <div class="note-snippet">Eggs, bread, olive oil, tomatoes‚Ä¶</div>
      </div>
      <div class="note-date">Sun</div>
    </button>

  </div>
</div>

<!-- TOOL VIEW -->
<div id="noteDetail" class="note-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">‚Äπ Notes</button>
    <div class="detail-title">Voice Memo</div>
    <button class="gear-btn" onclick="toggleSetup()">‚öôÔ∏è</button>
  </div>

  <div id="setupArea" class="setup-note" style="display:none;">
    <div class="setup-title">üîë API Key</div>
    <div class="setup-desc">Your Anthropic API key ‚Äî saved locally on this device only, never sent anywhere else.</div>
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-‚Ä¶" autocomplete="off" />
    <button class="save-btn" onclick="saveApiKey()">Save & Close</button>
  </div>

  <div class="voice-area">
    <div class="voice-top">
      <span class="voice-label">üéô Speak your problem</span>
      <span class="timer" id="timerDisplay"></span>
    </div>

    <div class="mic-wrap">
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()">üéôÔ∏è</button>
    </div>

    <div class="waveform" id="waveform">
      <div class="wave-bar" style="height:6px"></div>
      <div class="wave-bar" style="height:12px"></div>
      <div class="wave-bar" style="height:20px"></div>
      <div class="wave-bar" style="height:26px"></div>
      <div class="wave-bar" style="height:20px"></div>
      <div class="wave-bar" style="height:12px"></div>
      <div class="wave-bar" style="height:6px"></div>
    </div>

    <div class="voice-status" id="voiceStatus">Tap the mic and speak clearly</div>

    <div class="transcript-box" id="transcriptBox" contenteditable="true" spellcheck="false"></div>

    <div class="voice-actions">
      <button class="btn-clear" onclick="clearAll()">Clear</button>
      <button class="btn-generate" id="generateBtn" onclick="generate()" disabled>Generate ‚ö°</button>
    </div>
  </div>

  <div class="depth-row">
    <div class="depth-chip active" data-depth="interview" onclick="setDepth(this)">üéØ Interview</div>
    <div class="depth-chip" data-depth="explain" onclick="setDepth(this)">üó£Ô∏è Team</div>
    <div class="depth-chip" data-depth="beginner" onclick="setDepth(this)">üìñ Beginner</div>
  </div>

  <div class="thinking" id="thinking">
    <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="thinking-text">Building your full explanation‚Ä¶</div>
  </div>

  <div class="response-area" id="responseArea"></div>
</div>

<!-- SPEAK MODE -->
<div id="speakOverlay">
  <button class="speak-close" onclick="closeSpeakMode()">‚úï</button>
  <div class="speak-title">üì¢ How to Explain This</div>
  <div id="speakContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const STORAGE_KEY = 'nts_cfg_v2';
let currentDepth = 'interview';
let lastResult = null;
let recognition = null;
let isListening = false;
let silenceTimer = null;
let timerInterval = null;
let elapsed = 0;
let accumulatedText = '';

/* KEY */
function getApiKey() { return localStorage.getItem(STORAGE_KEY) || ''; }
function saveApiKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) { showToast('Please enter a key'); return; }
  localStorage.setItem(STORAGE_KEY, k);
  document.getElementById('setupArea').style.display = 'none';
  showToast('API key saved ‚úì');
}
function toggleSetup() {
  const a = document.getElementById('setupArea');
  const show = a.style.display === 'none';
  a.style.display = show ? 'block' : 'none';
  if (show && getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
}

/* NAV */
function openTool() {
  document.getElementById('notesList').style.display = 'none';
  document.getElementById('noteDetail').classList.add('open');
  if (!getApiKey()) {
    document.getElementById('setupArea').style.display = 'block';
    document.getElementById('apiKeyInput').focus();
  }
}
function goBack() {
  stopListening(false);
  document.getElementById('noteDetail').classList.remove('open');
  document.getElementById('notesList').style.display = 'block';
  clearAll();
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('thinking').classList.remove('active');
  lastResult = null;
}
function setDepth(el) {
  document.querySelectorAll('.depth-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentDepth = el.dataset.depth;
}

/* TOAST */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._to);
  t._to = setTimeout(() => t.style.opacity = '0', 2400);
}

/* TIMER */
function startTimer() {
  elapsed = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsed++;
    const m = String(Math.floor(elapsed/60)).padStart(2,'0');
    const s = String(elapsed%60).padStart(2,'0');
    document.getElementById('timerDisplay').textContent = m + ':' + s;
  }, 1000);
}
function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('timerDisplay').textContent = '';
}

/* VOICE */
function toggleVoice() {
  if (isListening) { stopListening(true); }
  else { startListening(); }
}

function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showToast('Voice not supported ‚Äî type your problem below'); return; }

  accumulatedText = document.getElementById('transcriptBox').textContent.trim();

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    isListening = true;
    document.getElementById('micBtn').classList.add('listening');
    document.getElementById('micBtn').textContent = '‚èπÔ∏è';
    document.getElementById('waveform').classList.add('active');
    document.getElementById('voiceStatus').textContent = 'Listening‚Ä¶ speak your problem';
    document.getElementById('voiceStatus').classList.add('listening');
    startTimer();
  };

  recognition.onresult = (e) => {
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(() => stopListening(true), 2800);

    let final = accumulatedText ? accumulatedText + ' ' : '';
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) {
        final += t;
        accumulatedText = final.trim();
      } else {
        interim = t;
      }
    }
    const box = document.getElementById('transcriptBox');
    box.textContent = (accumulatedText + (interim ? ' ' + interim : '')).trim();
    updateGenerateBtn();
  };

  recognition.onerror = (e) => {
    if (e.error === 'not-allowed') {
      showToast('Mic blocked ‚Äî allow microphone in Safari settings');
    } else if (e.error !== 'aborted' && e.error !== 'no-speech') {
      showToast('Mic error: ' + e.error);
    }
    stopListening(false);
  };

  recognition.onend = () => {
    if (isListening) {
      try { recognition.start(); } catch(e) { stopListening(false); }
    }
  };

  try { recognition.start(); }
  catch(e) { showToast('Could not access microphone'); }
}

function stopListening(autoGenerate) {
  const wasListening = isListening;
  isListening = false;
  clearTimeout(silenceTimer);
  stopTimer();
  if (recognition) { try { recognition.stop(); } catch(e){} recognition = null; }
  document.getElementById('micBtn').classList.remove('listening');
  document.getElementById('micBtn').textContent = 'üéôÔ∏è';
  document.getElementById('waveform').classList.remove('active');
  document.getElementById('voiceStatus').classList.remove('listening');
  const text = document.getElementById('transcriptBox').textContent.trim();
  if (wasListening && autoGenerate && text.length > 5) {
    document.getElementById('voiceStatus').textContent = 'Got it ‚Äî generating‚Ä¶';
    setTimeout(generate, 500);
  } else {
    document.getElementById('voiceStatus').textContent = text.length > 5 ? 'Ready ‚Äî tap Generate or mic again' : 'Tap the mic and speak clearly';
  }
}

function updateGenerateBtn() {
  const text = document.getElementById('transcriptBox').textContent.trim();
  document.getElementById('generateBtn').disabled = text.length < 5;
}

function clearAll() {
  accumulatedText = '';
  document.getElementById('transcriptBox').textContent = '';
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('voiceStatus').textContent = 'Tap the mic and speak clearly';
  document.getElementById('responseArea').innerHTML = '';
  document.getElementById('responseArea').classList.remove('visible');
  lastResult = null;
}

/* GENERATE */
async function generate() {
  const problem = document.getElementById('transcriptBox').textContent.trim();
  if (problem.length < 4) { showToast('Speak or type a problem first'); return; }
  const apiKey = getApiKey();
  if (!apiKey) { toggleSetup(); showToast('Add your API key first'); return; }

  document.getElementById('generateBtn').disabled = true;
  document.getElementById('thinking').classList.add('active');
  document.getElementById('responseArea').classList.remove('visible');
  document.getElementById('responseArea').innerHTML = '';

  const depthMap = {
    interview: 'The user is in a coding interview. Be crisp, confident, and precise. Anticipate interviewer follow-ups.',
    explain:   'The user explains to their engineering team. Be conversational and practical, mention real-world trade-offs.',
    beginner:  'The user explains to a beginner. Use simple language, no jargon, very vivid analogies.'
  };

  const sys = `You are an elite Java coding coach. Produce a response so thorough the user sounds like they deeply thought through and wrote the solution themselves.
Context: ${depthMap[currentDepth]}
Return ONLY valid JSON, no markdown fences, no extra text:
{"summary":"One confident sentence describing the approach as if user just thought of it","complexity":"Time: O(?) | Space: O(?)","complexity_explanation":"2-3 sentences explaining WHY the complexity is what it is in plain terms","pattern":"Algorithm pattern name","approach":"Core technique","thought_process":"4-5 sentences: how a smart engineer naturally arrives at this ‚Äî the aha moment, why naive approaches fail, why this clicks. First person as if user narrates.","analogy":"Vivid 2-3 sentence real-world analogy that makes the algorithm instantly intuitive.","code":"Complete clean well-commented Java code","steps":[{"title":"Short title","what":"What this step does 1-2 sentences","how":"How it works in code ‚Äî use backtick formatting for variable/method names like \`varName\`","why":"WHY we do it this way ‚Äî reasoning not just mechanics"}],"tricky_parts":[{"issue":"Gotcha name","explanation":"Why tricky and how code handles it, use backtick names"}],"followup_qa":[{"question":"Realistic follow-up question","answer":"Confident 2-4 sentence answer"}],"alternatives":[{"name":"Approach name","complexity":"Time/Space","when_to_use":"When better or worse and why","verdict":"better|tradeoff|worse"}]}
Provide 5-6 steps, 2-3 tricky parts, 4 Q&As, 2-3 alternatives. Sound organic and intelligent, never textbook.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4500,
        system: sys,
        messages: [{ role: 'user', content: problem }]
      })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.content[0].text.trim().replace(/^```json\s*/i,'').replace(/\s*```$/,'');
    const parsed = JSON.parse(text);
    lastResult = parsed;
    renderResponse(parsed);
  } catch(err) {
    document.getElementById('responseArea').innerHTML = `<div class="error-box">‚ö†Ô∏è ${err.message}</div>`;
    document.getElementById('responseArea').classList.add('visible');
  } finally {
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('thinking').classList.remove('active');
  }
}

/* TABS */
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel_' + id));
}

/* Q&A */
function toggleQA(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}

/* SPEAK MODE */
function openSpeakMode() {
  if (!lastResult) return;
  const d = lastResult;
  let html = '';
  html += speakCard('üß† How I Approached It', d.thought_process);
  html += speakCard('üéØ One-Liner', d.summary);
  html += speakCard('üí° Analogy to Use', d.analogy);
  html += speakCard('üîë Key Points', (d.steps||[]).map((s,i) => (i+1)+'. '+s.title+' ‚Äî '+s.why).join('\n'));
  html += speakCard('‚ö° On Complexity', d.complexity_explanation);
  html += speakCard('‚ö†Ô∏è Tricky Parts', (d.tricky_parts||[]).map(t => '‚Ä¢ '+t.issue+': '+t.explanation.substring(0,140)).join('\n'));
  html += speakCard('üîÑ Alternatives', (d.alternatives||[]).map(a => '‚Ä¢ '+a.name+' ('+a.complexity+') ‚Äî '+a.when_to_use).join('\n'));
  document.getElementById('speakContent').innerHTML = html;
  document.getElementById('speakOverlay').classList.add('open');
}
function closeSpeakMode() { document.getElementById('speakOverlay').classList.remove('open'); }
function speakCard(label, text) {
  return '<div class="speak-card"><div class="speak-card-label">'+label+'</div><div class="speak-card-text">'+String(text).replace(/\n/g,'<br>')+'</div></div>';
}

/* HIGHLIGHT */
function hl(code) {
  const kw = ['public','private','protected','class','interface','extends','implements','new','return','if','else','for','while','do','switch','case','default','break','continue','null','true','false','void','static','final','abstract','import','package','throws','throw','try','catch','finally','int','long','double','float','boolean','char','String','List','Map','Set','ArrayList','HashMap','HashSet','LinkedList','Stack','Queue','TreeMap','TreeSet','Arrays','Collections','Math','Integer','Character','Optional','var'];
  let h = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h = h.replace(/(\/\/[^\n]*)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span style="color:#6a9955">$1</span>');
  h = h.replace(/("(?:[^"\\]|\\.)*")/g,'<span style="color:#ce9178">$1</span>');
  h = h.replace(/\b(\d+)\b/g,'<span style="color:#b5cea8">$1</span>');
  kw.forEach(k => { h = h.replace(new RegExp('\\b('+k+')\\b','g'),'<span style="color:#569cd6">$1</span>'); });
  return h;
}
function rx(t) { return String(t).replace(/`([^`]+)`/g,'<code>$1</code>'); }

/* RENDER */
function renderResponse(d) {
  const area = document.getElementById('responseArea');

  const stepsHTML = (d.steps||[]).map((s,i) =>
    '<li class="step-item"><div class="step-num">'+(i+1)+'</div><div class="step-body"><div class="step-title">'+s.title+'</div><div class="step-desc">'+rx(s.what)+'<br><br>'+rx(s.how)+'</div><div class="step-why">üí° Why: '+s.why+'</div></div></li>'
  ).join('');

  const trickyHTML = (d.tricky_parts||[]).map(t =>
    '<div class="tricky-item"><div class="tricky-head">‚ö†Ô∏è '+t.issue+'</div><div class="tricky-desc">'+rx(t.explanation)+'</div></div>'
  ).join('');

  const qaHTML = (d.followup_qa||[]).map(q =>
    '<div class="qa-item"><div class="qa-q" onclick="toggleQA(this)"><span>'+q.question+'</span><span class="chevron">‚Ä∫</span></div><div class="qa-a">'+rx(q.answer)+'</div></div>'
  ).join('');

  const verdictLabel = v => v==='better' ? '‚úì Better' : v==='worse' ? '‚úó Worse' : '‚áÑ Trade-off';
  const altHTML = (d.alternatives||[]).map(a =>
    '<div class="alt-item"><div class="alt-head"><span>'+a.name+' <small style="color:var(--text-secondary);font-weight:400">'+a.complexity+'</small></span><span class="alt-badge '+a.verdict+'">'+verdictLabel(a.verdict)+'</span></div><div class="alt-desc">'+a.when_to_use+'</div></div>'
  ).join('');

  area.innerHTML =
    '<div class="tab-bar">' +
      '<div class="tab active" data-tab="overview" onclick="switchTab(\'overview\')">Overview</div>' +
      '<div class="tab" data-tab="code" onclick="switchTab(\'code\')">Code</div>' +
      '<div class="tab" data-tab="walkthrough" onclick="switchTab(\'walkthrough\')">Walkthrough</div>' +
      '<div class="tab" data-tab="tricky" onclick="switchTab(\'tricky\')">Gotchas</div>' +
      '<div class="tab" data-tab="qa" onclick="switchTab(\'qa\')">Q&amp;A</div>' +
      '<div class="tab" data-tab="alts" onclick="switchTab(\'alts\')">Alternatives</div>' +
    '</div>' +

    '<div class="tab-panel active" id="panel_overview">' +
      '<div class="thought-block"><div class="thought-label">üß† How I thought about this</div>'+d.thought_process+'</div>' +
      '<div class="analogy-block"><div class="analogy-label">üí° Real-world analogy</div>'+d.analogy+'</div>' +
      '<div class="summary-box">'+d.summary+'</div>' +
      '<div class="meta-row"><span class="badge badge-complexity">'+d.complexity+'</span><span class="badge badge-pattern">'+d.pattern+'</span><span class="badge badge-approach">'+d.approach+'</span></div>' +
      '<div style="font-size:13px;line-height:1.7;color:var(--text-secondary);padding:2px 0 16px;">'+d.complexity_explanation+'</div>' +
      '<button class="speak-btn" onclick="openSpeakMode()">üì¢ Open Speak Mode</button>' +
    '</div>' +

    '<div class="tab-panel" id="panel_code">' +
      '<div class="code-block"><div class="code-header"><span class="code-lang">Java</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div><div class="code-content"><pre>'+hl(d.code)+'</pre></div></div>' +
    '</div>' +

    '<div class="tab-panel" id="panel_walkthrough"><ul class="steps-list">'+stepsHTML+'</ul></div>' +

    '<div class="tab-panel" id="panel_tricky">' +
      '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Knowing these makes you sound thorough and experienced.</div>' +
      trickyHTML +
    '</div>' +

    '<div class="tab-panel" id="panel_qa">' +
      '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Tap to reveal a confident ready-to-deliver answer.</div>' +
      qaHTML +
    '</div>' +

    '<div class="tab-panel" id="panel_alts">' +
      '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">Mentioning trade-offs proactively signals real depth.</div>' +
      altHTML +
    '</div>';

  area._rawCode = d.code;
  area.classList.add('visible');
  setTimeout(() => area.scrollIntoView({ behavior: 'smooth', block: 'start' }), 150);
}

function copyCode(btn) {
  const area = document.getElementById('responseArea');
  navigator.clipboard.writeText(area._rawCode||'').then(() => { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); });
}

document.getElementById('transcriptBox').addEventListener('input', updateGenerateBtn);
</script>
</body>
</html>
